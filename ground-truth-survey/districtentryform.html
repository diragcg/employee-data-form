<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>District Entry Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background: #FFF8E1;
        }
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #1B5E20;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .topbar .brand {
            font-weight: 700;
            font-size: 1rem;
            margin-left: 0.5rem;
            text-transform: uppercase;
        }
        .container-app {
            padding-top: 80px;
            padding-bottom: 24px;
        }
        .main-card {
            background: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        }
        .form-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .form-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        label.required::after {
            content: " *";
            color: #d63333;
            font-weight: 700;
            margin-left: 2px;
        }
        .hidden {
            display: none !important;
        }
        .form-section {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        .table-container table {
            min-width: 700px; /* Ensures horizontal scroll on small screens */
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            cursor: pointer;
        }
        .table-container tfoot td {
            position: sticky;
            bottom: 0;
            background-color: #e9ecef;
            z-index: 10;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
        }
        .form-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .form-info-header h4 {
            font-size: 1.25rem;
            margin-bottom: 0;
        }
        .form-info-header .form-control {
            max-width: 250px;
            margin-top: 0.5rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .nav-link.active {
            background-color: #f8f9fa !important;
            color: #1B5E20 !important;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <div class="topbar">
        <div class="d-flex align-items-center">
            <h5 class="brand d-none d-sm-block">संचालनालय कृषि छत्तीसगढ़</h5>
            <h5 class="brand d-sm-none">कृषि</h5>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <span id="userName" class="me-2 text-white small"></span>
            <button id="btnAdmin" class="btn btn-sm btn-light hidden">Admin</button>
            <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
        </div>
    </div>

    <div class="container container-app">
        <div class="main-card">
            <div id="dashboardView">
                <div class="form-info-header">
                    <h4>Forms Dashboard</h4>
                    <input type="text" id="formSearch" class="form-control" placeholder="Search forms...">
                </div>
                <div id="formSelector" class="row g-3">
                </div>
            </div>
            
            <div id="formView" class="hidden">
                <button id="btnBackToDashboard" class="btn btn-sm btn-outline-secondary mb-3">
                    &larr; Back to Dashboard
                </button>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Data for: <span class="text-primary" id="currentFormTitle"></span></h4>
                </div>
                
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="data-entry-tab" data-bs-toggle="tab" data-bs-target="#data-entry" type="button" role="tab" aria-controls="data-entry" aria-selected="true">Data Entry</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="submitted-data-tab" data-bs-toggle="tab" data-bs-target="#submitted-data" type="button" role="tab" aria-controls="submitted-data" aria-selected="false">Submitted Data</button>
                    </li>
                </ul>
                
                <div class="tab-content border border-top-0 p-3 bg-white" id="myTabContent">
                    <div class="tab-pane fade show active" id="data-entry" role="tabpanel" aria-labelledby="data-entry-tab">
                        <form id="dataForm" class="form-section">
                            <input type="hidden" id="recordId">
                            <div id="formFields" class="row g-3">
                            </div>
                            <div class="mt-4">
                                <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
                                <button type="reset" class="btn btn-outline-secondary">Reset</button>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="submitted-data" role="tabpanel" aria-labelledby="submitted-data-tab">
                        <div id="dataList">
                            <div class="mb-2 d-flex justify-content-between align-items-center flex-wrap">
                                <input type="text" id="tableFilter" class="form-control mb-2 mb-md-0" placeholder="Filter table...">
                                <span class="text-muted small ms-2">Total records: <span id="recordCount">0</span></span>
                                <button id="btnGetReport" class="btn btn-info ms-auto">Get Report</button>
                            </div>
                            <div class="table-responsive table-container">
                                <table class="table table-striped table-bordered table-sm">
                                    <thead id="tableHead"></thead>
                                    <tbody id="tableBody"></tbody>
                                    <tfoot id="tableFoot"></tfoot>
                                </table>
                            </div>
                            <div class="pagination-controls">
                                <button id="prevPage" class="btn btn-sm btn-outline-primary">Previous</button>
                                <span id="pageInfo" class="align-self-center"></span>
                                <button id="nextPage" class="btn btn-sm btn-outline-primary">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="alertToast" style="position:fixed; right:1rem; bottom:1rem; z-index:2000;"></div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this record? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Generate Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select a format to export the complete dataset for '<span id="reportFormTitle" class="fw-bold"></span>':</p>
                    <div class="d-flex justify-content-around my-3">
                        <button id="reportExportExcel" class="btn btn-success">Export to Excel</button>
                        <button id="reportExportPdf" class="btn btn-danger">Export to PDF</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
<script>
    /* ---------------- Supabase configuration ---------------- */
    const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* ---------------- Helpers ---------------- */
    const $ = id => document.getElementById(id);
    function toast(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = `alert alert-${type} shadow`;
        div.style.minWidth = '240px';
        div.textContent = msg;
        $('alertToast').appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }
    function getCurrentUser() {
        const s = localStorage.getItem('user') || sessionStorage.getItem('user');
        return s ? JSON.parse(s) : null;
    }
    function showLoading() {
        $('loadingOverlay').classList.remove('hidden');
    }
    function hideLoading() {
        $('loadingOverlay').classList.add('hidden');
    }

    /* ---------------- State ---------------- */
    let currentUser = null;
    let formDefinitions = [];
    let currentTableName = null;
    let currentDefinition = null;
    let tableData = [];
    const PAGE_SIZE = 20;
    let currentPage = 0;
    let deleteId = null;

    /* ---------------- Init ---------------- */
    document.addEventListener('DOMContentLoaded', async () => {
        currentUser = getCurrentUser();
        if (!currentUser) {
            location.href = 'login.html';
            return;
        }
        $('userName').textContent = `Logged in as: ${currentUser.email}`;
        if (currentUser.is_admin) {
            $('btnAdmin').classList.remove('hidden');
        }
        $('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('user');
            sessionStorage.removeItem('user');
            location.href = 'login.html';
        });
        $('btnAdmin').addEventListener('click', () => {
            location.href = 'admin.html';
        });

        $('formSearch').addEventListener('input', filterFormList);
        $('tableFilter').addEventListener('input', filterTable);
        $('btnBackToDashboard').addEventListener('click', () => {
            $('dashboardView').classList.remove('hidden');
            $('formView').classList.add('hidden');
        });
        $('btnGetReport').addEventListener('click', () => {
            const reportModal = new bootstrap.Modal($('reportModal'));
            $('reportFormTitle').textContent = currentDefinition.displayName;
            reportModal.show();
        });
        $('reportExportExcel').addEventListener('click', () => {
            downloadTableAsExcel(tableData, currentDefinition, currentDefinition.displayName);
        });
        $('reportExportPdf').addEventListener('click', () => {
            downloadTableAsPdf(tableData, currentDefinition, currentDefinition.displayName);
        });

        const { data: formDefs, error } = await supabase.from('form_definitions').select('*');
        if (error) {
            toast('Failed to load form definitions.', 'danger');
            console.error('Error fetching form definitions:', error);
            return;
        }
        formDefinitions = formDefs;
        renderFormList(formDefinitions);
    });

    /* ---------------- Main functions ---------------- */
    function renderFormList(forms) {
        const formSelector = $('formSelector');
        formSelector.innerHTML = '';
        if (forms.length === 0) {
            formSelector.innerHTML = '<p class="text-muted text-center">No forms found.</p>';
            return;
        }
        forms.forEach(form => {
            const card = document.createElement('div');
            card.className = 'col-sm-6 col-md-4 col-lg-3';
            card.innerHTML = `
                <div class="card h-100 form-card" data-table-name="${form.table_name}">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-0">${form.display_name}</h5>
                    </div>
                </div>
            `;
            card.addEventListener('click', () => {
                showForm(form.table_name);
            });
            formSelector.appendChild(card);
        });
    }

    function filterFormList(event) {
        const query = event.target.value.toLowerCase();
        const filtered = formDefinitions.filter(def => 
            def.display_name.toLowerCase().includes(query) || 
            def.table_name.toLowerCase().includes(query)
        );
        renderFormList(filtered);
    }
    
    async function showForm(tableName) {
        currentTableName = tableName;
        currentDefinition = formDefinitions.find(def => def.table_name === tableName);
        if (!currentDefinition) return;
        $('currentFormTitle').textContent = currentDefinition.display_name;
        
        // Render form fields
        const formFieldsContainer = $('formFields');
        formFieldsContainer.innerHTML = '';
        currentDefinition.fields.forEach(field => {
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'col-md-6';
            let inputHtml = '';
            switch(field.type) {
                case 'select':
                    inputHtml = `<select class="form-select" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                                    <option value="">--Select--</option>
                                    ${field.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                                 </select>`;
                    break;
                case 'textarea':
                    inputHtml = `<textarea class="form-control" id="${field.name}" name="${field.name}" rows="3" ${field.required ? 'required' : ''}></textarea>`;
                    break;
                default:
                    inputHtml = `<input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>`;
            }
            fieldGroup.innerHTML = `
                <label for="${field.name}" class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${inputHtml}
            `;
            formFieldsContainer.appendChild(fieldGroup);
        });

        // Fetch and render data
        await fetchData(currentTableName);
        
        $('dashboardView').classList.add('hidden');
        $('formView').classList.remove('hidden');

        // Reset form to initial state when switching
        $('dataForm').reset();
        $('recordId').value = '';
        $('submitBtn').textContent = 'Submit';
        $('data-entry-tab').click();
    }
    
    async function fetchData(tableName) {
        showLoading();
        try {
            const { data, error } = await supabase
                .from(tableName)
                .select('*')
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            tableData = data || [];
            renderTable(tableData);
            
        } catch (error) {
            toast('Error fetching data: ' + error.message, 'danger');
            console.error('Fetch error:', error);
            tableData = [];
            renderTable([]);
        } finally {
            hideLoading();
        }
    }
    
    function renderTable(data) {
        const head = $('tableHead');
        const body = $('tableBody');
        const foot = $('tableFoot');
        const recordCount = $('recordCount');

        recordCount.textContent = data.length;

        // Reset table content
        head.innerHTML = '';
        body.innerHTML = '';
        foot.innerHTML = '';
        
        // Add headers
        const headerRow = document.createElement('tr');
        const defaultHeaders = ['ID', 'Created At'];
        const formHeaders = currentDefinition.fields.map(f => f.label);
        [...defaultHeaders, ...formHeaders, 'Actions'].forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        head.appendChild(headerRow);
        
        // Add body rows
        if (data.length === 0) {
            body.innerHTML = '<tr><td colspan="100%" class="text-center">No data submitted yet.</td></tr>';
            return;
        }

        const filteredData = filterTableData(data, $('tableFilter').value);
        const paginatedData = paginateTableData(filteredData, currentPage);

        paginatedData.forEach(row => {
            const tr = document.createElement('tr');
            let rowHtml = `<td>${row.id.substring(0, 8)}...</td>`;
            rowHtml += `<td>${new Date(row.created_at).toLocaleString()}</td>`;
            currentDefinition.fields.forEach(field => {
                const value = row[field.name] || '-';
                rowHtml += `<td>${value}</td>`;
            });
            rowHtml += `
                <td>
                    <button class="btn btn-sm btn-info text-white edit-btn me-1" data-id="${row.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${row.id}">Delete</button>
                </td>
            `;
            tr.innerHTML = rowHtml;
            body.appendChild(tr);
        });

        updatePagination(filteredData.length);
        addTableEventListeners();
    }

    function filterTableData(data, query) {
        if (!query) return data;
        const lowerQuery = query.toLowerCase();
        return data.filter(row => {
            return Object.values(row).some(value => {
                if (typeof value === 'string') {
                    return value.toLowerCase().includes(lowerQuery);
                }
                return false;
            });
        });
    }

    function paginateTableData(data, page) {
        const start = page * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        return data.slice(start, end);
    }
    
    function updatePagination(totalRecords) {
        const totalPages = Math.ceil(totalRecords / PAGE_SIZE);
        const prevBtn = $('prevPage');
        const nextBtn = $('nextPage');
        const pageInfo = $('pageInfo');
        
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage >= totalPages - 1;
        pageInfo.textContent = `Page ${totalPages > 0 ? currentPage + 1 : 0} of ${totalPages}`;
        
        prevBtn.onclick = () => {
            if (currentPage > 0) {
                currentPage--;
                renderTable(tableData);
            }
        };
        nextBtn.onclick = () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderTable(tableData);
            }
        };
    }

    function addTableEventListeners() {
        $('tableBody').addEventListener('click', (event) => {
            const target = event.target;
            const id = target.getAttribute('data-id');
            if (target.classList.contains('edit-btn')) {
                showEditForm(id);
            } else if (target.classList.contains('delete-btn')) {
                showDeleteModal(id);
            }
        });
    }

    function showEditForm(recordId) {
        const record = tableData.find(d => d.id === recordId);
        if (!record) return;
        $('recordId').value = record.id;
        $('submitBtn').textContent = 'Update';
        
        currentDefinition.fields.forEach(field => {
            const input = $(field.name);
            if (input) {
                input.value = record[field.name] || '';
            }
        });
        $('data-entry-tab').click();
    }

    function showDeleteModal(recordId) {
        deleteId = recordId;
        const deleteModal = new bootstrap.Modal($('deleteModal'));
        deleteModal.show();
    }

    $('confirmDeleteBtn').addEventListener('click', async () => {
        showLoading();
        try {
            const { error } = await supabase
                .from(currentTableName)
                .delete()
                .eq('id', deleteId);
            
            if (error) throw error;
            toast('Record deleted successfully!', 'success');
            await fetchData(currentTableName);
            bootstrap.Modal.getInstance($('deleteModal')).hide();
        } catch (error) {
            console.error('Delete error:', error);
            toast('Failed to delete record: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    });

    $('dataForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        showLoading();
        const form = event.target;
        const recordId = $('recordId').value;

        const formData = {};
        currentDefinition.fields.forEach(field => {
            formData[field.name] = $(field.name).value;
        });
        formData.created_by = currentUser.id;
        
        try {
            if (recordId) {
                // Update existing record
                const { data, error } = await supabase
                    .from(currentTableName)
                    .update({ ...formData, updated_at: new Date().toISOString() })
                    .eq('id', recordId)
                    .select();
                
                if (error) throw error;
                toast('Record updated successfully!', 'success');
            } else {
                // Add new record
                const { data, error } = await supabase
                    .from(currentTableName)
                    .insert({ ...formData, created_at: new Date().toISOString() })
                    .select();
                
                if (error) throw error;
                toast('Record added successfully!', 'success');
            }
            form.reset();
            $('recordId').value = '';
            $('submitBtn').textContent = 'Submit';
            await fetchData(currentTableName);
            
        } catch (error) {
            console.error('Submission error:', error);
            toast('Failed to save record: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    });

    function downloadTableAsExcel(data, def, filename) {
        const headers = ['ID', 'Created At', ...def.fields.map(f => f.label)];
        const rows = data.map(row => {
            const rowData = [row.id, new Date(row.created_at).toLocaleString()];
            def.fields.forEach(field => {
                rowData.push(row[field.name] || '-');
            });
            return rowData;
        });

        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `${filename}.xlsx`);
        toast('Excel file downloaded successfully!', 'success');
    }

    function downloadTableAsPdf(data, def, filename) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const headers = ['ID', 'Created At', ...def.fields.map(f => f.label)];
        const body = data.map(row => {
            const rowData = [row.id, new Date(row.created_at).toLocaleString()];
            def.fields.forEach(field => {
                rowData.push(row[field.name] || '-');
            });
            return rowData;
        });

        doc.autoTable({
            head: [headers],
            body: body,
            startY: 20
        });

        doc.save(`${filename}.pdf`);
        toast('PDF file downloaded successfully!', 'success');
    }
</script>
</body>
</html>
