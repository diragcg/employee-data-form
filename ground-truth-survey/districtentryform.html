<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District — Tables & Records (संचालनालय कृषि छत्तीसगढ़)</title>
  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Supabase + XLSX (load before inline script uses them) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#FFF8E1; --card:#FFFFFF; --pistachio:#e6f4e6; --accent:#1B5E20; --muted:#6b7280; --shadow:0 8px 24px rgba(2,6,23,0.06); --topbar-h:64px;
    }
    html,body{height:100%;margin:0;font-family:"Mukta",system-ui,Roboto,Arial;background:var(--bg);}
    .topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:var(--accent);color:#fff;display:flex;align-items:center;padding:0 16px;gap:12px;z-index:1000}
    .brand{font-weight:700}
    .container-app{max-width:1200px;margin:calc(var(--topbar-h)+18px) auto;padding:12px}
    .layout{display:flex;gap:16px;align-items:flex-start}
    @media(max-width:992px){.layout{flex-direction:column}}
    .sidebar{width:320px;min-width:220px}
    .card-panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:var(--shadow)}
    .sidebar .card-panel{position:sticky;top:calc(var(--topbar-h)+12px);max-height:calc(100vh - (var(--topbar-h)+40px));overflow:auto}
    .list-group-item { cursor:pointer; }
    .list-group-item.active { background:#eef6ff; border-left:4px solid var(--accent); }
    .main { flex:1; min-width:0; }
    .no-wrap { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .muted { color:var(--muted); font-size:13px; }
    .form-control { background:var(--pistachio); border-radius:8px; border:1px solid #d6ead6; }
    .form-control:focus { background:#fff; border-color:var(--accent); box-shadow:0 0 0 4px rgba(27,94,32,0.06); }
    .table-wrap { margin-top:12px; background:#fff; padding:12px; border-radius:10px; box-shadow:var(--shadow); overflow:auto; }
    .hidden { display:none !important; }
    .actions { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="34" height="34" alt="">
    <div class="brand">संचालनालय कृषि छत्तीसगढ़</div>
    <div style="margin-left:auto;display:flex;gap:12px;align-items:center;">
      <div id="userSummary" class="no-wrap" style="color:#fff;font-weight:600"></div>
      <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
  <div class="container-app">
    <div class="layout">
      <!-- Left: table list -->
      <aside class="sidebar">
        <div class="card-panel">
          <h6 class="mb-2">Created Tables</h6>
          <div id="tablesList" class="list-group"></div>
          <div class="mt-3">
            <button id="btnRefresh" class="btn btn-sm btn-outline-primary w-100">Refresh</button>
          </div>
        </div>
      </aside>
Text
  <!-- Right: records and entry form -->
  <main class="main">
    <div id="noSelection" class="card-panel">
      <div class="muted">बाएँ से एक तालिका चुनें ताकि उसके रिकॉर्ड दिखें और आप नया रिकॉर्ड जोड़ सकें।</div>
    </div>

    <div id="recordsPanel" class="card-panel hidden">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h5 id="panelTitle" class="mb-1"></h5>
          <div class="muted" id="panelSub">Records for selected table (only your district)</div>
        </div>

        <div class="actions">
          <input id="txtSearch" class="form-control form-control-sm" placeholder="Search (client-side)" style="width:220px;">
          <select id="pageSize" class="form-select form-select-sm" style="width:80px;">
            <option>10</option><option>25</option><option>50</option>
          </select>
          <button id="btnPrev" class="btn btn-sm btn-outline-secondary">Prev</button>
          <button id="btnNext" class="btn btn-sm btn-outline-secondary">Next</button>
          <div class="btn-group">
            <button id="btnExportXlsx" class="btn btn-sm btn-outline-success">XLSX</button>
            <button id="btnExportTxt" class="btn btn-sm btn-outline-secondary">TXT</button>
            <button id="btnPrint" class="btn btn-sm btn-outline-dark">Print</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <div id="recordsTableContainer"></div>
      </div>

      <div class="mt-3 card-panel">
        <h6 class="mb-2">Add New Record</h6>
        <form id="entryForm">
          <div id="entryFields" class="row g-2"></div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button id="btnClearDraft" type="button" class="btn btn-outline-secondary btn-sm">Clear Draft</button>
            <button id="btnSaveRecord" type="button" class="btn btn-success btn-sm">Save</button>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>
  </div>
  <div id="printArea" style="display:none"></div>
<script>
/* ---------------- CONFIG: paste your anon/public key here ---------------- */
const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------- Helpers ---------------- */
const \$ = id => document.getElementById(id);
const el = (t,a={},c=[])=>{ const e=document.createElement(t); for(const k in a){ if(k==='class') e.className=a[k]; else e.setAttribute(k,a[k]); } (Array.isArray(c)?c:[c]).forEach(ch=>{ if(!ch) return; if(typeof ch==='string') e.appendChild(document.createTextNode(ch)); else e.appendChild(ch); }); return e; };
function toast(msg){ alert(msg); }
function getUser(){ const s=localStorage.getItem('user')||sessionStorage.getItem('user'); return s?JSON.parse(s):null; }
function sanitizeName(s){ return String(s||'').replace(/[^a-zA-Z0-9_]/g,'_'); }

/* ---------------- State ---------------- */
let currentUser = null;
let definitions = [];          // form_definitions
let selectedTable = null;      // table_name (string)
let currentDefinition = null;  // full def record
let districtsCache = null;
let currentRows = [];
let currentPage = 1;
let pageSize = 10;

/* ---------------- Init ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  currentUser = getUser() || { id:null, username:'test_district', fullName:'test_district', role:'user', districtId:'7b161aeb-4492-4a74-b587-306a4bb00b99' };
  \$('userSummary').textContent = `${currentUser.fullName || currentUser.username} • Role: ${currentUser.role || 'user'} • District: ${currentUser.districtId || ''}`;

  // wire buttons
  \$('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href='login.html'; });
  \$('btnRefresh').addEventListener('click', loadDefinitions);
  \$('txtSearch').addEventListener('input', ()=> { currentPage=1; renderTablePage(); });
  $('pageSize').addEventListener('change', ()=> { pageSize = parseInt($('pageSize').value,10); currentPage=1; renderTablePage(); });
  \$('btnPrev').addEventListener('click', ()=> { if(currentPage>1){ currentPage--; renderTablePage(); }});
  \$('btnNext').addEventListener('click', ()=> { currentPage++; renderTablePage(); });
  \$('btnSaveRecord').addEventListener('click', saveEntry);
  \$('btnClearDraft').addEventListener('click', ()=> { if(!selectedTable) return; localStorage.removeItem(`draft::${selectedTable}`); toast('Draft cleared'); });
  \$('btnExportXlsx').addEventListener('click', exportXlsx);
  \$('btnExportTxt').addEventListener('click', exportTxt);
  \$('btnPrint').addEventListener('click', printPreview);

  await loadDefinitions();
});

/* ---------------- Load definitions (tables/form metadata) ---------------- */
async function loadDefinitions(){
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    definitions = data || [];
    renderTablesList();
  } catch(err){ console.error(err); toast('Failed to load form definitions (see console)'); }
}

function renderTablesList(){
  const el = \$('tablesList'); el.innerHTML = '';
  if(!definitions.length){ el.appendChild(el('div',{},['No tables found'])); return; }
  definitions.forEach(def => {
    const btn = el('button',{type:'button',class:'list-group-item list-group-item-action'},[ `${def.table_name} (${(def.fields||[]).length})` ]);
    btn.addEventListener('click', ()=> { selectTable(def.table_name); });
    el.appendChild(btn);
  });
}

/* ---------------- Select table -> render form and load records filtered by district ---------------- */
async function selectTable(tableName){
  selectedTable = tableName;
  // find definition
  currentDefinition = definitions.find(d => d.table_name === tableName);
  if(!currentDefinition){
    // try fetch single definition
    try {
      const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name', tableName).single();
      if(error) throw error;
      currentDefinition = data;
    } catch(err){ console.error(err); toast('Definition not found'); return; }
  }
  // highlight selected
  Array.from(\$('tablesList').children).forEach(ch => ch.classList.toggle('active', ch.textContent.startsWith(tableName)));
  // show records panel
  \$('noSelection').classList.add('hidden');
  \$('recordsPanel').classList.remove('hidden');
  \$('panelTitle').textContent = tableName;
  // render entry form fields
  await renderEntryForm();
  // load initial page
  currentPage = 1;
  pageSize = parseInt(\$('pageSize').value,10) || 10;
  await loadRecordsPage();
}

/* ---------------- Render entry form inputs based on definition (district field becomes dropdown) ---------------- */
async function renderEntryForm(){
  const container = \$('entryFields'); container.innerHTML = '';
  // load districts once
  if(!districtsCache){
    try{
      const { data, error } = await supabase.from('districts').select('id,name').order('name');
      if(error) throw error;
      districtsCache = data || [];
    }catch(e){ console.error('districts',e); districtsCache = []; }
  }
  (currentDefinition.fields || []).forEach(field => {
    const col = el('div',{class:'col-md-6'});
    const lbl = el('label',{},[ field.label || field.name ]);
    if(/district/i.test(field.name)){
      // select
      const sel = el('select',{class:'form-control', name: sanitizeName(field.name) }, [ el('option',{value:''},['-- जिला चुनें --']) ]);
      (districtsCache||[]).forEach(d => sel.appendChild(el('option',{value:d.id},[d.name])));
      if(currentUser && currentUser.districtId){ sel.value = currentUser.districtId; if(currentUser.role !== 'admin') sel.disabled = true; }
      col.appendChild(lbl); col.appendChild(sel);
    } else {
      let inputType = 'text';
      if(field.type === 'number') inputType = 'number';
      if(field.type === 'date') inputType = 'date';
      const inp = el('input',{class:'form-control',type:inputType,name:sanitizeName(field.name)});
      col.appendChild(lbl); col.appendChild(inp);
    }
    container.appendChild(col);
  });
  // load draft if exists
  const raw = localStorage.getItem(`draft::${selectedTable}`);
  if(raw){ try{ const parsed = JSON.parse(raw); const d = parsed.data||{}; \$('entryFields').querySelectorAll('input,select,textarea').forEach(i=>{ if(d.hasOwnProperty(i.name)) i.value = d[i.name]; }); }catch(e){console.warn(e);} }
  // autosave on change
  \$('entryFields').querySelectorAll('input,select,textarea').forEach(i=> i.addEventListener('change', ()=> saveDraft(selectedTable)));
}

/* ---------------- Draft save/load ---------------- */
function saveDraft(tableName){
  if(!tableName) return;
  const data = {};
  \$('entryFields').querySelectorAll('input,select,textarea').forEach(i => data[i.name]=i.value);
  localStorage.setItem(`draft::${tableName}`, JSON.stringify({ savedAt: new Date().toISOString(), data }));
  toastSmall('Draft saved locally');
}

/* ---------------- Load page of records (filtered by district if column exists) ---------------- */
async function loadRecordsPage(){
  if(!selectedTable) return;
  try {
    const hasDistrict = (currentDefinition.fields || []).some(f => /district/i.test(f.name));
    const districtField = (currentDefinition.fields || []).find(f => /district/i.test(f.name));
    let query = supabase.from(selectedTable).select('*');
    if(hasDistrict && currentUser && currentUser.districtId){
      query = query.eq(sanitizeName(districtField.name), currentUser.districtId);
    }
    const offset = (currentPage-1)*pageSize;
    const { data, error } = await query.range(offset, offset + pageSize - 1).order('id',{ascending:true});
    if(error) throw error;
    currentRows = data || [];
    renderTablePage();
  } catch(err){ console.error(err); toast('Failed to load records'); }
}

function renderTablePage(){
  const container = \$('recordsTableContainer'); container.innerHTML = '';
  if(!currentRows.length){ container.innerHTML = '<div class="muted">No records on this page.</div>'; return; }
  // client-side search filter
  const q = \$('txtSearch').value.trim().toLowerCase();
  const rows = q ? currentRows.filter(r => Object.values(r).some(v => v!==null && String(v).toLowerCase().includes(q))) : currentRows;
  const table = el('table',{class:'table table-sm table-bordered table-striped'});
  const thead = el('thead'); const headerRow = el('tr'); const keys = Object.keys(rows[0]);
  headerRow.appendChild(el('th',{},['#'])); keys.forEach(k=> headerRow.appendChild(el('th',{},[k]))); thead.appendChild(headerRow); table.appendChild(thead);
  const tbody = el('tbody');
  rows.forEach((r,idx) => {
    const tr = el('tr');
    tr.appendChild(el('td',{},[ ((currentPage-1)*pageSize + idx + 1).toString() ]));
    keys.forEach(k => tr.appendChild(el('td',{},[ r[k]===null||r[k]===undefined ? '' : String(r[k]) ])));
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); container.appendChild(table);
  \$('recordsInfo').textContent = `Showing ${rows.length} row(s) — page ${currentPage}`;
}

/* ---------------- Export functions ---------------- */
function exportXlsx(){
  if(!currentRows.length){ toast('No rows to export'); return; }
  const keys = Object.keys(currentRows[0]);
  const data = [keys];
  currentRows.forEach(r => data.push(keys.map(k => r[k]===null||r[k]===undefined ? '' : r[k])));
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, 'Export'); XLSX.writeFile(wb, `${selectedTable}_export.xlsx`);
}
function exportTxt(){
  if(!currentRows.length){ toast('No rows to export'); return; }
  const keys = Object.keys(currentRows[0]);
  const lines = [ keys.join('\t') ];
  currentRows.forEach(r => lines.push(keys.map(k=> r[k]===null||r[k]===undefined ? '' : String(r[k])).join('\t')));
  const blob = new Blob([lines.join('\n')], { type:'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = el('a',{href:url,download:`${selectedTable}_export.txt`}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function printPreview(){
  if(!currentRows.length){ toast('No rows to print'); return; }
  const keys = Object.keys(currentRows[0]);
  let html = '<table style="border-collapse:collapse;width:100%;font-family:monospace;"><thead><tr>';
  keys.forEach(k => html += `<th style="border:1px solid #000;padding:6px">${escapeHtml(k)}</th>`);
  html += '</tr></thead><tbody>';
  currentRows.forEach(r => { html += '<tr>'; keys.forEach(k => html += `<td style="border:1px solid #000;padding:6px">${escapeHtml(r[k]===null||r[k]===undefined?'':r[k])}</td>`); html += '</tr>'; });
  html += '</tbody></table>';
  const w = window.open('','_blank'); w.document.write(`<!doctype html><html><head><title>Print</title><style>@page{size:A4;margin:20mm}body{font-family:monospace}</style></head><body>${html}</body></html>`); w.document.close(); w.print();
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&','<':'<','>':'>','"':'"',"'":'''}[c])); }

/* ---------------- Utilities ---------------- */
function toastSmall(msg){ const d=el('div',{class:'alert alert-secondary'},[msg]); d.style.position='fixed'; d.style.right='16px'; d.style.bottom='16px'; d.style.zIndex=2000; document.body.appendChild(d); setTimeout(()=>d.remove(),1400); }

</script>
</body>
</html>
