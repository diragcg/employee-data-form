<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District — Data Entry (संचालनालय कृषि छत्तीसगढ़)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #FFF8E1;
      --card: #FFFFFF;
      --pistachio: #e6f4e6; /* light pistachio for field background */
      --accent: #1B5E20;
      --muted: #6b7280;
      --shadow: 0 8px 24px rgba(2,6,23,0.06);
      --topbar-height: 64px;
    }
    html,body{height:100%;}
    body{
      font-family: "Mukta", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      margin:0;
      -webkit-font-smoothing:antialiased;
    }

    /* topbar */
    .topbar{
      position:fixed; top:0; left:0; right:0; height:var(--topbar-height); background:var(--accent); color:#fff;
      display:flex; align-items:center; gap:12px; padding:0 18px; z-index:60;
    }
    .brand{ font-weight:700; font-size:18px; margin-left:8px; }
    .topbar .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

    /* layout */
    .container-app{ max-width:1100px; margin: calc(var(--topbar-height) + 28px) auto 48px; padding:0 12px; }
    .layout{ display:flex; gap:16px; align-items:flex-start; }
    @media (max-width: 992px){ .layout{ flex-direction:column; } }

    /* sidebar */
    .sidebar { width:300px; min-width:240px; }
    .sidebar .card-panel{ padding:14px; border-radius:10px; background:var(--card); box-shadow:var(--shadow); position:sticky; top:calc(var(--topbar-height) + 16px); max-height: calc(100vh - (var(--topbar-height) + 56px)); overflow:auto; }
    .user-badge{ background:var(--pistachio); padding:8px 12px; border-radius:8px; font-weight:700; color:var(--accent); box-shadow:0 2px 6px rgba(0,0,0,0.04); display:inline-block; }

    .forms-list .list-group-item { cursor:pointer; }
    .forms-list .list-group-item.active { background:#eef6ff; border-left:4px solid var(--accent); }

    /* main */
    .main { flex:1; min-width:0; }
    .card-panel { background:var(--card); border-radius:10px; padding:16px; box-shadow:var(--shadow); }
    .user-info { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; padding:12px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); }
    .user-info .meta { color:var(--muted); font-size:13px; }

    .form-card { padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow); }
    .form-section { margin-bottom:12px; }
    label.required::after{ content: " *"; color:#d63333; margin-left:3px; font-weight:700; }
    input.form-control, select.form-control, textarea.form-control {
      background: var(--pistachio);
      border:1px solid #d6ead6;
      height:46px;
      border-radius:8px;
    }
    input.form-control:focus, textarea.form-control:focus, select.form-control:focus {
      box-shadow: 0 0 0 4px rgba(27,94,32,0.06);
      outline:none;
      border-color:var(--accent);
      background:#fff;
    }

    .save-row { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; align-items:center; }
    .small-muted { color:var(--muted); font-size:13px; }

    /* sticky save on mobile small screens */
    @media (max-width: 576px) {
      .save-row { position:sticky; bottom:12px; background:transparent; padding-top:8px; }
    }

    /* utility */
    .muted-box { font-size:13px; color:var(--muted); }
  </style>
</head>
<body>

  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="34" height="34" alt="">
    <div class="brand">संचालनालय कृषि छत्तीसगढ़ — District Entry</div>
    <div class="actions">
      <button id="btnHome" class="btn btn-sm btn-light">Home</button>
      <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>

  <div class="container-app">
    <div class="layout">
      <aside class="sidebar">
        <div class="card-panel">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
            <div class="user-badge" id="userBadge">test_district</div>
            <div>
              <div id="userRoleLine" style="font-weight:700;color:var(--accent);">Role: user</div>
              <div id="userDistrictLine" class="muted-box">District: 7b161aeb-4492-4a74-b587-306a4bb00b99</div>
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="small-muted">Available forms</div>
            <div id="formsList" class="forms-list list-group mt-2"></div>
          </div>

          <div style="margin-top:12px;">
            <div class="small-muted">Drafts</div>
            <div id="draftsList" class="list-group mt-2"></div>
          </div>

          <div style="margin-top:14px;">
            <button id="btnRefreshForms" class="btn btn-sm btn-outline-primary w-100">Refresh Forms</button>
          </div>
        </div>
      </aside>

      <main class="main">
        <div class="user-info card-panel">
          <div>
            <div style="font-weight:800; font-size:16px;" id="pageTitle">डेटा एंट्री</div>
            <div class="muted-box">कृपया नीचे दिए फॉर्म में आवश्यक विवरण भरें और Save पर क्लिक करें।</div>
          </div>
          <div style="text-align:right;">
            <div class="muted-box">Logged in as</div>
            <div id="userSummary" style="font-weight:700;">test_district • Role: user • District: 7b161aeb-4492-4a74-b587-306a4bb00b99</div>
          </div>
        </div>

        <div id="formArea" class="form-card hidden">
          <h5 id="formTitle" class="mb-3"></h5>

          <form id="entryForm" autocomplete="off">
            <!-- dynamic fields -->
          </form>

          <div class="save-row">
            <div class="small-muted me-auto" id="formNote">All fields marked * are required.</div>
            <div>
              <button id="btnClearDraft" class="btn btn-outline-secondary btn-sm">Clear Draft</button>
              <button id="btnSave" class="btn btn-success btn-sm">Save</button>
            </div>
          </div>
        </div>

        <div id="noForm" class="card-panel">
          <div class="small-muted">कृपया बाईं पट्टी से कोई फॉर्म चुनें।</div>
        </div>
      </main>
    </div>
  </div>

  <!-- Load libs at end -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    // Supabase config (use your project's anon/public key)
    const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Helpers
    const $ = id => document.getElementById(id);
    function el(tag, attrs = {}, children = []) {
      const e = document.createElement(tag);
      for (const k in attrs) {
        if (k === 'class') e.className = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      children.forEach(c => typeof c === 'string' ? e.appendChild(document.createTextNode(c)) : e.appendChild(c));
      return e;
    }
    function toast(msg){ alert(msg); }
    function getCurrentUser(){
      const s = localStorage.getItem('user') || sessionStorage.getItem('user');
      return s ? JSON.parse(s) : null;
    }
    function sanitizeForInputName(s){ return String(s||'').replace(/[^a-zA-Z0-9_]/g,'_'); }
    const draftKeyPrefix = 'draft::';

    // State
    let currentUser = null;
    let definitions = [];
    let currentDefinition = null;

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      // restore user
      currentUser = getCurrentUser() || {
        id: null, username: 'test_district', fullName: 'test_district', role: 'user',
        districtId: '7b161aeb-4492-4a74-b587-306a4bb00b99'
      };

      // populate UI
      $('userBadge').textContent = currentUser.fullName || currentUser.username || 'user';
      $('userRoleLine').textContent = `Role: ${currentUser.role || 'user'}`;
      $('userDistrictLine').textContent = `District: ${currentUser.districtId || ''}`;
      $('userSummary').textContent = `${currentUser.fullName || currentUser.username} • Role: ${currentUser.role || 'user'} • District: ${currentUser.districtId || ''}`;

      // wire buttons
      $('btnLogout').addEventListener('click', () => { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href = 'login.html'; });
      $('btnHome').addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
      $('btnRefreshForms').addEventListener('click', loadDefinitions);
      $('btnSave').addEventListener('click', saveEntry);
      $('btnClearDraft').addEventListener('click', clearDraft);

      // load definitions and drafts
      await loadDefinitions();
      renderDraftsList();
    });

    // Load form_definitions
    async function loadDefinitions() {
      try {
        const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        definitions = data || [];
        renderFormsList();
      } catch (err) {
        console.error('Failed loading definitions', err);
        toast('फॉर्म लोड करने में त्रुटि — कंसोल देखें।');
      }
    }

    function renderFormsList() {
      const list = $('formsList'); list.innerHTML = '';
      if (!definitions.length) { list.innerHTML = '<div class="text-muted">No forms available</div>'; return; }
      definitions.forEach(def => {
        const item = el('button', { type: 'button', class: 'list-group-item list-group-item-action' }, [ `${def.table_name} — ${(def.fields||[]).length} fields` ]);
        item.addEventListener('click', () => selectDefinition(def.table_name));
        list.appendChild(item);
      });
    }

    // Select definition and render blank form
    async function selectDefinition(tableName) {
      Array.from($('formsList').children).forEach(ch => ch.classList.toggle('active', ch.textContent.startsWith(tableName)));
      try {
        const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name', tableName).single();
        if (error) throw error;
        currentDefinition = data;
        renderForm(currentDefinition);
        loadDraft(currentDefinition.table_name);
      } catch (err) {
        console.error('selectDefinition error', err);
        toast('Cannot open form. Check console.');
      }
    }

    function renderForm(def) {
      $('formTitle').textContent = def.label || def.table_name;
      const form = $('entryForm'); form.innerHTML = '';
      (def.fields || []).forEach(field => {
        const wrapper = el('div', { class: 'form-section' });
        const label = el('label', { class: field.required ? 'form-label required' : 'form-label' }, [ field.label || field.name ]);
        let input;
        const type = field.type || 'text';
        if (type === 'date') {
          input = el('input', { class: 'form-control', type: 'date', name: sanitizeForInputName(field.name) });
        } else if (type === 'number') {
          input = el('input', { class: 'form-control', type: 'number', name: sanitizeForInputName(field.name), step: 'any' });
        } else {
          input = el('input', { class: 'form-control', type: 'text', name: sanitizeForInputName(field.name) });
        }
        input.placeholder = field.placeholder || '';
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        form.appendChild(wrapper);
      });

      $('formArea').classList.remove('hidden');
      $('noForm').classList.add('hidden');
    }

    // Draft handling
    function draftStorageKey(tableName) { return draftKeyPrefix + (tableName || 'unknown'); }

    function saveDraft(tableName) {
      if (!tableName) return;
      const data = {};
      $('entryForm').querySelectorAll('input, textarea, select').forEach(i => data[i.name] = i.value);
      localStorage.setItem(draftStorageKey(tableName), JSON.stringify({ savedAt: new Date().toISOString(), data }));
      renderDraftsList();
      toastSmall('Draft saved locally');
    }

    function loadDraft(tableName) {
      const k = draftStorageKey(tableName);
      const raw = localStorage.getItem(k);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        const d = parsed.data || {};
        $('entryForm').querySelectorAll('input, textarea, select').forEach(i => { if (d.hasOwnProperty(i.name)) i.value = d[i.name]; });
        toastSmall('Draft loaded');
      } catch (e) { console.error('draft parse', e); }
    }

    function clearDraft() {
      if (!currentDefinition) return;
      const k = draftStorageKey(currentDefinition.table_name);
      localStorage.removeItem(k);
      renderDraftsList();
      toastSmall('Draft cleared');
    }

    function renderDraftsList() {
      const el = $('draftsList'); el.innerHTML = '';
      const keys = Object.keys(localStorage).filter(k => k.startsWith(draftKeyPrefix));
      if (!keys.length) { el.innerHTML = '<div class="text-muted">No drafts</div>'; return; }
      keys.forEach(k => {
        try {
          const raw = JSON.parse(localStorage.getItem(k));
          const name = k.replace(draftKeyPrefix, '');
          const item = el('button', { type: 'button', class: 'list-group-item list-group-item-action' }, [ `${name} • ${raw.savedAt ? new Date(raw.savedAt).toLocaleString() : 'Saved'}` ]);
          item.addEventListener('click', () => { selectDefinition(name); loadDraft(name); });
          el.appendChild(item);
        } catch (e) { console.warn('bad draft', e); }
      });
    }

    function toastSmall(msg){
      const div = document.createElement('div');
      div.className = 'alert alert-secondary';
      div.style.position = 'fixed'; div.style.right = '20px'; div.style.bottom = '20px'; div.style.zIndex = 9999;
      div.textContent = msg; document.body.appendChild(div);
      setTimeout(()=> div.remove(), 1600);
    }

    // Save entry to Supabase (manual only)
    async function saveEntry() {
      if (!currentDefinition) { toast('कृपया कोई फॉर्म चुनें'); return; }
      const payload = {};
      $('entryForm').querySelectorAll('input, textarea, select').forEach(i => payload[i.name] = i.value === '' ? null : i.value);

      // attach district_id automatically if user has one and the column exists
      if (currentUser && currentUser.districtId) {
        const hasDistrictCol = (currentDefinition.fields || []).some(f => sanitizeForInputName(f.name) === 'district_id' || f.name === 'district_id');
        if (hasDistrictCol) payload['district_id'] = currentUser.districtId;
      }

      // save draft locally before sending
      saveDraft(currentDefinition.table_name);

      try {
        const { data, error } = await supabase.from(currentDefinition.table_name).insert([payload]);
        console.log('insert response', { data, error });
        if (error) throw error;
        localStorage.removeItem(draftStorageKey(currentDefinition.table_name));
        renderDraftsList();
        toast('Record saved successfully');
        $('entryForm').querySelectorAll('input, textarea, select').forEach(i => i.value = '');
      } catch (err) {
        console.error('saveEntry error', err);
        toast('Save failed. Check console for details.');
      }
    }

  </script>
</body>
</html>
