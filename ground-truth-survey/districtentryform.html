<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District — Versioned Data Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f6f8fa; padding:18px; }
    .card { border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    .hidden { display:none; }
    .spinner-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.6); border-radius:10px; }
    .toast-area { position:fixed; right:20px; bottom:20px; z-index:3000; min-width:220px; }
    table.table td, table.table th { vertical-align: middle; }
    .muted-small { font-size:13px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h4 class="m-0">District Versioned Entry</h4>
      <div>
        <button id="btnShowViewer" class="btn btn-outline-secondary btn-sm me-2">View Records</button>
        <button id="btnRefreshTotals" class="btn btn-outline-primary btn-sm">Refresh Totals</button>
      </div>
    </div>

    <div id="topInfo" class="card mb-3 p-3">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div id="userSummary" style="font-weight:700;">Loading user...</div>
          <div id="userMeta" class="muted-small">Role: user</div>
        </div>
        <div style="text-align:right;">
          <div class="muted-small">Cumulative totals</div>
          <div id="totalsSummary" style="font-weight:700;">—</div>
        </div>
      </div>
    </div>

    <div id="entryCard" class="card mb-3 p-3 position-relative">
      <form id="entryForm" novalidate>
        <input type="hidden" id="editing_id" value="">
        <div class="row gx-2 gy-2">
          <div class="col-sm-3">
            <label class="form-label required">Entry Date</label>
            <input id="entry_date" name="entry_date" class="form-control" type="date" required>
          </div>
          <div class="col-sm-3">
            <label class="form-label required">Metric A</label>
            <input id="metric_a" name="metric_a" class="form-control" type="number" min="0" step="any" value="0" required>
          </div>
          <div class="col-sm-3">
            <label class="form-label required">Metric B</label>
            <input id="metric_b" name="metric_b" class="form-control" type="number" min="0" step="any" value="0" required>
          </div>
          <div class="col-sm-3">
            <label class="form-label">Change reason (required when editing)</label>
            <input id="change_reason" name="change_reason" class="form-control" type="text" placeholder="e.g., correction">
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">Notes</label>
          <textarea id="notes" class="form-control" rows="2" placeholder="Optional notes"></textarea>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="btnCreate" type="button" class="btn btn-success">Create New</button>
          <button id="btnSaveVersion" type="button" class="btn btn-primary">Save as Edit (Version)</button>
          <button id="btnClear" type="button" class="btn btn-outline-secondary">Clear</button>
          <div class="ms-auto">
            <button id="btnExportCSV" type="button" class="btn btn-outline-success btn-sm">Export CSV</button>
            <button id="btnExportXLSX" type="button" class="btn btn-outline-success btn-sm">Export XLSX</button>
          </div>
        </div>
      </form>

      <div id="entrySpinner" class="spinner-overlay hidden"><div class="spinner-border text-success" role="status"></div></div>
    </div>

    <div id="viewerCard" class="card p-3 hidden">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <strong>Records (latest first)</strong>
        <div>
          <button id="btnBackToEntry" class="btn btn-sm btn-outline-secondary">Back</button>
        </div>
      </div>

      <div style="max-height:520px; overflow:auto;">
        <table class="table table-sm table-hover" id="recordsTable">
          <thead>
            <tr>
              <th>Entry Date</th>
              <th>Metric A</th>
              <th>Metric B</th>
              <th>Version</th>
              <th>Current</th>
              <th>Predecessor</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="toastArea" class="toast-area"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // CONFIG: Replace with your secure auth in production. This uses the same key as earlier examples.
    const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // STATE
    let currentUser = { id: null, username: 'test_district', districtId: '7b161aeb-4492-4a74-b587-306a4bb00b99', role: 'user' };
    const TABLE = 'district_entries';
    const VIEW_TOTALS = 'v_district_totals';
    const RPC_UPSERT = 'upsert_versioned_entry'; // rpc created earlier

    // ELEMENTS
    const $ = id => document.getElementById(id);
    const toastArea = $('toastArea');

    // UTILS
    function showToast(message, type='secondary', ttl=3000) {
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.style.marginTop = '8px';
      div.textContent = message;
      toastArea.appendChild(div);
      setTimeout(()=> div.remove(), ttl);
    }
    function setSpinner(show) { const s = $('entrySpinner'); if(show) s.classList.remove('hidden'); else s.classList.add('hidden'); }
    function isoToday(){ return new Date().toISOString().slice(0,10); }

    // INIT
    document.addEventListener('DOMContentLoaded', async () => {
      // set user info (replace with real auth)
      $('userSummary').textContent = `${currentUser.username} • District: ${currentUser.districtId}`;
      $('userMeta').textContent = `Role: ${currentUser.role}`;

      $('entry_date').value = isoToday();
      bindEvents();
      await refreshTotals();
    });

    function bindEvents(){
      $('btnCreate').addEventListener('click', createNew);
      $('btnSaveVersion').addEventListener('click', saveAsVersion);
      $('btnClear').addEventListener('click', clearForm);
      $('btnShowViewer').addEventListener('click', () => { $('viewerCard').classList.remove('hidden'); $('entryCard').classList.add('hidden'); loadRecords(); });
      $('btnBackToEntry').addEventListener('click', () => { $('viewerCard').classList.add('hidden'); $('entryCard').classList.remove('hidden'); });
      $('btnRefreshTotals').addEventListener('click', refreshTotals);
      $('btnExportCSV').addEventListener('click', exportCSV);
      $('btnExportXLSX').addEventListener('click', exportXLSX);
    }

    function clearForm(){
      $('editing_id').value = '';
      $('entry_date').value = isoToday();
      $('metric_a').value = 0;
      $('metric_b').value = 0;
      $('notes').value = '';
      $('change_reason').value = '';
      showToast('Form cleared', 'secondary', 1200);
    }

    // Create as a brand new independent record (no predecessor)
    async function createNew(){
      // validation
      const entry_date = $('entry_date').value;
      const metric_a = parseFloat($('metric_a').value) || 0;
      const metric_b = parseFloat($('metric_b').value) || 0;
      const notes = $('notes').value || null;

      if(!entry_date){ showToast('Entry date required','warning'); return; }
      setSpinner(true);
      try {
        // Mark any existing current for same district+date as non-current (best done in backend but we do optimistic client-side step)
        await supabase.from(TABLE).update({ is_current: false }).match({ district_id: currentUser.districtId, entry_date: entry_date, is_current: true });

        const payload = {
          district_id: currentUser.districtId,
          entry_date,
          metric_a,
          metric_b,
          notes,
          created_by: currentUser.id,
          is_current: true,
          predecessor_id: null,
          version_number: 1,
        };
        const { data, error } = await supabase.from(TABLE).insert([payload]).select();
        if(error) throw error;
        showToast('Record created', 'success', 2000);
        clearForm();
        await refreshTotals();
      } catch (err) {
        console.error(err);
        showToast('Create failed — see console', 'danger', 3500);
      } finally { setSpinner(false); }
    }

    // Save as an edit: create a new version via RPC and mark predecessor non-current atomically in DB
    async function saveAsVersion(){
      const editingId = $('editing_id').value || null;
      const entry_date = $('entry_date').value;
      const metric_a = parseFloat($('metric_a').value) || 0;
      const metric_b = parseFloat($('metric_b').value) || 0;
      const notes = $('notes').value || null;
      const change_reason = $('change_reason').value || null;

      if(!entry_date){ showToast('Entry date required','warning'); return; }
      if(!editingId){ showToast('Select a record to edit from viewer (or use Duplicate then Save)', 'warning'); return; }
      if(!change_reason){ showToast('Change reason required for edits','warning'); return; }

      setSpinner(true);
      try {
        // RPC call with parameters matching the function signature
        const params = {
          p_predecessor_id: editingId,
          p_district_id: currentUser.districtId,
          p_entry_date: entry_date,
          p_metric_a: metric_a,
          p_metric_b: metric_b,
          p_notes: notes,
          p_created_by: currentUser.id,
          p_change_reason: change_reason
        };
        const { data, error } = await supabase.rpc(RPC_UPSERT, params);
        if(error) throw error;
        showToast('Edit saved as new version', 'success', 2500);
        clearForm();
        await refreshTotals();
        // if viewer open, reload records to show new version
        if(!$('viewerCard').classList.contains('hidden')) await loadRecords();
      } catch (err) {
        console.error(err);
        showToast('Version save failed — see console', 'danger', 3500);
      } finally { setSpinner(false); }
    }

    // Load records for district (show recent history)
    async function loadRecords(){
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
      try {
        const { data, error } = await supabase
          .from(TABLE)
          .select('*')
          .eq('district_id', currentUser.districtId)
          .order('created_at', { ascending: false })
          .limit(200);
        if(error) throw error;
        tbody.innerHTML = '';
        if(!data || !data.length){ tbody.innerHTML = '<tr><td colspan="8">No records</td></tr>'; return; }

        data.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.entry_date ? r.entry_date.slice(0,10) : ''}</td>
            <td>${r.metric_a ?? ''}</td>
            <td>${r.metric_b ?? ''}</td>
            <td>${r.version_number ?? ''}</td>
            <td>${r.is_current ? '<span class="badge bg-success">YES</span>' : '<span class="badge bg-secondary">NO</span>'}</td>
            <td style="font-size:11px">${r.predecessor_id ?? ''}</td>
            <td style="font-size:12px">${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${r.id}">Edit</button>
              <button class="btn btn-sm btn-outline-secondary btn-dup" data-id="${r.id}">Duplicate</button>
            </td>`;
          tbody.appendChild(tr);
        });

        // attach handlers
        tbody.querySelectorAll('.btn-edit').forEach(b => {
          b.addEventListener('click', async () => {
            const id = b.dataset.id;
            await loadRecordIntoFormForEdit(id);
            $('viewerCard').classList.add('hidden');
            $('entryCard').classList.remove('hidden');
            showToast('Loaded record for edit. Use "Save as Edit (Version)" to preserve old record.', 'info', 3500);
          });
        });
        tbody.querySelectorAll('.btn-dup').forEach(b => {
          b.addEventListener('click', async () => {
            const id = b.dataset.id;
            await duplicateRecordToForm(id);
            $('viewerCard').classList.add('hidden');
            $('entryCard').classList.remove('hidden');
            showToast('Record duplicated into form; press Create New to save as independent record.', 'info', 2200);
          });
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="8">Failed to load records</td></tr>';
        showToast('Failed to load records — see console', 'danger');
      }
    }

    // Load a single record into form for editing (will require change_reason before saving as version)
    async function loadRecordIntoFormForEdit(id){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').eq('id', id).single();
        if(error) throw error;
        $('editing_id').value = data.id;
        $('entry_date').value = data.entry_date ? data.entry_date.slice(0,10) : isoToday();
        $('metric_a').value = data.metric_a ?? 0;
        $('metric_b').value = data.metric_b ?? 0;
        $('notes').value = data.notes ?? '';
        $('change_reason').value = '';
      } catch (err) {
        console.error(err);
        showToast('Failed to load record', 'danger');
      }
    }

    // Duplicate a record into form for creating a new independent record
    async function duplicateRecordToForm(id){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').eq('id', id).single();
        if(error) throw error;
        $('editing_id').value = ''; // clear editing so Create New will create independent
        $('entry_date').value = data.entry_date ? data.entry_date.slice(0,10) : isoToday();
        $('metric_a').value = data.metric_a ?? 0;
        $('metric_b').value = data.metric_b ?? 0;
        $('notes').value = data.notes ?? '';
        $('change_reason').value = '';
      } catch (err) {
        console.error(err);
        showToast('Failed to duplicate record', 'danger');
      }
    }

    // Refresh cumulative totals (SQL view)
    async function refreshTotals(){
      try {
        const { data, error } = await supabase.from(VIEW_TOTALS).select('*').eq('district_id', currentUser.districtId).single();
        if(error && error.code !== 'PGRST116') { console.warn(error); }
        const totals = data || { total_metric_a: 0, total_metric_b: 0 };
        $('totalsSummary').textContent = `Metric A: ${totals.total_metric_a ?? 0} • Metric B: ${totals.total_metric_b ?? 0}`;
        showToast('Totals refreshed', 'secondary', 900);
      } catch (err) {
        console.error(err);
        showToast('Failed to refresh totals', 'danger');
      }
    }

    // EXPORT helpers
    async function exportCSV(){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').eq('district_id', currentUser.districtId).order('created_at', { ascending: false });
        if(error) throw error;
        if(!data || !data.length){ showToast('No records to export', 'warning'); return; }
        const keys = Object.keys(data[0]);
        const csv = [
          keys.join(','),
          ...data.map(r => keys.map(k => {
            const v = r[k];
            if(v === null || v === undefined) return '';
            return `"${String(v).replace(/"/g,'""')}"`;
          }).join(','))
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${TABLE}_${currentUser.districtId}.csv`; a.click();
        URL.revokeObjectURL(url);
        showToast('CSV exported', 'success');
      } catch (err) {
        console.error(err);
        showToast('CSV export failed', 'danger');
      }
    }

    async function exportXLSX(){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').eq('district_id', currentUser.districtId).order('created_at', { ascending: false });
        if(error) throw error;
        if(!data || !data.length){ showToast('No records to export', 'warning'); return; }
        const normalized = data.map(r => {
          const out = {};
          Object.keys(r).forEach(k => {
            const v = r[k];
            if(v === null || v === undefined) out[k] = '';
            else if(typeof v === 'object') out[k] = JSON.stringify(v);
            else out[k] = v;
          });
          return out;
        });
        const worksheet = XLSX.utils.json_to_sheet(normalized);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
        XLSX.writeFile(workbook, `${TABLE}_${currentUser.districtId}.xlsx`);
        showToast('XLSX exported', 'success');
      } catch (err) {
        console.error(err);
        showToast('XLSX export failed', 'danger');
      }
    }
  </script>
</body>
</html>
