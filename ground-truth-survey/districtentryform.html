<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District — Data Entry & Exports (संचालनालय कृषि छत्तीसगढ़)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#FFF8E1; --card:#fff; --pistachio:#e6f4e6; --accent:#1B5E20; --muted:#6b7280; --shadow:0 8px 24px rgba(2,6,23,0.06); --topbar:64px;
    }
    html,body{height:100%; margin:0; font-family:"Mukta",system-ui,Roboto,Arial; background:var(--bg);}
    .topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar);background:var(--accent);color:#fff;display:flex;align-items:center;padding:0 18px;gap:12px;z-index:1000;}
    .brand{font-weight:700;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .container-app{max-width:1200px;margin:calc(var(--topbar) + 20px) auto;padding:0 12px}
    .layout{display:flex;gap:16px;align-items:flex-start}
    @media (max-width:992px){.layout{flex-direction:column}}
    .sidebar{width:320px;min-width:220px}
    .card-panel{background:var(--card);border-radius:10px;padding:14px;box-shadow:var(--shadow)}
    .sidebar .card-panel{position:sticky;top:calc(var(--topbar) + 12px);max-height:calc(100vh - (var(--topbar) + 40px));overflow:auto}
    .user-badge{background:var(--pistachio);padding:8px 12px;border-radius:8px;font-weight:700;color:var(--accent)}
    .forms-list .list-group-item{cursor:pointer}
    .forms-list .list-group-item.active{background:#eef6ff;border-left:4px solid var(--accent)}
    .main{flex:1;min-width:0}
    .user-info{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));white-space:nowrap;overflow:hidden}
    .form-card{padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow)}
    .form-section{margin-bottom:12px}
    label.required::after{content:" *";color:#d63333;margin-left:3px;font-weight:700}
    input.form-control,select.form-control,textarea.form-control{background:var(--pistachio);border:1px solid #d6ead6;height:44px;border-radius:8px}
    input.form-control:focus,select.form-control:focus,textarea.form-control:focus{box-shadow:0 0 0 4px rgba(27,94,32,0.06);outline:none;border-color:var(--accent);background:#fff}
    .save-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;align-items:center}
    .small-muted{color:var(--muted);font-size:13px}
    .table-wrap{margin-top:14px;overflow:auto;background:#fff;padding:12px;border-radius:10px;box-shadow:var(--shadow)}
    .no-wrap { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="34" height="34" alt="">
    <div class="brand no-wrap" id="brandTitle">संचालनालय कृषि छत्तीसगढ़ — District Entry</div>
    <div class="actions">
      <div id="userInline" class="no-wrap" style="color:#fff;display:flex;gap:8px;align-items:center;">
        <div id="userNameInline" style="font-weight:700;"></div>
        <div id="userRoleInline"></div>
        <div id="userDistrictInline"></div>
      </div>
      <button id="btnHome" class="btn btn-sm btn-light">Home</button>
      <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
  <div class="container-app">
    <div class="layout">
      <aside class="sidebar">
        <div class="card-panel">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
            <div class="user-badge" id="userBadge">user</div>
            <div>
              <div id="userRoleLine" style="font-weight:700;color:var(--accent)"></div>
              <div id="userDistrictLine" class="small-muted"></div>
            </div>
          </div>
Text
      <div>
        <div class="small-muted">Available forms</div>
        <div id="formsList" class="forms-list list-group mt-2"></div>
      </div>

      <div style="margin-top:12px">
        <div class="small-muted">Drafts</div>
        <div id="draftsList" class="list-group mt-2"></div>
      </div>

      <div style="margin-top:14px">
        <button id="btnRefreshForms" class="btn btn-sm btn-outline-primary w-100">Refresh Forms</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="user-info card-panel">
      <div style="min-width:0;">
        <div style="font-weight:800;font-size:16px;" id="pageTitle">डेटा एंट्री</div>
        <div class="small-muted">कृपया फ़ॉर्म भरें और सेव करें।</div>
      </div>
      <div style="text-align:right;min-width:0;overflow:hidden">
        <div class="small-muted">Logged in as</div>
        <div id="userSummary" class="no-wrap" style="font-weight:700"></div>
      </div>
    </div>

    <div id="formArea" class="form-card hidden">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="formTitle" class="mb-0 no-wrap"></h5>
        <div class="d-flex gap-2">
          <button id="btnViewRecords" class="btn btn-outline-primary btn-sm">View Records</button>
          <div class="btn-group no-print">
            <button id="btnExportExcel" class="btn btn-sm btn-outline-success">Export XLSX</button>
            <button id="btnExportTxt" class="btn btn-sm btn-outline-secondary">Export TXT</button>
            <button id="btnPrint" class="btn btn-sm btn-outline-dark">Print</button>
          </div>
        </div>
      </div>

      <form id="entryForm" autocomplete="off"></form>

      <div class="save-row">
        <div class="small-muted me-auto" id="formNote">All fields marked * are required.</div>
        <div>
          <button id="btnClearDraft" class="btn btn-outline-secondary btn-sm">Clear Draft</button>
          <button id="btnSave" class="btn btn-success btn-sm">Save</button>
        </div>
      </div>

      <div id="listPanel" class="table-wrap mt-3 hidden">
        <div class="d-flex mb-2 justify-content-between align-items-center">
          <div>
            <label class="small-muted me-2">Search:</label>
            <input id="txtSearch" class="form-control form-control-sm d-inline-block" style="width:260px" placeholder="Search">
          </div>
          <div>
            <label class="small-muted me-2">Rows per page:</label>
            <select id="pageSize" class="form-select form-select-sm d-inline-block" style="width:100px"><option>10</option><option>25</option><option>50</option></select>
          </div>
        </div>

        <div id="recordsTableContainer"></div>

        <div class="d-flex justify-content-between align-items-center mt-2">
          <div id="recordsInfo" class="small-muted"></div>
          <div>
            <button id="prevPage" class="btn btn-sm btn-outline-secondary">Prev</button>
            <button id="nextPage" class="btn btn-sm btn-outline-secondary">Next</button>
          </div>
        </div>
      </div>
    </div>

    <div id="noForm" class="card-panel">
      <div class="small-muted">कृपया बाईं पट्टी से कोई फॉर्म चुनें।</div>
    </div>
  </main>
</div>
  </div>
  <div id="printArea" style="display:none"></div>
<script>
/* ---------------- CONFIG: replace with your anon/public key if different ---------------- */
const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* helpers */
const \$ = id => document.getElementById(id);
const el = (t, a={}, c=[])=>{ const e=document.createElement(t); for(const k in a){ if(k==='class') e.className=a[k]; else e.setAttribute(k,a[k]); } (Array.isArray(c)?c:[c]).forEach(ch=>{ if(!ch) return; if(typeof ch==='string') e.appendChild(document.createTextNode(ch)); else e.appendChild(ch);}); return e; };
function toast(msg){ alert(msg); }
function toastSmall(msg){ const d=el('div',{class:'alert alert-secondary'},[msg]); d.style.position='fixed'; d.style.right='18px'; d.style.bottom='18px'; d.style.zIndex=1200; document.body.appendChild(d); setTimeout(()=>d.remove(),1600); }
function getCurrentUser(){ const s=localStorage.getItem('user')||sessionStorage.getItem('user'); return s?JSON.parse(s):null; }
function sanitizeName(s){ return String(s||'').replace(/[^a-zA-Z0-9_]/g,'_'); }

/* state */
let currentUser = null, definitions=[], currentDefinition=null, districtsCache=null;
let currentPage=1, pageSize=10, currentRows=[], lastSearch='';

/* init */
document.addEventListener('DOMContentLoaded', async ()=> {
  currentUser = getCurrentUser() || { id:null, username:'test_district', fullName:'test_district', role:'user', districtId:'7b161aeb-4492-4a74-b587-306a4bb00b99' };
  // header alignment single line
  \$('userNameInline').textContent = currentUser.fullName || currentUser.username || 'user';
  \$('userRoleInline').textContent = `• Role: ${currentUser.role || 'user'}`;
  \$('userDistrictInline').textContent = `• District: ${currentUser.districtId || ''}`;
  \$('userBadge').textContent = currentUser.fullName || currentUser.username || 'user';
  \$('userRoleLine').textContent = `Role: ${currentUser.role || 'user'}`;
  \$('userDistrictLine').textContent = `District: ${currentUser.districtId || ''}`;
  \$('userSummary').textContent = `${currentUser.fullName || currentUser.username} • Role: ${currentUser.role || 'user'} • District: ${currentUser.districtId || ''}`;

  // wire buttons
  \$('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href='login.html'; });
  \$('btnHome').addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
  \$('btnRefreshForms').addEventListener('click', loadDefinitions);
  \$('btnSave').addEventListener('click', saveEntry);
  \$('btnClearDraft').addEventListener('click', clearDraft);
  $('btnViewRecords').addEventListener('click', ()=>{ $('listPanel').classList.toggle('hidden'); if(!\$('listPanel').classList.contains('hidden')){ currentPage=1; loadRecordsPage(); } });
  \$('btnExportExcel').addEventListener('click', exportExcel);
  \$('btnExportTxt').addEventListener('click', exportTxt);
  \$('btnPrint').addEventListener('click', printPreview);
  $('txtSearch').addEventListener('input', ()=>{ lastSearch=$('txtSearch').value.trim(); currentPage=1; loadRecordsPage(); });
  $('pageSize').addEventListener('change', ()=>{ pageSize=parseInt($('pageSize').value,10)||10; currentPage=1; loadRecordsPage(); });
  \$('prevPage').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; loadRecordsPage(); }});
  $('nextPage').addEventListener('click', ()=>{ if(currentRows.length===parseInt($('pageSize').value||10)) { currentPage++; loadRecordsPage(); }});

  await loadDefinitions();
  renderDraftsList();
});

/* definitions */
async function loadDefinitions(){
  try{
    const { data, error } = await supabase.from('form_definitions').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    definitions = data || [];
    renderFormsList();
  }catch(e){ console.error(e); toast('Failed to load forms — see console'); }
}
function renderFormsList(){
  const list=\$('formsList'); list.innerHTML='';
  if(!definitions.length){ list.innerHTML='<div class="text-muted">No forms available</div>'; return; }
  definitions.forEach(def=>{
    const item = el('button',{type:'button',class:'list-group-item list-group-item-action'},[`${def.table_name} — ${(def.fields||[]).length} fields`]);
    item.addEventListener('click', ()=> selectDefinition(def.table_name));
    list.appendChild(item);
  });
}

/* districts cache */
async function getDistricts(){
  if(districtsCache) return districtsCache;
  try{
    const { data, error } = await supabase.from('districts').select('id,name').order('name');
    if(error) throw error;
    districtsCache = data || [];
    return districtsCache;
  }catch(e){ console.error('districts',e); return []; }
}

/* select form & render */
async function selectDefinition(tableName){
  Array.from(\$('formsList').children).forEach(ch=>ch.classList.toggle('active', ch.textContent.startsWith(tableName)));
  try{
    const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name',tableName).single();
    if(error) throw error;
    currentDefinition = data;
    await renderForm(currentDefinition);
    loadDraft(currentDefinition.table_name);
  }catch(e){ console.error(e); toast('Cannot open form — see console'); }
}
async function renderForm(def){
  \$('formTitle').textContent = def.label || def.table_name;
  const form=\$('entryForm'); form.innerHTML='';
  const districts = await getDistricts();
  (def.fields||[]).forEach(field=>{
    const wrapper = el('div',{class:'form-section'});
    const label = el('label',{class: field.required ? 'form-label required' : 'form-label'},[field.label||field.name]);
    let input;
    const fname = sanitizeName(field.name);
    if(/district/i.test(field.name)){
      input = el('select',{class:'form-control', name: fname},[ el('option',{value:''},['-- जिला चुनें --']) ]);
      (districts||[]).forEach(d=> input.appendChild(el('option',{value:d.id},[d.name])));
      if(currentUser && currentUser.districtId){ input.value = currentUser.districtId; if(currentUser.role !== 'admin') input.disabled = true; }
    } else if(field.type==='date'){
      input = el('input',{class:'form-control',type:'date',name:fname});
    } else if(field.type==='number'){
      input = el('input',{class:'form-control',type:'number',name:fname,step:'any'});
    } else {
      input = el('input',{class:'form-control',type:'text',name:fname});
    }
    input.placeholder = field.placeholder||'';
    wrapper.appendChild(label); wrapper.appendChild(input); form.appendChild(wrapper);
  });
  $('formArea').classList.remove('hidden'); $('noForm').classList.add('hidden');
  \$('entryForm').querySelectorAll('input,select,textarea').forEach(i=>i.addEventListener('change',()=>saveDraft(currentDefinition.table_name)));
}

/* drafts */
const draftKeyPrefix='draft::';
function draftKey(t){ return `${draftKeyPrefix}${t}`; }
function saveDraft(tableName){
  if(!tableName) return;
  const data={}; \$('entryForm').querySelectorAll('input,select,textarea').forEach(i=>data[i.name]=i.value);
  localStorage.setItem(draftKey(tableName), JSON.stringify({savedAt:new Date().toISOString(),data}));
  renderDraftsList(); toastSmall('Draft saved locally');
}
function loadDraft(tableName){
  const raw = localStorage.getItem(draftKey(tableName)); if(!raw) return;
  try{ const parsed = JSON.parse(raw); const d = parsed.data||{}; \$('entryForm').querySelectorAll('input,select,textarea').forEach(i=>{ if(d.hasOwnProperty(i.name)) i.value=d[i.name]; }); toastSmall('Draft loaded'); }
  catch(e){ console.error(e); }
}
function clearDraft(){ if(!currentDefinition) return; localStorage.removeItem(draftKey(currentDefinition.table_name)); renderDraftsList(); toastSmall('Draft cleared'); }
function renderDraftsList(){ const el=\$('draftsList'); el.innerHTML=''; const keys = Object.keys(localStorage).filter(k=>k.startsWith(draftKeyPrefix)); if(!keys.length){ el.innerHTML='<div class="text-muted">No drafts</div>'; return; } keys.forEach(k=>{ try{ const raw = JSON.parse(localStorage.getItem(k)); const name = k.replace(draftKeyPrefix,''); const btn = el('button',{type:'button',class:'list-group-item list-group-item-action'},[`${name} • ${raw.savedAt?new Date(raw.savedAt).toLocaleString():'Saved'}`]); btn.addEventListener('click', ()=>{ selectDefinition(name); loadDraft(name); }); el.appendChild(btn);}catch(e){console.warn(e);} }); }

/* save */
async function saveEntry(){
  if(!currentDefinition){ toast('कृपया कोई फॉर्म चुनें'); return; }
  const payload={}; \$('entryForm').querySelectorAll('input,select,textarea').forEach(i=>payload[i.name]=i.value===''?null:i.value);
  // attach district if present in def and user has districtId
  if(currentUser && currentUser.districtId){
    const df = (currentDefinition.fields||[]).find(f=>/district/i.test(f.name));
    if(df) payload[sanitizeName(df.name)] = currentUser.districtId;
  }
  saveDraft(currentDefinition.table_name);
  try{
    const { data, error } = await supabase.from(currentDefinition.table_name).insert([payload]);
    console.log('insert', {data, error});
    if(error) throw error;
    localStorage.removeItem(draftKey(currentDefinition.table_name)); renderDraftsList();
    toast('Record saved successfully'); \$('entryForm').querySelectorAll('input,select,textarea').forEach(i=>i.value='');
    if(!\$('listPanel').classList.contains('hidden')) loadRecordsPage();
  }catch(e){ console.error(e); toast('Save failed — see console'); }
}

/* listing & pagination */
async function loadRecordsPage(){
  if(!currentDefinition) return;
  const table = currentDefinition.table_name;
  pageSize = parseInt(\$('pageSize').value||'10',10);
  const offset = (currentPage-1)*pageSize;
  try{
    // build query; filter by district if field exists
    const hasDistrict = (currentDefinition.fields||[]).some(f=>/district/i.test(f.name));
    const districtField = (currentDefinition.fields||[]).find(f=>/district/i.test(f.name));
    let query = supabase.from(table).select('*');
    if(hasDistrict && currentUser && currentUser.districtId){ query = query.eq(sanitizeName(districtField.name), currentUser.districtId); }
    const { data, error } = await query.range(offset, offset + pageSize -1).order('id',{ascending:true});
    if(error) throw error;
    currentRows = data||[];
    renderRecordsTable(currentRows);
    \$('prevPage').disabled = currentPage<=1;
    \$('nextPage').disabled = currentRows.length < pageSize;
    \$('recordsInfo').textContent = `Page ${currentPage} • Showing ${currentRows.length} row(s)`;
  }catch(e){ console.error(e); toast('Failed loading records — see console'); }
}
function renderRecordsTable(rows){
  const container = \$('recordsTableContainer'); container.innerHTML='';
  if(!rows.length){ container.innerHTML = '<div class="text-muted">No records on this page.</div>'; return; }
  const table = el('table',{class:'table table-sm table-bordered table-striped'});
  const thead = el('thead'); const headerRow = el('tr'); const keys = Object.keys(rows[0]);
  headerRow.appendChild(el('th',{},['#'])); keys.forEach(k=>headerRow.appendChild(el('th',{},[k]))); thead.appendChild(headerRow); table.appendChild(thead);
  const tbody = el('tbody');
  rows.forEach((r, idx)=>{ const tr = el('tr'); tr.appendChild(el('td',{},[ ((currentPage-1)*pageSize + idx + 1).toString() ])); keys.forEach(k=>tr.appendChild(el('td',{},[ r[k]===null||r[k]===undefined?'':String(r[k]) ]))); tbody.appendChild(tr); });
  table.appendChild(tbody); container.appendChild(table);
}

/* exports */
function exportExcel(){
  if(!currentRows.length){ toast('No rows to export'); return; }
  const keys = Object.keys(currentRows[0]); const data = [keys];
  currentRows.forEach(r=> data.push(keys.map(k=> r[k]===null||r[k]===undefined?'': r[k])));
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, 'Export'); XLSX.writeFile(wb, `${currentDefinition.table_name}_export.xlsx`);
}
function exportTxt(){
  if(!currentRows.length){ toast('No rows to export'); return; }
  const keys = Object.keys(currentRows[0]); const lines = []; lines.push(keys.join('\t')); currentRows.forEach(r=> lines.push(keys.map(k=> r[k]===null||r[k]===undefined?'': String(r[k])).join('\t'))); const blob = new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = el('a',{href:url,download:`${currentDefinition.table_name}_export.txt`}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function printPreview(){
  if(!currentRows.length){ toast('No rows to print'); return; }
  const keys = Object.keys(currentRows[0]);
  let html = `<div style="font-family:monospace;padding:12px;"><h3>${currentDefinition.table_name} — Export</h3><table style="border-collapse:collapse;width:100%;">`;
  html += '<thead><tr>' + keys.map(k=>`<th style="border:1px solid #000;padding:6px 8px;text-align:left">${k}</th>`.replace('\${k}',k)) + '</tr></thead><tbody>';
  currentRows.forEach(r=> html += '<tr>' + keys.map(k=>`<td style="border:1px solid #000;padding:6px 8px">${v}</td>`.replace('\${v}', (r[k]===null||r[k]===undefined?'': String(r[k])))) + '</tr>');
  html += '</tbody></table></div>';
  const w = window.open('','_blank'); w.document.open(); w.document.write(`<!doctype html><html><head><title>Print</title><style>@page{size:A4;margin:20mm}body{font-family:monospace;font-size:12px}</style></head><body>${html}</body></html>`); w.document.close(); w.print();
}

/* utils */
function sanitizeName(s){ return String(s||'').replace(/[^a-zA-Z0-9_]/g,'_'); }

</script>
</body>
</html>
