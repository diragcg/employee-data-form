<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District — Data Entry (संचालनालय कृषि छत्तीसगढ़)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --pistachio: #e6f4e6;
      --accent: #1B5E20;
      --muted: #6b7280;
      --shadow: 0 8px 24px rgba(2,6,23,0.06);
      --topbar-height: 64px;
    }
    html,body{height:100%;}
    body{
      font-family: "Mukta", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      margin:0;
    }
    .topbar{
      position:fixed; top:0; left:0; right:0; height:var(--topbar-height); background:var(--accent); color:#fff;
      display:flex; align-items:center; gap:12px; padding:0 18px; z-index:60;
    }
    .brand{ font-weight:700; font-size:18px; margin-left:8px; }
    .container-app{ max-width:1100px; margin: calc(var(--topbar-height) + 28px) auto 48px; padding:0 12px; }
    .layout{ display:flex; gap:16px; align-items:flex-start; }
    .sidebar { width:300px; min-width:240px; }
    .card-panel{ padding:14px; border-radius:10px; background:var(--card); box-shadow:var(--shadow); }
    .user-badge{ background:var(--pistachio); padding:8px 12px; border-radius:8px; font-weight:700; color:var(--accent); }
    .form-card { padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow); position:relative; }
    .form-section { margin-bottom:12px; }
    input.form-control, select.form-control, textarea.form-control { background: var(--pistachio); border:1px solid #d6ead6; height:46px; border-radius:8px; }
    .save-row { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; align-items:center; }
    .small-muted { color:var(--muted); font-size:13px; }
    .hidden { display:none; }
    .data-table-container { max-height: calc(100vh - 300px); overflow-y: auto; margin-top: 1rem; }
    .data-table th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    .spinner-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.6); border-radius:8px; }
    .toast-area { position: fixed; right: 20px; bottom: 20px; z-index: 3000; min-width: 220px; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="34" height="34" alt="">
    <div class="brand">संचालनालय कृषि छत्तीसगढ़ — District Entry</div>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button id="btnHome" class="btn btn-sm btn-light">Home</button>
      <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
  <div class="container-app">
    <div class="layout">
      <aside class="sidebar">
        <div class="card-panel">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
            <div class="user-badge" id="userBadge">test_district</div>
            <div>
              <div id="userRoleLine" style="font-weight:700;color:var(--accent);">Role: user</div>
              <div id="userDistrictLine" class="small-muted">District: -</div>
            </div>
          </div>
Text
      <div style="margin-top:8px;">
        <div class="small-muted">Available forms</div>
        <div id="formsList" class="list-group mt-2"></div>
      </div>

      <div style="margin-top:12px;">
        <div class="small-muted">Drafts</div>
        <div id="draftsList" class="list-group mt-2"></div>
      </div>

      <div style="margin-top:14px;">
        <button id="btnRefreshForms" class="btn btn-sm btn-outline-primary w-100">Refresh Forms</button>
      </div>
    </div>
  </aside>

  <main style="flex:1;min-width:0;">
    <div class="card-panel user-info" style="margin-bottom:12px;">
      <div>
        <div id="pageTitle" style="font-weight:800; font-size:16px;">डेटा एंट्री</div>
        <div class="small-muted">कृपया नीचे दिए फॉर्म में आवश्यक विवरण भरें और Save पर क्लिक करें।</div>
      </div>
      <div style="text-align:right;">
        <div class="small-muted">Logged in as</div>
        <div id="userSummary" style="font-weight:700;">test_district • Role: user • District: -</div>
      </div>
    </div>

    <div id="dataEntryPanel" class="form-card hidden">
      <h5 id="formTitle" class="mb-3"></h5>
      <div class="d-flex justify-content-end mb-3">
        <button id="btnViewRecords" class="btn btn-sm btn-outline-secondary">View Records</button>
      </div>

      <form id="entryForm" autocomplete="off"></form>

      <div class="save-row">
        <div class="small-muted me-auto" id="formNote">All fields marked * are required.</div>
        <div>
          <button id="btnClearDraft" class="btn btn-outline-secondary btn-sm">Clear Draft</button>
          <button id="btnSave" class="btn btn-success btn-sm">Create New</button>
          <button id="btnUpdate" class="btn btn-warning btn-sm">Update Existing</button>
        </div>
      </div>

      <div id="entrySpinner" class="spinner-overlay hidden"><div class="spinner-border text-success" role="status"></div></div>
    </div>

    <div id="dataViewerPanel" class="form-card hidden">
      <h5 id="viewerTitle" class="mb-3">View Records</h5>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="btnEnterNewData" class="btn btn-sm btn-outline-secondary">Enter New Data</button>
        <div id="viewerControls">
          <button id="btnExport" class="btn btn-sm btn-outline-success me-2">Export (Excel)</button>
          <button id="btnExportPDF" class="btn btn-sm btn-outline-danger me-2">Export (PDF)</button>
          <button id="btnRefreshData" class="btn btn-sm btn-outline-primary">Refresh Data</button>
        </div>
      </div>

      <div class="data-table-container position-relative">
        <div id="viewerSpinner" class="spinner-overlay hidden"><div class="spinner-border text-success" role="status"></div></div>
        <table class="table table-striped table-hover data-table mb-0">
          <thead id="dataTableHeaders"></thead>
          <tbody id="dataTableBody"></tbody>
        </table>
      </div>

      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>

    <div id="noForm" class="card-panel">
      <div class="small-muted">कृपया बाईं पट्टी से कोई फॉर्म चुनें।</div>
    </div>
  </main>
</div>
  </div>
  <div id="toastArea" class="toast-area"></div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- HELPERS ----------
    const \$ = id => document.getElementById(id);
    function el(tag, attrs = {}, children = []) {
      const e = document.createElement(tag);
      for (const k in attrs) {
        if (k === 'class') e.className = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      children.forEach(c => typeof c === 'string' ? e.appendChild(document.createTextNode(c)) : e.appendChild(c));
      return e;
    }
    function showToast(msg, type='secondary', ttl=3000) {
      const area = \$('toastArea');
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.style.marginTop = '8px';
      div.textContent = msg;
      area.appendChild(div);
      setTimeout(()=> div.remove(), ttl);
    }
    function setLoadingOverlay(container, show=true, targetId='entrySpinner') {
      const target = container ? container.querySelector(`#${targetId}`) : null;
      if (!target) return;
      if (show) target.classList.remove('hidden'); else target.classList.add('hidden');
    }
    function sanitizeForInputName(s) { return String(s || '').replace(/[^a-zA-Z0-9_]/g, '_'); }

    // ---------- STATE ----------
    let currentUser = null;
    let definitions = [];
    let currentDefinition = null;
    let currentPage = 1;
    const recordsPerPage = 20;
    let totalRecords = 0;
    let loadedCurrentRecord = null; // for update flow

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = getCurrentUser() || {
        id: null, username: 'test_district', fullName: 'test_district', role: 'user',
        districtId: '7b161aeb-4492-4a74-b587-306a4bb00b99'
      };

      \$('userBadge').textContent = currentUser.fullName || currentUser.username || 'user';
      \$('userRoleLine').textContent = `Role: ${currentUser.role || 'user'}`;
      \$('userDistrictLine').textContent = `District: ${currentUser.districtId || ''}`;
      \$('userSummary').textContent = `${currentUser.fullName || currentUser.username} • Role: ${currentUser.role || 'user'} • District: ${currentUser.districtId || ''}`;

      // event bindings
      \$('btnLogout').addEventListener('click', () => { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href = 'login.html'; });
      \$('btnHome').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      \$('btnRefreshForms').addEventListener('click', loadDefinitions);

      \$('btnSave').addEventListener('click', saveEntry);
      \$('btnUpdate').addEventListener('click', onUpdateClick);
      \$('btnClearDraft').addEventListener('click', clearDraft);
      \$('btnViewRecords').addEventListener('click', showDataViewer);
      \$('btnEnterNewData').addEventListener('click', showDataEntry);
      \$('btnExport').addEventListener('click', exportData);
      \$('btnExportPDF').addEventListener('click', exportPDF);
      \$('btnRefreshData').addEventListener('click', () => fetchAndRenderTableData(currentDefinition.table_name, currentPage));

      await loadDefinitions();
      renderDraftsList();
    });

    function getCurrentUser() {
      try {
        const s = localStorage.getItem('user') || sessionStorage.getItem('user');
        return s ? JSON.parse(s) : null;
      } catch (e) { return null; }
    }

    // ---------- FORMS DEFINITION ----------
    async function loadDefinitions() {
      try {
        const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        definitions = data || [];
        renderFormsList();
      } catch (err) {
        console.error('Failed loading definitions', err);
        showToast('फॉर्म लोड करने में त्रुटि — कंसोल देखें।', 'danger');
      }
    }

function renderFormsList() {
    const list = $('formsList');
    list.innerHTML = '';
    if (!definitions.length) {
        list.innerHTML = '<div class="text-muted">No forms available</div>';
        return;
    }
    definitions.forEach(def => {
        // store the canonical table_name in a data attribute so we always use the correct identifier
        const item = el('button', {
            type: 'button',
            class: 'list-group-item list-group-item-action',
            'data-table': def.table_name
        }, [ `${def.label || def.table_name}` ]);

        // click handler reads the table name from data attribute and calls selectDefinition
        item.addEventListener('click', (e) => {
            const tn = e.currentTarget.getAttribute('data-table');
            selectDefinition(tn);
        });

        list.appendChild(item);
    });
}

async function selectDefinition(tableName) {
    if (!tableName) return;
    // highlight the selected item by matching data-table attribute
    Array.from($('formsList').children).forEach(ch => {
        const tn = ch.getAttribute && ch.getAttribute('data-table');
        ch.classList.toggle('active', tn === tableName);
    });

    try {
        const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name', tableName).single();
        if (error) throw error;
        currentDefinition = data;
        showDataEntry();
        renderForm(currentDefinition);
        loadDraft(currentDefinition.table_name);

        // load latest record for update flow if available
        await loadLatestForDistrict(currentDefinition.table_name);
    } catch (err) {
        console.error('selectDefinition error', err);
        showToast('Cannot open form. Check console.', 'danger');
    }
}


    function renderForm(def) {
      \$('formTitle').textContent = def.label || def.table_name;
      const form = \$('entryForm');
      form.innerHTML = '';

      (def.fields || []).forEach(field => {
        const wrapper = el('div', { class: 'form-section' });
        const label = el('label', { class: field.required ? 'form-label required' : 'form-label' }, [ field.label || field.name ]);
        const inputName = sanitizeForInputName(field.name);
        let input;
        const type = field.type || 'text';
        if (type === 'date') {
          input = el('input', { class: 'form-control', type: 'date', name: inputName });
        } else if (type === 'number') {
          input = el('input', { class: 'form-control', type: 'number', name: inputName, step: 'any' });
        } else if (field.options && field.options.length) {
          input = el('select', { class: 'form-control', name: inputName });
          field.options.forEach(option => input.appendChild(el('option', { value: option.value }, [ option.label ])));
        } else {
          input = el('input', { class: 'form-control', type: 'text', name: inputName });
        }
        input.placeholder = field.placeholder || '';
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        form.appendChild(wrapper);
      });

      \$('dataEntryPanel').classList.remove('hidden');
      \$('noForm').classList.add('hidden');
    }

    function showDataEntry() {
      \$('dataEntryPanel').classList.remove('hidden');
      \$('dataViewerPanel').classList.add('hidden');
      \$('noForm').classList.add('hidden');
    }

    // ---------- VIEWER ----------
    async function showDataViewer() {
      if (!currentDefinition) { showToast('कृपया पहले फॉर्म चुनें।', 'warning'); return; }
      \$('dataEntryPanel').classList.add('hidden');
      \$('dataViewerPanel').classList.remove('hidden');
      \$('noForm').classList.add('hidden');
      await fetchAndRenderTableData(currentDefinition.table_name, 1);
    }

    async function fetchAndRenderTableData(tableName, page = 1) {
      currentPage = page;
      const start = (currentPage - 1) * recordsPerPage;
      const end = start + recordsPerPage - 1;

      const container = \$('dataViewerPanel').querySelector('.data-table-container');
      setLoadingOverlay(container, true, 'viewerSpinner');

      try {
        // filter by district to show only that district's rows
        const query = supabase.from(tableName)
          .select('*', { count: 'estimated' })
          .eq('district_id', currentUser && currentUser.districtId ? currentUser.districtId : null)
          .order('created_at', { ascending: false })
          .range(start, end);

        const { data, count, error } = await query;
        if (error) { throw error; }

        totalRecords = (typeof count === 'number') ? count : (data ? data.length : 0);
        renderDataTable(data || []);
        renderPagination();
      } catch (err) {
        console.error('Error fetching table data:', err);
        showToast('डेटा लाने में त्रुटि — कंसोल देखें।', 'danger');
      } finally {
        setLoadingOverlay(container, false, 'viewerSpinner');
      }
    }

    function renderDataTable(data) {
      const headers = \$('dataTableHeaders');
      const body = \$('dataTableBody');
      headers.innerHTML = '';
      body.innerHTML = '';

      if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="100%" class="text-center">No records found.</td></tr>';
        return;
      }

      const headerKeys = Object.keys(data[0]);
      const headerRow = el('tr', {}, headerKeys.map(k => el('th', { scope: 'col' }, [k])));
      headers.appendChild(headerRow);

      const frag = document.createDocumentFragment();
      data.forEach(row => {
        const tr = el('tr', {});
        headerKeys.forEach(key => {
          let cellValue = row[key] !== null && row[key] !== undefined ? row[key] : '';
          if (typeof cellValue === 'object') cellValue = JSON.stringify(cellValue);
          tr.appendChild(el('td', {}, [String(cellValue)]));
        });
        frag.appendChild(tr);
      });
      body.appendChild(frag);
    }

    function renderPagination() {
      const paginationEl = \$('pagination');
      paginationEl.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(totalRecords / recordsPerPage));

      const makeItem = (text, page, isDisabled) => {
        const li = el('li', { class: `page-item ${isDisabled ? 'disabled' : ''} ${page === currentPage ? 'active' : ''}` }, []);
        const a = el('a', { class: 'page-link', href: '#', 'data-page': page }, [text]);
        a.addEventListener('click', (e) => {
          e.preventDefault();
          if (!isDisabled && page !== currentPage) fetchAndRenderTableData(currentDefinition.table_name, page);
        });
        li.appendChild(a);
        return li;
      };

      paginationEl.appendChild(makeItem('Previous', Math.max(1, currentPage - 1), currentPage === 1));

      const maxVisible = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);
      if (endPage - startPage < maxVisible - 1) startPage = Math.max(1, endPage - maxVisible + 1);

      if (startPage > 1) {
        paginationEl.appendChild(makeItem('1', 1, false));
        if (startPage > 2) paginationEl.appendChild(el('li', { class: 'page-item disabled' }, [ el('span', { class: 'page-link' }, ['...']) ]));
      }

      for (let i = startPage; i <= endPage; i++) paginationEl.appendChild(makeItem(i, i, false));

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) paginationEl.appendChild(el('li', { class: 'page-item disabled' }, [ el('span', { class: 'page-link' }, ['...']) ]));
        paginationEl.appendChild(makeItem(totalPages, totalPages, false));
      }

      paginationEl.appendChild(makeItem('Next', Math.min(totalPages, currentPage + 1), currentPage === totalPages));
    }

    // ---------- EXPORT (fixed) ----------
    async function fetchAllTableData(tableName) {
      const pageSize = 1000;
      let from = 0;
      let all = [];
      while (true) {
        const { data, error } = await supabase.from(tableName)
          .select('*')
          .eq('district_id', currentUser && currentUser.districtId ? currentUser.districtId : null)
          .order('created_at', { ascending: false })
          .range(from, from + pageSize - 1);
        if (error) throw error;
        if (!data || data.length === 0) break;
        all = all.concat(data);
        if (data.length < pageSize) break;
        from += pageSize;
      }
      return all;
    }

    async function exportData() {
      if (!currentDefinition) { showToast('Please select a form first.', 'warning'); return; }
      try {
        const raw = await fetchAllTableData(currentDefinition.table_name);
        if (!raw || raw.length === 0) { showToast('No records to export.', 'warning'); return; }

        const normalized = raw.map(r => {
          const out = {};
          Object.keys(r).forEach(k => {
            const v = r[k];
            if (v === null || v === undefined) out[k] = '';
            else if (typeof v === 'object') out[k] = JSON.stringify(v);
            else out[k] = v;
          });
          return out;
        });

        const worksheet = XLSX.utils.json_to_sheet(normalized);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
        XLSX.writeFile(workbook, `${currentDefinition.table_name}_data.xlsx`);
        showToast('Export complete', 'success');
      } catch (err) {
        console.error('Error exporting to Excel:', err);
        showToast('Export failed. See console.', 'danger');
      }
    }

    async function exportPDF() {
      if (!currentDefinition) { showToast('Please select a form first.', 'warning'); return; }
      try {
        const raw = await fetchAllTableData(currentDefinition.table_name);
        if (!raw || raw.length === 0) { showToast('No records to export.', 'warning'); return; }

        const headerKeys = Object.keys(raw[0]);
        const body = raw.map(r => headerKeys.map(k => {
          const v = r[k];
          if (v === null || v === undefined) return '';
          if (typeof v === 'object') return JSON.stringify(v);
          return String(v);
        }));

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 12;
        const title = currentDefinition.label || currentDefinition.table_name;
        doc.setFontSize(12); doc.text(title, margin, 16);
        doc.setFontSize(9); doc.text(`Exported: ${new Date().toLocaleString()}`, pageWidth - margin, 16, { align: 'right' });

        doc.autoTable({
          startY: 20,
          head: [headerKeys],
          body,
          styles: { fontSize: 8, cellPadding: 3 },
          headStyles: { fillColor: [230,230,230], textColor: 20 },
          margin: { left: margin, right: margin, top: 20, bottom: margin },
          showHead: 'everyPage',
          pageBreak: 'auto'
        });

        doc.save(`${currentDefinition.table_name}_data.pdf`);
        showToast('PDF export complete', 'success');
      } catch (err) {
        console.error('Error exporting to PDF:', err);
        showToast('PDF export failed. See console.', 'danger');
      }
    }

    // ---------- DRAFTS ----------
    const draftKeyPrefix = 'draft::';
    function draftStorageKey(tableName) { return draftKeyPrefix + (tableName || 'unknown'); }

    function saveDraft(tableName) {
      if (!tableName) return;
      const data = {};
      \$('entryForm').querySelectorAll('input, textarea, select').forEach(i => data[i.name] = i.value);
      // only save if some meaningful value
      const meaningful = Object.values(data).some(v => v !== '' && v !== null && v !== undefined);
      if (!meaningful) return;
      localStorage.setItem(draftStorageKey(tableName), JSON.stringify({ savedAt: new Date().toISOString(), data }));
      renderDraftsList();
      showToast('Draft saved locally', 'secondary');
    }

    function loadDraft(tableName) {
      const k = draftStorageKey(tableName);
      const raw = localStorage.getItem(k);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        const d = parsed.data || {};
        \$('entryForm').querySelectorAll('input, textarea, select').forEach(i => { if (d.hasOwnProperty(i.name)) i.value = d[i.name]; });
        showToast('Draft loaded', 'secondary');
      } catch (e) { console.error('draft parse', e); }
    }

    function clearDraft() {
      if (!currentDefinition) return;
      const k = draftStorageKey(currentDefinition.table_name);
      localStorage.removeItem(k);
      renderDraftsList();
      showToast('Draft cleared', 'secondary');
    }

    function renderDraftsList() {
      const elDrafts = \$('draftsList'); elDrafts.innerHTML = '';
      const keys = Object.keys(localStorage).filter(k => k.startsWith(draftKeyPrefix));
      if (!keys.length) { elDrafts.innerHTML = '<div class="text-muted">No drafts</div>'; return; }
      keys.forEach(k => {
        try {
          const raw = JSON.parse(localStorage.getItem(k));
          const name = k.replace(draftKeyPrefix, '');
          const item = el('button', { type: 'button', class: 'list-group-item list-group-item-action' }, [ `${name} • ${raw.savedAt ? new Date(raw.savedAt).toLocaleString() : 'Saved'}` ]);
          item.addEventListener('click', () => { selectDefinition(name).then(() => loadDraft(name)).catch(()=>{}); });
          elDrafts.appendChild(item);
        } catch (e) { console.warn('bad draft', e); }
      });
    }

    // ---------- SAVE NEW ENTRY ----------
    async function saveEntry() {
      if (!currentDefinition) { showToast('कृपया कोई फॉर्म चुनें', 'warning'); return; }
      const payload = {};
      \$('entryForm').querySelectorAll('input, textarea, select').forEach(i => payload[i.name] = i.value === '' ? null : i.value);

      // add district id if the form defines district_id or we want to enforce
      if (currentUser && currentUser.districtId) payload['district_id'] = currentUser.districtId;

      saveDraft(currentDefinition.table_name);

      setLoadingOverlay(\$('dataEntryPanel'), true);
      try {
        // try to mark previous current for the same district+entry_date as non-current (best done server side via RPC/trigger)
        if (payload.entry_date) {
          await supabase.from(currentDefinition.table_name).update({ is_current: false })
            .match({ district_id: currentUser.districtId, entry_date: payload.entry_date, is_current: true });
        }

        const { data, error } = await supabase.from(currentDefinition.table_name).insert([payload]);
        if (error) throw error;

        localStorage.removeItem(draftStorageKey(currentDefinition.table_name));
        renderDraftsList();
        showToast('Record saved successfully', 'success');

        // clear form inputs after save
        \$('entryForm').querySelectorAll('input, textarea, select').forEach(i => i.value = '');
        // reload latest record if needed
        await loadLatestForDistrict(currentDefinition.table_name);
      } catch (err) {
        console.error('saveEntry error', err);
        showToast('Save failed. Check console for details.', 'danger');
      } finally {
        setLoadingOverlay(\$('dataEntryPanel'), false);
      }
    }

    // ---------- LOAD LATEST TO PREFILL (UPDATE FLOW) ----------
    async function loadLatestForDistrict(tableName) {
      if (!tableName) return;
      loadedCurrentRecord = null;
      try {
        const { data, error } = await supabase.from(tableName)
          .select('*')
          .eq('district_id', currentUser && currentUser.districtId ? currentUser.districtId : null)
          .eq('is_current', true)
          .order('created_at', { ascending: false })
          .limit(1)
          .maybeSingle();

        if (error) { console.warn('loadLatestForDistrict err', error); return; }
        if (!data) return;

        loadedCurrentRecord = data;
        const form = \$('entryForm');
        if (!form) return;
        form.querySelectorAll('input, textarea, select').forEach(i => {
          const n = i.name;
          if (loadedCurrentRecord.hasOwnProperty(n)) i.value = loadedCurrentRecord[n] == null ? '' : String(loadedCurrentRecord[n]);
        });

        const noteEl = \$('formNote');
        if (noteEl) noteEl.textContent = 'Loaded previous entry — edit and click "Update Existing" to save a new version (old entry preserved).';
      } catch (err) {
        console.error('loadLatestForDistrict error', err);
      }
    }

    // ---------- UPDATE (VERSIONED) ----------
    async function onUpdateClick(e) {
      e.preventDefault();
      if (!currentDefinition) { showToast('कृपया कोई फॉर्म चुनें', 'warning'); return; }
      if (!loadedCurrentRecord || !loadedCurrentRecord.id) { showToast('कोई मौजूदा रिकॉर्ड नहीं मिला। पहले Create/Save करें।', 'warning'); return; }

      const form = \$('entryForm');
      if (form && !form.checkValidity()) { form.reportValidity(); return; }

      const payload = {};
      form.querySelectorAll('input, textarea, select').forEach(i => payload[i.name] = i.value === '' ? null : i.value);

      // map params expected by RPC upsert_versioned_entry
      const rpcParams = {
        p_predecessor_id: loadedCurrentRecord.id,
        p_district_id: currentUser && currentUser.districtId ? currentUser.districtId : null,
        p_entry_date: payload.entry_date || null,
        p_metric_a: payload.metric_a != null ? Number(payload.metric_a) : null,
        p_metric_b: payload.metric_b != null ? Number(payload.metric_b) : null,
        p_notes: payload.notes || null,
        p_created_by: currentUser && currentUser.id ? currentUser.id : null,
        p_change_reason: payload.change_reason || 'Edited by user'
      };

      if (!rpcParams.p_district_id) { showToast('District not available for current user.', 'danger'); return; }

      \$('btnSave').disabled = true;
      \$('btnUpdate').disabled = true;
      setLoadingOverlay(\$('dataEntryPanel'), true);

      try {
        // expects RPC upsert_versioned_entry to exist in DB
        const { data, error } = await supabase.rpc('upsert_versioned_entry', rpcParams);
        if (error) throw error;

        localStorage.removeItem(draftStorageKey(currentDefinition.table_name));
        renderDraftsList();
        showToast('Update saved — previous entry preserved.', 'success');

        await loadLatestForDistrict(currentDefinition.table_name);
        if (!\$('dataViewerPanel').classList.contains('hidden')) await fetchAndRenderTableData(currentDefinition.table_name, 1);
      } catch (err) {
        console.error('onUpdateClick error', err);
        showToast('Update failed — check console.', 'danger');
      } finally {
        \$('btnSave').disabled = false;
        \$('btnUpdate').disabled = false;
        setLoadingOverlay(\$('dataEntryPanel'), false);
      }
    }

    // Prevent natural form submit
    document.addEventListener('submit', e => e.preventDefault());
  </script>
</body>
</html>
