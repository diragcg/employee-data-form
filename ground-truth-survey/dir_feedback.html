<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>फीडबैक फॉर्म - संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Inter', sans-serif;
            font-weight: 500;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        /* Form Card */
        .form-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--accent-green);
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-header p {
            opacity: 0.9;
            margin: 0;
            font-size: 0.95rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Form Styles */
        .form-section {
            background: var(--gray-50);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--accent-green);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--white);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .radio-item input[type="radio"] {
            margin: 0;
        }

        /* Submit Button */
        .submit-container {
            margin-top: 2rem;
            text-align: center;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 0.875rem 2rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            min-width: 160px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            margin-right: 1rem;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Panel */
        .admin-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .admin-header {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            color: var(--white);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .admin-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .admin-body {
            padding: 1.5rem;
        }

        .stats-card {
            background: var(--light-green);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .admin-btn {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            border: none;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition);
            margin-bottom: 0.5rem;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: none;
            font-weight: 500;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }

        .alert-success {
            background: #E8F5E8;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .admin-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand img {
                height: 32px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }

            .radio-group {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .form-section {
                padding: 1rem;
            }
            
            .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Print Styles for PDF */
        @media print {
            body {
                background: white;
                font-size: 12px;
                line-height: 1.4;
            }
            
            .header, .admin-panel, .submit-container {
                display: none !important;
            }
            
            .main-container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .card-header {
                background: white !important;
                color: black !important;
                border-bottom: 2px solid #000;
            }
            
            .form-section {
                background: white;
                border: 1px solid #ccc;
                margin-bottom: 15px;
            }
            
            .section-title {
                color: black;
                border-bottom: 1px solid #000;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार" class="cg-logo">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <div class="user-info">
                        <span id="userInfo" class="hindi"></span>
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            लॉगआउट
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="content-grid">
                <!-- Feedback Form -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="hindi">फीडबैक फॉर्म</h2>
                        <p class="hindi">कृपया अपनी फीडबैक दर्ज करें</p>
                    </div>
                    <div class="card-body">
                        <div id="alertBox" class="alert alert-danger" style="display: none;"></div>
                        
                        <form id="feedbackForm">
                            <!-- Template 1: State Specific Note & Background Note -->
                            <div class="form-section">
                                <h3 class="section-title hindi">Template 1: State Specific Note & Background Note</h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="officerName" class="form-label hindi">अधिकारी का नाम</label>
                                            <input type="text" class="form-input" id="officerName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="designation" class="form-label hindi">पद</label>
                                            <input type="text" class="form-input" id="designation" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="district" class="form-label hindi">जिला</label>
                                            <select class="form-select" id="district" required>
                                                <option value="">-- जिला चुनें --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="block" class="form-label hindi">ब्लॉक</label>
                                            <input type="text" class="form-input" id="block" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="stateSpecificNote" class="form-label hindi">State Specific Note</label>
                                    <textarea class="form-textarea" id="stateSpecificNote" rows="4" required placeholder="राज्य विशिष्ट टिप्पणी दर्ज करें..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="backgroundNote" class="form-label hindi">Background Note</label>
                                    <textarea class="form-textarea" id="backgroundNote" rows="4" required placeholder="पृष्ठभूमि टिप्पणी दर्ज करें..."></textarea>
                                </div>
                            </div>

                            <!-- Template 2: Feedback Note by Officers -->
                            <div class="form-section">
                                <h3 class="section-title hindi">Template 2: Feedback Note by Officers</h3>
                                
                                <div class="form-group">
                                    <label for="feedbackCategory" class="form-label hindi">फीडबैक श्रेणी</label>
                                    <select class="form-select" id="feedbackCategory" required>
                                        <option value="">-- श्रेणी चुनें --</option>
                                        <option value="कृषि योजना">कृषि योजना</option>
                                        <option value="फसल बीमा">फसल बीमा</option>
                                        <option value="किसान सहायता">किसान सहायता</option>
                                        <option value="तकनीकी सहायता">तकनीकी सहायता</option>
                                        <option value="अन्य">अन्य</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="priority" class="form-label hindi">प्राथमिकता</label>
                                    <div class="radio-group">
                                        <div class="radio-item">
                                            <input type="radio" id="priorityHigh" name="priority" value="उच्च" required>
                                            <label for="priorityHigh" class="hindi">उच्च</label>
                                        </div>
                                        <div class="radio-item">
                                            <input type="radio" id="priorityMedium" name="priority" value="मध्यम" required>
                                            <label for="priorityMedium" class="hindi">मध्यम</label>
                                        </div>
                                        <div class="radio-item">
                                            <input type="radio" id="priorityLow" name="priority" value="कम" required>
                                            <label for="priorityLow" class="hindi">कम</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="currentStatus" class="form-label hindi">वर्तमान स्थिति</label>
                                    <textarea class="form-textarea" id="currentStatus" rows="3" required placeholder="वर्तमान स्थिति का विवरण दें..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="issues" class="form-label hindi">समस्याएं/चुनौतियां</label>
                                    <textarea class="form-textarea" id="issues" rows="3" required placeholder="मुख्य समस्याओं का उल्लेख करें..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="suggestions" class="form-label hindi">सुझाव/सिफारिशें</label>
                                    <textarea class="form-textarea" id="suggestions" rows="3" required placeholder="सुधार के लिए सुझाव दें..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="actionRequired" class="form-label hindi">आवश्यक कार्रवाई</label>
                                    <textarea class="form-textarea" id="actionRequired" rows="3" required placeholder="किस प्रकार की कार्रवाई आवश्यक है..."></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="expectedDate" class="form-label hindi">अपेक्षित समाधान दिनांक</label>
                                            <input type="date" class="form-input" id="expectedDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="contactNumber" class="form-label hindi">संपर्क नंबर</label>
                                            <input type="tel" class="form-input" id="contactNumber" pattern="[0-9]{10}" required placeholder="10 अंकों का मोबाइल नंबर">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="submit-container">
                                <button type="submit" class="btn submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    <span class="hindi">फीडबैक सबमिट करें</span>
                                </button>
                                <button type="button" class="btn submit-btn" id="previewBtn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                                    <i class="fas fa-eye me-2"></i>
                                    <span class="hindi">प्रीव्यू देखें</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div class="admin-header">
                        <h3 class="hindi">फीडबैक प्रबंधन</h3>
                        <p class="hindi mb-0">रिपोर्ट और डाउनलोड</p>
                    </div>
                    <div class="admin-body">
                        <div class="stats-card">
                            <div class="stats-number" id="totalFeedbacks">0</div>
                            <div class="stats-label hindi">कुल फीडबैक</div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-number" id="todayFeedbacks">0</div>
                            <div class="stats-label hindi">आज के फीडबैक</div>
                        </div>

                        <div class="date-filter">
                            <label for="startDate" class="form-label hindi">प्रारंभ दिनांक</label>
                            <input type="date" class="form-input" id="startDate">
                        </div>

                        <div class="date-filter">
                            <label for="endDate" class="form-label hindi">अंत दिनांक</label>
                            <input type="date" class="form-input" id="endDate">
                        </div>

                        <button class="admin-btn" id="downloadSinglePDF">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span class="hindi">एकल PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="downloadBulkPDF">
                            <i class="fas fa-file-archive me-2"></i>
                            <span class="hindi">बल्क PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="viewAllFeedbacks">
                            <i class="fas fa-list me-2"></i>
                            <span class="hindi">सभी फीडबैक देखें</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Feedback List Modal -->
    <div class="modal fade" id="feedbackListModal" tabindex="-1" aria-labelledby="feedbackListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="feedbackListModalLabel">फीडबैक सूची</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="hindi">दिनांक</th>
                                    <th class="hindi">अधिकारी</th>
                                    <th class="hindi">जिला</th>
                                    <th class="hindi">श्रेणी</th>
                                    <th class="hindi">प्राथमिकता</th>
                                    <th class="hindi">कार्रवाई</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Supabase configuration (same as login.html)
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    console.log('✓ Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('✗ Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('✗ Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'alertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = document.getElementById(elementId);
            if (!alertBox) {
                console.error('Alert box not found:', elementId);
                return;
            }
            
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} hindi`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('क्या आप लॉगआउट करना चाहते हैं?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Load Districts
        async function loadDistricts() {
            try {
                const districtSelect = document.getElementById('district');
                
                const { data, error } = await supabaseClient
                    .from('districts')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (error) throw error;
                
                // Clear existing options except the first one
                while (districtSelect.options.length > 1) {
                    districtSelect.remove(1);
                }
                
                // Add districts to dropdown
                if (data) {
                    data.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                showAlert('जिला लोड करने में त्रुटि।', 'danger');
            }
        }

        // Initialize Page
        async function initializePage() {
            console.log('🚀 Initializing feedback form page...');
            
            try {
                // Initialize Supabase first
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                // Get stored user
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                console.log('📦 Stored user data:', storedUser ? 'Found' : 'Not found');
                
                if (!storedUser) {
                    showAlert('सत्र समाप्त हो गया है। कृपया पुनः लॉगिन करें।', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                // Parse user data
                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('👤 Current user:', currentUser);
                
                // Update UI with user info
                const userInfo = `${currentUser.fullName || currentUser.username} (${currentUser.districtName || 'N/A'})`;
                document.getElementById('userInfo').textContent = userInfo;
                console.log('✓ User info updated');
                
                // Show admin panel if user is admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    console.log('✓ Admin panel enabled');
                    await loadFeedbackStats();
                }
                
                // Hide loading and show content
                hideLoading();
                
                // Load districts
                await loadDistricts();
                
                // Set default district if user has one
                if (currentUser.districtId) {
                    document.getElementById('district').value = currentUser.districtId;
                }
                
                // Set today's date as default for expected date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expectedDate').value = today;
                
            } catch (error) {
                console.error('✗ Error initializing page:', error);
                hideLoading();
                showAlert('पृष्ठ लोड करने में त्रुटि। कृपया पुनः लॉगिन करें।', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // Load Feedback Statistics
        async function loadFeedbackStats() {
            try {
                // Get total feedbacks
                const { data: totalData, error: totalError, count: totalCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Get today's feedbacks
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData, error: todayError, count: todayCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' })
                    .gte('created_at', today + 'T00:00:00.000Z')
                    .lt('created_at', today + 'T23:59:59.999Z');

                if (todayError) throw todayError;

                document.getElementById('totalFeedbacks').textContent = totalCount || 0;
                document.getElementById('todayFeedbacks').textContent = todayCount || 0;

            } catch (error) {
                console.error('Error loading feedback stats:', error);
                document.getElementById('totalFeedbacks').textContent = '0';
                document.getElementById('todayFeedbacks').textContent = '0';
            }
        }

        // Submit Feedback Form
        async function submitFeedback(formData) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .insert([{
                        user_id: currentUser.id,
                        officer_name: formData.officerName,
                        designation: formData.designation,
                        district_id: formData.district,
                        block: formData.block,
                        state_specific_note: formData.stateSpecificNote,
                        background_note: formData.backgroundNote,
                        feedback_category: formData.feedbackCategory,
                        priority: formData.priority,
                        current_status: formData.currentStatus,
                        issues: formData.issues,
                        suggestions: formData.suggestions,
                        action_required: formData.actionRequired,
                        expected_date: formData.expectedDate,
                        contact_number: formData.contactNumber,
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('✅ Feedback submitted successfully:', data);
                showAlert('फीडबैक सफलतापूर्वक सबमिट किया गया!', 'success');
                
                // Reset form
                document.getElementById('feedbackForm').reset();
                
                // Set defaults again
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expectedDate').value = today;
                if (currentUser.districtId) {
                    document.getElementById('district').value = currentUser.districtId;
                }
                
                // Reload stats if admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    await loadFeedbackStats();
                }

                return data[0];

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                throw error;
            }
        }

        // Generate PDF from feedback data
        async function generatePDF(feedbackData, isPreview = false) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF margins and settings
                const margin = 20;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Helper function to add text with proper line breaks
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 12;
                    const maxWidth = options.maxWidth || contentWidth;
                    const lineHeight = options.lineHeight || fontSize * 0.4;
                    
                    pdf.setFontSize(fontSize);
                    if (options.bold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    lines.forEach((line, index) => {
                        pdf.text(line, x, y + (index * lineHeight));
                    });
                    
                    return y + (lines.length * lineHeight) + 5;
                }

                // Header
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('संचालनालय कृषि छत्तीसगढ़', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 10;
                
                pdf.setFontSize(14);
                pdf.text('फीडबैक फॉर्म', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Date and time
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                const currentDate = new Date().toLocaleString('hi-IN');
                pdf.text(`दिनांक: ${currentDate}`, margin, yPosition);
                yPosition += 15;

                // Template 1: State Specific Note & Background Note
                yPosition = addText('Template 1: State Specific Note & Background Note', margin, yPosition, { fontSize: 14, bold: true });
                
                // Draw border around Template 1
                const template1StartY = yPosition;
                
                yPosition = addText(`अधिकारी का नाम: ${feedbackData.officerName}`, margin + 5, yPosition);
                yPosition = addText(`पद: ${feedbackData.designation}`, margin + 5, yPosition);
                yPosition = addText(`जिला: ${feedbackData.districtName || 'N/A'}`, margin + 5, yPosition);
                yPosition = addText(`ब्लॉक: ${feedbackData.block}`, margin + 5, yPosition);
                yPosition += 5;
                
                yPosition = addText('State Specific Note:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.stateSpecificNote, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                yPosition += 5;
                
                yPosition = addText('Background Note:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.backgroundNote, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                
                // Draw border for Template 1
                pdf.rect(margin, template1StartY - 5, contentWidth, yPosition - template1StartY + 5);
                yPosition += 10;

                // Template 2: Feedback Note by Officers
                yPosition = addText('Template 2: Feedback Note by Officers', margin, yPosition, { fontSize: 14, bold: true });
                
                // Draw border around Template 2
                const template2StartY = yPosition;
                
                yPosition = addText(`फीडबैक श्रेणी: ${feedbackData.feedbackCategory}`, margin + 5, yPosition);
                yPosition = addText(`प्राथमिकता: ${feedbackData.priority}`, margin + 5, yPosition);
                yPosition += 5;
                
                yPosition = addText('वर्तमान स्थिति:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.currentStatus, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                yPosition += 5;
                
                yPosition = addText('समस्याएं/चुनौतियां:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.issues, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                yPosition += 5;
                
                yPosition = addText('सुझाव/सिफारिशें:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.suggestions, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                yPosition += 5;
                
                yPosition = addText('आवश्यक कार्रवाई:', margin + 5, yPosition, { bold: true });
                yPosition = addText(feedbackData.actionRequired, margin + 5, yPosition, { maxWidth: contentWidth - 10 });
                yPosition += 5;
                
                yPosition = addText(`अपेक्षित समाधान दिनांक: ${feedbackData.expectedDate}`, margin + 5, yPosition);
                yPosition = addText(`संपर्क नंबर: ${feedbackData.contactNumber}`, margin + 5, yPosition);
                
                // Draw border for Template 2
                pdf.rect(margin, template2StartY - 5, contentWidth, yPosition - template2StartY + 5);

                // Footer
                yPosition = pageHeight - 30;
                pdf.setFontSize(8);
                pdf.text('यह एक कंप्यूटर जनरेटेड दस्तावेज है।', pageWidth / 2, yPosition, { align: 'center' });

                if (isPreview) {
                    // Open in new tab for preview
                    const pdfBlob = pdf.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    window.open(url, '_blank');
                } else {
                    // Download PDF
                    const fileName = `feedback_${feedbackData.officerName}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                }

                return pdf;

            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        // Get Feedbacks by Date Range
        async function getFeedbacksByDateRange(startDate, endDate) {
            try {
                let query = supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        districts(name)
                    `)
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00.000Z');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59.999Z');
                }

                const { data, error } = await query;

                if (error) throw error;

                return data || [];

            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                throw error;
            }
        }

        // Generate Bulk PDF
        async function generateBulkPDF(feedbacks) {
            try {
                const JSZip = window.JSZip ? window.JSZip : await import('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                const zip = new JSZip();

                for (let i = 0; i < feedbacks.length; i++) {
                    const feedback = feedbacks[i];
                    const feedbackData = {
                        ...feedback,
                        districtName: feedback.districts?.name || 'N/A'
                    };

                    // Generate PDF for each feedback
                    const pdf = await generatePDF(feedbackData, false);
                    const pdfBlob = pdf.output('blob');
                    
                    const fileName = `feedback_${feedback.officer_name}_${feedback.created_at.split('T')[0]}.pdf`;
                    zip.file(fileName, pdfBlob);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip file
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedbacks_bulk_\${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error generating bulk PDF:', error);
                throw error;
            }
        }

        // Display Feedbacks in Modal
        async function displayFeedbacksInModal(feedbacks) {
            const tableBody = document.getElementById('feedbackTableBody');
            tableBody.innerHTML = '';

            if (feedbacks.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted hindi">कोई फीडबैक नहीं मिला</td>
                    </tr>
                `;
                return;
            }

            feedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                const createdDate = new Date(feedback.created_at).toLocaleDateString('hi-IN');
                
                row.innerHTML = `
                    <td>\${createdDate}</td>
                    <td>\${feedback.officer_name}</td>
                    <td>\${feedback.districts?.name || 'N/A'}</td>
                    <td>\${feedback.feedback_category}</td>
                    <td>
                        <span class="badge \${
                            feedback.priority === 'उच्च' ? 'bg-danger' : 
                            feedback.priority === 'मध्यम' ? 'bg-warning' : 'bg-success'
                        }">\${feedback.priority}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleFeedbackPDF('\${feedback.id}')">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Download Single Feedback PDF
        async function downloadSingleFeedbackPDF(feedbackId) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        districts(name)
                    `)
                    .eq('id', feedbackId)
                    .single();

                if (error) throw error;

                const feedbackData = {
                    ...data,
                    districtName: data.districts?.name || 'N/A'
                };

                await generatePDF(feedbackData, false);

            } catch (error) {
                console.error('Error downloading single feedback PDF:', error);
                showAlert('PDF डाउनलोड करने में त्रुटि।', 'danger');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM Content Loaded');
            initializePage();
        });

        // Logout button
        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        // Feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('📝 Feedback form submitted');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> सबमिट हो रहा है...';
                
                // Collect form data
                const formData = {
                    officerName: document.getElementById('officerName').value.trim(),
                    designation: document.getElementById('designation').value.trim(),
                    district: document.getElementById('district').value,
                    block: document.getElementById('block').value.trim(),
                    stateSpecificNote: document.getElementById('stateSpecificNote').value.trim(),
                    backgroundNote: document.getElementById('backgroundNote').value.trim(),
                    feedbackCategory: document.getElementById('feedbackCategory').value,
                    priority: document.querySelector('input[name="priority"]:checked')?.value,
                    currentStatus: document.getElementById('currentStatus').value.trim(),
                    issues: document.getElementById('issues').value.trim(),
                    suggestions: document.getElementById('suggestions').value.trim(),
                    actionRequired: document.getElementById('actionRequired').value.trim(),
                    expectedDate: document.getElementById('expectedDate').value,
                    contactNumber: document.getElementById('contactNumber').value.trim()
                };

                // Validate required fields
                const requiredFields = [
                    'officerName', 'designation', 'district', 'block', 
                    'stateSpecificNote', 'backgroundNote', 'feedbackCategory', 
                    'priority', 'currentStatus', 'issues', 'suggestions', 
                    'actionRequired', 'expectedDate', 'contactNumber'
                ];

                for (const field of requiredFields) {
                    if (!formData[field]) {
                        throw new Error(`कृपया सभी आवश्यक फील्ड भरें।`);
                    }
                }

                // Submit feedback
                await submitFeedback(formData);

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                const errorMessage = error.message || 'फीडबैक सबमिट करने में त्रुटि।';
                showAlert(errorMessage, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Preview button
        document.getElementById('previewBtn').addEventListener('click', async function() {
            try {
                // Collect form data for preview
                const formData = {
                    officerName: document.getElementById('officerName').value.trim() || 'N/A',
                    designation: document.getElementById('designation').value.trim() || 'N/A',
                    district: document.getElementById('district').value,
                    districtName: document.getElementById('district').selectedOptions[0]?.text || 'N/A',
                    block: document.getElementById('block').value.trim() || 'N/A',
                    stateSpecificNote: document.getElementById('stateSpecificNote').value.trim() || 'N/A',
                    backgroundNote: document.getElementById('backgroundNote').value.trim() || 'N/A',
                    feedbackCategory: document.getElementById('feedbackCategory').value || 'N/A',
                    priority: document.querySelector('input[name="priority"]:checked')?.value || 'N/A',
                    currentStatus: document.getElementById('currentStatus').value.trim() || 'N/A',
                    issues: document.getElementById('issues').value.trim() || 'N/A',
                    suggestions: document.getElementById('suggestions').value.trim() || 'N/A',
                    actionRequired: document.getElementById('actionRequired').value.trim() || 'N/A',
                    expectedDate: document.getElementById('expectedDate').value || 'N/A',
                    contactNumber: document.getElementById('contactNumber').value.trim() || 'N/A'
                };

                await generatePDF(formData, true);

            } catch (error) {
                console.error('Error generating preview:', error);
                showAlert('प्रीव्यू जेनरेट करने में त्रुटि।', 'danger');
            }
        });

        // Admin panel event listeners
        if (document.getElementById('downloadSinglePDF')) {
            document.getElementById('downloadSinglePDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('कृपया दिनांक रेंज चुनें।', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> डाउनलोड हो रहा है...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('चुने गए दिनांक रेंज में कोई फीडबैक नहीं मिला।', 'info');
                        return;
                    }

                    // Download first feedback as sample or create combined PDF
                    const feedbackData = {
                        ...feedbacks[0],
                        districtName: feedbacks[0].districts?.name || 'N/A'
                    };

                    await generatePDF(feedbackData, false);

                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    showAlert('PDF डाउनलोड करने में त्रुटि।', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-pdf me-2"></i><span class="hindi">एकल PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('downloadBulkPDF')) {
            document.getElementById('downloadBulkPDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('कृपया दिनांक रेंज चुनें।', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> तैयार हो रहा है...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('चुने गए दिनांक रेंज में कोई फीडबैक नहीं मिला।', 'info');
                        return;
                    }

                    // Load JSZip library if not already loaded
                    if (!window.JSZip) {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                        document.head.appendChild(script);
                        
                        await new Promise(resolve => {
                            script.onload = resolve;
                        });
                    }

                    await generateBulkPDF(feedbacks);
                    showAlert(`\${feedbacks.length} फीडबैक का बल्क PDF डाउनलोड पूरा हुआ।`, 'success');

                } catch (error) {
                    console.error('Error downloading bulk PDF:', error);
                    showAlert('बल्क PDF डाउनलोड करने में त्रुटि।', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-archive me-2"></i><span class="hindi">बल्क PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('viewAllFeedbacks')) {
            document.getElementById('viewAllFeedbacks').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> लोड हो रहा है...';

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    await displayFeedbacksInModal(feedbacks);

                    const modal = new bootstrap.Modal(document.getElementById('feedbackListModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading feedbacks:', error);
                    showAlert('फीडबैक लोड करने में त्रुटि।', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-list me-2"></i><span class="hindi">सभी फीडबैक देखें</span>';
                }
            });
        }

        // Set default date range (last 30 days)
        if (document.getElementById('startDate') && document.getElementById('endDate')) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Make downloadSingleFeedbackPDF available globally
        window.downloadSingleFeedbackPDF = downloadSingleFeedbackPDF;

        // Form validation enhancements
        document.getElementById('contactNumber').addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            if (value.length !== 10) {
                e.target.setCustomValidity('कृपया 10 अंकों का मोबाइल नंबर दर्ज करें।');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // Prevent form resubmission on page refresh
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        // Handle network status
        window.addEventListener('online', () => {
            console.log('🌐 Network online');
            showAlert('इंटरनेट कनेक्शन बहाल हो गया।', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('📡 Network offline');
            showAlert('इंटरनेट कनेक्शन बाधित है। कृपया कनेक्शन जांचें।', 'danger');
        });

        // Auto-save form data to localStorage (draft functionality)
        function saveFormDraft() {
            const formData = {
                officerName: document.getElementById('officerName').value,
                designation: document.getElementById('designation').value,
                district: document.getElementById('district').value,
                block: document.getElementById('block').value,
                stateSpecificNote: document.getElementById('stateSpecificNote').value,
                backgroundNote: document.getElementById('backgroundNote').value,
                feedbackCategory: document.getElementById('feedbackCategory').value,
                priority: document.querySelector('input[name="priority"]:checked')?.value,
                currentStatus: document.getElementById('currentStatus').value,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value,
                actionRequired: document.getElementById('actionRequired').value,
                expectedDate: document.getElementById('expectedDate').value,
                contactNumber: document.getElementById('contactNumber').value
            };
            
            localStorage.setItem('feedbackDraft', JSON.stringify(formData));
        }

        // Load form draft from localStorage
        function loadFormDraft() {
            const draft = localStorage.getItem('feedbackDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    document.getElementById('officerName').value = formData.officerName || '';
                    document.getElementById('designation').value = formData.designation || '';
                    document.getElementById('district').value = formData.district || '';
                    document.getElementById('block').value = formData.block || '';
                    document.getElementById('stateSpecificNote').value = formData.stateSpecificNote || '';
                    document.getElementById('backgroundNote').value = formData.backgroundNote || '';
                    document.getElementById('feedbackCategory').value = formData.feedbackCategory || '';
                    document.getElementById('currentStatus').value = formData.currentStatus || '';
                    document.getElementById('issues').value = formData.issues || '';
                    document.getElementById('suggestions').value = formData.suggestions || '';
                    document.getElementById('actionRequired').value = formData.actionRequired || '';
                    document.getElementById('expectedDate').value = formData.expectedDate || '';
                    document.getElementById('contactNumber').value = formData.contactNumber || '';
                    
                    if (formData.priority) {
                        const priorityRadio = document.querySelector(`input[name="priority"][value="${formData.priority}"]`);
                        if (priorityRadio) priorityRadio.checked = true;
                    }
                    
                    console.log('📝 Form draft loaded');
                } catch (error) {
                    console.error('Error loading form draft:', error);
                    localStorage.removeItem('feedbackDraft');
                }
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveFormDraft, 30000);

        // Save on form input change
        document.getElementById('feedbackForm').addEventListener('input', saveFormDraft);

        // Clear draft after successful submission
        function clearFormDraft() {
            localStorage.removeItem('feedbackDraft');
            console.log('📝 Form draft cleared');
        }

        // Load draft when page loads
        setTimeout(loadFormDraft, 1000);

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('💥 Unhandled error:', e.error);
            showAlert('एक अप्रत्याशित त्रुटि हुई। कृपया पृष्ठ को रीफ्रेश करें।', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection:', e.reason);
            showAlert('डेटा लोड करने में समस्या हुई। कृपया पुनः प्रयास करें।', 'danger');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFormDraft();
                showAlert('फॉर्म ड्राफ्ट सेव किया गया।', 'info');
            }
            
            // Ctrl + Enter to submit form
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
            
            // Escape key to clear form
            if (e.key === 'Escape' && e.ctrlKey) {
                if (confirm('क्या आप फॉर्म को साफ करना चाहते हैं?')) {
                    document.getElementById('feedbackForm').reset();
                    clearFormDraft();
                    showAlert('फॉर्म साफ किया गया।', 'info');
                }
            }
        });

        // Performance monitoring
        function logPerformance() {
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                console.log(`Page load time: ${loadTime}ms`);
            }
        }

        // Log performance on load
        window.addEventListener('load', logPerformance);

        // Session timeout management
        let sessionTimeout;
        
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                if (confirm('आपका सत्र जल्द ही समाप्त हो जाएगा। क्या आप जारी रखना चाहते हैं?')) {
                    resetSessionTimeout();
                } else {
                    handleLogout();
                }
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Initialize session timeout
        resetSessionTimeout();

        // Reset timeout on user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetSessionTimeout, { passive: true });
        });

        // Character counter for textareas
        function addCharacterCounter(textareaId, maxLength = 1000) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            // Create counter element
            const counter = document.createElement('div');
            counter.className = 'character-counter';
            counter.style.cssText = 'font-size: 0.8rem; color: #666; text-align: right; margin-top: 5px;';
            
            // Insert counter after textarea
            textarea.parentNode.insertBefore(counter, textarea.nextSibling);
            
            // Update counter function
            function updateCounter() {
                const length = textarea.value.length;
                counter.textContent = `${length}/${maxLength} अक्षर`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = '#ff6b6b';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = '#ffa726';
                } else {
                    counter.style.color = '#666';
                }
            }
            
            // Initial update
            updateCounter();
            
            // Update on input
            textarea.addEventListener('input', updateCounter);
        }

        // Add character counters to textareas
        setTimeout(() => {
            addCharacterCounter('stateSpecificNote', 2000);
            addCharacterCounter('backgroundNote', 2000);
            addCharacterCounter('currentStatus', 1000);
            addCharacterCounter('issues', 1000);
            addCharacterCounter('suggestions', 1000);
            addCharacterCounter('actionRequired', 1000);
        }, 1500);

        // Form field validation messages in Hindi
        const validationMessages = {
            officerName: 'कृपया अधिकारी का नाम दर्ज करें।',
            designation: 'कृपया पद दर्ज करें।',
            district: 'कृपया जिला चुनें।',
            block: 'कृपया ब्लॉक का नाम दर्ज करें।',
            stateSpecificNote: 'कृपया State Specific Note दर्ज करें।',
            backgroundNote: 'कृपया Background Note दर्ज करें।',
            feedbackCategory: 'कृपया फीडबैक श्रेणी चुनें।',
            currentStatus: 'कृपया वर्तमान स्थिति दर्ज करें।',
            issues: 'कृपया समस्याएं दर्ज करें।',
            suggestions: 'कृपया सुझाव दर्ज करें।',
            actionRequired: 'कृपया आवश्यक कार्रवाई दर्ज करें।',
            expectedDate: 'कृपया अपेक्षित दिनांक चुनें।',
            contactNumber: 'कृपया 10 अंकों का मोबाइल नंबर दर्ज करें।'
        };

        // Set custom validation messages
        Object.keys(validationMessages).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('invalid', function() {
                    this.setCustomValidity(validationMessages[fieldId]);
                });
                
                field.addEventListener('input', function() {
                    this.setCustomValidity('');
                });
            }
        });

        // Priority radio validation
        const priorityRadios = document.querySelectorAll('input[name="priority"]');
        priorityRadios.forEach(radio => {
            radio.addEventListener('invalid', function() {
                this.setCustomValidity('कृपया प्राथमिकता चुनें।');
            });
            
            radio.addEventListener('change', function() {
                priorityRadios.forEach(r => r.setCustomValidity(''));
            });
        });

        // Debug functions for development
        window.debugFeedback = {
            getCurrentUser: () => currentUser,
            getSupabaseClient: () => supabaseClient,
            loadDraft: loadFormDraft,
            saveDraft: saveFormDraft,
            clearDraft: clearFormDraft,
            testPDF: async () => {
                const sampleData = {
                    officerName: 'टेस्ट अधिकारी',
                    designation: 'सहायक निदेशक',
                    districtName: 'रायपुर',
                    block: 'रायपुर ब्लॉक',
                    stateSpecificNote: 'यह एक टेस्ट नोट है।',
                    backgroundNote: 'यह पृष्ठभूमि टेस्ट नोट है।',
                    feedbackCategory: 'कृषि योजना',
                    priority: 'उच्च',
                    currentStatus: 'प्रगति में',
                    issues: 'कुछ समस्याएं हैं।',
                    suggestions: 'कुछ सुझाव हैं।',
                    actionRequired: 'तत्काल कार्रवाई आवश्यक।',
                    expectedDate: '2025-01-31',
                    contactNumber: '9876543210'
                };
                await generatePDF(sampleData, true);
            },
            getFormData: () => {
                return {
                    officerName: document.getElementById('officerName').value,
                    designation: document.getElementById('designation').value,
                    district: document.getElementById('district').value,
                    block: document.getElementById('block').value,
                    stateSpecificNote: document.getElementById('stateSpecificNote').value,
                    backgroundNote: document.getElementById('backgroundNote').value,
                    feedbackCategory: document.getElementById('feedbackCategory').value,
                    priority: document.querySelector('input[name="priority"]:checked')?.value,
                    currentStatus: document.getElementById('currentStatus').value,
                    issues: document.getElementById('issues').value,
                    suggestions: document.getElementById('suggestions').value,
                    actionRequired: document.getElementById('actionRequired').value,
                    expectedDate: document.getElementById('expectedDate').value,
                    contactNumber: document.getElementById('contactNumber').value
                };
            }
        };

        // Add console welcome message
        console.log(`
        ╔══════════════════════════════════════════════════════════════╗
        ║                संचालनालय कृषि छत्तीसगढ़                      ║
        ║                   Feedback Form System                       ║
        ║                                                              ║
        ║  📝 Feedback Form with PDF Generation                        ║
        ║  📊 Admin Dashboard with Statistics                          ║
        ║  📄 Single & Bulk PDF Download                               ║
        ║  💾 Auto-save Draft Functionality                            ║
        ║  🔍 Date-wise Filtering                                      ║
        ║                                                              ║
        ║  Keyboard Shortcuts:                                         ║
        ║  • Ctrl + S: Save Draft                                      ║
        ║  • Ctrl + Enter: Submit Form                                 ║
        ║  • Ctrl + Escape: Clear Form                                 ║
        ║                                                              ║
        ║  For technical support: diagri-cg@cg.gov.in                ║
        ╚══════════════════════════════════════════════════════════════╝
        `);

        // Development mode helpers
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('🔧 Development Mode Active');
            console.log('🛠️ Debug helpers available in window.debugFeedback');
            console.log('Available commands:');
            console.log('- debugFeedback.getCurrentUser()');
            console.log('- debugFeedback.getSupabaseClient()');
            console.log('- debugFeedback.testPDF()');
            console.log('- debugFeedback.getFormData()');
            console.log('- debugFeedback.loadDraft()');
            console.log('- debugFeedback.saveDraft()');
            console.log('- debugFeedback.clearDraft()');
        }

        console.log('🎉 Feedback form script loaded successfully');
    </script>
</body>
</html>


