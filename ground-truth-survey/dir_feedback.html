<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Form - संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --light-orange: #FFF3E0;
            --sky-blue: #87CEEB;
            --highlight-blue: #007BFF;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Poppins', sans-serif;
            font-weight: 500;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            background-color: yellow; /* User info background */
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
        }

        .logout-btn {
            background-color: black !important; /* Black background */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            font-family: 'Poppins', sans-serif;
        }

        .logout-btn:hover {
            background-color: #333333 !important;
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 120px);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        /* Form Card */
        .form-card {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .form-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-family: 'Poppins', sans-serif;
        }

        .form-body {
            padding: 2rem;
        }

        /* Template Sections */
        .template-section {
            margin-bottom: 3rem;
            border: 2px solid #000;
            background: var(--white);
        }

        .template-header {
            background: #f8f9fa;
            border-bottom: 2px solid #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            font-family: 'Poppins', sans-serif;
        }

        .template-content {
            padding: 20px;
        }

        /* Form Fields with Light Orange Background */
        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
            display: block;
            color: #000;
            font-family: 'Poppins', sans-serif;
        }

        .field-description {
            font-style: italic;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #000;
            background: var(--light-orange) !important; /* Light orange background */
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            text-transform: none; /* Remove title case - use sentence case */
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            text-align: justify; /* Justified text */
            line-height: 1.5;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Two Column Layout for Template 1 */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Officer Details Section */
        .officer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            /* Hide these fields from main form as they are in popup now */
            display: none; 
        }

        /* Submit Button */
        .submit-container {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            border-top: 2px solid var(--border-light);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 1rem 2.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 200px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            margin: 0 10px;
            font-family: 'Poppins', sans-serif;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Panel with Sky Blue Background */
        .admin-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .admin-header {
            background-color: var(--sky-blue); /* Sky blue background */
            color: var(--text-primary);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .admin-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-body {
            padding: 1.5rem;
        }

        .stats-card {
            background: var(--light-green);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            cursor: pointer; /* Make clickable */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
            font-family: 'Poppins', sans-serif;
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-btn {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            border: none;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition);
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .form-input-admin {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--white);
            font-family: 'Poppins', sans-serif;
        }

        .form-input-admin:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-label-admin {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: none;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }

        .alert-success {
            background: #E8F5E8;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }

        .alert-warning {
            background: #FFF3CD;
            color: #856404;
            border-left: 4px solid #FFC107;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Character Counter */
        .character-counter {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-top: 5px;
            font-family: 'Poppins', sans-serif;
        }

        /* Footer Styles */
        .footer {
            background: var(--gray-100);
            border-top: 1px solid var(--border-light);
            padding: 1.5rem 0;
            text-align: center;
            margin-top: 2rem;
            font-family: 'Poppins', sans-serif;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .footer-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .footer-datetime {
            color: var(--highlight-blue);
            font-weight: 600;
            background: rgba(0, 123, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            display: inline-block;
            font-size: 0.9rem;
        }

        /* Auto-resize textareas */
        .form-textarea {
            overflow: hidden;
        }

        /* Submit Success Overlay */
        .submit-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
            font-size: 1.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .submit-success-overlay .spinner-grow {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }

        /* Print Styles for PDF Generation */
        @media print {
            body {
                background: white !important;
                font-family: 'Times New Roman', serif; /* PDF specific font */
                font-size: 12px;
                line-height: 1.4;
            }
            
            .header, .admin-panel, .submit-container, .footer, .submit-success-overlay, .modal-backdrop {
                display: none !important;
            }
            
            .main-container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card {
                box-shadow: none;
                border: 2px solid #000;
            }
            
            .template-section {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            /* White background for PDF */
            .form-input, .form-textarea, .form-select {
                background: white !important;
            }
            
            .two-column {
                display: block;
            }
            
            .two-column .field-group {
                margin-bottom: 15px;
            }

            /* Hide the modal from print */
            .modal {
                display: none !important;
            }
            .modal-dialog {
                display: none !important;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .admin-panel {
                position: static;
            }
            
            .two-column {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .form-body {
                padding: 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand img {
                height: 32px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }

            .officer-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार" class="cg-logo">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <div class="user-info" id="userInfoContainer">
                        <span id="userInfo" class="hindi"></span>
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            लॉगआउट
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="content-grid">
                <!-- Feedback Form -->
                <div class="form-card">
                    <div class="form-header">
                        <div class="form-title">National Summit Feedback Form</div>
                        <div class="form-subtitle">Template 1 & Template 2</div>
                    </div>
                    
                    <div class="form-body">
                        <div id="alertBox" class="alert alert-danger" style="display: none;"></div>
                        
                        <form id="feedbackForm">
                            <!-- Template 1: State Specific Note & Background Note -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 1: State Specific Note & Background Note
                                </div>
                                <div class="template-content">
                                    <div class="two-column">
                                        <!-- Left Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">I. Introduction</label>
                                                <div class="field-description">(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)</div>
                                                <textarea class="form-textarea" id="introduction" rows="4" required placeholder="Enter introduction details..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">II. Current Situation</label>
                                                <div class="field-description">(Current policy landscape, programmes, schemes and their progress)</div>
                                                <textarea class="form-textarea" id="currentSituation" rows="4" required placeholder="Describe current situation..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">III. Challenges</label>
                                                <div class="field-description">(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)</div>
                                                <textarea class="form-textarea" id="challenges" rows="4" required placeholder="List major challenges..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">IV. Possible Solutions</label>
                                                <div class="field-description">(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)</div>
                                                <textarea class="form-textarea" id="possibleSolutions" rows="4" required placeholder="Suggest possible solutions..."></textarea>
                                            </div>
                                        </div>

                                        <!-- Right Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">V. Best Practices</label>
                                                <div class="field-description">(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)</div>
                                                <textarea class="form-textarea" id="bestPractices" rows="4" required placeholder="Describe best practices..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VI. Priority Areas</label>
                                                <div class="field-description">(Selected for implementation by the States in the next 5 years)</div>
                                                <textarea class="form-textarea" id="priorityAreas" rows="4" required placeholder="Define priority areas..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VII. Way Forward - Strategy for Implementation</label>
                                                <div class="field-description">(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)</div>
                                                <textarea class="form-textarea" id="wayForwardStrategy" rows="4" required placeholder="Outline implementation strategy..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template 2: Feedback Note by Officers -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 2: Feedback Note by Officers
                                </div>
                                <div class="template-content">
                                    <!-- Section 1: Officer Name and Details - These fields are now handled by the popup modal -->
                                    <div class="field-group">
                                        <label class="field-label">Feedback Note (by all IAS officers / State Department Officers)</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Section 1: Officer Name and Details:</label>
                                        <div class="officer-details">
                                            <!-- These fields are intentionally empty as they are managed via the popup -->
                                        </div>
                                    </div>

                                    <!-- Section 2: Feedback for Summit -->
                                    <div class="field-group">
                                        <label class="field-label">Section 2: Feedback for Summit on &lt;Theme name&gt;</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">1. Name of the sub theme</label>
                                        <div class="field-description">(Choose from the sub theme of the summit)</div>
                                        <textarea class="form-textarea" id="subThemeName" rows="3" required placeholder="Enter sub theme name..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">2. Policy Gaps and Challenges</label>
                                        <div class="field-description">(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)</div>
                                        <textarea class="form-textarea" id="policyGapsChallenges" rows="4" required placeholder="Describe policy gaps and challenges..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">3. Potential Solutions</label>
                                        <div class="field-description">(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)</div>
                                        <textarea class="form-textarea" id="potentialSolutions" rows="4" required placeholder="Suggest potential solutions..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">4. Best Practices</label>
                                        <div class="field-description">(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)</div>
                                        <textarea class="form-textarea" id="feedbackBestPractices" rows="4" required placeholder="Describe best practices..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="submit-container">
                                <button type="submit" class="btn submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Submit Feedback
                                </button>
                                <button type="button" class="btn submit-btn" id="previewBtn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                                    <i class="fas fa-eye me-2"></i>
                                    Preview PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div class="admin-header">
                        <h3 class="hindi">फीडबैक प्रबंधन</h3>
                        <p class="hindi mb-0">रिपोर्ट और डाउनलोड</p>
                    </div>
                    <div class="admin-body">
                        <div class="stats-card" id="totalFeedbacksCard">
                            <div class="stats-number" id="totalFeedbacks">0</div>
                            <div class="stats-label hindi">कुल फीडबैक</div>
                        </div>

                        <div class="stats-card" id="todayFeedbacksCard">
                            <div class="stats-number" id="todayFeedbacks">0</div>
                            <div class="stats-label hindi">आज के फीडबैक</div>
                        </div>

                        <div class="date-filter">
                            <label for="startDate" class="form-label-admin hindi">प्रारंभ दिनांक</label>
                            <input type="date" class="form-input-admin" id="startDate">
                        </div>

                        <div class="date-filter">
                            <label for="endDate" class="form-label-admin hindi">अंत दिनांक</label>
                            <input type="date" class="form-input-admin" id="endDate">
                        </div>

                        <button class="admin-btn" id="downloadSinglePDF">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span class="hindi">एकल PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="downloadBulkPDF">
                            <i class="fas fa-file-archive me-2"></i>
                            <span class="hindi">बल्क PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="viewAllFeedbacks">
                            <i class="fas fa-list me-2"></i>
                            <span class="hindi">सभी फीडबैक देखें</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text hindi">
                2025 संचालनालय कृषि छत्तीसगढ़ | सर्वाधिकार सुरक्षित
            </div>
            <div class="footer-datetime" id="footerDateTime">
                <!-- Date and time will be inserted here -->
            </div>
        </div>
    </footer>

    <!-- Feedback List Modal -->
    <div class="modal fade" id="feedbackListModal" tabindex="-1" aria-labelledby="feedbackListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="feedbackListModalLabel">फीडबैक सूची</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Officer Name</th>
                                    <th>Designation</th>
                                    <th>Batch</th>
                                    <th>Current Posting</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Officer Profile Selection/Creation Modal -->
    <div class="modal fade" id="officerProfileModal" tabindex="-1" aria-labelledby="officerProfileModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title" id="officerProfileModalLabel" style="font-family: 'Poppins', sans-serif;">ऑफिसर प्रोफाइल चुनें/बनाएं</h5>
                    <!-- No close button, as it's a required step -->
                </div>
                <div class="modal-body">
                    <div id="officerProfileAlert" class="alert alert-danger" style="display: none; font-family: 'Poppins', sans-serif;"></div>

                    <div class="mb-3">
                        <label for="selectOfficerProfile" class="form-label" style="font-family: 'Poppins', sans-serif; font-weight: bold;">मौजूदा प्रोफाइल चुनें:</label>
                        <select class="form-select form-input" id="selectOfficerProfile">
                            <option value="">-- प्रोफाइल चुनें --</option>
                        </select>
                    </div>

                    <div class="text-center my-3" style="font-family: 'Poppins', sans-serif;">या</div>

                    <div class="mb-3">
                        <label for="newOfficerName" class="form-label" style="font-family: 'Poppins', sans-serif; font-weight: bold;">नया प्रोफाइल बनाएं:</label>
                        <input type="text" class="form-control form-input" id="newOfficerName" placeholder="नाम" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control form-input" id="newOfficerDesignation" placeholder="पद" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control form-input" id="newOfficerBatch" placeholder="बैच" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control form-input" id="newOfficerPosting" placeholder="वर्तमान पोस्टिंग" required>
                    </div>
                    <div class="mb-3">
                        <select class="form-select form-input" id="newOfficerDistrict" required>
                            <option value="">-- जिला चुनें --</option>
                            <!-- Districts will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="tel" class="form-control form-input" id="newOfficerMobile" pattern="[0-9]{10}" placeholder="मोबाइल नंबर (10 अंक)" required>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" id="cancelOfficerProfile" style="font-family: 'Poppins', sans-serif;">रद्द करें</button>
                    <button type="button" class="btn btn-primary" id="confirmOfficerProfile" style="font-family: 'Poppins', sans-serif;">प्रो फाइल पुष्टि करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Success Overlay -->
    <div class="submit-success-overlay" id="submitSuccessOverlay" style="display: none;">
        <div class="spinner-grow text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="hindi">फीडबैक सफलतापूर्वक सबमिट किया गया!</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // Supabase configuration (same as login.html)
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null; // This holds data from your custom 'test_users' table
        let authUserId = null; // This will hold the actual auth.uid()

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    console.log('✓ Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('✗ Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('✗ Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Update Footer Date and Time
        function updateFooterDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const dateTimeString = now.toLocaleString('en-US', options);
            document.getElementById('footerDateTime').textContent = dateTimeString;
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'alertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = document.getElementById(elementId);
            if (!alertBox) {
                console.error('Alert box not found:', elementId);
                return;
            }
            
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Load Districts for dropdowns
        async function loadDistricts(selectElementId) {
            try {
                const districtSelect = document.getElementById(selectElementId);
                
                const { data, error } = await supabaseClient
                    .from('districts')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (error) throw error;
                
                // Clear existing options except the first one
                while (districtSelect.options.length > 1) {
                    districtSelect.remove(1);
                }
                
                // Add districts to dropdown
                if (data) {
                    data.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                showAlert('Error loading districts for officer profile.', 'danger', 'officerProfileAlert');
            }
        }

        // Load Officer Profiles for the current user
        async function loadOfficerProfiles() {
            try {
                const selectOfficerProfile = document.getElementById('selectOfficerProfile');
                // Clear existing options except the first one
                while (selectOfficerProfile.options.length > 1) {
                    selectOfficerProfile.remove(1);
                }

                // Ensure authUserId is available before querying for profiles
                if (!authUserId) {
                    console.warn('authUserId not available for loading officer profiles.');
                    selectOfficerProfile.disabled = true;
                    selectOfficerProfile.textContent = "लॉगिन करें प्रोफाइल के लिए।";
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('officer_profiles')
                    .select('id, name, designation, batch, current_posting, mobile_number, districts(name)')
                    .eq('user_id', authUserId) // Use authUserId here
                    .order('name', { ascending: true });

                if (error) throw error;

                if (data && data.length > 0) {
                    data.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = `${profile.name} (${profile.designation}, ${profile.districts?.name || 'N/A'})`;
                        selectOfficerProfile.appendChild(option);
                    });
                    selectOfficerProfile.disabled = false; // Enable if profiles exist
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "कोई प्रोफाइल नहीं मिला। नया बनाएं।";
                    selectOfficerProfile.appendChild(option);
                    selectOfficerProfile.disabled = true; // Disable if no profiles exist
                }
            } catch (error) {
                console.error('Error loading officer profiles:', error);
                showAlert('Error loading officer profiles.', 'danger', 'officerProfileAlert');
            }
        }

        // Initialize Page
        async function initializePage() {
            console.log('🚀 Initializing feedback form page...');
            
            try {
                // Initialize Supabase first
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                // Get stored user from custom 'user' storage (test_users table)
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                console.log('📦 Stored user data (from test_users):', storedUser ? 'Found' : 'Not found');
                
                if (!storedUser) {
                    showAlert('Session expired. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                // Parse custom user data
                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('👤 Current user (from test_users):', currentUser);

                // IMPORTANT: Get the actual authenticated user ID from Supabase Auth
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    showAlert('Authentication session expired or invalid. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }
                authUserId = user.id; // Store the actual auth.uid()
                console.log('🔑 Authenticated User ID (auth.uid()):', authUserId);
                
                // Update UI with user info (using custom user data)
                const userInfoSpan = document.getElementById('userInfo');
                if (userInfoSpan) {
                    userInfoSpan.textContent = `${currentUser.fullName || currentUser.username} (${currentUser.districtName || 'N/A'})`;
                }
                
                console.log('✓ User info updated');
                
                // Show admin panel if user is admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    console.log('✓ Admin panel enabled');
                    await loadFeedbackStats();
                }
                
                // Update footer date time
                updateFooterDateTime();
                setInterval(updateFooterDateTime, 1000); // Update every second
                
                // Hide loading and show content
                hideLoading();

                // Load districts for the new officer profile modal
                await loadDistricts('newOfficerDistrict');
                // Load existing officer profiles (will now use authUserId)
                await loadOfficerProfiles();
                
            } catch (error) {
                console.error('✗ Error initializing page:', error);
                hideLoading();
                showAlert('Error loading page. Please login again.', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // Load Feedback Statistics
        async function loadFeedbackStats() {
            try {
                // Get total feedbacks
                const { data: totalData, error: totalError, count: totalCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Get today's feedbacks
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData, error: todayError, count: todayCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' })
                    .gte('created_at', today + 'T00:00:00.000Z')
                    .lt('created_at', today + 'T23:59:59.999Z');

                if (todayError) throw todayError;

                document.getElementById('totalFeedbacks').textContent = totalCount || 0;
                document.getElementById('todayFeedbacks').textContent = todayCount || 0;

            } catch (error) {
                console.error('Error loading feedback stats:', error);
                document.getElementById('totalFeedbacks').textContent = '0';
                document.getElementById('todayFeedbacks').textContent = '0';
            }
        }

        // Show Submit Success Animation
        function showSubmitSuccess() {
            const overlay = document.getElementById('submitSuccessOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000); // Hide after 2 seconds
        }

        // Actual submission of the feedback form after officer profile is confirmed
        async function proceedWithFeedbackSubmission(officerProfileId) {
            try {
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Submitting...';

                // Construct formData with fields that belong to the 'feedbacks' table
                const formData = {
                    user_id: authUserId, // Use authUserId here for consistency with RLS
                    // Template 1 fields (belong to feedbacks table)
                    introduction: document.getElementById('introduction').value.trim(),
                    current_situation: document.getElementById('currentSituation').value.trim(),
                    challenges: document.getElementById('challenges').value.trim(),
                    possible_solutions: document.getElementById('possibleSolutions').value.trim(),
                    best_practices: document.getElementById('bestPractices').value.trim(),
                    priority_areas: document.getElementById('priorityAreas').value.trim(),
                    way_forward_strategy: document.getElementById('wayForwardStrategy').value.trim(),
                    // Link to officer profile (this is the only officer-related field in feedbacks table)
                    officer_profile_id: officerProfileId,
                    // Template 2 fields (These are now directly from the main form, but not part of the officer_profile table itself)
                    sub_theme_name: document.getElementById('subThemeName').value.trim(),
                    policy_gaps_challenges: document.getElementById('policyGapsChallenges').value.trim(),
                    potential_solutions: document.getElementById('potentialSolutions').value.trim(),
                    feedback_best_practices: document.getElementById('feedbackBestPractices').value.trim(),
                    created_at: new Date().toISOString()
                };

                // Validate required fields from the main feedback form
                const requiredFields = [
                    'introduction', 'current_situation', 'challenges', 'possible_solutions',
                    'best_practices', 'priority_areas', 'way_forward_strategy',
                    'sub_theme_name', 'policy_gaps_challenges', 'potential_solutions', 'feedback_best_practices'
                ];

                for (const field of requiredFields) {
                    if (!formData[field]) {
                        throw new Error(`Please fill all required fields in the feedback form (e.g., ${field}).`);
                    }
                }

                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .insert([formData])
                    .select();

                if (error) throw error;

                console.log('✅ Feedback submitted successfully:', data);
                showSubmitSuccess(); // Show success animation
                
                // Reset main form
                document.getElementById('feedbackForm').reset();
                
                // Clear draft after successful submission
                clearFormDraft();
                
                // Reload stats if admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    await loadFeedbackStats();
                }

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                const errorMessage = error.message || 'Error submitting feedback.';
                showAlert(errorMessage, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Generate PDF with EXACT Layout Matching Your Document - FIXED MARGINS AND ALIGNMENT
        async function generatePDF(feedbackData, isPreview = false) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Fetch officer profile details
                let officerProfile = feedbackData.officer_profile_data_for_preview; // Use preview data if available
                if (!officerProfile && feedbackData.officer_profile_id) {
                    const { data, error } = await supabaseClient
                        .from('officer_profiles')
                        .select('name, designation, batch, current_posting, mobile_number, districts(name)')
                        .eq('id', feedbackData.officer_profile_id)
                        .single();
                    if (error) console.error('Error fetching officer profile for PDF:', error);
                    officerProfile = data || {};
                } else if (!officerProfile) {
                     officerProfile = { name: 'N/A', designation: 'N/A', batch: 'N/A', current_posting: 'N/A', mobile_number: 'N/A', districts: {name: 'N/A'} };
                }


                // REDUCED PDF margins for better space utilization
                const margin = 12; // Reduced from 20 to 12
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Set default font to Times New Roman
                pdf.setFont('times'); // Set font family
                pdf.setFontSize(10); // Default font size for most text

                // Helper function to add text with proper formatting and justification
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 9; // Default smaller font for body text
                    const maxWidth = options.maxWidth || contentWidth;
                    const lineHeight = options.lineHeight || fontSize * 0.4; // Adjusted for Times New Roman readability
                    
                    pdf.setFontSize(fontSize);
                    if (options.font === 'times' && options.fontStyle === 'bold') pdf.setFont('times', 'bold');
                    else if (options.font === 'times' && options.fontStyle === 'italic') pdf.setFont('times', 'italic');
                    else if (options.font === 'times') pdf.setFont('times', 'normal');
                    else if (options.font === 'helvetica' && options.fontStyle === 'bold') pdf.setFont('helvetica', 'bold');
                    else if (options.font === 'helvetica' && options.fontStyle === 'italic') pdf.setFont('helvetica', 'italic');
                    else pdf.setFont('helvetica', 'normal'); // Fallback to Helvetica if no specific font/style

                    if (options.align) {
                        pdf.text(text, x, y, { align: options.align, maxWidth: maxWidth });
                        return y + lineHeight + 2;
                    } else {
                        const lines = pdf.splitTextToSize(text, maxWidth);
                        lines.forEach((line, index) => {
                            pdf.text(line, x, y + (index * lineHeight), { align: options.justify ? 'justify' : 'left' });
                        });
                        return y + (lines.length * lineHeight) + 3;
                    }
                }

                // PAGE 1: Template 1: State Specific Note & Background Note
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                pdf.text('Template 1: State Specific Note & Background Note', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Two column layout with better spacing
                const leftColX = margin;
                const rightColX = margin + (contentWidth / 2) + 5; // Better spacing between columns
                const colWidth = (contentWidth / 2) - 5; // Increased column width
                let leftY = yPosition;
                let rightY = yPosition;

                // National Summit headers CENTERED in each column
                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                // Left column header - centered in left column
                pdf.text('National Summit', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 4;
                pdf.text('Theme:', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 4;
                pdf.text('Template: State Specific Note', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 10;

                // Right column header - centered in right column
                pdf.text('National Summit', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 4;
                pdf.text('Theme:', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 4;
                pdf.text('Template: State Specific Note', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 10;

                // Template 1: State Specific Note (left side header)
                addText('Template 1: State Specific Note', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 10;

                // LEFT COLUMN
                // I. Introduction
                addText('I.    Introduction', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const introDesc = '(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)';
                addText(introDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(introDesc, colWidth).length * 3.5 + 5;

                // Text box for Introduction - Better sizing
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(feedbackData.introduction, leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // II. Current Situation
                addText('II.   Current Situation', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const currDesc = '(Current policy landscape, programmes, schemes and their progress)';
                addText(currDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(currDesc, colWidth).length * 3.5 + 5;

                // Text box for Current Situation
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(feedbackData.current_situation, leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // III. Challenges
                addText('III.  Challenges', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const challDesc = '(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)';
                addText(challDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(challDesc, colWidth).length * 3.5 + 5;

                // Text box for Challenges
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(feedbackData.challenges, leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // IV. Possible Solutions
                addText('IV.   Possible Solutions', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const solDesc = '(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)';
                addText(solDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(solDesc, colWidth).length * 3.5 + 5;

                // Text box for Possible Solutions
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(feedbackData.possible_solutions, leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });

                // RIGHT COLUMN
                // V. Best Practices
                addText('V.    Best Practices', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const bestDesc = '(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)';
                addText(bestDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(bestDesc, colWidth).length * 3.5 + 5;

                // Text box for Best Practices
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(feedbackData.best_practices, rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                rightY += 27;

                // VI. Priority Areas
                addText('VI.   Priority Areas', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const prioDesc = '(Selected for implementation by the States in the next 5 years)';
                addText(prioDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(prioDesc, colWidth).length * 3.5 + 5;

                // Text box for Priority Areas
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(feedbackData.priority_areas, rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                rightY += 27;

                // VII. Way Forward - Strategy for Implementation
                addText('VII.  Way Forward - Strategy for Implementation', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const wayDesc = '(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)';
                addText(wayDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(wayDesc, colWidth).length * 3.5 + 5;

                // Text box for Way Forward
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(feedbackData.way_forward_strategy, rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });

                // PAGE 2: Template 2: Feedback Note by Officers
                pdf.addPage();
                yPosition = margin;

                // Template 2 Header
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                pdf.text('Template 2: Feedback Note by Officers', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // National Summit headers for Template 2 - CENTERED
                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                // Left side
                pdf.text('National Summit', leftColX + (colWidth / 2), yPosition, { align: 'center' });
                pdf.text('Theme:', leftColX + (colWidth / 2), yPosition + 4, { align: 'center' });
                pdf.text('Template: Feedback Note', leftColX + (colWidth / 2), yPosition + 8, { align: 'center' });
                
                // Right side
                pdf.text('National Summit', rightColX + (colWidth / 2), yPosition, { align: 'center' });
                pdf.text('Theme:', rightColX + (colWidth / 2), yPosition + 4, { align: 'center' });
                pdf.text('Template: Feedback Note', rightColX + (colWidth / 2), yPosition + 8, { align: 'center' });
                yPosition += 20;

                // Feedback Note header
                addText('Feedback Note (by all IAS officers / State Department Officers)', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 15;

                // Section 1: Officer Name and Details
                addText('Section 1: Officer Name and Details:', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 10;

                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                pdf.text(`• Name: ${officerProfile.name || ''}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`• Designation: ${officerProfile.designation || ''}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`• Batch: ${officerProfile.batch || ''}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`• Current Posting: ${officerProfile.current_posting || ''}`, margin, yPosition); // Ensure this displays data
                yPosition += 15;

                // Section 2: Feedback for Summit
                addText('Section 2: Feedback for Summit on <Theme name>', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 15;

                // 1. Name of the sub theme
                addText('1. Name of the sub theme', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const subThemeDesc = '(Choose from the sub theme of the summit)';
                addText(subThemeDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(subThemeDesc, contentWidth).length * 3.5 + 5;

                // Text box for sub theme
                pdf.rect(margin, yPosition, contentWidth, 15);
                addText(feedbackData.sub_theme_name, margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 20;

                // 2. Policy Gaps and Challenges
                addText('2. Policy Gaps and Challenges', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const policyDesc = '(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)';
                addText(policyDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(policyDesc, contentWidth).length * 3.5 + 5;

                // Text box for Policy Gaps
                pdf.rect(margin, yPosition, contentWidth, 22);
                addText(feedbackData.policy_gaps_challenges, margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 27;

                // 3. Potential Solutions
                addText('3. Potential Solutions', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const potentialDesc = '(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)';
                addText(potentialDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(potentialDesc, contentWidth).length * 3.5 + 5;

                // Text box for Potential Solutions
                pdf.rect(margin, yPosition, contentWidth, 22);
                addText(feedbackData.potential_solutions, margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 27;

                // Right side box for Template 2 (as shown in your PDF) - Better positioning
                const rightBoxX = rightColX;
                const rightBoxY = 65;
                const rightBoxWidth = colWidth;
                const rightBoxHeight = 65; // Adjusted height based on content
                pdf.rect(rightBoxX, rightBoxY, rightBoxWidth, rightBoxHeight);

                // 4. Best Practices (description OUTSIDE the main text box)
                addText('4. Best Practices', rightBoxX + 2, rightBoxY + 8, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                const bestPracticesDesc = '(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)';
                // This description is now placed BEFORE the box content, outside the box.
                addText(bestPracticesDesc, rightBoxX + 2, rightBoxY + 12, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: rightBoxWidth - 4, justify: true });

                // Text content for Best Practices (inside the box)
                // The actual text box starts after the description, so adjust Y for content
                addText(feedbackData.feedback_best_practices, rightBoxX + 2, rightBoxY + 25, { fontSize: 9, font: 'times', justify: true, maxWidth: rightBoxWidth - 4 });

                // Instructions section at bottom - BETTER ALIGNED
                const instructionsY = pageHeight - 55;
                addText('Instructions for filing feedback note:', margin, instructionsY, { fontSize: 11, font: 'times', fontStyle: 'bold' });

                pdf.setFontSize(9);
                pdf.setFont('times', 'normal');
                
                // 1. References - properly aligned
                pdf.text('1. References:', margin + 5, instructionsY + 8);
                const ref1 = '• In-text citing as well as the listing of all the references used for compiling the data';
                addText(ref1, margin + 10, instructionsY + 12, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 15 });
                pdf.text('  and information.', margin + 12, instructionsY + 16);
                pdf.text('• Hyperlinks can be added in the document', margin + 10, instructionsY + 20);
                
                // 2. Documentation style - properly aligned
                pdf.text('2. Documentation style:', margin + 5, instructionsY + 26);
                const docStyle = '○ Microsoft Word - Paper Size A4 with one inch margin from all four sides';
                addText(docStyle, margin + 10, instructionsY + 30, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 15 });

                if (isPreview) {
                    // Open in new tab for preview
                    const pdfBlob = pdf.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    window.open(url, '_blank');
                } else {
                    // Download PDF
                    const fileName = `feedback_${officerProfile.name || 'form'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                }

                return pdf;

            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        // Get Feedbacks by Date Range
        async function getFeedbacksByDateRange(startDate, endDate) {
            try {
                let query = supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        officer_profiles(name, designation, batch, current_posting)
                    `) // Fetch associated officer profile
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00.000Z');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59.999Z');
                }

                const { data, error } = await query;

                if (error) throw error;

                return data || [];

            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                throw error;
            }
        }

        // Generate Bulk PDF
        async function generateBulkPDF(feedbacks) {
            try {
                const zip = new JSZip();

                for (let i = 0; i < feedbacks.length; i++) {
                    const feedback = feedbacks[i];
                    
                    // Generate PDF for each feedback
                    const pdf = await generatePDF(feedback, false); // generatePDF now handles fetching profile
                    const pdfBlob = pdf.output('blob');
                    
                    const fileName = `feedback_${feedback.officer_profiles?.name || 'form'}_${feedback.created_at.split('T')[0]}.pdf`;
                    zip.file(fileName, pdfBlob);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip file
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedbacks_bulk_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error generating bulk PDF:', error);
                throw error;
            }
        }

        // Display Feedbacks in Modal
        async function displayFeedbacksInModal(feedbacks) {
            const tableBody = document.getElementById('feedbackTableBody');
            tableBody.innerHTML = '';

            if (feedbacks.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No feedbacks found</td>
                    </tr>
                `;
                return;
            }

            feedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                const createdDate = new Date(feedback.created_at).toLocaleDateString('en-US');
                
                row.innerHTML = `
                    <td>${createdDate}</td>
                    <td>${feedback.officer_profiles?.name || 'N/A'}</td>
                    <td>${feedback.officer_profiles?.designation || 'N/A'}</td>
                    <td>${feedback.officer_profiles?.batch || 'N/A'}</td>
                    <td>${feedback.officer_profiles?.current_posting || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleFeedbackPDF('${feedback.id}')">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Download Single Feedback PDF
        async function downloadSingleFeedbackPDF(feedbackId) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        officer_profiles(name, designation, batch, current_posting)
                    `)
                    .eq('id', feedbackId)
                    .single();

                if (error) throw error;

                await generatePDF(data, false); // generatePDF now handles fetching profile

            } catch (error) {
                console.error('Error downloading single feedback PDF:', error);
                showAlert('Error downloading PDF.', 'danger');
            }
        }

        // Auto-save form data to localStorage (draft functionality)
        function saveFormDraft() {
            const formData = {
                // Template 1 fields
                introduction: document.getElementById('introduction').value,
                currentSituation: document.getElementById('currentSituation').value,
                challenges: document.getElementById('challenges').value,
                possibleSolutions: document.getElementById('possibleSolutions').value,
                bestPractices: document.getElementById('bestPractices').value,
                priorityAreas: document.getElementById('priorityAreas').value,
                wayForwardStrategy: document.getElementById('wayForwardStrategy').value,
                // officer_profile_id is not part of draft, as it's selected at submission
            };
            
            localStorage.setItem('feedbackDraft', JSON.stringify(formData));
        }

        // Load form draft from localStorage
        function loadFormDraft() {
            const draft = localStorage.getItem('feedbackDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    // Template 1 fields
                    document.getElementById('introduction').value = formData.introduction || '';
                    document.getElementById('currentSituation').value = formData.currentSituation || '';
                    document.getElementById('challenges').value = formData.challenges || '';
                    document.getElementById('possibleSolutions').value = formData.possibleSolutions || '';
                    document.getElementById('bestPractices').value = formData.bestPractices || '';
                    document.getElementById('priorityAreas').value = formData.priorityAreas || '';
                    document.getElementById('wayForwardStrategy').value = formData.wayForwardStrategy || '';
                    
                    console.log('📝 Form draft loaded');
                } catch (error) {
                    console.error('Error loading form draft:', error);
                    localStorage.removeItem('feedbackDraft');
                }
            }
        }

        // Clear draft after successful submission
        function clearFormDraft() {
            localStorage.removeItem('feedbackDraft');
            console.log('📝 Form draft cleared');
        }

        // Auto-resize textareas
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Character counter function
        function addCharacterCounter(textareaId, maxLength = 2000) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            const counter = document.createElement('div');
            counter.className = 'character-counter';
            counter.style.cssText = 'font-size: 0.8rem; color: #666; text-align: right; margin-top: 5px; font-family: Poppins, sans-serif;';
            
            textarea.parentNode.insertBefore(counter, textarea.nextSibling);
            
            function updateCounter() {
                const length = textarea.value.length;
                counter.textContent = `${length}/${maxLength} characters`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = '#ff6b6b';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = '#ffa726';
                } else {
                    counter.style.color = '#666';
                }
            }
            
            updateCounter();
            textarea.addEventListener('input', updateCounter);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM Content Loaded');
            initializePage();
        });

        // Logout button
        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        // Feedback form submission - NOW OPENS OFFICER PROFILE MODAL
        document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('📝 Feedback form submitted - Opening Officer Profile Modal');
            
            // Validate main form fields first
            const requiredFieldsMainForm = [
                'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
            ];
            for (const fieldId of requiredFieldsMainForm) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showAlert(`Please fill all required fields in the feedback form (e.g., ${field.id}).`, 'danger');
                    return;
                }
            }

            // Show Officer Profile Modal
            const officerProfileModal = new bootstrap.Modal(document.getElementById('officerProfileModal'));
            officerProfileModal.show();
        });

        // Officer Profile Modal Logic
        const officerProfileModalElement = document.getElementById('officerProfileModal');
        const officerProfileAlert = document.getElementById('officerProfileAlert');

        document.getElementById('selectOfficerProfile').addEventListener('change', function() {
            const selectedId = this.value;
            if (selectedId) {
                // Clear new profile fields if an existing one is selected
                document.getElementById('newOfficerName').value = '';
                document.getElementById('newOfficerDesignation').value = '';
                document.getElementById('newOfficerBatch').value = '';
                document.getElementById('newOfficerPosting').value = '';
                document.getElementById('newOfficerDistrict').value = '';
                document.getElementById('newOfficerMobile').value = '';
            }
        });

        document.getElementById('confirmOfficerProfile').addEventListener('click', async function() {
            officerProfileAlert.style.display = 'none'; // Hide previous alerts
            const selectedProfileId = document.getElementById('selectOfficerProfile').value;
            let officerIdToUse = null;

            if (selectedProfileId) {
                officerIdToUse = selectedProfileId;
                console.log('Using existing officer profile:', officerIdToUse);
            } else {
                // Create new officer profile
                const newOfficerName = document.getElementById('newOfficerName').value.trim();
                const newOfficerDesignation = document.getElementById('newOfficerDesignation').value.trim();
                const newOfficerBatch = document.getElementById('newOfficerBatch').value.trim();
                const newOfficerPosting = document.getElementById('newOfficerPosting').value.trim();
                const newOfficerDistrict = document.getElementById('newOfficerDistrict').value;
                const newOfficerMobile = document.getElementById('newOfficerMobile').value.trim();

                // Validate new profile fields
                if (!newOfficerName || !newOfficerDesignation || !newOfficerBatch || !newOfficerPosting || !newOfficerDistrict || !newOfficerMobile) {
                    officerProfileAlert.textContent = 'कृपया नए प्रोफाइल के सभी आवश्यक फ़ील्ड भरें।';
                    officerProfileAlert.style.display = 'block';
                    return;
                }
                if (newOfficerMobile.length !== 10 || !/^\d+$/.test(newOfficerMobile)) {
                    officerProfileAlert.textContent = 'कृपया 10 अंकों का वैध मोबाइल नंबर दर्ज करें।';
                    officerProfileAlert.style.display = 'block';
                    return;
                }

                try {
                    // Ensure authUserId is available for the user_id field
                    if (!authUserId) {
                        officerProfileAlert.textContent = 'लॉगिन उपयोगकर्ता जानकारी उपलब्ध नहीं है। कृपया पुनः लॉगिन करें।';
                        officerProfileAlert.style.display = 'block';
                        console.error('authUserId is null during officer profile creation attempt.');
                        return;
                    }

                    const { data, error } = await supabaseClient
                        .from('officer_profiles')
                        .insert([{
                            user_id: authUserId, // Explicitly use authUserId here
                            name: newOfficerName,
                            designation: newOfficerDesignation,
                            batch: newOfficerBatch,
                            current_posting: newOfficerPosting,
                            district_id: newOfficerDistrict,
                            mobile_number: newOfficerMobile
                        }])
                        .select();

                    if (error) {
                        console.error('Supabase error creating officer profile:', error); // Log detailed error
                        let errorMessage = 'ऑफिसर प्रोफाइल बनाने में त्रुटि।';
                        if (error.code === '23503') { // Foreign key violation
                            errorMessage += ' (जिला आईडी अमान्य है या उपयोगकर्ता आईडी मौजूद नहीं है)';
                        } else if (error.message.includes('duplicate key')) { // Unique constraint violation
                            errorMessage += ' (यह प्रोफाइल पहले से मौजूद हो सकता है)';
                        } else if (error.message.includes('RLS policy')) {
                            errorMessage += ' (सुरक्षा नीति द्वारा अस्वीकृत। सुनिश्चित करें कि आप सही उपयोगकर्ता के रूप में लॉग इन हैं)';
                        } else {
                             errorMessage += ` (${error.message || 'अज्ञात त्रुटि'})`;
                        }
                        showAlert(errorMessage, 'danger', 'officerProfileAlert');
                        return;
                    }
                    officerIdToUse = data[0].id;
                    console.log('New officer profile created:', officerIdToUse);
                    showAlert('नया ऑफिसर प्रोफाइल सफलतापूर्वक बनाया गया!', 'success', 'officerProfileAlert');
                    // Reload profiles for future use
                    await loadOfficerProfiles(); 

                } catch (error) {
                    console.error('Error creating officer profile (catch block):', error);
                    showAlert('ऑफिसर प्रोफाइल बनाने में त्रुटि।', 'danger', 'officerProfileAlert');
                    return;
                }
            }

            if (officerIdToUse) {
                selectedOfficerProfileId = officerIdToUse; // Store the confirmed ID
                const officerProfileModal = bootstrap.Modal.getInstance(officerProfileModalElement);
                officerProfileModal.hide();
                // Proceed with main feedback submission
                await proceedWithFeedbackSubmission(selectedOfficerProfileId);
            } else {
                showAlert('कृपया एक ऑफिसर प्रोफाइल चुनें या नया बनाएं।', 'warning', 'officerProfileAlert');
            }
        });

        document.getElementById('cancelOfficerProfile').addEventListener('click', function() {
            const officerProfileModal = bootstrap.Modal.getInstance(officerProfileModalElement);
            officerProfileModal.hide();
            // Reset main form submit button state
            document.querySelector('button[type="submit"]').disabled = false;
            document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-paper-plane me-2"></i> Submit Feedback';
        });


        // Preview button
        document.getElementById('previewBtn').addEventListener('click', async function() {
            try {
                // For preview, we'll use dummy officer data if no profile is selected/created
                let dummyOfficerProfile = {
                    name: 'Sample Officer Name',
                    designation: 'Joint Secretary',
                    batch: '2008',
                    current_posting: 'Ministry of Agriculture & Farmers Welfare'
                };
                
                // If a profile was previously selected/created, try to fetch it for preview
                if (selectedOfficerProfileId) {
                    const { data, error } = await supabaseClient
                        .from('officer_profiles')
                        .select('*')
                        .eq('id', selectedOfficerProfileId)
                        .single();
                    if (data) dummyOfficerProfile = data;
                    if (error) console.warn('Could not fetch selected officer profile for preview, using dummy data.');
                }

                const formData = {
                    introduction: document.getElementById('introduction').value.trim() || 'This topic is crucial for States/UTs as it addresses fundamental challenges in governance and policy implementation, supported by comprehensive data analysis and evidence-based recommendations for sustainable development.',
                    currentSituation: document.getElementById('currentSituation').value.trim() || 'The current policy landscape encompasses various central and state schemes with varying degrees of implementation success across different regions, requiring systematic evaluation and improvement strategies.',
                    challenges: document.getElementById('challenges').value.trim() || 'Major policy gaps include coordination issues between departments, capacity building requirements, technological infrastructure limitations, and resource allocation challenges affecting effective implementation at grassroots level.',
                    possibleSolutions: document.getElementById('possibleSolutions').value.trim() || 'Proposed solutions include establishing inter-departmental coordination mechanisms, comprehensive capacity building programs, leveraging advanced technology for better convergence, and implementing robust monitoring and evaluation systems.',
                    bestPractices: document.getElementById('bestPractices').value.trim() || 'International best practices from countries like Estonia, Singapore, and Denmark, along with successful state initiatives in Kerala, Gujarat, and Telangana, demonstrate effective digital governance models, innovative implementation strategies, and sustainable development approaches.',
                    priorityAreas: document.getElementById('priorityAreas').value.trim() || 'Key priority areas for the next 5 years include comprehensive digital infrastructure development, human resource capacity building, policy framework modernization, sustainable implementation mechanisms, and citizen-centric service delivery models.',
                    wayForwardStrategy: document.getElementById('wayForwardStrategy').value.trim() || 'Implementation strategy requires comprehensive legal and regulatory reforms, systematic administrative restructuring, strategic technology adoption, adequate budgetary allocation with transparent utilization, phased rollout with continuous monitoring, and stakeholder engagement at all levels.',
                    // Pass officer profile data for PDF generation
                    officer_profile_id: selectedOfficerProfileId, // Pass the ID, generatePDF will fetch it
                    // Also pass the direct profile data for immediate preview if not yet saved to DB
                    officer_profile_data_for_preview: dummyOfficerProfile,
                    // Template 2 fields for preview
                    sub_theme_name: document.getElementById('subThemeName').value.trim() || 'Digital Agriculture Transformation and Farmer Empowerment through Technology Integration, Sustainable Development Practices, and Comprehensive Rural Development Initiatives',
                    policy_gaps_challenges: document.getElementById('policyGapsChallenges').value.trim() || 'Current challenges include fragmented digital systems across departments, lack of interoperability between state and central databases, insufficient digital literacy among field officers, coordination gaps between various implementing agencies, and inadequate infrastructure in remote areas.',
                    potential_solutions: document.getElementById('potentialSolutions').value.trim() || 'Comprehensive solutions include developing unified digital platforms with seamless integration, implementing systematic training programs for capacity building, establishing robust data governance frameworks, and fostering public-private partnerships for sustainable development.',
                    feedback_best_practices: document.getElementById('feedbackBestPractices').value.trim() || 'Successful sustainable practices include Andhra Pradesh comprehensive farmer database system with real-time monitoring, Karnataka innovative mobile-based extension services, Telangana integrated crop monitoring system using satellite technology, and various state-level technology adoption models that have shown measurable impact on farmer welfare and agricultural productivity.'
                };

                await generatePDF(formData, true);

            } catch (error) {
                console.error('Error generating preview:', error);
                showAlert('Error generating preview.', 'danger');
            }
        });

        // Admin panel event listeners
        if (document.getElementById('downloadSinglePDF')) {
            document.getElementById('downloadSinglePDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Downloading...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    // Download first feedback as sample
                    await generatePDF(feedbacks[0], false);

                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    showAlert('Error downloading PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-pdf me-2"></i><span class="hindi">एकल PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('downloadBulkPDF')) {
            document.getElementById('downloadBulkPDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Preparing...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    await generateBulkPDF(feedbacks);
                    showAlert(`Bulk PDF download completed for ${feedbacks.length} feedbacks.`, 'success');

                } catch (error) {
                    console.error('Error downloading bulk PDF:', error);
                    showAlert('Error downloading bulk PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-archive me-2"></i><span class="hindi">बल्क PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('viewAllFeedbacks')) {
            document.getElementById('viewAllFeedbacks').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    await displayFeedbacksInModal(feedbacks);

                    const modal = new bootstrap.Modal(document.getElementById('feedbackListModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading feedbacks:', error);
                    showAlert('Error loading feedbacks.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-list me-2"></i><span class="hindi">सभी फीडबैक देखें</span>';
                }
            });
        }

        // Clickable stats cards
        document.getElementById('totalFeedbacksCard').addEventListener('click', async () => {
            const feedbacks = await getFeedbacksByDateRange(null, null); // All feedbacks
            await displayFeedbacksInModal(feedbacks);
            new bootstrap.Modal(document.getElementById('feedbackListModal')).show();
        });

        document.getElementById('todayFeedbacksCard').addEventListener('click', async () => {
            const today = new Date().toISOString().split('T')[0];
            const feedbacks = await getFeedbacksByDateRange(today, today); // Today's feedbacks
            await displayFeedbacksInModal(feedbacks);
            new bootstrap.Modal(document.getElementById('feedbackListModal')).show();
        });


        // Set default date range (last 30 days)
        if (document.getElementById('startDate') && document.getElementById('endDate')) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Make downloadSingleFeedbackPDF available globally
        window.downloadSingleFeedbackPDF = downloadSingleFeedbackPDF;

        // Auto-save every 30 seconds
        setInterval(saveFormDraft, 30000);

        // Save on form input change
        document.getElementById('feedbackForm').addEventListener('input', saveFormDraft);

        // Load draft when page loads
        setTimeout(loadFormDraft, 1000);

        // Auto-resize textareas on input
        setTimeout(() => {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                // Initial resize
                autoResizeTextarea(textarea);
            });
        }, 1500);

        // Add character counters to all textareas
        setTimeout(() => {
            const textareaIds = [
                'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
            ];
            
            textareaIds.forEach(id => addCharacterCounter(id, 2000));
        }, 1500);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFormDraft();
                showAlert('Form draft saved.', 'info');
            }
            
            // Ctrl + Enter to submit form
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
        });

        // Handle network status
        window.addEventListener('online', () => {
            console.log('🌐 Network online');
            showAlert('Internet connection restored.', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('📡 Network offline');
            showAlert('Internet connection lost. Please check your connection.', 'danger');
        });

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('💥 Unhandled error:', e.error);
            showAlert('An unexpected error occurred. Please refresh the page.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection:', e.reason);
            showAlert('Data loading error. Please try again.', 'danger');
        });

        // Debug functions for development
        window.debugFeedback = {
            getCurrentUser: () => currentUser,
            getSupabaseClient: () => supabaseClient,
            loadDraft: loadFormDraft,
            saveDraft: saveFormDraft,
            clearDraft: clearFormDraft,
            testPDF: async () => {
                const sampleData = {
                    introduction: 'This topic is crucial for States/UTs as it addresses fundamental challenges in governance and policy implementation, supported by comprehensive data analysis and evidence-based recommendations for sustainable development.',
                    currentSituation: 'The current policy landscape encompasses various central and state schemes with varying degrees of implementation success across different regions, requiring systematic evaluation and improvement strategies.',
                    challenges: 'Major policy gaps include coordination issues between departments, capacity building requirements, technological infrastructure limitations, and resource allocation challenges affecting effective implementation at grassroots level.',
                    possibleSolutions: 'Proposed solutions include establishing inter-departmental coordination mechanisms, comprehensive capacity building programs, leveraging advanced technology for better convergence, and implementing robust monitoring and evaluation systems.',
                    bestPractices: 'International best practices from countries like Estonia, Singapore, and Denmark, along with successful state initiatives in Kerala, Gujarat, and Telangana, demonstrate effective digital governance models, innovative implementation strategies, and sustainable development approaches.',
                    priorityAreas: 'Key priority areas for the next 5 years include comprehensive digital infrastructure development, human resource capacity building, policy framework modernization, sustainable implementation mechanisms, and citizen-centric service delivery models.',
                    wayForwardStrategy: 'Implementation strategy requires comprehensive legal and regulatory reforms, systematic administrative restructuring, strategic technology adoption, adequate budgetary allocation with transparent utilization, phased rollout with continuous monitoring, and stakeholder engagement at all levels.',
                    // Dummy officer profile for PDF preview
                    officer_profile_id: 'dummy-id', // This ID won't exist in DB, but generatePDF handles it
                    officer_profile_data_for_preview: {
                        name: 'Dr. Rajesh Kumar Singh',
                        designation: 'Joint Secretary',
                        batch: '2008',
                        current_posting: 'Ministry of Agriculture & Farmers Welfare'
                    },
                    sub_theme_name: 'Digital Agriculture Transformation and Farmer Empowerment through Technology Integration, Sustainable Development Practices, and Comprehensive Rural Development Initiatives',
                    policy_gaps_challenges: 'Current challenges include fragmented digital systems across departments, lack of interoperability between state and central databases, insufficient digital literacy among field officers, coordination gaps between various implementing agencies, and inadequate infrastructure in remote areas.',
                    potential_solutions: 'Comprehensive solutions include developing unified digital platforms with seamless integration, implementing systematic training programs for capacity building, establishing robust data governance frameworks, and fostering public-private partnerships for sustainable development.',
                    feedback_best_practices: 'Successful sustainable practices include Andhra Pradesh comprehensive farmer database system with real-time monitoring, Karnataka innovative mobile-based extension services, Telangana integrated crop monitoring system using satellite technology, and various state-level technology adoption models that have shown measurable impact on farmer welfare and agricultural productivity.'
                };
                await generatePDF(sampleData, true);
            },
            getFormData: () => {
                return {
                    introduction: document.getElementById('introduction').value,
                    currentSituation: document.getElementById('currentSituation').value,
                    challenges: document.getElementById('challenges').value,
                    possibleSolutions: document.getElementById('possibleSolutions').value,
                    bestPractices: document.getElementById('bestPractices').value,
                    priorityAreas: document.getElementById('priorityAreas').value,
                    wayForwardStrategy: document.getElementById('wayForwardStrategy').value,
                    // Officer details are now from selected profile
                    officer_profile_id: selectedOfficerProfileId,
                    sub_theme_name: document.getElementById('subThemeName').value,
                    policy_gaps_challenges: document.getElementById('policyGapsChallenges').value,
                    potential_solutions: document.getElementById('potentialSolutions').value,
                    feedback_best_practices: document.getElementById('feedbackBestPractices').value
                };
            }
        };

        // Add console welcome message
        console.log(`
        ╔══════════════════════════════════════════════════════════════╗
        ║                संचालनालय कृषि छत्तीसगढ़                      ║
        ║              National Summit Feedback System                 ║
        ║                                                              ║
        ║  📝 Template 1: State Specific Note & Background Note        ║
        ║  📋 Template 2: Feedback Note by Officers                    ║
        ║  📄 EXACT PDF Layout with REDUCED MARGINS                    ║
        ║  🎨 Light Orange Background & Sentence Case                  ║
        ║  📊 Sky Blue Admin Header & Poppins Font                     ║
        ║  📦 Single & Bulk PDF Download                               ║
        ║  💾 Auto-save Draft & Character Counters                     ║
        ║  🔍 Date-wise Filtering & Footer with Date/Time              ║
        ║  ✨ Justified Text & Better Alignment                        ║
        ║  ✅ Submit Success Animation & Clickable Stats               ║
        ║  ✅ Times New Roman PDF Font & Current Posting Fix           ║
        ║  ✅ Officer Profile Management (Popup on Submit)             ║
        ║  ✅ "Best Practices" Description OUTSIDE Box                 ║
        ║  ✅ FIXED N/A in Modal & Officer Profile Creation Error      ║
        ║                                                              ║
        ║  Keyboard Shortcuts:                                         ║
        ║  • Ctrl + S: Save Draft                                      ║
        ║  • Ctrl + Enter: Submit Form                                 ║
        ║                                                              ║
        ║  Debug: debugFeedback.testPDF() to test PDF                 ║
        ╚══════════════════════════════════════════════════════════════╝
        `);

        console.log('🎉 Complete National Summit Feedback System loaded successfully');
        console.log('💡 All Features: Officer profile management, Times New Roman PDF font, submit animation, clickable stats, reduced margins, centered headers, justified text, sky blue admin panel, Poppins font, sentence case, "Best Practices" description outside box, FIXED N/A in modal and profile creation error.');
        console.log('🔧 Use debugFeedback.testPDF() to test PDF generation with comprehensive sample data');
    </script>
</body>
</html>
