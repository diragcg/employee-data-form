<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>फीडबैक फॉर्म - संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Inter', sans-serif;
            font-weight: 500;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        /* Form Card - Exact PDF Layout */
        .form-card {
            background: var(--white);
            border: 2px solid #000;
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            line-height: 1.4;
        }

        .form-header {
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #000;
            background: #f8f9fa;
        }

        .form-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-subtitle {
            font-size: 14px;
            font-weight: bold;
        }

        /* Template Sections */
        .template-section {
            border: 2px solid #000;
            margin: 0;
            background: var(--white);
        }

        .template-header {
            background: #e9ecef;
            border-bottom: 1px solid #000;
            padding: 8px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .template-content {
            padding: 15px;
        }

        /* Form Fields - Exact PDF Style */
        .form-row {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .form-field {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .field-label {
            font-weight: bold;
            margin-right: 10px;
            min-width: 120px;
            font-size: 12px;
        }

        .field-input {
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            font-size: 12px;
            padding: 2px 5px;
            font-family: inherit;
            flex: 1;
            min-height: 20px;
        }

        .field-input:focus {
            outline: none;
            border-bottom: 2px solid #000;
        }

        .field-textarea {
            border: 1px solid #000;
            background: transparent;
            font-size: 12px;
            padding: 5px;
            font-family: inherit;
            width: 100%;
            min-height: 60px;
            resize: vertical;
        }

        .field-textarea:focus {
            outline: none;
            border: 2px solid #000;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 15px;
            height: 15px;
        }

        /* Table Style for organized layout */
        .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .form-table td {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: top;
        }

        .form-table .label-cell {
            background: #f8f9fa;
            font-weight: bold;
            width: 200px;
        }

        .form-table .input-cell {
            background: white;
        }

        .form-table input, .form-table textarea, .form-table select {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 12px;
            font-family: inherit;
            padding: 2px;
        }

        .form-table input:focus, .form-table textarea:focus, .form-table select:focus {
            outline: 1px solid #000;
        }

        /* Submit Button */
        .submit-container {
            margin-top: 2rem;
            text-align: center;
            padding: 20px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 0.875rem 2rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            min-width: 160px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            margin-right: 1rem;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Panel */
        .admin-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .admin-header {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            color: var(--white);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .admin-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .admin-body {
            padding: 1.5rem;
        }

        .stats-card {
            background: var(--light-green);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .admin-btn {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            border: none;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition);
            margin-bottom: 0.5rem;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .form-input-admin {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input-admin:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-label-admin {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: none;
            font-weight: 500;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }

        .alert-success {
            background: #E8F5E8;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Print Styles for PDF */
        @media print {
            body {
                background: white;
                font-size: 12px;
                line-height: 1.4;
                font-family: 'Times New Roman', serif;
            }
            
            .header, .admin-panel, .submit-container {
                display: none !important;
            }
            
            .main-container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card {
                box-shadow: none;
                border: 2px solid #000;
            }
            
            .template-section {
                page-break-inside: avoid;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .admin-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand img {
                height: 32px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }

            .form-table {
                font-size: 11px;
            }

            .field-label {
                min-width: 100px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .form-table td {
                padding: 5px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार" class="cg-logo">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <div class="user-info">
                        <span id="userInfo" class="hindi"></span>
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            लॉगआउट
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="content-grid">
                <!-- Feedback Form - Exact PDF Layout -->
                <div class="form-card">
                    <div class="form-header">
                        <div class="form-title">Feedback Form</div>
                        <div class="form-subtitle">Agriculture Department, Chhattisgarh</div>
                    </div>

                    <div id="alertBox" class="alert alert-danger" style="display: none; margin: 15px;"></div>
                    
                    <form id="feedbackForm">
                        <!-- Template 1: State Specific Note & Background Note -->
                        <div class="template-section">
                            <div class="template-header">
                                Template 1: State Specific Note & Background Note
                            </div>
                            <div class="template-content">
                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Officer Name:</td>
                                        <td class="input-cell">
                                            <input type="text" id="officerName" required>
                                        </td>
                                        <td class="label-cell">Designation:</td>
                                        <td class="input-cell">
                                            <input type="text" id="designation" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">District:</td>
                                        <td class="input-cell">
                                            <select id="district" required>
                                                <option value="">-- Select District --</option>
                                            </select>
                                        </td>
                                        <td class="label-cell">Block:</td>
                                        <td class="input-cell">
                                            <input type="text" id="block" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Date:</td>
                                        <td class="input-cell">
                                            <input type="date" id="formDate" required>
                                        </td>
                                        <td class="label-cell">Contact Number:</td>
                                        <td class="input-cell">
                                            <input type="tel" id="contactNumber" pattern="[0-9]{10}" required>
                                        </td>
                                    </tr>
                                </table>

                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">State Specific Note:</td>
                                        <td class="input-cell">
                                            <textarea id="stateSpecificNote" rows="4" required placeholder="Enter state specific observations and notes..."></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Background Note:</td>
                                        <td class="input-cell">
                                            <textarea id="backgroundNote" rows="4" required placeholder="Enter background information and context..."></textarea>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Template 2: Feedback Note by Officers -->
                        <div class="template-section">
                            <div class="template-header">
                                Template 2: Feedback Note by Officers
                            </div>
                            <div class="template-content">
                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Feedback Category:</td>
                                        <td class="input-cell">
                                            <select id="feedbackCategory" required>
                                                <option value="">-- Select Category --</option>
                                                <option value="Agricultural Scheme">Agricultural Scheme</option>
                                                <option value="Crop Insurance">Crop Insurance</option>
                                                <option value="Farmer Support">Farmer Support</option>
                                                <option value="Technical Assistance">Technical Assistance</option>
                                                <option value="Infrastructure">Infrastructure</option>
                                                <option value="Training & Development">Training & Development</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </td>
                                        <td class="label-cell">Priority Level:</td>
                                        <td class="input-cell">
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="radio" id="priorityHigh" name="priority" value="High" required>
                                                    <label for="priorityHigh">High</label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <input type="radio" id="priorityMedium" name="priority" value="Medium" required>
                                                    <label for="priorityMedium">Medium</label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <input type="radio" id="priorityLow" name="priority" value="Low" required>
                                                    <label for="priorityLow">Low</label>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Current Status:</td>
                                        <td class="input-cell">
                                            <textarea id="currentStatus" rows="3" required placeholder="Describe the current situation and status..."></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Issues/Challenges:</td>
                                        <td class="input-cell">
                                            <textarea id="issues" rows="3" required placeholder="List the main issues and challenges faced..."></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Suggestions/Recommendations:</td>
                                        <td class="input-cell">
                                            <textarea id="suggestions" rows="3" required placeholder="Provide suggestions and recommendations for improvement..."></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">Action Required:</td>
                                        <td class="input-cell">
                                            <textarea id="actionRequired" rows="3" required placeholder="Specify the actions that need to be taken..."></textarea>
                                        </td>
                                    </tr>
                                </table>

                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Expected Resolution Date:</td>
                                        <td class="input-cell">
                                            <input type="date" id="expectedDate" required>
                                        </td>
                                        <td class="label-cell">Follow-up Required:</td>
                                        <td class="input-cell">
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="radio" id="followupYes" name="followup" value="Yes" required>
                                                    <label for="followupYes">Yes</label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <input type="radio" id="followupNo" name="followup" value="No" required>
                                                    <label for="followupNo">No</label>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Additional Comments:</td>
                                        <td class="input-cell">
                                            <textarea id="additionalComments" rows="3" placeholder="Any additional comments or observations..."></textarea>
                                        </td>
                                    </tr>
                                </table>

                                <table class="form-table">
                                    <tr>
                                        <td class="label-cell">Officer Signature:</td>
                                        <td class="input-cell" style="height: 50px; border-bottom: 1px solid #000;">
                                            <!-- Space for signature -->
                                        </td>
                                        <td class="label-cell">Date & Time:</td>
                                        <td class="input-cell" id="signatureDateTime">
                                            <!-- Auto-filled date and time -->
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="submit-container">
                            <button type="submit" class="btn submit-btn">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Feedback
                            </button>
                            <button type="button" class="btn submit-btn" id="previewBtn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                                <i class="fas fa-eye me-2"></i>
                                Preview PDF
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div class="admin-header">
                        <h3 class="hindi">फीडबैक प्रबंधन</h3>
                        <p class="hindi mb-0">रिपोर्ट और डाउनलोड</p>
                    </div>
                    <div class="admin-body">
                        <div class="stats-card">
                            <div class="stats-number" id="totalFeedbacks">0</div>
                            <div class="stats-label hindi">कुल फीडबैक</div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-number" id="todayFeedbacks">0</div>
                            <div class="stats-label hindi">आज के फीडबैक</div>
                        </div>

                        <div class="date-filter">
                            <label for="startDate" class="form-label-admin hindi">प्रारंभ दिनांक</label>
                            <input type="date" class="form-input-admin" id="startDate">
                        </div>

                        <div class="date-filter">
                            <label for="endDate" class="form-label-admin hindi">अंत दिनांक</label>
                            <input type="date" class="form-input-admin" id="endDate">
                        </div>

                        <button class="admin-btn" id="downloadSinglePDF">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span class="hindi">एकल PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="downloadBulkPDF">
                            <i class="fas fa-file-archive me-2"></i>
                            <span class="hindi">बल्क PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="viewAllFeedbacks">
                            <i class="fas fa-list me-2"></i>
                            <span class="hindi">सभी फीडबैक देखें</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Feedback List Modal -->
    <div class="modal fade" id="feedbackListModal" tabindex="-1" aria-labelledby="feedbackListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="feedbackListModalLabel">फीडबैक सूची</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Officer</th>
                                    <th>District</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // Supabase configuration (same as login.html)
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    console.log('✓ Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('✗ Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('✗ Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'alertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = document.getElementById(elementId);
            if (!alertBox) {
                console.error('Alert box not found:', elementId);
                return;
            }
            
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Load Districts
        async function loadDistricts() {
            try {
                const districtSelect = document.getElementById('district');
                
                const { data, error } = await supabaseClient
                    .from('districts')
                    .select('id, name')
                    .order('name', { ascending: true });
                    
                if (error) throw error;
                
                // Clear existing options except the first one
                while (districtSelect.options.length > 1) {
                    districtSelect.remove(1);
                }
                
                // Add districts to dropdown
                if (data) {
                    data.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                showAlert('Error loading districts.', 'danger');
            }
        }

        // Initialize Page
        async function initializePage() {
            console.log('🚀 Initializing feedback form page...');
            
            try {
                // Initialize Supabase first
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                // Get stored user
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                console.log('📦 Stored user data:', storedUser ? 'Found' : 'Not found');
                
                if (!storedUser) {
                    showAlert('Session expired. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                // Parse user data
                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('👤 Current user:', currentUser);
                
                // Update UI with user info
                const userInfo = `${currentUser.fullName || currentUser.username} (\${currentUser.districtName || 'N/A'})`;
                document.getElementById('userInfo').textContent = userInfo;
                console.log('✓ User info updated');
                
                // Show admin panel if user is admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    console.log('✓ Admin panel enabled');
                    await loadFeedbackStats();
                }
                
                // Hide loading and show content
                hideLoading();
                
                // Load districts
                await loadDistricts();
                
                // Set default district if user has one
                if (currentUser.districtId) {
                    document.getElementById('district').value = currentUser.districtId;
                }
                
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('formDate').value = today;
                document.getElementById('expectedDate').value = today;
                
                // Set current date and time for signature
                const now = new Date();
                const dateTimeString = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('signatureDateTime').textContent = dateTimeString;
                
            } catch (error) {
                console.error('✗ Error initializing page:', error);
                hideLoading();
                showAlert('Error loading page. Please login again.', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // Load Feedback Statistics
        async function loadFeedbackStats() {
            try {
                // Get total feedbacks
                const { data: totalData, error: totalError, count: totalCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Get today's feedbacks
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData, error: todayError, count: todayCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' })
                    .gte('created_at', today + 'T00:00:00.000Z')
                    .lt('created_at', today + 'T23:59:59.999Z');

                if (todayError) throw todayError;

                document.getElementById('totalFeedbacks').textContent = totalCount || 0;
                document.getElementById('todayFeedbacks').textContent = todayCount || 0;

            } catch (error) {
                console.error('Error loading feedback stats:', error);
                document.getElementById('totalFeedbacks').textContent = '0';
                document.getElementById('todayFeedbacks').textContent = '0';
            }
        }

        // Submit Feedback Form
        async function submitFeedback(formData) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .insert([{
                        user_id: currentUser.id,
                        officer_name: formData.officerName,
                        designation: formData.designation,
                        district_id: formData.district,
                        block: formData.block,
                        form_date: formData.formDate,
                        contact_number: formData.contactNumber,
                        state_specific_note: formData.stateSpecificNote,
                        background_note: formData.backgroundNote,
                        feedback_category: formData.feedbackCategory,
                        priority: formData.priority,
                        current_status: formData.currentStatus,
                        issues: formData.issues,
                        suggestions: formData.suggestions,
                        action_required: formData.actionRequired,
                        expected_date: formData.expectedDate,
                        followup_required: formData.followup,
                        additional_comments: formData.additionalComments,
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('✅ Feedback submitted successfully:', data);
                showAlert('Feedback submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('feedbackForm').reset();
                
                // Set defaults again
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('formDate').value = today;
                document.getElementById('expectedDate').value = today;
                if (currentUser.districtId) {
                    document.getElementById('district').value = currentUser.districtId;
                }
                
                // Update signature date time
                const now = new Date();
                const dateTimeString = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('signatureDateTime').textContent = dateTimeString;
                
                // Clear draft after successful submission
                clearFormDraft();
                
                // Reload stats if admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    await loadFeedbackStats();
                }

                return data[0];

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                throw error;
            }
        }

        // Generate PDF from feedback data - Exact PDF Layout
        async function generatePDF(feedbackData, isPreview = false) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF settings
                const margin = 15;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Helper function to add text
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 11;
                    const maxWidth = options.maxWidth || contentWidth;
                    
                    pdf.setFontSize(fontSize);
                    if (options.bold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    
                    if (options.align) {
                        pdf.text(text, x, y, { align: options.align, maxWidth: maxWidth });
                    } else {
                        const lines = pdf.splitTextToSize(text, maxWidth);
                        lines.forEach((line, index) => {
                            pdf.text(line, x, y + (index * (fontSize * 0.35)));
                        });
                    }
                    
                    return y + (fontSize * 0.35) + 2;
                }

                // Header
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('Feedback Form', pageWidth / 2, yPosition + 5, { align: 'center' });
                yPosition += 10;
                
                pdf.setFontSize(14);
                pdf.text('Agriculture Department, Chhattisgarh', pageWidth / 2, yPosition + 5, { align: 'center' });
                yPosition += 15;

                // Draw main border
                pdf.setLineWidth(1);
                pdf.rect(margin, yPosition, contentWidth, pageHeight - yPosition - 20);
                yPosition += 5;

                // Template 1 Header
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setFillColor(240, 240, 240);
                pdf.rect(margin + 2, yPosition, contentWidth - 4, 8, 'F');
                pdf.rect(margin + 2, yPosition, contentWidth - 4, 8);
                pdf.text('Template 1: State Specific Note & Background Note', pageWidth / 2, yPosition + 5, { align: 'center' });
                yPosition += 12;

                // Template 1 Content - Table format
                const cellHeight = 8;
                const col1Width = (contentWidth - 4) / 4;
                const col2Width = (contentWidth - 4) / 4;
                const col3Width = (contentWidth - 4) / 4;
                const col4Width = (contentWidth - 4) / 4;
                
                // Row 1: Officer Name and Designation
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Officer Name:', margin + 4, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.officerName || '', margin + 4 + col1Width, yPosition + 5);
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Designation:', margin + 4 + col1Width + col2Width, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.designation || '', margin + 4 + col1Width + col2Width + col3Width, yPosition + 5);
                yPosition += cellHeight;

                // Row 2: District and Block
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('District:', margin + 4, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.districtName || '', margin + 4 + col1Width, yPosition + 5);
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Block:', margin + 4 + col1Width + col2Width, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.block || '', margin + 4 + col1Width + col2Width + col3Width, yPosition + 5);
                yPosition += cellHeight;

                // Row 3: Date and Contact Number
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Date:', margin + 4, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.formDate || '', margin + 4 + col1Width, yPosition + 5);
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Contact Number:', margin + 4 + col1Width + col2Width, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.contactNumber || '', margin + 4 + col1Width + col2Width + col3Width, yPosition + 5);
                yPosition += cellHeight + 3;

                // State Specific Note
                const noteHeight = 25;
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, noteHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, noteHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('State Specific Note:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, noteHeight);
                pdf.setFont(undefined, 'normal');
                const stateNoteLines = pdf.splitTextToSize(feedbackData.stateSpecificNote || '', contentWidth - 4 - col1Width - 6);
                stateNoteLines.slice(0, 6).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += noteHeight;

                // Background Note
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, noteHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, noteHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Background Note:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, noteHeight);
                pdf.setFont(undefined, 'normal');
                const backgroundNoteLines = pdf.splitTextToSize(feedbackData.backgroundNote || '', contentWidth - 4 - col1Width - 6);
                backgroundNoteLines.slice(0, 6).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += noteHeight + 5;

                // Template 2 Header
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setFillColor(240, 240, 240);
                pdf.rect(margin + 2, yPosition, contentWidth - 4, 8, 'F');
                pdf.rect(margin + 2, yPosition, contentWidth - 4, 8);
                pdf.text('Template 2: Feedback Note by Officers', pageWidth / 2, yPosition + 5, { align: 'center' });
                yPosition += 12;

                // Template 2 Content
                // Row 1: Feedback Category and Priority
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Feedback Category:', margin + 4, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.feedbackCategory || '', margin + 4 + col1Width, yPosition + 5);
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Priority Level:', margin + 4 + col1Width + col2Width, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.priority || '', margin + 4 + col1Width + col2Width + col3Width, yPosition + 5);
                yPosition += cellHeight + 3;

                // Current Status
                const statusHeight = 18;
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Current Status:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, statusHeight);
                pdf.setFont(undefined, 'normal');
                const statusLines = pdf.splitTextToSize(feedbackData.currentStatus || '', contentWidth - 4 - col1Width - 6);
                statusLines.slice(0, 4).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += statusHeight;

                // Issues/Challenges
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Issues/Challenges:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, statusHeight);
                pdf.setFont(undefined, 'normal');
                const issuesLines = pdf.splitTextToSize(feedbackData.issues || '', contentWidth - 4 - col1Width - 6);
                issuesLines.slice(0, 4).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += statusHeight;

                // Suggestions/Recommendations
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Suggestions:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, statusHeight);
                pdf.setFont(undefined, 'normal');
                const suggestionsLines = pdf.splitTextToSize(feedbackData.suggestions || '', contentWidth - 4 - col1Width - 6);
                suggestionsLines.slice(0, 4).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += statusHeight;

                // Action Required
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, statusHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Action Required:', margin + 4, yPosition + 6);
                
                pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, statusHeight);
                pdf.setFont(undefined, 'normal');
                const actionLines = pdf.splitTextToSize(feedbackData.actionRequired || '', contentWidth - 4 - col1Width - 6);
                actionLines.slice(0, 4).forEach((line, index) => {
                    pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                });
                yPosition += statusHeight + 3;

                // Expected Resolution Date and Follow-up
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Expected Date:', margin + 4, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.expectedDate || '', margin + 4 + col1Width, yPosition + 5);
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, cellHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Follow-up Required:', margin + 4 + col1Width + col2Width, yPosition + 5);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, cellHeight);
                pdf.setFont(undefined, 'normal');
                pdf.text(feedbackData.followup || '', margin + 4 + col1Width + col2Width + col3Width, yPosition + 5);
                yPosition += cellHeight + 3;

                // Additional Comments (if provided)
                if (feedbackData.additionalComments && feedbackData.additionalComments.trim()) {
                    pdf.setFillColor(248, 249, 250);
                    pdf.rect(margin + 2, yPosition, col1Width, statusHeight, 'F');
                    pdf.rect(margin + 2, yPosition, col1Width, statusHeight);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Additional Comments:', margin + 4, yPosition + 6);
                    
                    pdf.rect(margin + 2 + col1Width, yPosition, contentWidth - 4 - col1Width, statusHeight);
                    pdf.setFont(undefined, 'normal');
                    const commentsLines = pdf.splitTextToSize(feedbackData.additionalComments, contentWidth - 4 - col1Width - 6);
                    commentsLines.slice(0, 4).forEach((line, index) => {
                        pdf.text(line, margin + 6 + col1Width, yPosition + 6 + (index * 3.5));
                    });
                    yPosition += statusHeight + 3;
                }

                // Signature Section
                const sigHeight = 15;
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2, yPosition, col1Width, sigHeight, 'F');
                pdf.rect(margin + 2, yPosition, col1Width, sigHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Officer Signature:', margin + 4, yPosition + 8);
                
                pdf.rect(margin + 2 + col1Width, yPosition, col2Width, sigHeight);
                // Empty signature space
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, sigHeight, 'F');
                pdf.rect(margin + 2 + col1Width + col2Width, yPosition, col3Width, sigHeight);
                pdf.setFont(undefined, 'bold');
                pdf.text('Date & Time:', margin + 4 + col1Width + col2Width, yPosition + 8);
                
                pdf.rect(margin + 2 + col1Width + col2Width + col3Width, yPosition, col4Width, sigHeight);
                pdf.setFont(undefined, 'normal');
                const currentDateTime = new Date().toLocaleString('en-US');
                const dateTimeLines = pdf.splitTextToSize(currentDateTime, col4Width - 4);
                dateTimeLines.forEach((line, index) => {
                    pdf.text(line, margin + 4 + col1Width + col2Width + col3Width, yPosition + 8 + (index * 3.5));
                });

                // Footer
                yPosition = pageHeight - 15;
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('This is a computer generated document.', pageWidth / 2, yPosition, { align: 'center' });

                if (isPreview) {
                    // Open in new tab for preview
                    const pdfBlob = pdf.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    window.open(url, '_blank');
                } else {
                    // Download PDF
                    const fileName = `feedback_${feedbackData.officerName}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                }

                return pdf;

            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        // Get Feedbacks by Date Range
        async function getFeedbacksByDateRange(startDate, endDate) {
            try {
                let query = supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        districts(name)
                    `)
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00.000Z');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59.999Z');
                }

                const { data, error } = await query;

                if (error) throw error;

                return data || [];

            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                throw error;
            }
        }

        // Generate Bulk PDF
        async function generateBulkPDF(feedbacks) {
            try {
                const zip = new JSZip();

                for (let i = 0; i < feedbacks.length; i++) {
                    const feedback = feedbacks[i];
                    const feedbackData = {
                        ...feedback,
                        districtName: feedback.districts?.name || 'N/A'
                    };

                    // Generate PDF for each feedback
                    const pdf = await generatePDF(feedbackData, false);
                    const pdfBlob = pdf.output('blob');
                    
                    const fileName = `feedback_${feedback.officer_name}_${feedback.created_at.split('T')[0]}.pdf`;
                    zip.file(fileName, pdfBlob);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip file
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedbacks_bulk_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error generating bulk PDF:', error);
                throw error;
            }
        }

        // Display Feedbacks in Modal
        async function displayFeedbacksInModal(feedbacks) {
            const tableBody = document.getElementById('feedbackTableBody');
            tableBody.innerHTML = '';

            if (feedbacks.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No feedbacks found</td>
                    </tr>
                `;
                return;
            }

            feedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                const createdDate = new Date(feedback.created_at).toLocaleDateString('en-US');
                
                row.innerHTML = `
                    <td>${createdDate}</td>
                    <td>${feedback.officer_name}</td>
                    <td>${feedback.districts?.name || 'N/A'}</td>
                    <td>${feedback.feedback_category}</td>
                    <td>
                        <span class="badge ${
                            feedback.priority === 'High' ? 'bg-danger' : 
                            feedback.priority === 'Medium' ? 'bg-warning' : 'bg-success'
                        }">${feedback.priority}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleFeedbackPDF('${feedback.id}')">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Download Single Feedback PDF
        async function downloadSingleFeedbackPDF(feedbackId) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .select(`
                        *,
                        districts(name)
                    `)
                    .eq('id', feedbackId)
                    .single();

                if (error) throw error;

                const feedbackData = {
                    ...data,
                    districtName: data.districts?.name || 'N/A'
                };

                await generatePDF(feedbackData, false);

            } catch (error) {
                console.error('Error downloading single feedback PDF:', error);
                showAlert('Error downloading PDF.', 'danger');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM Content Loaded');
            initializePage();
        });

        // Logout button
        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        // Feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('📝 Feedback form submitted');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Submitting...';
                
                // Collect form data
                const formData = {
                    officerName: document.getElementById('officerName').value.trim(),
                    designation: document.getElementById('designation').value.trim(),
                    district: document.getElementById('district').value,
                    block: document.getElementById('block').value.trim(),
                    formDate: document.getElementById('formDate').value,
                    contactNumber: document.getElementById('contactNumber').value.trim(),
                    stateSpecificNote: document.getElementById('stateSpecificNote').value.trim(),
                    backgroundNote: document.getElementById('backgroundNote').value.trim(),
                    feedbackCategory: document.getElementById('feedbackCategory').value,
                    priority: document.querySelector('input[name="priority"]:checked')?.value,
                    currentStatus: document.getElementById('currentStatus').value.trim(),
                    issues: document.getElementById('issues').value.trim(),
                    suggestions: document.getElementById('suggestions').value.trim(),
                    actionRequired: document.getElementById('actionRequired').value.trim(),
                    expectedDate: document.getElementById('expectedDate').value,
                    followup: document.querySelector('input[name="followup"]:checked')?.value,
                    additionalComments: document.getElementById('additionalComments').value.trim()
                };

                // Validate required fields
                const requiredFields = [
                    'officerName', 'designation', 'district', 'block', 'formDate',
                    'contactNumber', 'stateSpecificNote', 'backgroundNote', 'feedbackCategory', 
                    'priority', 'currentStatus', 'issues', 'suggestions', 
                    'actionRequired', 'expectedDate', 'followup'
                ];

                for (const field of requiredFields) {
                    if (!formData[field]) {
                        throw new Error(`Please fill all required fields.`);
                    }
                }

                // Submit feedback
                await submitFeedback(formData);

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                const errorMessage = error.message || 'Error submitting feedback.';
                showAlert(errorMessage, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Preview button
        document.getElementById('previewBtn').addEventListener('click', async function() {
            try {
                // Collect form data for preview
                const formData = {
                    officerName: document.getElementById('officerName').value.trim() || 'N/A',
                    designation: document.getElementById('designation').value.trim() || 'N/A',
                    district: document.getElementById('district').value,
                    districtName: document.getElementById('district').selectedOptions[0]?.text || 'N/A',
                    block: document.getElementById('block').value.trim() || 'N/A',
                    formDate: document.getElementById('formDate').value || 'N/A',
                    contactNumber: document.getElementById('contactNumber').value.trim() || 'N/A',
                    stateSpecificNote: document.getElementById('stateSpecificNote').value.trim() || 'N/A',
                    backgroundNote: document.getElementById('backgroundNote').value.trim() || 'N/A',
                    feedbackCategory: document.getElementById('feedbackCategory').value || 'N/A',
                    priority: document.querySelector('input[name="priority"]:checked')?.value || 'N/A',
                    currentStatus: document.getElementById('currentStatus').value.trim() || 'N/A',
                    issues: document.getElementById('issues').value.trim() || 'N/A',
                    suggestions: document.getElementById('suggestions').value.trim() || 'N/A',
                    actionRequired: document.getElementById('actionRequired').value.trim() || 'N/A',
                    expectedDate: document.getElementById('expectedDate').value || 'N/A',
                    followup: document.querySelector('input[name="followup"]:checked')?.value || 'N/A',
                    additionalComments: document.getElementById('additionalComments').value.trim() || ''
                };

                await generatePDF(formData, true);

            } catch (error) {
                console.error('Error generating preview:', error);
                showAlert('Error generating preview.', 'danger');
            }
        });

        // Admin panel event listeners
        if (document.getElementById('downloadSinglePDF')) {
            document.getElementById('downloadSinglePDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Downloading...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    // Download first feedback as sample
                    const feedbackData = {
                        ...feedbacks[0],
                        districtName: feedbacks[0].districts?.name || 'N/A'
                    };

                    await generatePDF(feedbackData, false);

                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    showAlert('Error downloading PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-pdf me-2"></i><span class="hindi">एकल PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('downloadBulkPDF')) {
            document.getElementById('downloadBulkPDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Preparing...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    await generateBulkPDF(feedbacks);
                    showAlert(`Bulk PDF download completed for ${feedbacks.length} feedbacks.`, 'success');

                } catch (error) {
                    console.error('Error downloading bulk PDF:', error);
                    showAlert('Error downloading bulk PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-archive me-2"></i><span class="hindi">बल्क PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('viewAllFeedbacks')) {
            document.getElementById('viewAllFeedbacks').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    await displayFeedbacksInModal(feedbacks);

                    const modal = new bootstrap.Modal(document.getElementById('feedbackListModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading feedbacks:', error);
                    showAlert('Error loading feedbacks.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-list me-2"></i><span class="hindi">सभी फीडबैक देखें</span>';
                }
            });
        }

        // Set default date range (last 30 days)
        if (document.getElementById('startDate') && document.getElementById('endDate')) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Make downloadSingleFeedbackPDF available globally
        window.downloadSingleFeedbackPDF = downloadSingleFeedbackPDF;

        // Form validation enhancements
        document.getElementById('contactNumber').addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            if (value.length !== 10) {
                e.target.setCustomValidity('Please enter a 10-digit mobile number.');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // Auto-save form data to localStorage (draft functionality)
        function saveFormDraft() {
            const formData = {
                officerName: document.getElementById('officerName').value,
                designation: document.getElementById('designation').value,
                district: document.getElementById('district').value,
                block: document.getElementById('block').value,
                formDate: document.getElementById('formDate').value,
                contactNumber: document.getElementById('contactNumber').value,
                stateSpecificNote: document.getElementById('stateSpecificNote').value,
                backgroundNote: document.getElementById('backgroundNote').value,
                feedbackCategory: document.getElementById('feedbackCategory').value,
                priority: document.querySelector('input[name="priority"]:checked')?.value,
                currentStatus: document.getElementById('currentStatus').value,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value,
                actionRequired: document.getElementById('actionRequired').value,
                expectedDate: document.getElementById('expectedDate').value,
                followup: document.querySelector('input[name="followup"]:checked')?.value,
                additionalComments: document.getElementById('additionalComments').value
            };
            
            localStorage.setItem('feedbackDraft', JSON.stringify(formData));
        }

        // Load form draft from localStorage
        function loadFormDraft() {
            const draft = localStorage.getItem('feedbackDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    document.getElementById('officerName').value = formData.officerName || '';
                    document.getElementById('designation').value = formData.designation || '';
                    document.getElementById('district').value = formData.district || '';
                    document.getElementById('block').value = formData.block || '';
                    document.getElementById('formDate').value = formData.formDate || '';
                    document.getElementById('contactNumber').value = formData.contactNumber || '';
                    document.getElementById('stateSpecificNote').value = formData.stateSpecificNote || '';
                    document.getElementById('backgroundNote').value = formData.backgroundNote || '';
                    document.getElementById('feedbackCategory').value = formData.feedbackCategory || '';
                    document.getElementById('currentStatus').value = formData.currentStatus || '';
                    document.getElementById('issues').value = formData.issues || '';
                    document.getElementById('suggestions').value = formData.suggestions || '';
                    document.getElementById('actionRequired').value = formData.actionRequired || '';
                    document.getElementById('expectedDate').value = formData.expectedDate || '';
                    document.getElementById('additionalComments').value = formData.additionalComments || '';
                    
                    if (formData.priority) {
                        const priorityRadio = document.querySelector(`input[name="priority"][value="${formData.priority}"]`);
                        if (priorityRadio) priorityRadio.checked = true;
                    }
                    
                    if (formData.followup) {
                        const followupRadio = document.querySelector(`input[name="followup"][value="${formData.followup}"]`);
                        if (followupRadio) followupRadio.checked = true;
                    }
                    
                    console.log('📝 Form draft loaded');
                } catch (error) {
                    console.error('Error loading form draft:', error);
                    localStorage.removeItem('feedbackDraft');
                }
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveFormDraft, 30000);

        // Save on form input change
        document.getElementById('feedbackForm').addEventListener('input', saveFormDraft);

        // Clear draft after successful submission
        function clearFormDraft() {
            localStorage.removeItem('feedbackDraft');
            console.log('📝 Form draft cleared');
        }

        // Load draft when page loads
        setTimeout(loadFormDraft, 1000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFormDraft();
                showAlert('Form draft saved.', 'info');
            }
            
            // Ctrl + Enter to submit form
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
        });

        // Handle network status
        window.addEventListener('online', () => {
            console.log('🌐 Network online');
            showAlert('Internet connection restored.', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('📡 Network offline');
            showAlert('Internet connection lost. Please check your connection.', 'danger');
        });

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('💥 Unhandled error:', e.error);
            showAlert('An unexpected error occurred. Please refresh the page.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection:', e.reason);
            showAlert('Data loading error. Please try again.', 'danger');
        });

        // Debug functions for development
        window.debugFeedback = {
            getCurrentUser: () => currentUser,
            getSupabaseClient: () => supabaseClient,
            loadDraft: loadFormDraft,
            saveDraft: saveFormDraft,
            clearDraft: clearFormDraft,
            testPDF: async () => {
                const sampleData = {
                    officerName: 'Test Officer',
                    designation: 'Assistant Director',
                    districtName: 'Raipur',
                    block: 'Raipur Block',
                    formDate: '2025-01-20',
                    contactNumber: '9876543210',
                    stateSpecificNote: 'This is a test state specific note for demonstration purposes.',
                    backgroundNote: 'This is a test background note providing context and background information.',
                    feedbackCategory: 'Agricultural Scheme',
                    priority: 'High',
                    currentStatus: 'The current status shows that the project is in progress with some challenges.',
                    issues: 'Main issues include resource allocation and timeline management.',
                    suggestions: 'Recommendations include better coordination and resource planning.',
                    actionRequired: 'Immediate action required to address the resource allocation issues.',
                    expectedDate: '2025-01-31',
                    followup: 'Yes',
                    additionalComments: 'Additional comments and observations for the feedback form.'
                };
                await generatePDF(sampleData, true);
            },
            getFormData: () => {
                return {
                    officerName: document.getElementById('officerName').value,
                    designation: document.getElementById('designation').value,
                    district: document.getElementById('district').value,
                    block: document.getElementById('block').value,
                    formDate: document.getElementById('formDate').value,
                    contactNumber: document.getElementById('contactNumber').value,
                    stateSpecificNote: document.getElementById('stateSpecificNote').value,
                    backgroundNote: document.getElementById('backgroundNote').value,
                    feedbackCategory: document.getElementById('feedbackCategory').value,
                    priority: document.querySelector('input[name="priority"]:checked')?.value,
                    currentStatus: document.getElementById('currentStatus').value,
                    issues: document.getElementById('issues').value,
                    suggestions: document.getElementById('suggestions').value,
                    actionRequired: document.getElementById('actionRequired').value,
                    expectedDate: document.getElementById('expectedDate').value,
                    followup: document.querySelector('input[name="followup"]:checked')?.value,
                    additionalComments: document.getElementById('additionalComments').value
                };
            }
        };

        // Add console welcome message
        console.log(`
        ╔══════════════════════════════════════════════════════════════╗
        ║                संचालनालय कृषि छत्तीसगढ़                      ║
        ║                   Feedback Form System                       ║
        ║                                                              ║
        ║  📝 Exact PDF Layout Matching                                ║
        ║  📊 Admin Dashboard with Statistics                          ║
        ║  📄 Single & Bulk PDF Download                               ║
        ║  💾 Auto-save Draft Functionality                            ║
        ║  🔍 Date-wise Filtering                                      ║
        ║                                                              ║
        ║  Keyboard Shortcuts:                                         ║
        ║  • Ctrl + S: Save Draft                                      ║
        ║  • Ctrl + Enter: Submit Form                                 ║
        ║                                                              ║
        ║  Debug: debugFeedback.testPDF() to test PDF                 ║
        ╚══════════════════════════════════════════════════════════════╝
        `);

        console.log('🎉 Feedback form script loaded successfully');
        console.log('💡 Use debugFeedback.testPDF() to test PDF generation');
    </script>
</body>
</html>

