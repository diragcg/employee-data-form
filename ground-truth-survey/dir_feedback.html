<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Form - संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Inter', sans-serif;
            font-weight: 500;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        /* Form Card - Exact PDF Layout */
        .form-card {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .form-body {
            padding: 2rem;
        }

        /* Template Sections */
        .template-section {
            margin-bottom: 3rem;
            border: 2px solid #000;
            background: var(--white);
        }

        .template-header {
            background: #f8f9fa;
            border-bottom: 2px solid #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .template-content {
            padding: 20px;
        }

        /* Form Fields */
        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
            display: block;
            color: #000;
        }

        .field-description {
            font-style: italic;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #000;
            background: var(--white);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Two Column Layout for Template 1 */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Officer Details Section */
        .officer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Submit Button */
        .submit-container {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            border-top: 2px solid var(--border-light);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 1rem 2.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 200px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            margin: 0 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Panel */
        .admin-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .admin-header {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            color: var(--white);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .admin-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .admin-body {
            padding: 1.5rem;
        }

        .stats-card {
            background: var(--light-green);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .admin-btn {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            border: none;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition);
            margin-bottom: 0.5rem;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .form-input-admin {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input-admin:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-label-admin {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: none;
            font-weight: 500;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }

        .alert-success {
            background: #E8F5E8;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }

        .alert-warning {
            background: #FFF3CD;
            color: #856404;
            border-left: 4px solid #FFC107;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Print Styles for PDF Generation */
        @media print {
            body {
                background: white;
                font-family: 'Times New Roman', serif;
                font-size: 12px;
                line-height: 1.4;
            }
            
            .header, .admin-panel, .submit-container {
                display: none !important;
            }
            
            .main-container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card {
                box-shadow: none;
                border: 2px solid #000;
            }
            
            .template-section {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .two-column {
                display: block;
            }
            
            .two-column .field-group {
                margin-bottom: 15px;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .admin-panel {
                position: static;
            }
            
            .two-column {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .form-body {
                padding: 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand img {
                height: 32px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }

            .officer-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार" class="cg-logo">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <div class="user-info">
                        <span id="userInfo" class="hindi"></span>
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            लॉगआउट
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="content-grid">
                <!-- Feedback Form -->
                <div class="form-card">
                    <div class="form-header">
                        <div class="form-title">Feedback Form</div>
                        <div class="form-subtitle">National Summit Templates</div>
                    </div>
                    
                    <div class="form-body">
                        <div id="alertBox" class="alert alert-danger" style="display: none;"></div>
                        
                        <form id="feedbackForm">
                            <!-- Template 1: State Specific Note & Background Note -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 1: State Specific Note & Background Note
                                </div>
                                <div class="template-content">
                                    <div class="two-column">
                                        <!-- Left Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">I. Introduction</label>
                                                <div class="field-description">(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)</div>
                                                <textarea class="form-textarea" id="introduction" rows="4" required></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">II. Current Situation</label>
                                                <div class="field-description">(Current policy landscape, programmes, schemes and their progress)</div>
                                                <textarea class="form-textarea" id="currentSituation" rows="4" required></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">III. Challenges</label>
                                                <div class="field-description">(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)</div>
                                                <textarea class="form-textarea" id="challenges" rows="4" required></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">IV. Possible Solutions</label>
                                                <div class="field-description">(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)</div>
                                                <textarea class="form-textarea" id="possibleSolutions" rows="4" required></textarea>
                                            </div>
                                        </div>

                                        <!-- Right Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">V. Best Practices</label>
                                                <div class="field-description">(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)</div>
                                                <textarea class="form-textarea" id="bestPractices" rows="4" required></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VI. Priority Areas</label>
                                                <div class="field-description">(Selected for implementation by the States in the next 5 years)</div>
                                                <textarea class="form-textarea" id="priorityAreas" rows="4" required></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VII. Way Forward - Strategy for Implementation</label>
                                                <div class="field-description">(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)</div>
                                                <textarea class="form-textarea" id="wayForwardStrategy" rows="4" required></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template 2: Feedback Note by Officers -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 2: Feedback Note by Officers
                                </div>
                                <div class="template-content">
                                    <!-- Section 1: Officer Name and Details -->
                                    <div class="field-group">
                                        <label class="field-label">Feedback Note (by all IAS officers / State Department Officers)</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Section 1: Officer Name and Details:</label>
                                        <div class="officer-details">
                                            <div>
                                                <label class="field-label">• Name:</label>
                                                <input type="text" class="form-input" id="officerName" required>
                                            </div>
                                            <div>
                                                <label class="field-label">• Designation:</label>
                                                <input type="text" class="form-input" id="designation" required>
                                            </div>
                                            <div>
                                                <label class="field-label">• Batch:</label>
                                                <input type="text" class="form-input" id="batch" required>
                                            </div>
                                            <div>
                                                <label class="field-label">• Current Posting:</label>
                                                <input type="text" class="form-input" id="currentPosting" required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 2: Feedback for Summit -->
                                    <div class="field-group">
                                        <label class="field-label">Section 2: Feedback for Summit on &lt;Theme name&gt;</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">1. Name of the sub theme</label>
                                        <div class="field-description">(Choose from the sub theme of the summit)</div>
                                        <textarea class="form-textarea" id="subThemeName" rows="3" required></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">2. Policy Gaps and Challenges</label>
                                        <div class="field-description">(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)</div>
                                        <textarea class="form-textarea" id="policyGapsChallenges" rows="4" required></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">3. Potential Solutions</label>
                                        <div class="field-description">(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)</div>
                                        <textarea class="form-textarea" id="potentialSolutions" rows="4" required></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">4. Best Practices</label>
                                        <div class="field-description">(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)</div>
                                        <textarea class="form-textarea" id="feedbackBestPractices" rows="4" required></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="submit-container">
                                <button type="submit" class="btn submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Submit Feedback
                                </button>
                                <button type="button" class="btn submit-btn" id="previewBtn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                                    <i class="fas fa-eye me-2"></i>
                                    Preview PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div class="admin-header">
                        <h3 class="hindi">फीडबैक प्रबंधन</h3>
                        <p class="hindi mb-0">रिपोर्ट और डाउनलोड</p>
                    </div>
                    <div class="admin-body">
                        <div class="stats-card">
                            <div class="stats-number" id="totalFeedbacks">0</div>
                            <div class="stats-label hindi">कुल फीडबैक</div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-number" id="todayFeedbacks">0</div>
                            <div class="stats-label hindi">आज के फीडबैक</div>
                        </div>

                        <div class="date-filter">
                            <label for="startDate" class="form-label-admin hindi">प्रारंभ दिनांक</label>
                            <input type="date" class="form-input-admin" id="startDate">
                        </div>

                        <div class="date-filter">
                            <label for="endDate" class="form-label-admin hindi">अंत दिनांक</label>
                            <input type="date" class="form-input-admin" id="endDate">
                        </div>

                        <button class="admin-btn" id="downloadSinglePDF">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span class="hindi">एकल PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="downloadBulkPDF">
                            <i class="fas fa-file-archive me-2"></i>
                            <span class="hindi">बल्क PDF डाउनलोड</span>
                        </button>

                        <button class="admin-btn" id="viewAllFeedbacks">
                            <i class="fas fa-list me-2"></i>
                            <span class="hindi">सभी फीडबैक देखें</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Feedback List Modal -->
    <div class="modal fade" id="feedbackListModal" tabindex="-1" aria-labelledby="feedbackListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="feedbackListModalLabel">फीडबैक सूची</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Officer Name</th>
                                    <th>Designation</th>
                                    <th>Batch</th>
                                    <th>Current Posting</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // Supabase configuration (same as login.html)
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    console.log('✓ Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('✗ Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('✗ Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'alertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = document.getElementById(elementId);
            if (!alertBox) {
                console.error('Alert box not found:', elementId);
                return;
            }
            
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Initialize Page
        async function initializePage() {
            console.log('🚀 Initializing feedback form page...');
            
            try {
                // Initialize Supabase first
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                // Get stored user
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                console.log('📦 Stored user data:', storedUser ? 'Found' : 'Not found');
                
                if (!storedUser) {
                    showAlert('Session expired. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                // Parse user data
                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('👤 Current user:', currentUser);
                
                // Update UI with user info
                const userInfo = `${currentUser.fullName || currentUser.username} (${currentUser.districtName || 'N/A'})`;
                document.getElementById('userInfo').textContent = userInfo;
                console.log('✓ User info updated');
                
                // Show admin panel if user is admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    console.log('✓ Admin panel enabled');
                    await loadFeedbackStats();
                }
                
                // Hide loading and show content
                hideLoading();
                
            } catch (error) {
                console.error('✗ Error initializing page:', error);
                hideLoading();
                showAlert('Error loading page. Please login again.', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // Load Feedback Statistics
        async function loadFeedbackStats() {
            try {
                // Get total feedbacks
                const { data: totalData, error: totalError, count: totalCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Get today's feedbacks
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData, error: todayError, count: todayCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' })
                    .gte('created_at', today + 'T00:00:00.000Z')
                    .lt('created_at', today + 'T23:59:59.999Z');

                if (todayError) throw todayError;

                document.getElementById('totalFeedbacks').textContent = totalCount || 0;
                document.getElementById('todayFeedbacks').textContent = todayCount || 0;

            } catch (error) {
                console.error('Error loading feedback stats:', error);
                document.getElementById('totalFeedbacks').textContent = '0';
                document.getElementById('todayFeedbacks').textContent = '0';
            }
        }

        // Submit Feedback Form
        async function submitFeedback(formData) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .insert([{
                        user_id: currentUser.id,
                        // Template 1 fields
                        introduction: formData.introduction,
                        current_situation: formData.currentSituation,
                        challenges: formData.challenges,
                        possible_solutions: formData.possibleSolutions,
                        best_practices: formData.bestPractices,
                        priority_areas: formData.priorityAreas,
                        way_forward_strategy: formData.wayForwardStrategy,
                        // Template 2 fields
                        officer_name: formData.officerName,
                        designation: formData.designation,
                        batch: formData.batch,
                        current_posting: formData.currentPosting,
                        sub_theme_name: formData.subThemeName,
                        policy_gaps_challenges: formData.policyGapsChallenges,
                        potential_solutions: formData.potentialSolutions,
                        feedback_best_practices: formData.feedbackBestPractices,
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('✅ Feedback submitted successfully:', data);
                showAlert('Feedback submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('feedbackForm').reset();
                
                // Clear draft after successful submission
                clearFormDraft();
                
                // Reload stats if admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    await loadFeedbackStats();
                }

                return data[0];

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                throw error;
            }
        }

        // Generate PDF with Exact Layout Matching
        async function generatePDF(feedbackData, isPreview = false) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF settings - exact margins as original
                const margin = 25;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Helper function to add text with proper formatting
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 11;
                    const maxWidth = options.maxWidth || contentWidth;
                    const lineHeight = options.lineHeight || fontSize * 0.4;
                    
                    pdf.setFontSize(fontSize);
                    if (options.bold) pdf.setFont(undefined, 'bold');
                    else if (options.italic) pdf.setFont(undefined, 'italic');
                    else pdf.setFont(undefined, 'normal');
                    
                    if (options.align) {
                        pdf.text(text, x, y, { align: options.align, maxWidth: maxWidth });
                        return y + lineHeight + 2;
                    } else {
                        const lines = pdf.splitTextToSize(text, maxWidth);
                        lines.forEach((line, index) => {
                            pdf.text(line, x, y + (index * lineHeight));
                        });
                        return y + (lines.length * lineHeight) + 3;
                    }
                }

                // Template 1: State Specific Note & Background Note
                yPosition = addText('Template 1: State Specific Note & Background Note', pageWidth / 2, yPosition, { 
                    fontSize: 16, bold: true, align: 'center' 
                });
                yPosition += 10;

                // Add National Summit headers (left and right)
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('National Summit', margin, yPosition);
                pdf.text('National Summit', pageWidth - margin - 30, yPosition);
                yPosition += 5;
                pdf.text('Theme:', margin, yPosition);
                pdf.text('Theme:', pageWidth - margin - 30, yPosition);
                yPosition += 5;
                pdf.text('Template: State Specific Note', margin, yPosition);
                pdf.text('Template: State Specific Note', pageWidth - margin - 50, yPosition);
                yPosition += 15;

                // Template 1 content in two columns
                const leftColX = margin;
                const rightColX = margin + (contentWidth / 2) + 10;
                const colWidth = (contentWidth / 2) - 10;
                let leftY = yPosition;
                let rightY = yPosition;

                // Left Column
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Template 1: State Specific Note', leftColX, leftY);
                leftY += 10;

                // I. Introduction
                pdf.setFont(undefined, 'bold');
                pdf.text('I.    Introduction', leftColX, leftY);
                leftY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const introDesc = '(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)';
                const introDescLines = pdf.splitTextToSize(introDesc, colWidth);
                introDescLines.forEach((line, index) => {
                    pdf.text(line, leftColX, leftY + (index * 3.5));
                });
                leftY += introDescLines.length * 3.5 + 5;

                // Draw box for Introduction
                pdf.rect(leftColX, leftY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.introduction) {
                    const introLines = pdf.splitTextToSize(feedbackData.introduction, colWidth - 4);
                    introLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, leftColX + 2, leftY + 5 + (index * 3.5));
                    });
                }
                leftY += 30;

                // II. Current Situation
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('II.   Current Situation', leftColX, leftY);
                leftY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const currDesc = '(Current policy landscape, programmes, schemes and their progress)';
                pdf.text(currDesc, leftColX, leftY);
                leftY += 8;

                // Draw box for Current Situation
                pdf.rect(leftColX, leftY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.currentSituation) {
                    const currLines = pdf.splitTextToSize(feedbackData.currentSituation, colWidth - 4);
                    currLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, leftColX + 2, leftY + 5 + (index * 3.5));
                    });
                }
                leftY += 30;

                // III. Challenges
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('III.  Challenges', leftColX, leftY);
                leftY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const challDesc = '(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)';
                const challDescLines = pdf.splitTextToSize(challDesc, colWidth);
                challDescLines.forEach((line, index) => {
                    pdf.text(line, leftColX, leftY + (index * 3.5));
                });
                leftY += challDescLines.length * 3.5 + 5;

                // Draw box for Challenges
                pdf.rect(leftColX, leftY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.challenges) {
                    const challLines = pdf.splitTextToSize(feedbackData.challenges, colWidth - 4);
                    challLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, leftColX + 2, leftY + 5 + (index * 3.5));
                    });
                }
                leftY += 30;

                // IV. Possible Solutions
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('IV.   Possible Solutions', leftColX, leftY);
                leftY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const solDesc = '(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)';
                const solDescLines = pdf.splitTextToSize(solDesc, colWidth);
                solDescLines.forEach((line, index) => {
                    pdf.text(line, leftColX, leftY + (index * 3.5));
                });
                leftY += solDescLines.length * 3.5 + 5;

                // Draw box for Possible Solutions
                pdf.rect(leftColX, leftY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.possibleSolutions) {
                    const solLines = pdf.splitTextToSize(feedbackData.possibleSolutions, colWidth - 4);
                    solLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, leftColX + 2, leftY + 5 + (index * 3.5));
                    });
                }

                // Right Column
                // V. Best Practices
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('V.    Best Practices', rightColX, rightY);
                rightY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const bestDesc = '(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)';
                const bestDescLines = pdf.splitTextToSize(bestDesc, colWidth);
                bestDescLines.forEach((line, index) => {
                    pdf.text(line, rightColX, rightY + (index * 3.5));
                });
                rightY += bestDescLines.length * 3.5 + 5;

                // Draw box for Best Practices
                pdf.rect(rightColX, rightY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.bestPractices) {
                    const bestLines = pdf.splitTextToSize(feedbackData.bestPractices, colWidth - 4);
                    bestLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, rightColX + 2, rightY + 5 + (index * 3.5));
                    });
                }
                rightY += 30;

                // VI. Priority Areas
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('VI.   Priority Areas', rightColX, rightY);
                rightY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const prioDesc = '(Selected for implementation by the States in the next 5 years)';
                pdf.text(prioDesc, rightColX, rightY);
                rightY += 8;

                // Draw box for Priority Areas
                pdf.rect(rightColX, rightY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.priorityAreas) {
                    const prioLines = pdf.splitTextToSize(feedbackData.priorityAreas, colWidth - 4);
                    prioLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, rightColX + 2, rightY + 5 + (index * 3.5));
                    });
                }
                rightY += 30;

                // VII. Way Forward - Strategy for Implementation
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('VII.  Way Forward - Strategy for Implementation', rightColX, rightY);
                rightY += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const wayDesc = '(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)';
                const wayDescLines = pdf.splitTextToSize(wayDesc, colWidth);
                wayDescLines.forEach((line, index) => {
                    pdf.text(line, rightColX, rightY + (index * 3.5));
                });
                rightY += wayDescLines.length * 3.5 + 5;

                // Draw box for Way Forward
                pdf.rect(rightColX, rightY, colWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.wayForwardStrategy) {
                    const wayLines = pdf.splitTextToSize(feedbackData.wayForwardStrategy, colWidth - 4);
                    wayLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, rightColX + 2, rightY + 5 + (index * 3.5));
                    });
                }

                // Add new page for Template 2
                pdf.addPage();
                yPosition = margin;

                // Template 2: Feedback Note by Officers
                yPosition = addText('Template 2: Feedback Note by Officers', pageWidth / 2, yPosition, { 
                    fontSize: 16, bold: true, align: 'center' 
                });
                yPosition += 10;

                // Add National Summit headers for Template 2
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('National Summit', margin, yPosition);
                pdf.text('National Summit', pageWidth - margin - 30, yPosition);
                yPosition += 5;
                pdf.text('Theme:', margin, yPosition);
                pdf.text('Theme:', pageWidth - margin - 30, yPosition);
                yPosition += 5;
                pdf.text('Template: Feedback Note', margin, yPosition);
                pdf.text('Template: Feedback Note', pageWidth - margin - 50, yPosition);
                yPosition += 15;

                // Feedback Note by all IAS officers / State Department Officers
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Feedback Note (by all IAS officers / State Department Officers)', margin, yPosition);
                yPosition += 10;

                // Section 1: Officer Name and Details
                pdf.setFont(undefined, 'bold');
                pdf.text('Section 1: Officer Name and Details:', margin, yPosition);
                yPosition += 8;

                pdf.setFont(undefined, 'normal');
                pdf.text(`• Name: ${feedbackData.officerName || ''}`, margin + 5, yPosition);
                yPosition += 6;
                pdf.text(`• Designation: ${feedbackData.designation || ''}`, margin + 5, yPosition);
                yPosition += 6;
                pdf.text(`• Batch: ${feedbackData.batch || ''}`, margin + 5, yPosition);
                yPosition += 6;
                pdf.text(`• Current Posting: ${feedbackData.currentPosting || ''}`, margin + 5, yPosition);
                yPosition += 15;

                // Section 2: Feedback for Summit
                pdf.setFont(undefined, 'bold');
                pdf.text('Section 2: Feedback for Summit on <Theme name>', margin, yPosition);
                yPosition += 10;

                // 1. Name of the sub theme
                pdf.setFont(undefined, 'bold');
                pdf.text('1. Name of the sub theme', margin, yPosition);
                yPosition += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                pdf.text('(Choose from the sub theme of the summit)', margin, yPosition);
                yPosition += 8;

                // Draw box for sub theme
                pdf.rect(margin, yPosition, contentWidth, 15);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.subThemeName) {
                    const subThemeLines = pdf.splitTextToSize(feedbackData.subThemeName, contentWidth - 4);
                    subThemeLines.slice(0, 3).forEach((line, index) => {
                        pdf.text(line, margin + 2, yPosition + 5 + (index * 4));
                    });
                }
                yPosition += 20;

                // 2. Policy Gaps and Challenges
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('2. Policy Gaps and Challenges', margin, yPosition);
                yPosition += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const policyDesc = '(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)';
                const policyDescLines = pdf.splitTextToSize(policyDesc, contentWidth);
                policyDescLines.forEach((line, index) => {
                    pdf.text(line, margin, yPosition + (index * 3.5));
                });
                yPosition += policyDescLines.length * 3.5 + 5;

                // Draw box for Policy Gaps
                pdf.rect(margin, yPosition, contentWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.policyGapsChallenges) {
                    const policyLines = pdf.splitTextToSize(feedbackData.policyGapsChallenges, contentWidth - 4);
                    policyLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, margin + 2, yPosition + 5 + (index * 3.5));
                    });
                }
                yPosition += 30;

                // 3. Potential Solutions
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('3. Potential Solutions', margin, yPosition);
                yPosition += 5;
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'italic');
                const potentialDesc = '(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)';
                const potentialDescLines = pdf.splitTextToSize(potentialDesc, contentWidth);
                potentialDescLines.forEach((line, index) => {
                    pdf.text(line, margin, yPosition + (index * 3.5));
                });
                yPosition += potentialDescLines.length * 3.5 + 5;

                // Draw box for Potential Solutions
                pdf.rect(margin, yPosition, contentWidth, 25);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                if (feedbackData.potentialSolutions) {
                    const potentialLines = pdf.splitTextToSize(feedbackData.potentialSolutions, contentWidth - 4);
                    potentialLines.slice(0, 6).forEach((line, index) => {
                        pdf.text(line, margin + 2, yPosition + 5 + (index * 3.5));
                    });
                }
                yPosition += 30;

                // Add large box on right side for Template 2
                const rightBoxX = margin + (contentWidth / 2) + 10;
                const rightBoxY = 50; // Start from top of page
                const rightBoxWidth = (contentWidth / 2) - 10;
                const rightBoxHeight = 80;

                pdf.rect(rightBoxX, rightBoxY, rightBoxWidth, rightBoxHeight);

                // 4. Best Practices (on right side)
                if (yPosition > 200) {
                    // Move to right column if we're running out of space
                    const rightColStartY = 180;
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('4. Best Practices', rightBoxX, rightColStartY);
                    
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'italic');
                    const bestPracticesDesc = '(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)';
                    const bestPracticesDescLines = pdf.splitTextToSize(bestPracticesDesc, rightBoxWidth);
                    bestPracticesDescLines.forEach((line, index) => {
                        pdf.text(line, rightBoxX, rightColStartY + 5 + (index * 3.5));
                    });
                    
                    const bestPracticesBoxY = rightColStartY + bestPracticesDescLines.length * 3.5 + 8;
                    pdf.rect(rightBoxX, bestPracticesBoxY, rightBoxWidth, 25);
                    
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    if (feedbackData.feedbackBestPractices) {
                        const bestPracticesLines = pdf.splitTextToSize(feedbackData.feedbackBestPractices, rightBoxWidth - 4);
                        bestPracticesLines.slice(0, 6).forEach((line, index) => {
                            pdf.text(line, rightBoxX + 2, bestPracticesBoxY + 5 + (index * 3.5));
                        });
                    }
                } else {
                    // Continue in left column
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('4. Best Practices', margin, yPosition);
                    yPosition += 5;
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'italic');
                    const bestPracticesDesc = '(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)';
                    const bestPracticesDescLines = pdf.splitTextToSize(bestPracticesDesc, contentWidth);
                    bestPracticesDescLines.forEach((line, index) => {
                        pdf.text(line, margin, yPosition + (index * 3.5));
                    });
                    yPosition += bestPracticesDescLines.length * 3.5 + 5;

                    // Draw box for Best Practices
                    pdf.rect(margin, yPosition, contentWidth, 25);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    if (feedbackData.feedbackBestPractices) {
                        const bestPracticesLines = pdf.splitTextToSize(feedbackData.feedbackBestPractices, contentWidth - 4);
                        bestPracticesLines.slice(0, 6).forEach((line, index) => {
                            pdf.text(line, margin + 2, yPosition + 5 + (index * 3.5));
                        });
                    }
                }

                // Add instructions at bottom
                const instructionsY = pageHeight - 40;
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Instructions for filing feedback note:', margin, instructionsY);
                
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.text('1. References:', margin + 10, instructionsY + 6);
                pdf.text('• In-text citing as well as the listing of all the references used for compiling the data', margin + 15, instructionsY + 10);
                pdf.text('and information.', margin + 20, instructionsY + 13);
                pdf.text('• Hyperlinks can be added in the document', margin + 15, instructionsY + 16);
                pdf.text('2. Documentation style:', margin + 10, instructionsY + 20);
                pdf.text('○ Microsoft Word - Paper Size A4 with one inch margin from all four sides', margin + 15, instructionsY + 24);

                if (isPreview) {
                    // Open in new tab for preview
                    const pdfBlob = pdf.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    window.open(url, '_blank');
                } else {
                    // Download PDF
                    const fileName = `feedback_${feedbackData.officerName || 'form'}_\${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                }

                return pdf;

            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        // Get Feedbacks by Date Range
        async function getFeedbacksByDateRange(startDate, endDate) {
            try {
                let query = supabaseClient
                    .from('feedbacks')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00.000Z');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59.999Z');
                }

                        const { data, error } = await query;

                if (error) throw error;

                return data || [];

            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                throw error;
            }
        }

        // Generate Bulk PDF
        async function generateBulkPDF(feedbacks) {
            try {
                const zip = new JSZip();

                for (let i = 0; i < feedbacks.length; i++) {
                    const feedback = feedbacks[i];
                    
                    // Generate PDF for each feedback
                    const pdf = await generatePDF(feedback, false);
                    const pdfBlob = pdf.output('blob');
                    
                    const fileName = `feedback_${feedback.officer_name || 'form'}_${feedback.created_at.split('T')[0]}.pdf`;
                    zip.file(fileName, pdfBlob);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip file
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedbacks_bulk_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error generating bulk PDF:', error);
                throw error;
            }
        }

        // Display Feedbacks in Modal
        async function displayFeedbacksInModal(feedbacks) {
            const tableBody = document.getElementById('feedbackTableBody');
            tableBody.innerHTML = '';

            if (feedbacks.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No feedbacks found</td>
                    </tr>
                `;
                return;
            }

            feedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                const createdDate = new Date(feedback.created_at).toLocaleDateString('en-US');
                
                row.innerHTML = `
                    <td>${createdDate}</td>
                    <td>${feedback.officer_name || 'N/A'}</td>
                    <td>${feedback.designation || 'N/A'}</td>
                    <td>${feedback.batch || 'N/A'}</td>
                    <td>${feedback.current_posting || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleFeedbackPDF('${feedback.id}')">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Download Single Feedback PDF
        async function downloadSingleFeedbackPDF(feedbackId) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .select('*')
                    .eq('id', feedbackId)
                    .single();

                if (error) throw error;

                await generatePDF(data, false);

            } catch (error) {
                console.error('Error downloading single feedback PDF:', error);
                showAlert('Error downloading PDF.', 'danger');
            }
        }

        // Auto-save form data to localStorage (draft functionality)
        function saveFormDraft() {
            const formData = {
                // Template 1 fields
                introduction: document.getElementById('introduction').value,
                currentSituation: document.getElementById('currentSituation').value,
                challenges: document.getElementById('challenges').value,
                possibleSolutions: document.getElementById('possibleSolutions').value,
                bestPractices: document.getElementById('bestPractices').value,
                priorityAreas: document.getElementById('priorityAreas').value,
                wayForwardStrategy: document.getElementById('wayForwardStrategy').value,
                // Template 2 fields
                officerName: document.getElementById('officerName').value,
                designation: document.getElementById('designation').value,
                batch: document.getElementById('batch').value,
                currentPosting: document.getElementById('currentPosting').value,
                subThemeName: document.getElementById('subThemeName').value,
                policyGapsChallenges: document.getElementById('policyGapsChallenges').value,
                potentialSolutions: document.getElementById('potentialSolutions').value,
                feedbackBestPractices: document.getElementById('feedbackBestPractices').value
            };
            
            localStorage.setItem('feedbackDraft', JSON.stringify(formData));
        }

        // Load form draft from localStorage
        function loadFormDraft() {
            const draft = localStorage.getItem('feedbackDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    // Template 1 fields
                    document.getElementById('introduction').value = formData.introduction || '';
                    document.getElementById('currentSituation').value = formData.currentSituation || '';
                    document.getElementById('challenges').value = formData.challenges || '';
                    document.getElementById('possibleSolutions').value = formData.possibleSolutions || '';
                    document.getElementById('bestPractices').value = formData.bestPractices || '';
                    document.getElementById('priorityAreas').value = formData.priorityAreas || '';
                    document.getElementById('wayForwardStrategy').value = formData.wayForwardStrategy || '';
                    // Template 2 fields
                    document.getElementById('officerName').value = formData.officerName || '';
                    document.getElementById('designation').value = formData.designation || '';
                    document.getElementById('batch').value = formData.batch || '';
                    document.getElementById('currentPosting').value = formData.currentPosting || '';
                    document.getElementById('subThemeName').value = formData.subThemeName || '';
                    document.getElementById('policyGapsChallenges').value = formData.policyGapsChallenges || '';
                    document.getElementById('potentialSolutions').value = formData.potentialSolutions || '';
                    document.getElementById('feedbackBestPractices').value = formData.feedbackBestPractices || '';
                    
                    console.log('📝 Form draft loaded');
                } catch (error) {
                    console.error('Error loading form draft:', error);
                    localStorage.removeItem('feedbackDraft');
                }
            }
        }

        // Clear draft after successful submission
        function clearFormDraft() {
            localStorage.removeItem('feedbackDraft');
            console.log('📝 Form draft cleared');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM Content Loaded');
            initializePage();
        });

        // Logout button
        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        // Feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('📝 Feedback form submitted');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Submitting...';
                
                // Collect form data
                const formData = {
                    // Template 1 fields
                    introduction: document.getElementById('introduction').value.trim(),
                    currentSituation: document.getElementById('currentSituation').value.trim(),
                    challenges: document.getElementById('challenges').value.trim(),
                    possibleSolutions: document.getElementById('possibleSolutions').value.trim(),
                    bestPractices: document.getElementById('bestPractices').value.trim(),
                    priorityAreas: document.getElementById('priorityAreas').value.trim(),
                    wayForwardStrategy: document.getElementById('wayForwardStrategy').value.trim(),
                    // Template 2 fields
                    officerName: document.getElementById('officerName').value.trim(),
                    designation: document.getElementById('designation').value.trim(),
                    batch: document.getElementById('batch').value.trim(),
                    currentPosting: document.getElementById('currentPosting').value.trim(),
                    subThemeName: document.getElementById('subThemeName').value.trim(),
                    policyGapsChallenges: document.getElementById('policyGapsChallenges').value.trim(),
                    potentialSolutions: document.getElementById('potentialSolutions').value.trim(),
                    feedbackBestPractices: document.getElementById('feedbackBestPractices').value.trim()
                };

                // Validate required fields
                const requiredFields = [
                    'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                    'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                    'officerName', 'designation', 'batch', 'currentPosting',
                    'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
                ];

                for (const field of requiredFields) {
                    if (!formData[field]) {
                        throw new Error(`Please fill all required fields.`);
                    }
                }

                // Submit feedback
                await submitFeedback(formData);

            } catch (error) {
                console.error('❌ Error submitting feedback:', error);
                const errorMessage = error.message || 'Error submitting feedback.';
                showAlert(errorMessage, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Preview button
        document.getElementById('previewBtn').addEventListener('click', async function() {
            try {
                // Collect form data for preview
                const formData = {
                    // Template 1 fields
                    introduction: document.getElementById('introduction').value.trim() || 'Sample introduction text for preview...',
                    currentSituation: document.getElementById('currentSituation').value.trim() || 'Sample current situation text for preview...',
                    challenges: document.getElementById('challenges').value.trim() || 'Sample challenges text for preview...',
                    possibleSolutions: document.getElementById('possibleSolutions').value.trim() || 'Sample possible solutions text for preview...',
                    bestPractices: document.getElementById('bestPractices').value.trim() || 'Sample best practices text for preview...',
                    priorityAreas: document.getElementById('priorityAreas').value.trim() || 'Sample priority areas text for preview...',
                    wayForwardStrategy: document.getElementById('wayForwardStrategy').value.trim() || 'Sample way forward strategy text for preview...',
                    // Template 2 fields
                    officerName: document.getElementById('officerName').value.trim() || 'Sample Officer Name',
                    designation: document.getElementById('designation').value.trim() || 'Sample Designation',
                    batch: document.getElementById('batch').value.trim() || 'Sample Batch',
                    currentPosting: document.getElementById('currentPosting').value.trim() || 'Sample Current Posting',
                    subThemeName: document.getElementById('subThemeName').value.trim() || 'Sample sub theme name for preview...',
                    policyGapsChallenges: document.getElementById('policyGapsChallenges').value.trim() || 'Sample policy gaps and challenges text for preview...',
                    potentialSolutions: document.getElementById('potentialSolutions').value.trim() || 'Sample potential solutions text for preview...',
                    feedbackBestPractices: document.getElementById('feedbackBestPractices').value.trim() || 'Sample feedback best practices text for preview...'
                };

                await generatePDF(formData, true);

            } catch (error) {
                console.error('Error generating preview:', error);
                showAlert('Error generating preview.', 'danger');
            }
        });

        // Admin panel event listeners
        if (document.getElementById('downloadSinglePDF')) {
            document.getElementById('downloadSinglePDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Downloading...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    // Download first feedback as sample
                    await generatePDF(feedbacks[0], false);

                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    showAlert('Error downloading PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-pdf me-2"></i><span class="hindi">एकल PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('downloadBulkPDF')) {
            document.getElementById('downloadBulkPDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Preparing...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    await generateBulkPDF(feedbacks);
                    showAlert(`Bulk PDF download completed for ${feedbacks.length} feedbacks.`, 'success');

                } catch (error) {
                    console.error('Error downloading bulk PDF:', error);
                    showAlert('Error downloading bulk PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-archive me-2"></i><span class="hindi">बल्क PDF डाउनलोड</span>';
                }
            });
        }

        if (document.getElementById('viewAllFeedbacks')) {
            document.getElementById('viewAllFeedbacks').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    await displayFeedbacksInModal(feedbacks);

                    const modal = new bootstrap.Modal(document.getElementById('feedbackListModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading feedbacks:', error);
                    showAlert('Error loading feedbacks.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-list me-2"></i><span class="hindi">सभी फीडबैक देखें</span>';
                }
            });
        }

        // Set default date range (last 30 days)
        if (document.getElementById('startDate') && document.getElementById('endDate')) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Make downloadSingleFeedbackPDF available globally
        window.downloadSingleFeedbackPDF = downloadSingleFeedbackPDF;

        // Auto-save every 30 seconds
        setInterval(saveFormDraft, 30000);

        // Save on form input change
        document.getElementById('feedbackForm').addEventListener('input', saveFormDraft);

        // Load draft when page loads
        setTimeout(loadFormDraft, 1000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFormDraft();
                showAlert('Form draft saved.', 'info');
            }
            
            // Ctrl + Enter to submit form
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
        });

        // Handle network status
        window.addEventListener('online', () => {
            console.log('🌐 Network online');
            showAlert('Internet connection restored.', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('📡 Network offline');
            showAlert('Internet connection lost. Please check your connection.', 'danger');
        });

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('💥 Unhandled error:', e.error);
            showAlert('An unexpected error occurred. Please refresh the page.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection:', e.reason);
            showAlert('Data loading error. Please try again.', 'danger');
        });

        // Form validation enhancements
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // Character counter for textareas
        function addCharacterCounter(textareaId, maxLength = 2000) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            const counter = document.createElement('div');
            counter.className = 'character-counter';
            counter.style.cssText = 'font-size: 0.8rem; color: #666; text-align: right; margin-top: 5px;';
            
            textarea.parentNode.insertBefore(counter, textarea.nextSibling);
            
            function updateCounter() {
                const length = textarea.value.length;
                counter.textContent = `${length}/${maxLength} characters`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = '#ff6b6b';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = '#ffa726';
                } else {
                    counter.style.color = '#666';
                }
            }
            
            updateCounter();
            textarea.addEventListener('input', updateCounter);
        }

        // Add character counters to all textareas
        setTimeout(() => {
            const textareaIds = [
                'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
            ];
            
            textareaIds.forEach(id => addCharacterCounter(id));
        }, 1500);

        // Debug functions for development
        window.debugFeedback = {
            getCurrentUser: () => currentUser,
            getSupabaseClient: () => supabaseClient,
            loadDraft: loadFormDraft,
            saveDraft: saveFormDraft,
            clearDraft: clearFormDraft,
            testPDF: async () => {
                const sampleData = {
                    introduction: 'This is a sample introduction explaining why this topic is important for States/UTs with supporting data evidence.',
                    currentSituation: 'Current policy landscape includes various programmes and schemes with their implementation progress.',
                    challenges: 'Major challenges include policy gaps, programmatic issues, and capacity building requirements.',
                    possibleSolutions: 'Proposed solutions involve stakeholder collaboration and convergence with existing schemes.',
                    bestPractices: 'International and national best practices include training initiatives, strategic communication campaigns, and new technologies.',
                    priorityAreas: 'Priority areas selected for implementation in the next 5 years include policy reforms and capacity building.',
                    wayForwardStrategy: 'Implementation strategy requires legal, administrative, technological, and budgetary reforms.',
                    officerName: 'Sample Officer Name',
                    designation: 'Joint Secretary',
                    batch: '2010',
                    currentPosting: 'Ministry of Agriculture',
                    subThemeName: 'Digital Agriculture and Technology Integration',
                    policyGapsChallenges: 'Current policy challenges include coordination between departments and implementation at ground level.',
                    potentialSolutions: 'Technology solutions include AI-based crop monitoring and integrated farmer support systems.',
                    feedbackBestPractices: 'Sustainable practices include farmer training programs, digital literacy initiatives, and scalable technology solutions.'
                };
                await generatePDF(sampleData, true);
            },
            getFormData: () => {
                return {
                    introduction: document.getElementById('introduction').value,
                    currentSituation: document.getElementById('currentSituation').value,
                    challenges: document.getElementById('challenges').value,
                    possibleSolutions: document.getElementById('possibleSolutions').value,
                    bestPractices: document.getElementById('bestPractices').value,
                    priorityAreas: document.getElementById('priorityAreas').value,
                    wayForwardStrategy: document.getElementById('wayForwardStrategy').value,
                    officerName: document.getElementById('officerName').value,
                    designation: document.getElementById('designation').value,
                    batch: document.getElementById('batch').value,
                    currentPosting: document.getElementById('currentPosting').value,
                    subThemeName: document.getElementById('subThemeName').value,
                    policyGapsChallenges: document.getElementById('policyGapsChallenges').value,
                    potentialSolutions: document.getElementById('potentialSolutions').value,
                    feedbackBestPractices: document.getElementById('feedbackBestPractices').value
                };
            }
        };

        // Add console welcome message
        console.log(`
        ╔══════════════════════════════════════════════════════════════╗
        ║                संचालनालय कृषि छत्तीसगढ़                      ║
        ║              National Summit Feedback System                 ║
        ║                                                              ║
        ║  📝 Template 1: State Specific Note & Background Note        ║
        ║  📋 Template 2: Feedback Note by Officers                    ║
        ║  📄 Exact PDF Layout Matching Original Templates             ║
        ║  📊 Admin Dashboard with Statistics                          ║
        ║  📦 Single & Bulk PDF Download                               ║
        ║  💾 Auto-save Draft Functionality                            ║
        ║  🔍 Date-wise Filtering                                      ║
        ║                                                              ║
        ║  Keyboard Shortcuts:                                         ║
        ║  • Ctrl + S: Save Draft                                      ║
        ║  • Ctrl + Enter: Submit Form                                 ║
        ║                                                              ║
        ║  Debug: debugFeedback.testPDF() to test PDF                 ║
        ╚══════════════════════════════════════════════════════════════╝
        `);

        console.log('🎉 National Summit Feedback form loaded successfully');
        console.log('💡 Use debugFeedback.testPDF() to test PDF generation with sample data');
    </script>
</body>
</html>


