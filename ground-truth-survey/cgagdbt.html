<!DOCTYPE html>
<html lang="en"> <!-- Changed to en for English-first form -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBT Data Entry - Directorate Agriculture Chhattisgarh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- External Libraries for PDF/Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> <!-- For Excel parsing -->
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --warning-bg: #FFF3CD;
            --warning-border: #FFEAA7;
            --warning-text: #856404;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Inter', sans-serif;
            font-weight: 500;
        }

        /* Header Styles (from selectmodule.html) */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .navbar-brand img.cg-logo {
            filter: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* User Info (Yellow) */
        #userInfo {
            background-color: #FFD700 !important;
            color: #000000 !important;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            border: 2px solid #FFC107;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        /* KCC Stats Dropdown (Green) */
        .stats-dropdown {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: var(--white) !important;
            padding: 0.5rem 1rem !important;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid #66BB6A;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-dropdown:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .quick-preview {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            min-width: 25px;
            text-align: center;
        }

        .stats-menu {
            min-width: 320px;
            padding: 1.2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stats-grid .stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, #f8f9fa 100%);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .stats-grid .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            background: linear-gradient(135deg, #f8f9fa 0%, var(--white) 100%);
        }

        .stats-grid .stat-item i {
            font-size: 1.4rem;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
            font-weight: 500;
            margin-bottom: 0.1rem;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-green);
            display: block;
            line-height: 1;
        }

        .percentage-stats, .additional-stats {
            background-color: var(--light-green);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
        }

        .percentage-stats .fw-bold, .additional-stats .fw-bold {
            color: var(--primary-green);
            font-size: 0.9rem;
        }

        /* Active Users Counter (Blue) */
        .active-users-nav {
            background-color: #2196F3 !important;
            color: var(--white) !important;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            border: 2px solid #1976D2;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .active-users-nav:hover {
            background-color: #1976D2 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        #activeUsersCount {
            font-size: 0.9rem;
            padding: 0.25rem 0.6rem;
            border-radius: 15px;
            animation: pulse 2s infinite;
            transition: var(--transition);
            background-color: var(--white) !important;
            color: #2196F3 !important;
            font-weight: 700;
        }

        #activeUsersCount:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Logout Button (Black) */
        .logout-btn {
            background-color: #000000 !important;
            border: 2px solid #333333 !important;
            color: var(--white) !important;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .logout-btn:hover {
            background-color: #333333 !important;
            border-color: #555555 !important;
            color: var(--white) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Main Content */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 140px);
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
            margin-bottom: 2rem; /* Added margin for separation */
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--accent-green);
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-header p {
            opacity: 0.9;
            margin: 0;
            font-size: 0.95rem;
        }

        .card-body {
            padding: 2rem;
        }

        .form-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-green);
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-light);
        }
        .form-section-title:first-of-type {
            margin-top: 0;
        }

        .form-group-custom {
            margin-bottom: 1.5rem;
        }

        .form-label-custom {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control-custom, .form-select-custom {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--text-primary);
        }

        .form-control-custom:focus, .form-select-custom:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Calculated/Readonly fields */
        .form-control-custom[readonly] {
            background-color: var(--gray-100);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .calc-display {
            background: var(--warning-bg) !important;
            border-color: var(--warning-border) !important;
            color: var(--warning-text) !important;
        }

        /* Action Buttons */
        .form-actions {
            margin-top: 2.5rem;
            text-align: center;
        }

        .btn-custom {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 0.875rem 2rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            min-width: 160px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            margin: 0 0.5rem;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-custom:active {
            transform: translateY(0);
        }

        .btn-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-draft {
            background: #6c757d;
            border-color: #6c757d;
        }
        .btn-draft:hover {
            background: #5a6268;
            border-color: #545b62;
        }

        .btn-download {
            background: #007bff;
            border-color: #007bff;
        }
        .btn-download:hover {
            background: #0069d9;
            border-color: #0062cc;
        }

        /* Data Display Table */
        .data-table-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            padding: 2rem;
        }

        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .data-table-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .table-responsive-custom {
            overflow-x: auto;
        }

        .table-custom {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table-custom th, .table-custom td {
            padding: 0.8rem;
            border: 1px solid var(--border-light);
            text-align: left;
            font-size: 0.9rem;
        }

        .table-custom th {
            background-color: var(--gray-100);
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap; /* Prevent wrapping in headers */
        }

        .table-custom tbody tr:nth-child(even) {
            background-color: var(--gray-50);
        }

        .table-custom tbody tr:hover {
            background-color: var(--light-green);
        }

        .table-actions .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }

        .btn-edit { background-color: #ffc107; border-color: #ffc107; color: #000; }
        .btn-edit:hover { background-color: #e0a800; border-color: #d39e00; color: #000; }
        .btn-delete { background-color: #dc3545; border-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; border-color: #bd2130; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            min-height: 50vh;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer (from selectmodule.html) */
        .footer {
            background: var(--gray-100);
            border-top: 1px solid var(--border-light);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 3rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                padding: 1.5rem;
            }
            .card-body {
                padding: 1.5rem;
            }
        }

        @media (max-width: 992px) {
            .user-info {
                flex-wrap: wrap;
                justify-content: flex-end;
                gap: 0.5rem;
            }
            .navbar-brand {
                font-size: 1.3rem;
            }
            .navbar-brand img {
                height: 35px;
            }
            .form-section-title {
                font-size: 1.2rem;
            }
            .btn-custom {
                width: 100%;
                margin: 0.5rem 0;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            .card-body {
                padding: 1rem;
            }
            .navbar-brand {
                font-size: 1.1rem;
            }
            .navbar-brand img {
                height: 30px;
            }
            .user-info {
                flex-direction: column;
                align-items: flex-end;
            }
            #userInfo, .stats-dropdown, .active-users-nav, .logout-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.8rem;
            }
            .quick-preview {
                font-size: 0.7rem;
                padding: 0.1rem 0.3rem;
            }
            .stats-dropdown span.hindi {
                display: none; /* Hide text for smaller screens */
            }
            .active-users-nav span.hindi {
                display: none; /* Hide text for smaller screens */
            }
            .stats-menu {
                min-width: unset;
                width: 250px;
                right: 0 !important;
                left: auto !important;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .card-header h2 {
                font-size: 1.3rem;
            }
            .form-control-custom, .form-select-custom {
                font-size: 0.9rem;
            }
            .table-custom th, .table-custom td {
                font-size: 0.8rem;
                padding: 0.6rem;
            }
            .data-table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="Chhattisgarh Government" class="cg-logo">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <div class="user-info">
                        <!-- User Info with Yellow Background -->
                        <span id="userInfo" class="hindi"></span>
                        
                        <!-- KCC Data Stats Dropdown with Green Background -->
                        <div class="dropdown">
                            <span class="nav-link stats-dropdown" data-bs-toggle="dropdown" title="KCC Data Statistics">
                                <i class="fas fa-chart-bar me-1"></i>
                                <span class="hindi">KCC Data</span>
                                <span id="quickStatsPreview" class="quick-preview">0</span>
                                <i class="fas fa-chevron-down ms-1"></i>
                            </span>
                            <div class="dropdown-menu dropdown-menu-end stats-menu">
                                <div class="dropdown-header hindi">KCC Data Statistics</div>
                                
                                <!-- Latest Entry Data -->
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <i class="fas fa-users text-success"></i>
                                        <div>
                                            <span class="stat-label hindi">Total Active KCC</span>
                                            <span id="totalActiveKCC" class="stat-value">0</span>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-check-circle text-primary"></i>
                                        <div>
                                            <span class="stat-label hindi">Saturated KCC</span>
                                            <span id="totalSaturatedKCC" class="stat-value">0</span>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-times-circle text-warning"></i>
                                        <div>
                                            <span class="stat-label hindi">Not Saturated KCC</span>
                                            <span id="totalNotSaturatedKCC" class="stat-value">0</span>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-user-times text-danger"></i>
                                        <div>
                                            <span class="stat-label hindi">Opt-out Holders</span>
                                            <span id="optOutHolders" class="stat-value">0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="dropdown-divider"></div>
                                
                                <!-- Percentage Analysis -->
                                <div class="percentage-stats">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted hindi">Saturation Rate:</small><br>
                                            <span id="saturationRate" class="fw-bold text-success">0%</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted hindi">Opt-out Rate:</small><br>
                                            <span id="optOutRate" class="fw-bold text-danger">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="dropdown-divider"></div>
                                
                                <!-- Entry Information -->
                                <div class="additional-stats">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted hindi">Region:</small><br>
                                            <span id="currentLocation" class="fw-bold">--</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted hindi">Entry Date:</small><br>
                                            <span id="lastEntryDate" class="fw-bold">--</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="dropdown-divider"></div>
                                
                                <a class="dropdown-item text-center hindi" href="#" onclick="showDetailedKCCReport()">
                                    <i class="fas fa-external-link-alt me-1"></i>View Detailed KCC Report
                                </a>
                            </div>
                        </div>
                        
                        <!-- Active Users Counter (Blue) -->
                        <span class="active-users-nav" id="activeUsersNavItem" title="Click to view active users details">
                            <i class="fas fa-users me-1"></i>
                            <span class="hindi">Active: </span>
                            <span id="activeUsersCount" class="badge">0</span>
                        </span>
                        
                        <!-- Logout Button (Black) -->
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- DBT Data Entry Form -->
            <div class="card">
                <div class="card-header">
                    <h2 class="hindi">DBT Data Entry</h2>
                    <p class="hindi">Enter latest DBT data or update existing entries.</p>
                </div>
                <div class="card-body">
                    <div id="formAlertBox" class="alert" style="display: none;"></div>
                    <form id="dbtEntryForm">
                        <input type="hidden" id="currentEntryId" value="">
                        <input type="hidden" id="currentEntryVersion" value="1">
                        <input type="hidden" id="currentPredecessorId" value="">

                        <!-- Section A.1: FY Scheme & Budget Selection -->
                        <div id="sectionA1">
                            <h4 class="form-section-title">A) FY Scheme & Budget</h4>
                            <h5 class="form-section-title">A.1) FY and Scheme Selection</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="schemeNameCode" class="form-label-custom">Scheme Name & Code *</label>
                                    <select id="schemeNameCode" class="form-select-custom" required>
                                        <option value="">-- Select Scheme --</option>
                                        <!-- Schemes will be loaded dynamically here -->
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="entryDate" class="form-label-custom">Select a Date to Add DBT Data *</label>
                                    <input type="date" id="entryDate" class="form-control-custom" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-custom btn-draft" data-section="A1">
                                    <i class="fas fa-save me-2"></i>Save A.1 as Draft
                                </button>
                            </div>
                        </div>

                        <!-- Section A.2: Budget Allocation -->
                        <div id="sectionA2" style="display: none;">
                            <h5 class="form-section-title">A.2) Budget Allocation</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="centralAllocation" class="form-label-custom">Central Allocation for the State (INR)</label>
                                    <input type="number" id="centralAllocation" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="stateNormativeAllocation" class="form-label-custom">State Normative Allocation (INR)</label>
                                    <input type="number" id="stateNormativeAllocation" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="additionalStateAllocation" class="form-label-custom">Additional State Allocation (if any) (INR)</label>
                                    <input type="number" id="additionalStateAllocation" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="budgetRemarks" class="form-label-custom">Remarks (if any relate to budget allocation)</label>
                                    <textarea id="budgetRemarks" class="form-control-custom" rows="2" placeholder="Enter remarks"></textarea>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-custom btn-draft" data-section="A2">
                                    <i class="fas fa-save me-2"></i>Save A.2 as Draft
                                </button>
                            </div>
                        </div>

                        <!-- Section B.1: Benefits Transferred -->
                        <div id="sectionB1" style="display: none;">
                            <h4 class="form-section-title">B) DBT Data Reporting</h4>
                            <h5 class="form-section-title">B.1) Benefits Transferred</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="totalAmountDisbursed" class="form-label-custom">Total Amount Disbursed</label>
                                    <input type="number" id="totalAmountDisbursed" class="form-control-custom calc-display" placeholder="0" value="0" min="0" step="0.01" readonly>
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="centralShareFundTransferred" class="form-label-custom">Central Share Fund Transferred</label>
                                    <input type="number" id="centralShareFundTransferred" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="normativeStateShareFundTransferred" class="form-label-custom">Normative - State Share Fund Transferred</label>
                                    <input type="number" id="normativeStateShareFundTransferred" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="additionalStateContributedFundTransferred" class="form-label-custom">Additional State Contributed Fund Transferred</label>
                                    <input type="number" id="additionalStateContributedFundTransferred" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="stateShareFundTransferredAdditionalBeneficiaries" class="form-label-custom">State Share Fund Transferred To Additional Beneficiaries Supported By State</label>
                                    <input type="number" id="stateShareFundTransferredAdditionalBeneficiaries" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="totalAmountDisbursedNonElectronic" class="form-label-custom">Total Amount Disbursed Through Non Electronic Mode (Cash, Cheque, DD, MO...)</label>
                                    <input type="number" id="totalAmountDisbursedNonElectronic" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="totalAmountDisbursedElectronic" class="form-label-custom">Total Amount Disbursed Through Electronic Mode (ABP, NEFT, RTGS, AEPS etc)</label>
                                    <input type="number" id="totalAmountDisbursedElectronic" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-custom btn-draft" data-section="B1">
                                    <i class="fas fa-save me-2"></i>Save B.1 as Draft
                                </button>
                            </div>
                        </div>

                        <!-- Section B.2: Beneficiary Details -->
                        <div id="sectionB2" style="display: none;">
                            <h5 class="form-section-title">B.2) Beneficiary Details</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="totalNumberOfBeneficiaries" class="form-label-custom">Total Number Of Beneficiaries</label>
                                    <input type="number" id="totalNumberOfBeneficiaries" class="form-control-custom calc-display" placeholder="0" value="0" min="0" readonly>
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numAdditionalBeneficiariesCSS" class="form-label-custom">Number Of Additional Beneficiaries Supported By State (CSS)</label>
                                    <input type="number" id="numAdditionalBeneficiariesCSS" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numAdditionalBeneficiariesStateScheme" class="form-label-custom">Number Of Additional Beneficiaries Supported By State (State Scheme)</label>
                                    <input type="number" id="numAdditionalBeneficiariesStateScheme" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesDigitized" class="form-label-custom">Number Of Beneficiaries - Digitized</label>
                                    <input type="number" id="numBeneficiariesDigitized" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesBankDetailsAvailable" class="form-label-custom">Number Of Beneficiaries - Bank Account Details Available With Department</label>
                                    <input type="number" id="numBeneficiariesBankDetailsAvailable" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesAadhaarSeeded" class="form-label-custom">Number Of Beneficiaries - Aadhaar Seeded</label>
                                    <input type="number" id="numBeneficiariesAadhaarSeeded" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesAadhaarAuthenticated" class="form-label-custom">Number Of Beneficiaries - Aadhaar Authenticated</label>
                                    <input type="number" id="numBeneficiariesAadhaarAuthenticated" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesMobileAvailable" class="form-label-custom">Number Of Beneficiaries - Mobile Number Available With Department</label>
                                    <input type="number" id="numBeneficiariesMobileAvailable" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesAmountDisbursedNonElectronic" class="form-label-custom">Number Of Beneficiaries - Amount Disbursed Through Non-Electronic Mode</label>
                                    <input type="number" id="numBeneficiariesAmountDisbursedNonElectronic" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numTransactionsNonElectronic" class="form-label-custom">Number Of Transactions Through Non-Electronic Mode</label>
                                    <input type="number" id="numTransactionsNonElectronic" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numTransactionsElectronic" class="form-label-custom">Number Of Transactions Through Electronic Mode</label>
                                    <input type="number" id="numTransactionsElectronic" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-custom btn-draft" data-section="B2">
                                    <i class="fas fa-save me-2"></i>Save B.2 as Draft
                                </button>
                            </div>
                        </div>

                        <!-- Section B.3: DBT Savings Data -->
                        <div id="sectionB3" style="display: none;">
                            <h5 class="form-section-title">B.3) DBT Savings Data</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numBeneficiariesRemovedDeduplication" class="form-label-custom">Number Of Beneficiaries Removed Due To De-Duplication Using Aadhaar</label>
                                    <input type="number" id="numBeneficiariesRemovedDeduplication" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="numGhostFakeBeneficiariesRemoved" class="form-label-custom">Number Of Ghost/Fake Beneficiaries Removed</label>
                                    <input type="number" id="numGhostFakeBeneficiariesRemoved" class="form-control-custom" placeholder="0" value="0" min="0">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="otherSavingsProcessImprovement" class="form-label-custom">Other Savings Due To Process Improvement Efficiency</label>
                                    <input type="number" id="otherSavingsProcessImprovement" class="form-control-custom" placeholder="0" value="0" min="0" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3 form-group-custom">
                                    <label for="savingAmountINR" class="form-label-custom">Saving Amount (in INR)</label>
                                    <input type="number" id="savingAmountINR" class="form-control-custom calc-display" placeholder="0" value="0" min="0" step="0.01" readonly>
                                </div>
                            </div>
                            <!-- Change Reason for updates -->
                            <div class="row g-3" id="changeReasonRow" style="display:none;">
                                <div class="col-md-12 mb-3 form-group-custom">
                                    <label for="changeReason" class="form-label-custom">Change Reason *</label>
                                    <textarea id="changeReason" class="form-control-custom" rows="2" placeholder="REQUIRED: Reason for this update"></textarea>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="clearFormBtn" class="btn btn-custom btn-draft">
                                    <i class="fas fa-eraser me-2"></i>Clear Form
                                </button>
                                <button type="submit" id="finalSubmitBtn" class="btn btn-custom">
                                    <i class="fas fa-upload me-2"></i>Final Submit
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Existing DBT Data Table -->
            <div class="data-table-container">
                <div class="data-table-header">
                    <h3 class="hindi">Existing DBT Data</h3>
                    <div class="data-table-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadDbtEntries()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button class="btn btn-download btn-sm" id="downloadDataBtn">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                <div id="dataTableAlertBox" class="alert" style="display: none;"></div>
                <div class="table-responsive-custom">
                    <table class="table-custom" id="dbtEntriesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Scheme</th>
                                <th>District</th>
                                <th>Total Active KCC</th>
                                <th>Saturated KCC</th>
                                <th>Not Saturated KCC</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dbtEntriesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted hindi">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noDataFound" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <p class="hindi">No DBT data found.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Scheme Upload Modal -->
    <div class="modal fade" id="schemeUploadModal" tabindex="-1" aria-labelledby="schemeUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #455A64 0%, #546E7A 100%); color: white;">
                    <h5 class="modal-title hindi" id="schemeUploadModalLabel">Upload Schemes from Excel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="schemeUploadAlertBox" class="alert" style="display: none;"></div>
                    <p class="hindi mb-3">Please upload an Excel file (.xlsx) containing "Scheme Name" and "Scheme Code" columns.</p>
                    <div class="mb-3">
                        <label for="schemeExcelFile" class="form-label-custom">Choose Excel File *</label>
                        <input class="form-control-custom" type="file" id="schemeExcelFile" accept=".xlsx" required>
                    </div>
                    <p class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        The Excel file must have columns named "Scheme Name" and "Scheme Code".
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom" id="uploadSchemesBtn">
                        <i class="fas fa-upload me-2"></i>Upload Schemes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Users Detail Modal (from selectmodule.html) -->
    <div class="modal fade" id="activeUsersModal" tabindex="-1" aria-labelledby="activeUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="activeUsersModalLabel">Active User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="hindi mb-0">Total Active Users: <span id="totalActiveUsers" class="text-success fw-bold">0</span></h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshActiveUsers()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th class="hindi">Name</th>
                                    <th class="hindi">District</th>
                                    <th class="hindi">Role</th>
                                    <th class="hindi">Last Activity</th>
                                    <th class="hindi">Status</th>
                                </tr>
                            </thead>
                            <tbody id="activeUsersTable">
                                <tr>
                                    <td colspan="5" class="text-center text-muted hindi">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Options Modal -->
    <div class="modal fade" id="downloadOptionsModal" tabindex="-1" aria-labelledby="downloadOptionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="downloadOptionsModalLabel">Download Options</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="hindi mb-4">In what format would you like to download the data?</p>
                    <button class="btn btn-custom me-3" id="downloadPdfBtn">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </button>
                    <button class="btn btn-custom btn-draft" id="downloadExcelBtn">
                        <i class="fas fa-file-excel me-2"></i>Download Excel (CSV)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p class="mb-0 hindi">&copy; 2025 Directorate Agriculture Chhattisgarh. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <script>
        console.log('DBT Data Entry Script starting...');
        
        // Supabase configuration
        const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;
        let currentEditingEntryId = null; // To track which entry is being edited
        let currentStep = 1; // Tracks the current visible form section (1-5 for A1, A2, B1, B2, B3)

        // Active Users Tracking Variables
        let heartbeatInterval;
        let isUserActive = true;

        // Helper for DOM element selection
        const $ = (id) => document.getElementById(id);

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('✓ Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('✗ Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('✗ Failed to initialize Supabase: ', error);
                return false;
            }
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'formAlertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = $(elementId);
            if (!alertBox) {
                console.error('Alert box not found: ', elementId);
                return;
            }
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`; // Removed hindi class as per new request
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            $('loadingState').style.display = 'none';
            $('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            $('loadingState').style.display = 'flex';
            $('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) { // Changed to English
                if (currentUser && currentUser.id) {
                    updateUserOnlineStatus(currentUser.id, false);
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                }
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'selectmodule.html';
            }
        }

        // Active Users Tracking Functions (copied from selectmodule.html)
        function trackUserActivity() {
            isUserActive = true;
        }
        document.addEventListener('mousemove', trackUserActivity);
        document.addEventListener('keypress', trackUserActivity);
        document.addEventListener('click', trackUserActivity);
        document.addEventListener('scroll', trackUserActivity);

        async function updateUserOnlineStatus(userId, isOnline = true) {
            try {
                await supabaseClient
                    .from('test_users')
                    .update({ 
                        is_online: isOnline,
                        last_activity: new Date().toISOString()
                    })
                    .eq('id', userId);
                console.log(`User ${userId} status updated: ${isOnline ? 'online' : 'offline'}`);
            } catch (error) {
                console.error('Error updating online status: ', error);
            }
        }

        async function sendHeartbeat(userId) {
            if (isUserActive) {
                await updateUserOnlineStatus(userId, true);
                isUserActive = false;
            }
        }

        function startUserSession(userData) {
            updateUserOnlineStatus(userData.id, true);
            heartbeatInterval = setInterval(() => {
                sendHeartbeat(userData.id);
            }, 30000);
            window.addEventListener('beforeunload', () => {
                updateUserOnlineStatus(userData.id, false);
            });
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    updateUserOnlineStatus(userData.id, false);
                } else {
                    updateUserOnlineStatus(userData.id, true);
                }
            });
        }

        async function getActiveUsersCount() {
            try {
                const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
                const { count } = await supabaseClient
                    .from('test_users')
                    .select('id', { count: 'exact' })
                    .eq('is_online', true)
                    .gte('last_activity', twoMinutesAgo);
                return count || 0;
            } catch (error) {
                console.error('Error getting active users count: ', error);
                return 0;
            }
        }

        async function updateActiveUsersDisplay() {
            const count = await getActiveUsersCount();
            const counterElement = $('activeUsersCount');
            if (counterElement) {
                const currentCount = parseInt(counterElement.textContent) || 0;
                counterElement.textContent = count;
                if (count !== currentCount) {
                    counterElement.style.transform = 'scale(1.3)';
                    counterElement.style.transition = 'transform 0.2s ease';
                    setTimeout(() => {
                        counterElement.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        }

        async function getActiveUsersList() {
            try {
                const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
                const { data } = await supabaseClient
                    .from('test_users')
                    .select(`id, full_name, role, last_activity, districts(name)`)
                    .eq('is_online', true)
                    .gte('last_activity', twoMinutesAgo)
                    .order('last_activity', { ascending: false });
                return data || [];
            } catch (error) {
                console.error('Error getting active users list: ', error);
                return [];
            }
        }

        async function showActiveUsersModal() {
            const users = await getActiveUsersList();
            const tableBody = $('activeUsersTable');
            const totalElement = $('totalActiveUsers');
            totalElement.textContent = users.length;
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No active users found</td></tr>`; // Changed to English
            } else {
                tableBody.innerHTML = users.map(user => {
                    const lastActivity = new Date(user.last_activity);
                    const timeAgo = Math.floor((Date.now() - lastActivity.getTime()) / 1000);
                    let timeDisplay;
                    if (timeAgo < 60) timeDisplay = timeAgo + 's ago';
                    else if (timeAgo < 3600) timeDisplay = Math.floor(timeAgo/60) + 'm ago';
                    else timeDisplay = Math.floor(timeAgo/3600) + 'h ago';
                    return `
                        <tr>
                            <td>${user.full_name || 'N/A'}</td>
                            <td>${user.districts?.name || 'N/A'}</td>
                            <td><span class="badge bg-info">${user.role || 'User'}</span></td>
                            <td><span style="color: var(--text-secondary); font-size: 0.8rem;">${timeDisplay}</span></td>
                            <td><span class="online-indicator"></span><small class="text-success">Online</small></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function refreshActiveUsers() {
            await showActiveUsersModal();
            await updateActiveUsersDisplay();
        }

        $('activeUsersNavItem').addEventListener('click', function() {
            showActiveUsersModal();
            const modal = new bootstrap.Modal($('activeUsersModal'));
            modal.show();
        });

        async function cleanupOfflineUsers() {
            try {
                const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000).toISOString();
                await supabaseClient
                    .from('test_users')
                    .update({ is_online: false })
                    .lt('last_activity', threeMinutesAgo)
                    .eq('is_online', true);
                console.log('Cleaned up offline users');
            } catch (error) {
                console.error('Error cleaning up offline users: ', error);
            }
        }
        setInterval(cleanupOfflineUsers, 2 * 60 * 1000);

        // KCC Data Stats Functions (from selectmodule.html, adjusted for this page)
        async function getKCCDataStats() {
            try {
                const userId = currentUser.id;
                const userRole = currentUser.role?.toLowerCase();
                const isAdmin = userRole === 'admin' || userRole === 'state_admin';

                if (isAdmin) {
                    const { data: stateData, error } = await supabaseClient
                        .from('kcc_entries')
                        .select(`total_active_kcc, total_kcc_saturated, total_kcc_not_saturated, opt_out_holders_count, entry_date, district_name`)
                        .eq('is_current', true)
                        .order('entry_date', { ascending: false });

                    if (error) throw error;

                    let stateTotals = {
                        total_active_kcc: 0,
                        total_kcc_saturated: 0,
                        total_kcc_not_saturated: 0,
                        opt_out_holders_count: 0,
                        district_count: 0,
                        latest_date: null
                    };

                    const districtMap = new Map();
                    stateData.forEach(entry => {
                        const district = entry.district_name;
                        const entryDate = new Date(entry.entry_date);
                        if (!districtMap.has(district) || entryDate > new Date(districtMap.get(district).entry_date)) {
                            districtMap.set(district, entry);
                        }
                    });

                    districtMap.forEach(entry => {
                        stateTotals.total_active_kcc += entry.total_active_kcc || 0;
                        stateTotals.total_kcc_saturated += entry.total_kcc_saturated || 0;
                        stateTotals.total_kcc_not_saturated += entry.total_kcc_not_saturated || 0;
                        stateTotals.opt_out_holders_count += entry.opt_out_holders_count || 0;
                        stateTotals.district_count++;
                        if (!stateTotals.latest_date || new Date(entry.entry_date) > new Date(stateTotals.latest_date)) {
                            stateTotals.latest_date = entry.entry_date;
                        }
                    });

                    return { latest: stateTotals, isStateData: true, districtCount: stateTotals.district_count };

                } else {
                    const { data: userEntries, error } = await supabaseClient
                        .from('kcc_entries')
                        .select(`id, district_name, entry_date, total_active_kcc, total_kcc_saturated, total_kcc_not_saturated, opt_out_holders_count, non_saturation_reason, created_at`)
                        .eq('created_by', userId)
                        .eq('is_current', true)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (error) throw error;
                    return { latest: userEntries?.[0] || null, isStateData: false };
                }
            } catch (error) {
                console.error('Error fetching KCC data stats: ', error);
                return { latest: null, isStateData: false };
            }
        }

        async function updateKCCDataStats() {
            try {
                console.log('🔄 Updating KCC data statistics...');
                const stats = await getKCCDataStats();
                const userRole = currentUser.role?.toLowerCase();
                const isAdmin = userRole === 'admin' || userRole === 'state_admin';

                if (stats.latest) {
                    const data = stats.latest;
                    document.getElementById('totalActiveKCC').textContent = data.total_active_kcc || 0;
                    document.getElementById('totalSaturatedKCC').textContent = data.total_kcc_saturated || 0;
                    document.getElementById('totalNotSaturatedKCC').textContent = data.total_kcc_not_saturated || 0;
                    document.getElementById('optOutHolders').textContent = data.opt_out_holders_count || 0;
                    
                    const totalActive = data.total_active_kcc || 0;
                    const saturated = data.total_kcc_saturated || 0;
                    const optOut = data.opt_out_holders_count || 0;
                    
                    const saturationRate = totalActive > 0 ? Math.round((saturated / totalActive) * 100) : 0;
                    const optOutRate = totalActive > 0 ? Math.round((optOut / totalActive) * 100) : 0;
                    
                    document.getElementById('saturationRate').textContent = saturationRate + '%';
                    document.getElementById('optOutRate').textContent = optOutRate + '%';
                    
                    if (isAdmin) {
                        document.getElementById('currentLocation').textContent = `Chhattisgarh State (${stats.districtCount} districts)`; // Changed to English
                        const entryDate = new Date(data.latest_date);
                        document.getElementById('lastEntryDate').textContent = entryDate.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'}); // Changed to English date format
                    } else {
                        document.getElementById('currentLocation').textContent = data.district_name || 'N/A';
                        const entryDate = new Date(data.entry_date);
                        document.getElementById('lastEntryDate').textContent = entryDate.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'}); // Changed to English date format
                    }
                    
                    document.getElementById('quickStatsPreview').textContent = totalActive;
                    
                    const satRateElement = document.getElementById('saturationRate');
                    if (saturationRate >= 80) satRateElement.className = 'fw-bold text-success';
                    else if (saturationRate >= 60) satRateElement.className = 'fw-bold text-warning';
                    else satRateElement.className = 'fw-bold text-danger';
                    
                    console.log(`✅ KCC ${isAdmin ? 'state' : 'district'} stats updated:`, data);
                } else {
                    document.getElementById('totalActiveKCC').textContent = '0';
                    document.getElementById('totalSaturatedKCC').textContent = '0';
                    document.getElementById('totalNotSaturatedKCC').textContent = '0';
                    document.getElementById('optOutHolders').textContent = '0';
                    document.getElementById('saturationRate').textContent = '0%';
                    document.getElementById('optOutRate').textContent = '0%';
                    document.getElementById('currentLocation').textContent = isAdmin ? 'No State Data' : 'No Data'; // Changed to English
                    document.getElementById('lastEntryDate').textContent = '--';
                    document.getElementById('quickStatsPreview').textContent = '0';
                }
            } catch (error) {
                console.error('❌ Error updating KCC data stats: ', error);
            }
        }

        function showDetailedKCCReport() {
            const userRole = currentUser.role?.toLowerCase();
            const isAdmin = userRole === 'admin' || userRole === 'state_admin';
            
            const totalActive = document.getElementById('totalActiveKCC').textContent;
            const saturated = document.getElementById('totalSaturatedKCC').textContent;
            const notSaturated = document.getElementById('totalNotSaturatedKCC').textContent;
            const optOut = document.getElementById('optOutHolders').textContent;
            const satRate = document.getElementById('saturationRate').textContent;
            const location = document.getElementById('currentLocation').textContent;
            
            const reportTitle = isAdmin ? '🏛️ State-wide KCC Report:' : '📊 District KCC Report:'; // Changed to English
            const locationLabel = isAdmin ? '🗺️ Region:' : '🏢 District:'; // Changed to English
            
            const reportText = `${reportTitle}\n\n` +
                `${locationLabel} ${location}\n` +
                `👥 Total Active KCC: ${totalActive}\n` + // Changed to English
                `✅ Saturated KCC: ${saturated}\n` + // Changed to English
                `❌ Not Saturated KCC: ${notSaturated}\n` + // Changed to English
                `🚫 Opt-out Holders: ${optOut}\n` + // Changed to English
                `📈 Saturation Rate: ${satRate}\n\n` + // Changed to English
                `${isAdmin ? '💡 This is combined data from all districts.' : '💡 This is the latest data for your district.'}`; // Changed to English
            
            alert(reportText);
            console.log(`${isAdmin ? 'State-wide' : 'District'} KCC report for:`, currentUser.username);
        }

        // Main Application Logic
        async function initializePage() {
            console.log('🚀 Initializing DBT Data Entry page...');
            try {
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                if (!storedUser) {
                    showAlert('Session expired or not logged in. Redirecting...', 'danger'); // Changed to English
                    setTimeout(() => window.location.href = 'selectmodule.html', 2000);
                    return;
                }

                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('👤 Current user: ', currentUser);
                
                const userInfo = `${currentUser.fullName || currentUser.username} (${currentUser.districtName || 'N/A'})`;
                $('userInfo').textContent = userInfo;
                console.log('✓ User info updated');
                
                // Update form district display
                $('district_name_display').value = currentUser.districtName || '';
                $('district_id').value = currentUser.districtId || '';

                startUserSession(currentUser);
                updateActiveUsersDisplay();
                setInterval(updateActiveUsersDisplay, 30000);

                updateKCCDataStats();
                setInterval(updateKCCDataStats, 2 * 60 * 1000);
                
                // Set default entry date to today
                $('entryDate').valueAsDate = new Date();

                await loadSchemes(); // Load schemes for dropdown

                // Load existing draft or start new entry
                await loadCurrentDraft();

                await loadDbtEntries(); // Load existing entries into table
                hideLoading();
                
            } catch (error) {
                console.error('✗ Error initializing page: ', error);
                hideLoading();
                showAlert('Error loading page. Please try again.', 'danger'); // Changed to English
                setTimeout(() => window.location.href = 'selectmodule.html', 2000);
            }
        }

        // --- Multi-Step Form Logic ---
        const sections = ['sectionA1', 'sectionA2', 'sectionB1', 'sectionB2', 'sectionB3'];
        const sectionMap = { 'A1': 0, 'A2': 1, 'B1': 2, 'B2': 3, 'B3': 4 };

        function showSection(stepIndex) {
            sections.forEach((sectionId, index) => {
                const sectionElement = $(sectionId);
                if (sectionElement) {
                    sectionElement.style.display = index <= stepIndex ? 'block' : 'none';
                }
            });
            currentStep = stepIndex + 1; // Update global currentStep
            console.log(`Current form section: ${sections[stepIndex]} (Step ${currentStep})`);
        }

        // Call this when a section's "Save as Draft" is clicked
        async function saveSectionDraft(sectionId) {
            const sectionIndex = sectionMap[sectionId];
            if (!validateSection(sectionId)) {
                return;
            }

            const status = (sectionId === 'B3') ? 'submitted' : 'draft';
            await saveDbtEntry(status, sectionId);

            if (status === 'draft') {
                nextStep(); // Only move to next step if it's a draft save
            } else {
                // Final submit, clear form and reset to first step
                clearForm();
                showSection(0);
            }
        }

        function nextStep() {
            if (currentStep < sections.length) {
                showSection(currentStep); // Show the next section
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
            }
        }

        // Validate individual section fields
        function validateSection(sectionId) {
            const sectionElement = $(sectionId);
            if (!sectionElement) return false;

            const inputs = sectionElement.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    input.reportValidity(); // Show browser validation message
                    isValid = false;
                }
            });
            
            // Add custom validation for calculated fields if they are source of error
            if (sectionId === 'B1') {
                const totalAmountDisbursed = parseFloat($('totalAmountDisbursed').value) || 0;
                const totalNonElectronic = parseFloat($('totalAmountDisbursedNonElectronic').value) || 0;
                const totalElectronic = parseFloat($('totalAmountDisbursedElectronic').value) || 0;
                if (Math.abs(totalAmountDisbursed - (totalNonElectronic + totalElectronic)) > 0.01) {
                    showAlert('Total Amount Disbursed does not match sum of electronic and non-electronic modes.', 'danger', 'formAlertBox');
                    isValid = false;
                }
            }
            if (sectionId === 'B2') {
                const totalBeneficiaries = parseInt($('totalNumberOfBeneficiaries').value) || 0;
                const numAdditionalCSS = parseInt($('numAdditionalBeneficiariesCSS').value) || 0;
                const numAdditionalState = parseInt($('numAdditionalBeneficiariesStateScheme').value) || 0;
                 if (totalBeneficiaries !== (numAdditionalCSS + numAdditionalState)) {
                    showAlert('Total Number Of Beneficiaries does not match sum of additional beneficiaries.', 'danger', 'formAlertBox');
                    isValid = false;
                }
            }
             if (sectionId === 'B3') {
                const savingAmount = parseFloat($('savingAmountINR').value) || 0;
                const otherSavings = parseFloat($('otherSavingsProcessImprovement').value) || 0;
                if (savingAmount !== otherSavings) {
                    showAlert('Saving Amount (in INR) must match Other Savings Due To Process Improvement Efficiency.', 'danger', 'formAlertBox');
                    isValid = false;
                }
            }

            return isValid;
        }

        // Load current draft for the user, if any
        async function loadCurrentDraft() {
            try {
                const { data: draftEntry, error } = await supabaseClient
                    .from('dbt_entries')
                    .select('*')
                    .eq('created_by', currentUser.id)
                    .eq('status', 'draft')
                    .eq('is_current', true)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 is "No rows found"
                    throw error;
                }

                if (draftEntry) {
                    currentEditingEntryId = draftEntry.id;
                    populateForm(draftEntry);
                    // Determine which section to show based on data availability
                    let lastCompletedSectionIndex = 0;
                    if (draftEntry.scheme_name_code) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['A1']);
                    if (draftEntry.central_allocation !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['A2']);
                    if (draftEntry.total_amount_disbursed !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B1']);
                    if (draftEntry.total_number_of_beneficiaries !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B2']);
                    if (draftEntry.saving_amount_inr !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B3']);
                    
                    showSection(lastCompletedSectionIndex);
                    // If it's a full draft, set to the last section for final submit
                    if (lastCompletedSectionIndex === sectionMap['B3']) {
                        currentStep = sectionMap['B3'] + 1; // Ready for final submit
                    } else {
                        currentStep = lastCompletedSectionIndex + 1; // Ready for next section
                    }

                    // Show change reason row if loading an existing draft
                    $('changeReasonRow').style.display = 'block';

                    showAlert('Existing draft loaded. Please complete and submit.', 'info', 'formAlertBox'); // Changed to English
                } else {
                    showSection(0); // Start with A.1 if no draft
                }
            } catch (error) {
                console.error('Error loading current draft: ', error);
                showAlert('Error loading draft. Starting new entry.', 'danger', 'formAlertBox'); // Changed to English
                showSection(0);
            }
        }

        // Populate form with data (for edit or draft load)
        function populateForm(entry) {
            $('currentEntryId').value = entry.id || '';
            $('currentEntryVersion').value = entry.version_number || 1;
            $('currentPredecessorId').value = entry.predecessor_id || entry.id;
            
            $('schemeNameCode').value = entry.scheme_name_code || '';
            $('entryDate').value = entry.entry_date || '';

            $('centralAllocation').value = entry.central_allocation || 0;
            $('stateNormativeAllocation').value = entry.state_normative_allocation || 0;
            $('additionalStateAllocation').value = entry.additional_state_allocation || 0;
            $('budgetRemarks').value = entry.budget_remarks || '';

            $('totalAmountDisbursedNonElectronic').value = entry.total_amount_disbursed_non_electronic || 0;
            $('totalAmountDisbursedElectronic').value = entry.total_amount_disbursed_electronic || 0;
            // Calculated field will update on input
            $('centralShareFundTransferred').value = entry.central_share_fund_transferred || 0;
            $('normativeStateShareFundTransferred').value = entry.normative_state_share_fund_transferred || 0;
            $('additionalStateContributedFundTransferred').value = entry.additional_state_contributed_fund_transferred || 0;
            $('stateShareFundTransferredAdditionalBeneficiaries').value = entry.state_share_fund_transferred_additional_beneficiaries || 0;
            
            $('numAdditionalBeneficiariesCSS').value = entry.num_additional_beneficiaries_css || 0;
            $('numAdditionalBeneficiariesStateScheme').value = entry.num_additional_beneficiaries_state_scheme || 0;
            // Calculated field will update on input
            $('numBeneficiariesDigitized').value = entry.num_beneficiaries_digitized || 0;
            $('numBeneficiariesBankDetailsAvailable').value = entry.num_beneficiaries_bank_details_available || 0;
            $('numBeneficiariesAadhaarSeeded').value = entry.num_beneficiaries_aadhaar_seeded || 0;
            $('numBeneficiariesAadhaarAuthenticated').value = entry.num_beneficiaries_aadhaar_authenticated || 0;
            $('numBeneficiariesMobileAvailable').value = entry.num_beneficiaries_mobile_available || 0;
            $('numBeneficiariesAmountDisbursedNonElectronic').value = entry.num_beneficiaries_amount_disbursed_non_electronic || 0;
            $('numTransactionsNonElectronic').value = entry.num_transactions_non_electronic || 0;
            $('numTransactionsElectronic').value = entry.num_transactions_electronic || 0;

            $('numBeneficiariesRemovedDeduplication').value = entry.num_beneficiaries_removed_deduplication || 0;
            $('numGhostFakeBeneficiariesRemoved').value = entry.num_ghost_fake_beneficiaries_removed || 0;
            $('otherSavingsProcessImprovement').value = entry.other_savings_process_improvement || 0;
            // Calculated field will update on input
            $('changeReason').value = entry.change_reason || '';

            // Trigger calculations to update read-only fields
            updateCalculatedFields();
        }

        // Save DBT Entry (can be a draft or final submit)
        async function saveDbtEntry(status, sectionId = null) {
            const submitBtn = (status === 'submitted') ? $('finalSubmitBtn') : document.querySelector(`.btn-custom[data-section="${sectionId}"]`);
            const originalBtnText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> ${status === 'submitted' ? 'Submitting...' : 'Saving Draft...'}`; // Changed to English

            try {
                const entryData = {
                    scheme_name_code: $('schemeNameCode').value,
                    entry_date: $('entryDate').value,
                    
                    central_allocation: parseFloat($('centralAllocation').value) || 0,
                    state_normative_allocation: parseFloat($('stateNormativeAllocation').value) || 0,
                    additional_state_allocation: parseFloat($('additionalStateAllocation').value) || 0,
                    budget_remarks: $('budgetRemarks').value,

                    total_amount_disbursed: parseFloat($('totalAmountDisbursed').value) || 0, // Calculated
                    central_share_fund_transferred: parseFloat($('centralShareFundTransferred').value) || 0,
                    normative_state_share_fund_transferred: parseFloat($('normativeStateShareFundTransferred').value) || 0,
                    additional_state_contributed_fund_transferred: parseFloat($('additionalStateContributedFundTransferred').value) || 0,
                    state_share_fund_transferred_additional_beneficiaries: parseFloat($('stateShareFundTransferredAdditionalBeneficiaries').value) || 0,
                    total_amount_disbursed_non_electronic: parseFloat($('totalAmountDisbursedNonElectronic').value) || 0,
                    total_amount_disbursed_electronic: parseFloat($('totalAmountDisbursedElectronic').value) || 0,

                    total_number_of_beneficiaries: parseInt($('totalNumberOfBeneficiaries').value) || 0, // Calculated
                    num_additional_beneficiaries_css: parseInt($('numAdditionalBeneficiariesCSS').value) || 0,
                    num_additional_beneficiaries_state_scheme: parseInt($('numAdditionalBeneficiariesStateScheme').value) || 0,
                    num_beneficiaries_digitized: parseInt($('numBeneficiariesDigitized').value) || 0,
                    num_beneficiaries_bank_details_available: parseInt($('numBeneficiariesBankDetailsAvailable').value) || 0,
                    num_beneficiaries_aadhaar_seeded: parseInt($('numBeneficiariesAadhaarSeeded').value) || 0,
                    num_beneficiaries_aadhaar_authenticated: parseInt($('numBeneficiariesAadhaarAuthenticated').value) || 0,
                    num_beneficiaries_mobile_available: parseInt($('numBeneficiariesMobileAvailable').value) || 0,
                    num_beneficiaries_amount_disbursed_non_electronic: parseInt($('numBeneficiariesAmountDisbursedNonElectronic').value) || 0,
                    num_transactions_non_electronic: parseInt($('numTransactionsNonElectronic').value) || 0,
                    num_transactions_electronic: parseInt($('numTransactionsElectronic').value) || 0,

                    num_beneficiaries_removed_deduplication: parseInt($('numBeneficiariesRemovedDeduplication').value) || 0,
                    num_ghost_fake_beneficiaries_removed: parseInt($('numGhostFakeBeneficiariesRemoved').value) || 0,
                    other_savings_process_improvement: parseFloat($('otherSavingsProcessImprovement').value) || 0,
                    saving_amount_inr: parseFloat($('savingAmountINR').value) || 0, // Calculated
                    
                    status: status,
                    district_id: currentUser.districtId,
                    district_name: currentUser.districtName,
                    created_by: currentUser.id
                };

                let response;
                if (currentEditingEntryId) {
                    // Updating an existing record (versioning)
                    const oldEntryId = currentEditingEntryId;
                    const oldVersion = parseInt($('currentEntryVersion').value);
                    const predecessorId = $('currentPredecessorId').value || oldEntryId;
                    const changeReason = $('changeReason').value.trim();

                    if (!changeReason && status === 'submitted') {
                        showAlert('Change Reason is required for final submission of an updated entry.', 'danger', 'formAlertBox'); // Changed to English
                        return;
                    }

                    // 1. Mark old entry as not current
                    const { error: updateError } = await supabaseClient
                        .from('dbt_entries')
                        .update({ is_current: false, updated_at: new Date().toISOString() })
                        .eq('id', oldEntryId);

                    if (updateError) throw updateError;

                    // 2. Insert new version
                    entryData.version_number = oldVersion + 1;
                    entryData.predecessor_id = predecessorId;
                    entryData.is_current = true;
                    entryData.change_reason = changeReason;

                    response = await supabaseClient
                        .from('dbt_entries')
                        .insert([entryData])
                        .select();

                } else {
                    // Inserting a brand new entry
                    entryData.is_current = true;
                    entryData.version_number = 1;
                    entryData.predecessor_id = null;
                    entryData.change_reason = null; // No change reason for initial entry

                    response = await supabaseClient
                        .from('dbt_entries')
                        .insert([entryData])
                        .select();
                }

                if (response.error) throw response.error;

                showAlert(`DBT Data successfully ${status === 'submitted' ? 'submitted' : 'saved'}!`, 'success', 'formAlertBox'); // Changed to English
                
                // If it's a final submission, clear form and reset to first step
                if (status === 'submitted') {
                    clearForm();
                    showSection(0);
                }
                
                loadDbtEntries(); // Refresh table
                updateKCCDataStats(); // Refresh KCC stats in navbar
            } catch (error) {
                console.error('Error saving DBT entry: ', error);
                showAlert(`Error saving DBT data: ${error.message}`, 'danger', 'formAlertBox'); // Changed to English
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }

        // Load existing DBT entries into the table
        async function loadDbtEntries() {
            console.log('📋 Loading DBT entries...');
            const tableBody = $('dbtEntriesTableBody');
            const noDataFound = $('noDataFound');
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>`; // Changed to English
            noDataFound.style.display = 'none';

            try {
                const userRole = currentUser.role?.toLowerCase();
                const isAdmin = userRole === 'admin' || userRole === 'state_admin';

                let query = supabaseClient
                    .from('dbt_entries')
                    .select(`
                        id, 
                        scheme_name_code, 
                        entry_date, 
                        district_name,
                        total_active_kcc,
                        total_kcc_saturated,
                        total_kcc_not_saturated,
                        status,
                        is_current,
                        version_number,
                        predecessor_id,
                        created_by,
                        created_at,
                        -- Select all other columns for edit functionality
                        central_allocation, state_normative_allocation, additional_state_allocation, budget_remarks,
                        total_amount_disbursed, central_share_fund_transferred, normative_state_share_fund_transferred, 
                        additional_state_contributed_fund_transferred, state_share_fund_transferred_additional_beneficiaries, 
                        total_amount_disbursed_non_electronic, total_amount_disbursed_electronic,
                        total_number_of_beneficiaries, num_additional_beneficiaries_css, num_additional_beneficiaries_state_scheme, 
                        num_beneficiaries_digitized, num_beneficiaries_bank_details_available, num_beneficiaries_aadhaar_seeded, 
                        num_beneficiaries_aadhaar_authenticated, num_beneficiaries_mobile_available, 
                        num_beneficiaries_amount_disbursed_non_electronic, num_transactions_non_electronic, num_transactions_electronic,
                        num_beneficiaries_removed_deduplication, num_ghost_fake_beneficiaries_removed, 
                        other_savings_process_improvement, saving_amount_inr, change_reason
                    `)
                    .order('entry_date', { ascending: false })
                    .order('created_at', { ascending: false }); // Order by creation time for latest version

                if (!isAdmin) {
                    query = query.eq('created_by', currentUser.id); // Filter by user for non-admins
                }
                
                // Only show current versions in the main table
                query = query.eq('is_current', true);

                const { data: entries, error } = await query;

                if (error) throw error;

                if (!entries || entries.length === 0) {
                    tableBody.innerHTML = ''; // Clear loading message
                    noDataFound.style.display = 'block';
                    showAlert('No DBT data found.', 'info', 'dataTableAlertBox'); // Changed to English
                    return;
                }

                tableBody.innerHTML = ''; // Clear loading message

                entries.forEach(entry => {
                    const row = document.createElement('tr');
                    const entryDate = new Date(entry.entry_date).toLocaleDateString('en-IN'); // Changed to English date format
                    const statusBadge = entry.status === 'submitted' 
                        ? `<span class="badge bg-success">Submitted</span>` // Changed to English
                        : `<span class="badge bg-secondary">Draft</span>`; // Changed to English

                    row.innerHTML = `
                        <td>${entryDate}</td>
                        <td>${entry.scheme_name_code || 'N/A'}</td>
                        <td>${entry.district_name || 'N/A'}</td>
                        <td>${entry.total_active_kcc || 0}</td>
                        <td>${entry.total_kcc_saturated || 0}</td>
                        <td>${entry.total_kcc_not_saturated || 0}</td>
                        <td>${statusBadge}</td>
                        <td class="table-actions">
                            <button class="btn btn-edit btn-sm" onclick="editDbtEntry('${entry.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDbtEntry('${entry.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                console.log('✅ DBT entries loaded successfully.');
                showAlert(`Found ${entries.length} entries.`, 'success', 'dataTableAlertBox'); // Changed to English

            } catch (error) {
                console.error('❌ Error loading DBT entries: ', error);
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error loading data.</td></tr>`; // Changed to English
                showAlert(`Error loading data: ${error.message}`, 'danger', 'dataTableAlertBox'); // Changed to English
            }
        }

        // Edit DBT Entry
        async function editDbtEntry(entryId) {
            console.log('✏️ Editing entry: ', entryId);
            const { data: entry, error } = await supabaseClient
                .from('dbt_entries')
                .select('*')
                .eq('id', entryId)
                .single();

            if (error) {
                console.error('Error fetching entry for edit: ', error);
                showAlert('Error fetching entry.', 'danger', 'formAlertBox'); // Changed to English
                return;
            }

            // Security check: Admin can edit any record, regular user only their own district's records
            const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'state_admin');
            if (!isAdmin && entry.created_by !== currentUser.id) { // Check created_by instead of district_id for stricter user control
                showAlert('You do not have permission to edit this record.', 'danger', 'formAlertBox'); // Changed to English
                console.warn(`Permission denied: User ${currentUser.id} attempted to edit record from another user.`);
                return;
            }

            currentEditingEntryId = entryId; // Set editing state
            populateForm(entry); // Populate form fields
            
            // Show all sections up to the last known filled section, or B3 if already submitted/full draft
            let lastCompletedSectionIndex = 0;
            if (entry.scheme_name_code) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['A1']);
            if (entry.central_allocation !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['A2']);
            if (entry.total_amount_disbursed !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B1']);
            if (entry.total_number_of_beneficiaries !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B2']);
            if (entry.saving_amount_inr !== null) lastCompletedSectionIndex = Math.max(lastCompletedSectionIndex, sectionMap['B3']);
            
            showSection(lastCompletedSectionIndex); // Show all previously filled sections

            $('changeReasonRow').style.display = 'block'; // Show change reason for edits

            showAlert('Record loaded for editing. Please update and submit.', 'info', 'formAlertBox'); // Changed to English
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of form
        }

        // Delete DBT Entry
        async function deleteDbtEntry(entryId) {
            console.log('🗑️ Deleting entry: ', entryId);
            if (confirm('Are you sure you want to delete this entry? This action is irreversible.')) { // Changed to English
                try {
                    // Security check: Admin can delete any record, regular user only their own
                    const { data: entryToDelete, error: fetchError } = await supabaseClient
                        .from('dbt_entries')
                        .select('created_by')
                        .eq('id', entryId)
                        .single();

                    if (fetchError) throw fetchError;

                    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'state_admin');
                    if (!isAdmin && entryToDelete.created_by !== currentUser.id) {
                        showAlert('You do not have permission to delete this record.', 'danger', 'dataTableAlertBox'); // Changed to English
                        console.warn(`Permission denied: User ${currentUser.id} attempted to delete record from another user.`);
                        return;
                    }

                    const { error } = await supabaseClient
                        .from('dbt_entries')
                        .delete()
                        .eq('id', entryId);

                    if (error) throw error;

                    showAlert('Entry successfully deleted!', 'success', 'dataTableAlertBox'); // Changed to English
                    loadDbtEntries(); // Refresh table
                } catch (error) {
                    console.error('Error deleting entry: ', error);
                    showAlert(`Error deleting entry: ${error.message}`, 'danger', 'dataTableAlertBox'); // Changed to English
                }
            }
        }

        // Clear the form fields and reset state
        function clearForm(){
            document.getElementById('dbtEntryForm').reset();
            currentEditingEntryId = null;
            $('currentEntryVersion').value = 1;
            $('currentPredecessorId').value = '';
            $('entryDate').valueAsDate = new Date(); // Reset date
            $('changeReason').value = '';
            $('changeReasonRow').style.display = 'none'; // Hide change reason row
            showSection(0); // Reset to first section
            showAlert('Form cleared. Ready for new entry.', 'info', 'formAlertBox'); // Changed to English
        }

        // Download Functionality
        $('downloadDataBtn').addEventListener('click', function() {
            const downloadModal = new bootstrap.Modal($('downloadOptionsModal'));
            downloadModal.show();
        });

        $('downloadPdfBtn').addEventListener('click', async function() {
            const downloadModal = bootstrap.Modal.getInstance($('downloadOptionsModal'));
            downloadModal.hide();
            await downloadTableAsPdf();
        });

        $('downloadExcelBtn').addEventListener('click', async function() {
            const downloadModal = bootstrap.Modal.getInstance($('downloadOptionsModal'));
            downloadModal.hide();
            await downloadTableAsCsv();
        });

        async function downloadTableAsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');

            const table = $('dbtEntriesTable');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const body = Array.from(table.querySelectorAll('tbody tr')).map(row => 
                Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim())
            );

            // Filter out action column from PDF
            const filteredHeaders = headers.slice(0, -1);
            const filteredBody = body.map(row => row.slice(0, -1));

            doc.autoTable({
                head: [filteredHeaders],
                body: filteredBody,
                startY: 20,
                headStyles: { fillColor: [27, 94, 32], textColor: [255, 255, 255], font: 'NotoSansDevanagari', fontStyle: 'bold' }, // Assuming NotoSansDevanagari is loaded for PDF
                styles: { font: 'NotoSansDevanagari', fontSize: 8, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 20 }, // Date
                    1: { cellWidth: 40 }, // Scheme
                    2: { cellWidth: 30 }, // District
                    3: { cellWidth: 25 }, // Active KCC
                    4: { cellWidth: 25 }, // Saturated
                    5: { cellWidth: 25 }, // Not Saturated
                    6: { cellWidth: 20 }  // Status
                },
                didDrawPage: function(data) {
                    doc.text("DBT Data Report - Directorate Agriculture Chhattisgarh", data.settings.margin.left, 10); // Changed to English
                }
            });
            doc.save('DBT_Data_Report.pdf');
            showAlert('PDF downloaded successfully!', 'success', 'dataTableAlertBox'); // Changed to English
        }

        async function downloadTableAsCsv() {
            const table = $('dbtEntriesTable');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            // Filter out action column from CSV
            const filteredHeaders = headers.slice(0, -1);
            const csvRows = [];
            csvRows.push(filteredHeaders.join(',')); // Add headers

            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent.trim();
                    if (text.includes(',')) {
                        text = `"${text}"`;
                    }
                    return text;
                });
                csvRows.push(rowData.slice(0, -1).join(',')); // Remove last column (Action)
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'DBT_Data_Report.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('Excel (CSV) downloaded successfully!', 'success', 'dataTableAlertBox'); // Changed to English
        }

        // --- Admin Scheme Upload Logic ---
        async function loadSchemes() {
            const schemeSelect = $('schemeNameCode');
            schemeSelect.innerHTML = '<option value="">-- Loading Schemes --</option>'; // Changed to English
            try {
                const { data: schemes, error } = await supabaseClient
                    .from('schemes')
                    .select('scheme_name, scheme_code')
                    .eq('is_active', true)
                    .order('scheme_name', { ascending: true });

                if (error) throw error;

                schemeSelect.innerHTML = '<option value="">-- Select Scheme --</option>'; // Changed to English
                schemes.forEach(scheme => {
                    const option = document.createElement('option');
                    option.value = `${scheme.scheme_name} (${scheme.scheme_code})`;
                    option.textContent = `${scheme.scheme_name} (${scheme.scheme_code})`;
                    schemeSelect.appendChild(option);
                });
                console.log('✅ Schemes loaded successfully.');
            } catch (error) {
                console.error('Error loading schemes: ', error);
                schemeSelect.innerHTML = '<option value="">-- Error Loading Schemes --</option>'; // Changed to English
                showAlert('Error loading schemes. Please try refreshing.', 'danger', 'formAlertBox'); // Changed to English
            }
        }

        // Show Admin Scheme Upload Modal
        document.getElementById('btnStateAdmin')?.addEventListener('click', function() {
            // Only show if current user is admin
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'state_admin')) {
                const schemeUploadModal = new bootstrap.Modal($('schemeUploadModal'));
                schemeUploadModal.show();
            } else {
                showAlert('You do not have permission to upload schemes.', 'danger'); // Changed to English
            }
        });

        // Handle Scheme Excel File Upload
        $('uploadSchemesBtn').addEventListener('click', async function() {
            const fileInput = $('schemeExcelFile');
            const file = fileInput.files[0];
            if (!file) {
                showAlert('Please select an Excel file to upload.', 'danger', 'schemeUploadAlertBox'); // Changed to English
                return;
            }

            const uploadBtn = this;
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Uploading...`; // Changed to English

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                if (!json || json.length === 0) {
                    showAlert('No data found in the Excel file.', 'danger', 'schemeUploadAlertBox'); // Changed to English
                    return;
                }

                const schemesToInsert = [];
                for (const row of json) {
                    const schemeName = row['Scheme Name']?.toString().trim(); // Ensure column names match Excel
                    const schemeCode = row['Scheme Code']?.toString().trim();

                    if (schemeName && schemeCode) {
                        schemesToInsert.push({ scheme_name: schemeName, scheme_code: schemeCode });
                    } else {
                        console.warn('Skipping row due to missing Scheme Name or Scheme Code:', row);
                    }
                }

                if (schemesToInsert.length === 0) {
                    showAlert('No valid schemes found in the Excel file. Ensure "Scheme Name" and "Scheme Code" columns exist.', 'danger', 'schemeUploadAlertBox'); // Changed to English
                    return;
                }

                // Insert into Supabase with ON CONFLICT DO NOTHING
                const { error } = await supabaseClient
                    .from('schemes')
                    .insert(schemesToInsert)
                    .select()
                    .onConflict('scheme_code') // Conflict on scheme_code to prevent duplicates
                    .doNothing(); // Do nothing if scheme_code already exists

                if (error) throw error;

                showAlert(`${schemesToInsert.length} schemes processed. Duplicates (if any) skipped.`, 'success', 'schemeUploadAlertBox'); // Changed to English
                fileInput.value = ''; // Clear file input
                loadSchemes(); // Reload schemes dropdown
                const schemeUploadModal = bootstrap.Modal.getInstance($('schemeUploadModal'));
                schemeUploadModal.hide();

            } catch (error) {
                console.error('Error uploading schemes: ', error);
                showAlert(`Error uploading schemes: ${error.message}. Please check file format.`, 'danger', 'schemeUploadAlertBox'); // Changed to English
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
            }
        });

        // --- Multi-Step Form Event Listeners ---
        document.querySelectorAll('.btn-custom[data-section]').forEach(button => {
            button.addEventListener('click', (event) => {
                const sectionId = event.target.dataset.section;
                saveSectionDraft(sectionId);
            });
        });

        $('finalSubmitBtn').addEventListener('click', async function(event) {
            event.preventDefault();
            await saveSectionDraft('B3'); // Final submit for B3
        });

        $('clearFormBtn').addEventListener('click', clearForm);

        // --- Calculation Dependencies ---
        const totalAmountDisbursedNonElectronic = $('totalAmountDisbursedNonElectronic');
        const totalAmountDisbursedElectronic = $('totalAmountDisbursedElectronic');
        const totalAmountDisbursed = $('totalAmountDisbursed');

        function calculateTotalAmountDisbursed() {
            const nonElectronic = parseFloat(totalAmountDisbursedNonElectronic.value) || 0;
            const electronic = parseFloat(totalAmountDisbursedElectronic.value) || 0;
            totalAmountDisbursed.value = (nonElectronic + electronic).toFixed(2);
        }
        totalAmountDisbursedNonElectronic.addEventListener('input', calculateTotalAmountDisbursed);
        totalAmountDisbursedElectronic.addEventListener('input', calculateTotalAmountDisbursed);

        const numAdditionalBeneficiariesCSS = $('numAdditionalBeneficiariesCSS');
        const numAdditionalBeneficiariesStateScheme = $('numAdditionalBeneficiariesStateScheme');
        const totalNumberOfBeneficiaries = $('totalNumberOfBeneficiaries');

        function calculateTotalBeneficiaries() {
            const css = parseInt(numAdditionalBeneficiariesCSS.value) || 0;
            const stateScheme = parseInt(numAdditionalBeneficiariesStateScheme.value) || 0;
            totalNumberOfBeneficiaries.value = css + stateScheme;
        }
        numAdditionalBeneficiariesCSS.addEventListener('input', calculateTotalBeneficiaries);
        numAdditionalBeneficiariesStateScheme.addEventListener('input', calculateTotalBeneficiaries);

        const otherSavingsProcessImprovement = $('otherSavingsProcessImprovement');
        const savingAmountINR = $('savingAmountINR');

        function calculateSavingAmount() {
            savingAmountINR.value = (parseFloat(otherSavingsProcessImprovement.value) || 0).toFixed(2);
        }
        otherSavingsProcessImprovement.addEventListener('input', calculateSavingAmount);

        // Function to trigger all calculations
        function updateCalculatedFields() {
            calculateTotalAmountDisbursed();
            calculateTotalBeneficiaries();
            calculateSavingAmount();
        }

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('💥 Unhandled error: ', e.error);
            showAlert('An unexpected error occurred. Please refresh the page.', 'danger', 'formAlertBox'); // Changed to English
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('💥 Unhandled promise rejection: ', e.reason);
            showAlert('There was a problem loading data. Please try again.', 'danger', 'formAlertBox'); // Changed to English
        });

        // Initialize page on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
