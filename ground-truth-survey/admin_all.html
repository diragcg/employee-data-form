<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Form Designer (संचालनालय कृषि छत्तीसगढ़)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    body { font-family: 'Mukta', system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#FFF8E1; }
    .topbar { position:fixed; top:0; left:0; right:0; height:64px; background:#1B5E20; color:#fff; display:flex; align-items:center; padding:0 20px; z-index:50; }
    .topbar .brand { font-weight:700; font-size:18px; margin-left:10px; }
    .container-app { max-width:1200px; margin:92px auto 48px; }
    .sidebar { background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.06); min-height:520px; }
    .main-card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.06); }
    .header-small { font-weight:700; color:#1B5E20; }
    .field-badge { border-radius:6px; padding:6px 8px; background:#F1F8E9; color:#1B5E20; margin-right:6px; margin-bottom:6px; display:inline-block; border:1px solid #E6F4D9; }
    .muted-small { color:#6b7280; font-size:13px; }
    .danger-note { background:#fff3f2; border:1px solid #ffcbc4; padding:8px; border-radius:8px; color:#b02a37; }
    .hidden { display:none !important; }
    label.required::after { content: " *"; color:#d63333; font-weight:700; margin-left:2px; }
    .form-actions { display:flex; gap:10px; align-items:center; }
    .table-list .list-group-item { cursor:pointer; }
    .designer-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .designer-row .col-label { flex:1; }
    .small-muted { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" alt="supabase" width="34" height="34">
    <div class="brand ms-2">संचालनालय कृषि छत्तीसगढ़ — Admin</div>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button id="btnHome" class="btn btn-sm btn-light">Home</button>
      <button id="btnDashboard" class="btn btn-sm btn-light">Dashboard</button>
      <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>

  <div class="container-app">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="sidebar">
          <div class="mb-3">
            <div class="header-small">Admin Controls</div>
            <div class="muted-small">केवल एडमिन ही फ़ॉर्म और तालिकाएँ बना सकता है</div>
          </div>

          <div class="mb-3">
            <label class="form-label required">Excel फ़ाइल अपलोड</label>
            <input id="inputExcel" type="file" accept=".xlsx,.xls" class="form-control form-control-sm" />
          </div>

          <div class="mb-3">
            <label class="form-label">टेबल नाम (वैकल्पिक)</label>
            <input id="inputTableName" class="form-control form-control-sm" placeholder="यदि खाली, फ़ाइल का नाम उपयोग होगा" />
          </div>

          <div class="mb-3 form-actions">
            <button id="btnProcess" class="btn btn-success btn-sm">Process</button>
            <button id="btnPreviewDesigner" class="btn btn-outline-secondary btn-sm">Preview Designer</button>
          </div>

          <div class="mb-3">
            <div class="header-small">Saved Forms</div>
            <div id="listDefinitions" class="list-group table-list mt-2" style="max-height:300px; overflow:auto;"></div>
            <div class="mt-2 d-grid">
              <button id="btnReloadDefs" class="btn btn-sm btn-outline-primary">Reload</button>
            </div>
          </div>

          <div class="mt-3 danger-note small-muted">
            Security: This UI calls a server function to create tables (execute_sql_script). For production, run DDL server-side using a service-role key and secure it. Do not expose admin keys in frontend.
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="main-card">
          <div id="welcomeBlock">
            <h4>Admin Form Designer</h4>
            <p class="muted-small">Upload an Excel file, confirm headers, optionally edit labels/types in the designer preview, then create the table and save the form definition. No file rows are inserted into the created table.</p>
          </div>

          <div id="previewArea" class="mt-3 hidden">
            <div class="mb-2 d-flex justify-content-between align-items-center">
              <div><strong>Preview — Table:</strong> <span id="previewTableName" class="text-primary"></span></div>
              <div class="small-muted">Columns detected: <span id="previewColsCount"></span></div>
            </div>

            <div id="designerFields" class="mb-3"></div>

            <div class="d-flex gap-2">
              <button id="btnCreateConfirm" class="btn btn-primary">Create Table & Save Definition</button>
              <button id="btnCancelPreview" class="btn btn-outline-secondary">Cancel</button>
            </div>
          </div>

          <hr class="my-3">

          <div id="definitionsArea">
            <h5>Definitions</h5>
            <div id="definitionsBucket" class="mt-2"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="alertToast" style="position:fixed; right:20px; bottom:20px; z-index:9999;"></div>

<script>
/* ---------------- Supabase configuration (as provided) ---------------- */
const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);
function toast(msg, type='info') {
  const div = document.createElement('div');
  div.className = `alert alert-${type} shadow`;
  div.style.minWidth = '240px';
  div.textContent = msg;
  $('alertToast').appendChild(div);
  setTimeout(()=> div.remove(), 5000);
}
function sanitizeIdentifier(name) {
  return String(name||'').replace(/\.[^/.]+$/, '').trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() || `table_${Date.now()}`;
}
function sanitizeColName(str, idx) {
  let s = String(str||`column_${idx+1}`).trim().replace(/[^a-zA-Z0-9_]/g,'');
  if (!s) s = `column_${idx+1}`; return s;
}
function getCurrentUser() {
  const s = localStorage.getItem('user') || sessionStorage.getItem('user');
  return s ? JSON.parse(s) : null;
}

/* ---------------- State ---------------- */
let currentUser = null;
let lastHeaders = [];
let lastTableName = '';
let definitionsCache = [];

/* ---------------- Init ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  currentUser = getCurrentUser();
  if (!currentUser || currentUser.role !== 'admin') {
    alert('Admin access required. Redirecting to login.');
    location.href = 'login.html';
    return;
  }

  $('btnLogout').addEventListener('click', ()=> { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href = 'login.html'; });
  $('btnReloadDefs').addEventListener('click', loadDefinitions);
  $('btnProcess').addEventListener('click', processExcel);
  $('btnPreviewDesigner').addEventListener('click', previewDesigner);
  $('btnCancelPreview').addEventListener('click', ()=> $('previewArea').classList.add('hidden'));
  $('btnCreateConfirm').addEventListener('click', createTableAndSaveDef);
  $('btnHome').addEventListener('click', ()=> window.scrollTo({ top:0, behavior:'smooth' }));
  $('btnDashboard').addEventListener('click', ()=> renderDefinitionsArea());

  loadDefinitions();
});

/* ---------------- Excel processing ---------------- */
function processExcel() {
  const f = $('inputExcel').files[0];
  if (!f) return toast('कृपया Excel फ़ाइल चुनें', 'warning');

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
      if (!rows || !rows.length || !rows[0].length) return toast('फ़ाइल में हेडर नहीं मिले', 'danger');

      lastHeaders = rows[0].map(h => String(h||'').trim());
      lastTableName = sanitizeIdentifier($('inputTableName').value || f.name);
      showDesignerPreview(lastTableName, lastHeaders);
    } catch(err) {
      console.error(err); toast('फ़ाइल पढ़ने में त्रुटि', 'danger');
    }
  };
  reader.readAsArrayBuffer(f);
}

function previewDesigner() {
  const f = $('inputExcel').files[0];
  if (!f) return toast('कृपया Excel फ़ाइल चुनें', 'warning');
  processExcel();
}

/* ---------------- Designer preview render ---------------- */
function showDesignerPreview(tableName, headers) {
  $('previewTableName').textContent = tableName;
  $('previewColsCount').textContent = headers.length;
  const container = $('designerFields');
  container.innerHTML = '';
  headers.forEach((h, i) => {
    const row = document.createElement('div'); row.className = 'designer-row';
    const colLabel = document.createElement('input'); colLabel.className = 'form-control col-label form-control-sm'; colLabel.value = h || `Column ${i+1}`;
    const colName = document.createElement('input'); colName.className = 'form-control form-control-sm'; colName.value = sanitizeColName(h, i);
    const typeSel = document.createElement('select'); typeSel.className = 'form-select form-select-sm'; typeSel.innerHTML = '<option value="text">Text</option><option value="number">Number</option><option value="date">Date</option>';
    row.appendChild(colLabel);
    row.appendChild(colName);
    row.appendChild(typeSel);
    container.appendChild(row);
  });
  $('previewArea').classList.remove('hidden');
}

/* ---------------- Create table & save definition (with verbose logging) ---------------- */
async function createTableAndSaveDef() {
  try {
    const container = $('designerFields');
    if (!container.children.length) return toast('Designer empty', 'warning');

    const tableName = $('previewTableName').textContent || sanitizeIdentifier($('inputTableName').value || 'table_' + Date.now());
    // build columns from inputs
    const seen = new Set();
    const fields = [];
    const columns = Array.from(container.children).map((row, idx) => {
      const labelInput = row.querySelector('input.col-label');
      const colNameInput = row.querySelectorAll('input')[1] || row.querySelector('input[name]');
      const typeSel = row.querySelector('select');
      const label = labelInput ? labelInput.value.trim() : `Column ${idx+1}`;
      let col = colNameInput ? colNameInput.value.trim() : sanitizeColName(label, idx);
      col = col.replace(/[^a-zA-Z0-9_]/g, '') || `column_${idx+1}`;
      const base = col; let s = 1;
      while (seen.has(col.toLowerCase())) col = `${base}_${s++}`;
      seen.add(col.toLowerCase());
      const sqlType = (typeSel?.value === 'number') ? 'NUMERIC' : (typeSel?.value === 'date' ? 'DATE' : 'TEXT');
      fields.push({ name: col, label, position: idx, type: typeSel?.value || 'text' });
      return `"${col}" ${sqlType}`;
    }).join(', ');

    const ddl = `CREATE TABLE IF NOT EXISTS public."${tableName}" (${columns});`;

    console.log('DDL to execute:', ddl);
    console.log('Calling RPC execute_sql_script...');

    const { error: rpcErr, data: rpcData } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
    console.log('RPC result:', { rpcErr, rpcData });
    if (rpcErr) {
      console.error('RPC error', rpcErr);
      if (rpcErr.message && rpcErr.message.toLowerCase().includes('invalid api key')) {
        toast('Create failed: Invalid API key — check SUPABASE_KEY in script (use anon/public key).', 'danger');
      } else {
        toast('Create failed: ' + (rpcErr.message || JSON.stringify(rpcErr)), 'danger');
      }
      return;
    }

    // Prepare definition payload
    const def = {
      table_name: tableName,
      label: tableName,
      created_by: currentUser.id,
      created_at: new Date().toISOString(),
      fields
    };

    // DEBUG: show payload
    console.log('Saving form_definitions payload:', def);

    const resp = await supabase.from('form_definitions').insert([def]);
    console.log('Insert response:', resp);
    if (resp.error) {
      console.error('Insert def error object:', resp.error, 'full response:', resp);
      toast('Failed to save definition: ' + (resp.error.message || JSON.stringify(resp.error)), 'danger');
      return;
    }

    toast(`Table & definition created: ${tableName}`, 'success');
    $('previewArea').classList.add('hidden');
    $('inputTableName').value = ''; $('inputExcel').value = '';
    loadDefinitions();
  } catch (err) {
    console.error(err);
    toast('Create failed: ' + (err.message || JSON.stringify(err)), 'danger');
  }
}

/* ---------------- Load & render definitions ---------------- */
async function loadDefinitions() {
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    definitionsCache = data || [];
    renderDefinitionsList();
    renderDefinitionsArea();
  } catch (err) {
    console.error('loadDefinitions', err);
    toast('Failed to load definitions: ' + (err.message || JSON.stringify(err)), 'danger');
  }
}

function renderDefinitionsList() {
  const el = $('listDefinitions'); el.innerHTML = '';
  if (!definitionsCache.length) { el.innerHTML = '<div class="text-muted">No definitions</div>'; return; }
  definitionsCache.forEach(def => {
    const item = document.createElement('div');
    item.className = 'list-group-item';
    item.textContent = `${def.table_name} — ${(def.fields||[]).length} fields`;
    item.addEventListener('click', () => viewDefinition(def.table_name));
    el.appendChild(item);
  });
}

function renderDefinitionsArea() {
  const bucket = $('definitionsBucket');
  bucket.innerHTML = '';
  if (!definitionsCache.length) { bucket.innerHTML = '<div class="text-muted">No definitions found</div>'; return; }
  definitionsCache.forEach(def => {
    const card = document.createElement('div');
    card.className = 'border rounded p-2 mb-2 d-flex justify-content-between';
    const left = document.createElement('div');
    left.innerHTML = `<div class="fw-semibold">${def.table_name}</div><div class="small-muted">${(def.fields||[]).length} fields • ${new Date(def.created_at).toLocaleString()}</div>`;
    const right = document.createElement('div');
    const btnView = document.createElement('button'); btnView.className = 'btn btn-sm btn-outline-primary me-1'; btnView.textContent = 'View';
    btnView.addEventListener('click', ()=> viewDefinition(def.table_name));
    const btnDrop = document.createElement('button'); btnDrop.className = 'btn btn-sm btn-danger'; btnDrop.textContent = 'Drop';
    btnDrop.addEventListener('click', ()=> dropTable(def.table_name));
    right.appendChild(btnView); right.appendChild(btnDrop);
    card.appendChild(left); card.appendChild(right);
    bucket.appendChild(card);
  });
}

async function viewDefinition(tableName) {
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name', tableName).single();
    if (error) throw error;
    const def = data;
    alert(`Definition: ${def.table_name}\n\nFields:\n${(def.fields||[]).map(f => `${f.position+1}. ${f.label} (${f.name})`).join('\n')}`);
  } catch (err) {
    console.error(err);
    toast('View failed: ' + (err.message || JSON.stringify(err)), 'danger');
  }
}

async function dropTable(tableName) {
  if (!confirm(`Drop table "${tableName}"? This will delete all data.`)) return;
  try {
    const ddl = `DROP TABLE IF EXISTS public."${tableName}" CASCADE;`;
    const { error } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
    if (error) throw error;
    const { error: delErr } = await supabase.from('form_definitions').delete().eq('table_name', tableName);
    if (delErr) throw delErr;
    toast('Table dropped', 'success');
    loadDefinitions();
  } catch (err) {
    console.error('drop err', err);
    toast('Drop failed: ' + (err.message || JSON.stringify(err)), 'danger');
  }
}
</script>
</body>
</html>
