<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard (संचालनालय कृषि छत्तीसगढ़)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; }
        .topbar {
            position: fixed;
            top: 0; left: 0; right: 0; height: 64px;
            background: #176531; color: #fff; display: flex; align-items: center;
            padding: 0 1.5rem;
            z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .topbar .brand { font-weight: 700; font-size: 1.2rem; }
        .container-app { padding-top: 80px; padding-bottom: 24px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .card-header {
            background-color: #f8f9fa; border-bottom: 1px solid #e9ecef;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            font-weight: 600;
            color: #343a40;
            padding: 1rem 1.5rem;
        }
        .form-card-link {
            cursor: pointer; transition: transform 0.2s ease-in-out;
        }
        .form-card-link:hover {
            transform: translateY(-3px);
        }
        .danger-note {
            background: #fff3f2; border: 1px solid #ffcbc4; padding: 1rem;
            border-radius: 8px; color: #b02a37; font-size: 0.875rem;
        }
        .hidden { display: none !important; }
        label.required::after { content: " *"; color: #d63333; font-weight: 700; margin-left: 2px; }
        .designer-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 1rem; }
        @media (min-width: 768px) {
            .designer-row { flex-direction: row; align-items: center; }
        }
        .designer-row .col-label { flex: 1; }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">संचालनालय कृषि छत्तीसगढ़ — Admin</div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btnHome" class="btn btn-sm btn-light">Home</button>
            <button id="btnDashboard" class="btn btn-sm btn-light">Dashboard</button>
            <button id="btnLogout" class="btn btn-sm btn-dark">Logout</button>
        </div>
    </div>

    <div class="container container-app">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">नए फॉर्म बनाएं</div>
                    <div class="card-body">
                        <p class="card-text text-muted">Excel फ़ाइल अपलोड करें, फिर टेबल बनाएं।</p>
                        
                        <div class="mb-3">
                            <label for="inputExcel" class="form-label required">Excel फ़ाइल अपलोड</label>
                            <input id="inputExcel" type="file" accept=".xlsx,.xls" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="inputTableName" class="form-label">टेबल का नाम (वैकल्पिक)</label>
                            <input id="inputTableName" class="form-control" placeholder="यदि खाली, फ़ाइल का नाम उपयोग होगा" />
                        </div>

                        <div class="d-grid mt-4">
                            <button id="btnPreviewDesigner" class="btn btn-primary btn-sm">Preview Designer</button>
                        </div>

                        <hr class="my-4">
                        
                        <div class="danger-note">
                            सुरक्षा: यह UI सीधे Supabase को SQL कमांड भेजता है। प्रोडक्शन में, इस सुविधा को सर्वर-साइड (service-role key के साथ) सुरक्षित रूप से चलाएं।
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header" id="mainHeader">Dashboard</div>
                    <div class="card-body">
                        <div id="mainContent">
                            <div id="welcomeBlock">
                                <h4 class="card-title">Admin Form Designer</h4>
                                <p class="text-muted">Excel फ़ाइल अपलोड करें, हेडर की पुष्टि करें, लेबल/प्रकार संपादित करें, फिर टेबल बनाएं और फ़ॉर्म परिभाषा सहेजें। फ़ाइल की कोई भी पंक्ति बनाई गई तालिका में नहीं डाली जाती है।</p>
                            </div>
            
                            <div id="previewArea" class="mt-4 hidden">
                                <h5 class="card-title">Designer Preview</h5>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div><strong>Table:</strong> <span id="previewTableName" class="text-primary"></span></div>
                                    <div class="text-muted small">Columns detected: <span id="previewColsCount"></span></div>
                                </div>
            
                                <div id="designerFields" class="mb-3"></div>
            
                                <div class="d-flex gap-2">
                                    <button id="btnCreateConfirm" class="btn btn-success">Create Table & Save Definition</button>
                                    <button id="btnCancelPreview" class="btn btn-outline-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div id="definitionsArea" class="hidden">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Saved Forms Dashboard</h5>
                                <button id="btnReloadDefs" class="btn btn-sm btn-outline-primary">Reload</button>
                            </div>
                            <div id="definitionsBucket" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertToast" style="position:fixed; right:1rem; bottom:1rem; z-index:9999;"></div>

    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">Form Definition</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Table Name:</strong> <span id="modalTableName"></span></p>
                    <p><strong>Created By:</strong> <span id="modalCreatedBy"></span></p>
                    <p><strong>Created At:</strong> <span id="modalCreatedAt"></span></p>
                    <hr>
                    <h6>Fields:</h6>
                    <ul id="modalFieldsList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dropModal" tabindex="-1" aria-labelledby="dropModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-danger" id="dropModalLabel">Drop Table?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            आप निश्चित हैं कि आप इस टेबल "<span id="dropTableName"></span>" को हटाना चाहते हैं? यह क्रिया सभी डेटा को स्थायी रूप से हटा देगी।
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDropBtn">Drop</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="viewDataModal" tabindex="-1" aria-labelledby="viewDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewDataModalLabel">Data for: <span id="dataModalTableName"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <label for="startDateFilter">From:</label>
                    <input type="date" id="startDateFilter" class="form-control form-control-sm">
                    <label for="endDateFilter">To:</label>
                    <input type="date" id="endDateFilter" class="form-control form-control-sm">
                    <button id="applyDateFilterBtn" class="btn btn-sm btn-primary">Apply Filter</button>
                </div>
                <div>
                    <button id="exportExcelBtn" class="btn btn-sm btn-success me-2">Export to Excel</button>
                    <button id="exportPdfBtn" class="btn btn-sm btn-danger">Export to PDF</button>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
              <table class="table table-striped table-bordered table-sm">
                <thead id="dataModalTableHead"></thead>
                <tbody id="dataModalTableBody"></tbody>
              </table>
            </div>
            <nav>
                <ul class="pagination pagination-sm justify-content-center mt-3" id="pagination"></ul>
            </nav>
            <div id="dataStatus" class="text-center text-muted mt-2">Loading data...</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
<script>
/* ---------------- Supabase configuration ---------------- */
const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ---------------- Helpers & Utilities ---------------- */
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
function toast(msg, type='info') {
    const div = document.createElement('div');
    div.className = `alert alert-${type} shadow`;
    div.style.minWidth = '240px';
    div.textContent = msg;
    $('alertToast').appendChild(div);
    setTimeout(() => div.remove(), 5000);
}
function sanitizeIdentifier(name) {
    return String(name || '').replace(/\.[^/.]+$/, '').trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() || `table_${Date.now()}`;
}
function sanitizeColName(str, idx) {
    let s = String(str || `column_${idx+1}`).trim().replace(/[^a-zA-Z0-9_]/g,'');
    if (!s) s = `column_${idx+1}`;
    return s;
}
function getCurrentUser() {
    const s = localStorage.getItem('user') || sessionStorage.getItem('user');
    return s ? JSON.parse(s) : null;
}
function setStatus(msg, type='text-muted') {
    const el = $('dataStatus');
    el.textContent = msg;
    el.className = `text-center mt-2 ${type}`;
}

/* ---------------- State Management ---------------- */
let currentUser = null;
let lastHeaders = [];
let lastTableName = '';
let definitionsCache = [];
let dropTableName = '';
let allTableData = [];
let currentPage = 1;
const rowsPerPage = 25;
/* ---------------- Init & Event Listeners ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
    currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
        alert('Admin access required. Redirecting to login.');
        location.href = 'login.html';
        return;
    }

    // Set up navigation buttons
    $('btnLogout').addEventListener('click', () => { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href = 'login.html'; });
    $('btnHome').addEventListener('click', showCreator);
    $('btnDashboard').addEventListener('click', showDefinitionsDashboard);
    $('btnReloadDefs').addEventListener('click', loadDefinitions);
    
    // Set up form and designer buttons
    $('btnPreviewDesigner').addEventListener('click', processExcel);
    $('btnCancelPreview').addEventListener('click', () => hide($('previewArea')));
    $('btnCreateConfirm').addEventListener('click', createTableAndSaveDef);
    $('confirmDropBtn').addEventListener('click', dropTableConfirmed);

    // Set up export buttons
    $('exportExcelBtn').addEventListener('click', exportToExcel);
    $('exportPdfBtn').addEventListener('click', exportToPdf);
    // Initial view
    showCreator();
    loadDefinitions();
});

/* ---------------- View Management ---------------- */
function showCreator() {
    $('mainHeader').textContent = 'Form Creator';
    show($('mainContent'));
    hide($('definitionsArea'));
    hide($('previewArea'));
}

function showDefinitionsDashboard() {
    $('mainHeader').textContent = 'Dashboard';
    hide($('mainContent'));
    hide($('previewArea'));
    show($('definitionsArea'));
    renderDefinitionsDashboard();
}

/* ---------------- Excel Processing Logic ---------------- */
function processExcel() {
    const f = $('inputExcel').files[0];
    if (!f) return toast('कृपया Excel फ़ाइल चुनें', 'warning');
    
    setStatus('Processing Excel file...');
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (!rows || !rows.length || !rows[0].length) {
                setStatus('Failed to read file.', 'text-danger');
                return toast('फ़ाइल में हेडर नहीं मिले', 'danger');
            }

            lastHeaders = rows[0].map(h => String(h||'').trim());
            lastTableName = sanitizeIdentifier($('inputTableName').value || f.name);
            showDesignerPreview(lastTableName, lastHeaders);
            setStatus('');
            
        } catch(err) {
            console.error(err);
            setStatus('Failed to read file.', 'text-danger');
            toast('फ़ाइल पढ़ने में त्रुटि', 'danger');
        }
    };
    reader.readAsArrayBuffer(f);
}

function showDesignerPreview(tableName, headers) {
    $('previewTableName').textContent = tableName;
    $('previewColsCount').textContent = headers.length;
    const container = $('designerFields');
    container.innerHTML = '';
    headers.forEach((h, i) => {
        const row = document.createElement('div');
        row.className = 'designer-row';
        row.innerHTML = `
            <div class="col-12 col-md-4">
                <input type="text" class="form-control form-control-sm col-label" value="${h || `Column ${i+1}`}">
            </div>
            <div class="col-12 col-md-4">
                <input type="text" class="form-control form-control-sm" value="${sanitizeColName(h, i)}">
            </div>
            <div class="col-12 col-md-4">
                <select class="form-select form-select-sm">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                </select>
            </div>
        `;
        container.appendChild(row);
    });
    show($('previewArea'));
}

/* ---------------- Supabase DDL & Form Definition Saving ---------------- */
async function createTableAndSaveDef() {
    setStatus('Creating table and saving definition...');
    try {
        const container = $('designerFields');
        if (!container.children.length) {
            setStatus('Designer empty', 'text-warning');
            return toast('Designer empty', 'warning');
        }

        const tableName = $('previewTableName').textContent || sanitizeIdentifier($('inputTableName').value || 'table_' + Date.now());
        
        const seen = new Set();
        const fields = [];
        const columns = Array.from(container.children).map((row, idx) => {
            const labelInput = row.querySelector('input.col-label');
            const colNameInput = row.querySelectorAll('input')[1];
            const typeSel = row.querySelector('select');
            
            const label = labelInput ? labelInput.value.trim() : `Column ${idx+1}`;
            let col = colNameInput ? colNameInput.value.trim() : sanitizeColName(label, idx);
            col = col.replace(/[^a-zA-Z0-9_]/g, '') || `column_${idx+1}`;
            
            const base = col; let s = 1;
            while (seen.has(col.toLowerCase())) col = `${base}_${s++}`;
            seen.add(col.toLowerCase());
            
            const sqlType = (typeSel?.value === 'number') ? 'NUMERIC' : (typeSel?.value === 'date' ? 'DATE' : 'TEXT');
            fields.push({ name: col, label, position: idx, type: typeSel?.value || 'text', required: false });
            return `"${col}" ${sqlType}`;
        }).join(', ');
        const ddl = `CREATE TABLE IF NOT EXISTS public."${tableName}" (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            ${columns},
            created_at TIMESTAMPTZ DEFAULT now() NOT NULL
        );`;
        // Execute DDL via RPC
        const { error: rpcErr } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
        if (rpcErr) throw new Error('Failed to create table: ' + rpcErr.message);
        
        // --- START OF MODIFICATION ---
        const def = {
            table_name: tableName,
            label: tableName,
            created_by: currentUser.id,
            created_at: new Date().toISOString(),
            fields,
            // Add the district_id here
            district_id: currentUser.districtId 
        };
        // --- END OF MODIFICATION ---
        
        // Save form definition
        const { error: insertErr } = await supabase.from('form_definitions').insert([def]);
        if (insertErr) throw new Error('Failed to save definition: ' + insertErr.message);
        
        toast(`Table & definition created: ${tableName}`, 'success');
        hide($('previewArea'));
        $('inputTableName').value = '';
        $('inputExcel').value = '';
        await loadDefinitions();
        showDefinitionsDashboard();
        setStatus('');
        
    } catch (err) {
        console.error('Create failed:', err);
        setStatus('Create failed.', 'text-danger');
        toast('Create failed: ' + (err.message || JSON.stringify(err)), 'danger');
    }
}

/* ---------------- Definitions Dashboard Logic ---------------- */
async function loadDefinitions() {
    setStatus('Loading forms...');
    try {
        const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        definitionsCache = data || [];
        renderDefinitionsDashboard();
        setStatus('');
    } catch (err) {
        console.error('loadDefinitions', err);
        setStatus('Failed to load forms.', 'text-danger');
        toast('Failed to load definitions: ' + (err.message || JSON.stringify(err)), 'danger');
    }
}
function renderDefinitionsDashboard() {
    const bucket = $('definitionsBucket');
    bucket.innerHTML = '';
    if (!definitionsCache.length) {
        bucket.innerHTML = '<div class="text-muted text-center p-4">No definitions found.</div>';
        return;
    }
    definitionsCache.forEach(def => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center flex-wrap';
        const left = document.createElement('div');
        left.className = 'mb-2 mb-sm-0';
        left.innerHTML = `<h6 class="mb-1">${def.label || def.table_name}</h6><div class="text-muted small">${(def.fields||[]).length} fields • ${new Date(def.created_at).toLocaleString()}</div>`;
        const right = document.createElement('div');
        const btnView = document.createElement('button');
        btnView.className = 'btn btn-sm btn-outline-secondary me-1';
        btnView.textContent = 'View';
        btnView.addEventListener('click', () => viewDefinition(def));
        const btnViewData = document.createElement('button');
        btnViewData.className = 'btn btn-sm btn-primary me-1';
        btnViewData.textContent = 'View Data';
        btnViewData.addEventListener('click', () => viewData(def.table_name));
        const btnDrop = document.createElement('button');
        btnDrop.className = 'btn btn-sm btn-danger';
        btnDrop.textContent = 'Drop';
        btnDrop.addEventListener('click', () => showDropModal(def.table_name));
        right.appendChild(btnView);
        right.appendChild(btnViewData);
        right.appendChild(btnDrop);
        item.appendChild(left);
        item.appendChild(right);
        bucket.appendChild(item);
    });
}
function viewDefinition(def) {
    $('modalTableName').textContent = def.table_name;
    $('modalCreatedBy').textContent = def.created_by;
    $('modalCreatedAt').textContent = new Date(def.created_at).toLocaleString();
    const fieldsList = $('modalFieldsList');
    fieldsList.innerHTML = '';
    def.fields.forEach(f => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `${f.label} (${f.name}) [${f.type}]`;
        fieldsList.appendChild(li);
    });
    const viewModal = new bootstrap.Modal($('viewModal'));
    viewModal.show();
}
async function viewData(tableName) {
    setStatus('Loading data...');
    try {
        const def = definitionsCache.find(d => d.table_name === tableName);
        if (!def) {
            setStatus('Form definition not found.', 'text-danger');
            return toast('Form definition not found!', 'danger');
        }
        $('dataModalTableName').textContent = def.label || tableName;
        const { data: allData, error: allDataError } = await supabase.from(tableName).select('*').order('created_at', { ascending: false });
        if (allDataError) throw allDataError;
        allTableData = allData;
        renderTableData(tableName, 1);
        const viewDataModal = new bootstrap.Modal($('viewDataModal'));
        viewDataModal.show();
        const applyFilterBtn = $('applyDateFilterBtn');
        if (applyFilterBtn) {
            applyFilterBtn.onclick = applyDateFilter;
        }
    } catch (err) {
        console.error('Data view failed:', err);
        setStatus('Failed to view data.', 'text-danger');
        toast('Failed to view data: ' + (err.message || JSON.stringify(err)), 'danger');
    }
}
async function renderTableData(tableName, page) {
    currentPage = page;
    const startDateStr = $('startDateFilter').value;
    const endDateStr = $('endDateFilter').value;
    let filteredData = allTableData;
    if (startDateStr || endDateStr) {
        const startDate = startDateStr ? new Date(startDateStr) : null;
        const endDate = endDateStr ?
        new Date(endDateStr + 'T23:59:59.999Z') : null;
        filteredData = allTableData.filter(row => {
            const rowDate = new Date(row.created_at);
            const isAfterStart = startDate ? rowDate >= startDate : true;
            const isBeforeEnd = endDate ? rowDate <= endDate : true;
            return isAfterStart && isBeforeEnd;
        });
    }

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = filteredData.slice(start, end);
    const tableBody = $('dataModalTableBody');
    const tableHead = $('dataModalTableHead');

    tableBody.innerHTML = '';
    tableHead.innerHTML = '';

    if (paginatedData.length > 0) {
        const headers = Object.keys(paginatedData[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        paginatedData.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header];
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        setStatus(`${filteredData.length} records found. Page ${page} of ${Math.ceil(filteredData.length / rowsPerPage)}.`);
    } else {
        tableHead.innerHTML = '';
        setStatus('No data available.', 'text-warning');
    }

    renderPagination(filteredData.length);
}

function renderPagination(totalRows) {
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const paginationEl = $('pagination');
    paginationEl.innerHTML = '';

    if (totalPages <= 1) return;

    const createPageItem = (page, isActive = false, isDisabled = false) => {
        const li = document.createElement('li');
        li.className = `page-item ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = page;
        if (!isDisabled) {
            a.addEventListener('click', () => renderTableData(lastTableName, page));
        }
        li.appendChild(a);
        return li;
    };

    paginationEl.appendChild(createPageItem('Previous', false, currentPage === 1));

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
        paginationEl.appendChild(createPageItem(1));
        if (startPage > 2) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">...</span>';
            paginationEl.appendChild(li);
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        paginationEl.appendChild(createPageItem(i, i === currentPage));
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">...</span>';
            paginationEl.appendChild(li);
        }
        paginationEl.appendChild(createPageItem(totalPages));
    }

    paginationEl.appendChild(createPageItem('Next', false, currentPage === totalPages));
}

function applyDateFilter() {
    renderTableData(lastTableName, 1);
}

function showDropModal(tableName) {
    $('dropTableName').textContent = tableName;
    dropTableName = tableName;
    const dropModal = new bootstrap.Modal($('dropModal'));
    dropModal.show();
}

async function dropTableConfirmed() {
    const tableName = dropTableName;
    try {
        const { error: rpcErr } = await supabase.rpc('drop_table', { table_name: tableName });
        if (rpcErr) throw rpcErr;

        const { error: deleteErr } = await supabase.from('form_definitions').delete().eq('table_name', tableName);
        if (deleteErr) throw deleteErr;

        toast(`Table ${tableName} and its definition dropped successfully.`, 'success');
        loadDefinitions();
    } catch (err) {
        console.error('Drop table failed:', err);
        toast('Failed to drop table: ' + (err.message || JSON.stringify(err)), 'danger');
    }
    const dropModal = bootstrap.Modal.getInstance($('dropModal'));
    if (dropModal) dropModal.hide();
}


/* ---------------- Export Functionality ---------------- */

async function exportToExcel() {
    if (allTableData.length === 0) {
        toast('No data to export.', 'warning');
        return;
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(allTableData);
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `${$('dataModalTableName').textContent}_data.xlsx`);
}

async function exportToPdf() {
    if (allTableData.length === 0) {
        toast('No data to export.', 'warning');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt');

    const headers = Object.keys(allTableData[0]);
    const data = allTableData.map(row => headers.map(header => String(row[header])));

    doc.autoTable({
        head: [headers],
        body: data,
        theme: 'striped',
        styles: {
            font: 'Helvetica',
            fontSize: 8,
            cellPadding: 4,
        },
        headStyles: {
            fillColor: [23, 101, 49],
            textColor: 255
        },
        columnStyles: {
            created_at: {
                cellWidth: 'auto',
            },
        },
        margin: { top: 10, right: 10, bottom: 10, left: 10 }
    });

    doc.save(`${$('dataModalTableName').textContent}_data.pdf`);
}
</script>
</body>
</html>
