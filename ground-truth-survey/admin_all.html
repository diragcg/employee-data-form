<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — Form Designer (संचालनालय कृषि छत्तीसगढ़)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mukta:wght@400;700&display=swap');
        body { font-family: 'Mukta', sans-serif; background: #FFF8E1; }
        .topbar {
            position: fixed; top: 0; left: 0; right: 0; height: 64px;
            background: #1B5E20; color: #fff; display: flex; align-items: center;
            padding: 0 1rem; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .topbar .brand { font-weight: 700; font-size: 1rem; margin-left: 0.5rem; text-transform: uppercase; }
        .container-app { padding-top: 80px; padding-bottom: 24px; }
        .main-card {
            background: #fff; border-radius: 10px; padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            height: 100%;
        }
        .form-section {
            background: #fff; border-radius: 10px; padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            height: 100%;
        }
        .header-small { font-weight: 700; color: #1B5E20; }
        .muted-small { color: #6b7280; font-size: 13px; }
        .danger-note {
            background: #fff3f2; border: 1px solid #ffcbc4; padding: 1rem;
            border-radius: 8px; color: #b02a37;
        }
        .hidden { display: none !important; }
        label.required::after { content: " *"; color: #d63333; font-weight: 700; margin-left: 2px; }
        .designer-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 1rem; }
        @media (min-width: 768px) {
            .designer-row { flex-direction: row; align-items: center; }
        }
        .designer-row .col-label { flex: 1; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <div class="topbar">
        <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" alt="supabase" width="34" height="34">
        <div class="brand d-none d-sm-block ms-2">संचालनालय कृषि छत्तीसगढ़ — Admin</div>
        <div class="brand d-sm-none ms-2">Admin</div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btnHome" class="btn btn-sm btn-light">Home</button>
            <button id="btnDashboard" class="btn btn-sm btn-light">Dashboard</button>
            <button id="btnLogout" class="btn btn-sm btn-outline-light">Logout</button>
        </div>
    </div>

    <div class="container container-app">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="form-section">
                    <h5 class="header-small">नए फॉर्म बनाएं</h5>
                    <p class="muted-small">Excel फ़ाइल अपलोड करें, फिर टेबल बनाएं।</p>
                    
                    <div class="mb-3">
                        <label for="inputExcel" class="form-label required">Excel फ़ाइल अपलोड</label>
                        <input id="inputExcel" type="file" accept=".xlsx,.xls" class="form-control form-control-sm" />
                    </div>

                    <div class="mb-3">
                        <label for="inputTableName" class="form-label">टेबल का नाम (वैकल्पिक)</label>
                        <input id="inputTableName" class="form-control form-control-sm" placeholder="यदि खाली, फ़ाइल का नाम उपयोग होगा" />
                    </div>

                    <div class="d-grid gap-2">
                        <button id="btnPreviewDesigner" class="btn btn-primary btn-sm">Preview Designer</button>
                    </div>

                    <hr class="my-4">
                    
                    <div class="danger-note small-muted">
                        सुरक्षा: यह UI सीधे Supabase को SQL कमांड भेजता है। प्रोडक्शन में, इस सुविधा को सर्वर-साइड (service-role key के साथ) सुरक्षित रूप से चलाएं।
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="main-card">
                    <div id="mainContent">
                        <div id="welcomeBlock">
                            <h4>Admin Form Designer</h4>
                            <p class="muted-small">Excel फ़ाइल अपलोड करें, हेडर की पुष्टि करें, लेबल/प्रकार संपादित करें, फिर टेबल बनाएं और फ़ॉर्म परिभाषा सहेजें। फ़ाइल की कोई भी पंक्ति बनाई गई तालिका में नहीं डाली जाती है।</p>
                        </div>
        
                        <div id="previewArea" class="mt-3 hidden">
                            <h5 class="header-small mb-3">Designer Preview</h5>
                            <div class="mb-2 d-flex justify-content-between align-items-center">
                                <div><strong>Table:</strong> <span id="previewTableName" class="text-primary"></span></div>
                                <div class="small-muted">Columns detected: <span id="previewColsCount"></span></div>
                            </div>
        
                            <div id="designerFields" class="mb-3"></div>
        
                            <div class="d-flex gap-2">
                                <button id="btnCreateConfirm" class="btn btn-success">Create Table & Save Definition</button>
                                <button id="btnCancelPreview" class="btn btn-outline-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="definitionsArea" class="hidden">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="header-small mb-0">Saved Forms Dashboard</h5>
                            <button id="btnReloadDefs" class="btn btn-sm btn-outline-primary">Reload</button>
                        </div>
                        <div id="definitionsBucket" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertToast" style="position:fixed; right:1rem; bottom:1rem; z-index:9999;"></div>

    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">Form Definition</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Table Name:</strong> <span id="modalTableName"></span></p>
                    <p><strong>Created By:</strong> <span id="modalCreatedBy"></span></p>
                    <p><strong>Created At:</strong> <span id="modalCreatedAt"></span></p>
                    <hr>
                    <h6>Fields:</h6>
                    <ul id="modalFieldsList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dropModal" tabindex="-1" aria-labelledby="dropModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-danger" id="dropModalLabel">Drop Table?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            आप निश्चित हैं कि आप इस टेबल "<span id="dropTableName"></span>" को हटाना चाहते हैं? यह क्रिया सभी डेटा को स्थायी रूप से हटा देगी।
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDropBtn">Drop</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="viewDataModal" tabindex="-1" aria-labelledby="viewDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewDataModalLabel">Data for: <span id="dataModalTableName"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
              <table class="table table-striped table-bordered table-sm">
                <thead id="dataModalTableHead"></thead>
                <tbody id="dataModalTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

<script>
/* ---------------- Supabase configuration ---------------- */
const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ---------------- Helpers & Utilities ---------------- */
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');

function toast(msg, type='info') {
    const div = document.createElement('div');
    div.className = `alert alert-${type} shadow`;
    div.style.minWidth = '240px';
    div.textContent = msg;
    $('alertToast').appendChild(div);
    setTimeout(() => div.remove(), 5000);
}
function sanitizeIdentifier(name) {
    return String(name || '').replace(/\.[^/.]+$/, '').trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() || `table_${Date.now()}`;
}
function sanitizeColName(str, idx) {
    let s = String(str || `column_${idx+1}`).trim().replace(/[^a-zA-Z0-9_]/g,'');
    if (!s) s = `column_${idx+1}`; return s;
}
function getCurrentUser() {
    const s = localStorage.getItem('user') || sessionStorage.getItem('user');
    return s ? JSON.parse(s) : null;
}
function showLoading() { show($('loadingOverlay')); }
function hideLoading() { hide($('loadingOverlay')); }

/* ---------------- State Management ---------------- */
let currentUser = null;
let lastHeaders = [];
let lastTableName = '';
let definitionsCache = [];
let dropTableName = '';

/* ---------------- Init & Event Listeners ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
    currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
        alert('Admin access required. Redirecting to login.');
        location.href = 'login.html';
        return;
    }

    // Set up navigation buttons
    $('btnLogout').addEventListener('click', () => { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href = 'login.html'; });
    $('btnHome').addEventListener('click', showCreator);
    $('btnDashboard').addEventListener('click', showDefinitionsDashboard);
    $('btnReloadDefs').addEventListener('click', loadDefinitions);
    
    // Set up form and designer buttons
    $('btnPreviewDesigner').addEventListener('click', processExcel);
    $('btnCancelPreview').addEventListener('click', () => hide($('previewArea')));
    $('btnCreateConfirm').addEventListener('click', createTableAndSaveDef);
    $('confirmDropBtn').addEventListener('click', dropTableConfirmed);

    // Initial view
    showCreator();
    loadDefinitions();
});

/* ---------------- View Management ---------------- */
function showCreator() {
    show($('mainContent'));
    hide($('definitionsArea'));
    hide($('previewArea'));
}

function showDefinitionsDashboard() {
    hide($('mainContent'));
    hide($('previewArea'));
    show($('definitionsArea'));
    renderDefinitionsDashboard();
}

/* ---------------- Excel Processing Logic ---------------- */
function processExcel() {
    const f = $('inputExcel').files[0];
    if (!f) return toast('कृपया Excel फ़ाइल चुनें', 'warning');
    
    showLoading();
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (!rows || !rows.length || !rows[0].length) return toast('फ़ाइल में हेडर नहीं मिले', 'danger');

            lastHeaders = rows[0].map(h => String(h||'').trim());
            lastTableName = sanitizeIdentifier($('inputTableName').value || f.name);
            showDesignerPreview(lastTableName, lastHeaders);
            
        } catch(err) {
            console.error(err);
            toast('फ़ाइल पढ़ने में त्रुटि', 'danger');
        } finally {
            hideLoading();
        }
    };
    reader.readAsArrayBuffer(f);
}

function showDesignerPreview(tableName, headers) {
    $('previewTableName').textContent = tableName;
    $('previewColsCount').textContent = headers.length;
    const container = $('designerFields');
    container.innerHTML = '';
    headers.forEach((h, i) => {
        const row = document.createElement('div');
        row.className = 'designer-row';
        row.innerHTML = `
            <div class="col-12 col-md-4">
                <input type="text" class="form-control form-control-sm col-label" value="${h || `Column ${i+1}`}">
            </div>
            <div class="col-12 col-md-4">
                <input type="text" class="form-control form-control-sm" value="${sanitizeColName(h, i)}">
            </div>
            <div class="col-12 col-md-4">
                <select class="form-select form-select-sm">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                </select>
            </div>
        `;
        container.appendChild(row);
    });
    show($('previewArea'));
}

/* ---------------- Supabase DDL & Form Definition Saving ---------------- */
async function createTableAndSaveDef() {
    showLoading();
    try {
        const container = $('designerFields');
        if (!container.children.length) {
            toast('Designer empty', 'warning');
            hideLoading();
            return;
        }

        const tableName = $('previewTableName').textContent || sanitizeIdentifier($('inputTableName').value || 'table_' + Date.now());
        
        const seen = new Set();
        const fields = [];
        const columns = Array.from(container.children).map((row, idx) => {
            const labelInput = row.querySelector('input.col-label');
            const colNameInput = row.querySelectorAll('input')[1];
            const typeSel = row.querySelector('select');
            
            const label = labelInput ? labelInput.value.trim() : `Column ${idx+1}`;
            let col = colNameInput ? colNameInput.value.trim() : sanitizeColName(label, idx);
            col = col.replace(/[^a-zA-Z0-9_]/g, '') || `column_${idx+1}`;
            
            const base = col; let s = 1;
            while (seen.has(col.toLowerCase())) col = `${base}_${s++}`;
            seen.add(col.toLowerCase());
            
            const sqlType = (typeSel?.value === 'number') ? 'NUMERIC' : (typeSel?.value === 'date' ? 'DATE' : 'TEXT');
            fields.push({ name: col, label, position: idx, type: typeSel?.value || 'text', required: false });
            return `"${col}" ${sqlType}`;
        }).join(', ');

        const ddl = `CREATE TABLE IF NOT EXISTS public."${tableName}" (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            ${columns},
            created_at TIMESTAMPTZ DEFAULT now() NOT NULL
        );`;
        
        // Execute DDL via RPC
        const { error: rpcErr } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
        if (rpcErr) throw new Error('Failed to create table: ' + rpcErr.message);

        // Save form definition
        const def = {
            table_name: tableName,
            label: tableName,
            created_by: currentUser.id,
            created_at: new Date().toISOString(),
            fields
        };
        const { error: insertErr } = await supabase.from('form_definitions').insert([def]);
        if (insertErr) throw new Error('Failed to save definition: ' + insertErr.message);

        toast(`Table & definition created: ${tableName}`, 'success');
        hide($('previewArea'));
        $('inputTableName').value = '';
        $('inputExcel').value = '';
        await loadDefinitions();
        showDefinitionsDashboard();
        
    } catch (err) {
        console.error('Create failed:', err);
        toast('Create failed: ' + (err.message || JSON.stringify(err)), 'danger');
    } finally {
        hideLoading();
    }
}

/* ---------------- Definitions Dashboard Logic ---------------- */
async function loadDefinitions() {
    showLoading();
    try {
        const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        definitionsCache = data || [];
        renderDefinitionsDashboard();
    } catch (err) {
        console.error('loadDefinitions', err);
        toast('Failed to load definitions: ' + (err.message || JSON.stringify(err)), 'danger');
    } finally {
        hideLoading();
    }
}

function renderDefinitionsDashboard() {
    const bucket = $('definitionsBucket');
    bucket.innerHTML = '';
    if (!definitionsCache.length) {
        bucket.innerHTML = '<div class="text-muted text-center p-4">No definitions found.</div>';
        return;
    }
    definitionsCache.forEach(def => {
        const card = document.createElement('div');
        card.className = 'border rounded p-3 mb-2 d-flex justify-content-between align-items-center flex-wrap';
        
        const left = document.createElement('div');
        left.className = 'mb-2 mb-sm-0';
        left.innerHTML = `<div class="fw-semibold">${def.label || def.table_name}</div><div class="small-muted">${(def.fields||[]).length} fields • ${new Date(def.created_at).toLocaleString()}</div>`;
        
        const right = document.createElement('div');
        const btnView = document.createElement('button');
        btnView.className = 'btn btn-sm btn-outline-primary me-1';
        btnView.textContent = 'View';
        btnView.addEventListener('click', () => viewDefinition(def));
        
        const btnViewData = document.createElement('button');
        btnViewData.className = 'btn btn-sm btn-info me-1';
        btnViewData.textContent = 'View Data';
        btnViewData.addEventListener('click', () => viewData(def.table_name));

        const btnDrop = document.createElement('button');
        btnDrop.className = 'btn btn-sm btn-danger';
        btnDrop.textContent = 'Drop';
        btnDrop.addEventListener('click', () => showDropModal(def.table_name));
        
        right.appendChild(btnView);
        right.appendChild(btnViewData);
        right.appendChild(btnDrop);
        
        card.appendChild(left);
        card.appendChild(right);
        bucket.appendChild(card);
    });
}

function viewDefinition(def) {
    $('modalTableName').textContent = def.table_name;
    $('modalCreatedBy').textContent = def.created_by;
    $('modalCreatedAt').textContent = new Date(def.created_at).toLocaleString();
    const fieldsList = $('modalFieldsList');
    fieldsList.innerHTML = '';
    def.fields.forEach(f => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `${f.label} (${f.name}) [${f.type}]`;
        fieldsList.appendChild(li);
    });
    const viewModal = new bootstrap.Modal($('viewModal'));
    viewModal.show();
}

// New function to handle data viewing
async function viewData(tableName) {
    showLoading();
    try {
        const { data, error } = await supabase.from(tableName).select('*').order('created_at', { ascending: false });
        if (error) throw error;
        
        const def = definitionsCache.find(d => d.table_name === tableName);
        
        $('dataModalTableName').textContent = def.label || tableName;
        const tableHead = $('dataModalTableHead');
        const tableBody = $('dataModalTableBody');
        
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        
        const headerRow = document.createElement('tr');
        const headers = ['ID', 'Created At', ...def.fields.map(f => f.label)];
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);
        
        if (!data || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center text-muted">No data found.</td></tr>`;
        } else {
            data.forEach(row => {
                const tr = document.createElement('tr');
                const idCell = document.createElement('td');
                idCell.textContent = row.id;
                tr.appendChild(idCell);
                
                const createdAtCell = document.createElement('td');
                createdAtCell.textContent = new Date(row.created_at).toLocaleString();
                tr.appendChild(createdAtCell);
                
                def.fields.forEach(field => {
                    const td = document.createElement('td');
                    td.textContent = row[field.name] || '-';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        const viewDataModal = new bootstrap.Modal($('viewDataModal'));
        viewDataModal.show();
        
    } catch (err) {
        console.error('Data view failed:', err);
        toast('Failed to view data: ' + (err.message || JSON.stringify(err)), 'danger');
    } finally {
        hideLoading();
    }
}

function showDropModal(tableName) {
    dropTableName = tableName;
    $('dropTableName').textContent = tableName;
    const dropModal = new bootstrap.Modal($('dropModal'));
    dropModal.show();
}

async function dropTableConfirmed() {
    showLoading();
    try {
        const ddl = `DROP TABLE IF EXISTS public."${dropTableName}" CASCADE;`;
        const { error: dropErr } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
        if (dropErr) throw dropErr;
        
        const { error: delErr } = await supabase.from('form_definitions').delete().eq('table_name', dropTableName);
        if (delErr) throw delErr;
        
        toast(`Table "${dropTableName}" dropped successfully`, 'success');
        bootstrap.Modal.getInstance($('dropModal')).hide();
        await loadDefinitions();
    } catch (err) {
        console.error('Drop failed:', err);
        toast('Drop failed: ' + (err.message || JSON.stringify(err)), 'danger');
    } finally {
        hideLoading();
    }
}
</script>
</body>
</html>
