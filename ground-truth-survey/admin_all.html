<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Form Designer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Load Supabase UMD bundle BEFORE inline script that creates client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    body { font-family: 'Mukta', system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#FFF8E1; }
    .container { max-width:1100px; margin:84px auto; }
    .card-sm { border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.06); background:#fff; padding:18px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" width="40" alt="">
        <span class="h4 ms-2">संचालनालय कृषि छत्तीसगढ़ — Admin</span>
      </div>
      <div>
        <button id="btnLogout" class="btn btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div id="alertArea"></div>

    <div class="card-sm mb-3">
      <h5>Upload Excel (.xlsx/.xls)</h5>
      <p class="text-muted">First row will be used as headers. No file rows will be inserted into the created table. Admin-only operation.</p>

      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <input id="excelFile" type="file" accept=".xlsx,.xls" class="form-control" />
        </div>
        <div class="col-md-3">
          <input id="tableNameInput" class="form-control" placeholder="Optional table name (or use filename)" />
        </div>
        <div class="col-md-2">
          <button id="processBtn" class="btn btn-primary w-100">Process & Create</button>
        </div>
        <div class="col-md-3 text-end">
          <button id="reloadDefs" class="btn btn-outline-primary">Reload Definitions</button>
        </div>
      </div>

      <div id="headersPreview" class="mt-3"></div>
    </div>

    <div class="card-sm mb-3">
      <h5>Saved Form Definitions</h5>
      <div id="definitionsList" class="mt-2"></div>
    </div>
  </div>

<script>
/* --------- CONFIG - Insert your Supabase values here ---------
  Replace SUPABASE_URL and SUPABASE_KEY (anon/public key) with your project's values.
  Use the anon/public key for client-side operations in dev/testing.
  Do NOT embed service_role key in frontend.
*/
const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const SUPABASE_KEY = 'PASTE_YOUR_ANON_KEY_HERE_FULL';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);
function showMessage(msg, type='info') {
  $('alertArea').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=> { if ($('alertArea')) $('alertArea').innerHTML = ''; }, 6000);
}
function sanitizeIdentifier(name) {
  return String(name||'').replace(/\.[^/.]+$/, '').trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() || `table_${Date.now()}`;
}
function sanitizeColName(str, idx) {
  let s = String(str||`column_${idx+1}`).trim().replace(/[^a-zA-Z0-9_]/g,'');
  if (!s) s = `column_${idx+1}`; return s;
}
function getCurrentUser() {
  const s = localStorage.getItem('user') || sessionStorage.getItem('user');
  return s ? JSON.parse(s) : null;
}
async function ensureAdmin() {
  const u = getCurrentUser();
  if (!u || u.role !== 'admin') {
    alert('Admin access required. Redirecting to login.');
    location.href = 'login.html';
    throw new Error('Not admin');
  }
  return u;
}

/* ---------------- Page init ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await ensureAdmin();
    loadDefinitions();
  } catch(e){ console.warn(e); }
});

/* ---------------- Logout ---------------- */
$('btnLogout').addEventListener('click', ()=> {
  localStorage.removeItem('user'); sessionStorage.removeItem('user');
  location.href = 'login.html';
});

/* ---------------- Process Excel -> Create table + save form_definitions ---------------- */
$('processBtn').addEventListener('click', async () => {
  try {
    await ensureAdmin();
    const f = $('excelFile').files[0];
    if (!f) return showMessage('Please choose an Excel file', 'warning');

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (!rows || !rows.length || !rows[0].length) return showMessage('File has no headers', 'danger');

        const headers = rows[0].map(h => String(h||'').trim());
        const suggested = sanitizeIdentifier($('tableNameInput').value || f.name);

        // preview
        $('headersPreview').innerHTML = `<div><strong>Table:</strong> ${suggested}</div>` +
          `<div class="mt-2">${headers.map(h=>`<span class="badge bg-light text-dark me-1 mb-1" style="border:1px solid #e6e6e6">${h||'(empty)'}</span>`).join('')}</div>`;

        if (!confirm(`Create table "${suggested}" with ${headers.length} columns? (No file rows will be inserted)`)) return;

        // Build sanitized unique column list
        const seen = new Set();
        const cols = headers.map((h,i) => {
          let col = sanitizeColName(h, i);
          const base = col; let s = 1;
          while (seen.has(col.toLowerCase())) col = `${base}_${s++}`;
          seen.add(col.toLowerCase());
          return `"${col}" TEXT`;
        }).join(', ');
        const ddl = `CREATE TABLE IF NOT EXISTS public."${suggested}" (${cols});`;

        // EXECUTE DDL via RPC 'execute_sql_script' (must exist). WARNING: for dev only.
        const { error: rpcErr } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
        if (rpcErr) {
          // common failure: invalid API key or RPC missing/permission denied
          console.error('RPC error:', rpcErr);
          if (rpcErr.message && rpcErr.message.toLowerCase().includes('invalid api key')) {
            showMessage('Create failed: Invalid API key — check SUPABASE_KEY in the script (use anon/public key).', 'danger');
          } else {
            showMessage('Create failed: ' + (rpcErr.message || JSON.stringify(rpcErr)), 'danger');
          }
          return;
        }

        // Save metadata to form_definitions
        const fields = headers.map((h,i) => ({ name: sanitizeColName(h,i), label: String(h||`Column ${i+1}`), position: i }));
        const def = {
          table_name: suggested,
          label: suggested,
          created_by: getCurrentUser().id,
          created_at: new Date().toISOString(),
          fields
        };
        const { error: insErr } = await supabase.from('form_definitions').insert([def]);
        if (insErr) throw insErr;

        showMessage(`Table "${suggested}" created and definition saved.`, 'success');
        $('tableNameInput').value = ''; $('excelFile').value = '';
        loadDefinitions();
      } catch (err) {
        console.error(err);
        const msg = err && err.message ? err.message : JSON.stringify(err);
        showMessage('Create failed: ' + msg, 'danger');
      }
    };
    reader.readAsArrayBuffer(f);
  } catch(err) { console.error(err); showMessage('Processing failed: ' + (err.message||err), 'danger'); }
});

/* ---------------- Load definitions ---------------- */
async function loadDefinitions() {
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    renderDefinitions(data || []);
  } catch (err) {
    console.error('loadDefinitions', err);
    showMessage('Failed to load definitions: ' + (err.message || err), 'danger');
  }
}
$('reloadDefs').addEventListener('click', loadDefinitions);

function renderDefinitions(list) {
  const target = $('definitionsList');
  if (!list.length) { target.innerHTML = '<div class="text-muted">No definitions</div>'; return; }
  target.innerHTML = list.map(d => {
    const fieldsCount = (d.fields||[]).length;
    return `<div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-start">
      <div>
        <div class="fw-semibold">${d.table_name}</div>
        <div class="text-muted small">${fieldsCount} fields • created ${new Date(d.created_at).toLocaleString()}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-outline-primary me-1" data-view="${d.table_name}">View</button>
        <button class="btn btn-sm btn-danger" data-drop="${d.table_name}">Drop</button>
      </div>
    </div>`;
  }).join('');

  // attach listeners
  target.querySelectorAll('button[data-view]').forEach(btn => btn.addEventListener('click', ev => viewDefinition(ev.target.getAttribute('data-view'))));
  target.querySelectorAll('button[data-drop]').forEach(btn => btn.addEventListener('click', ev => dropTable(ev.target.getAttribute('data-drop'))));
}

async function viewDefinition(tableName) {
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').eq('table_name', tableName).single();
    if (error) throw error;
    const d = data;
    alert(`Definition: ${d.table_name}\nFields:\n${(d.fields||[]).map(f => `${f.position+1}. ${f.label} (${f.name})`).join('\n')}`);
  } catch (err) {
    console.error(err); showMessage('View failed: ' + (err.message || err), 'danger');
  }
}

async function dropTable(tableName) {
  if (!confirm(`Drop table "${tableName}"? This will delete all data.`)) return;
  try {
    const ddl = `DROP TABLE IF EXISTS public."${tableName}" CASCADE;`;
    const { error } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
    if (error) throw error;
    // delete definition
    const { error: delErr } = await supabase.from('form_definitions').delete().eq('table_name', tableName);
    if (delErr) throw delErr;
    showMessage(`Table "${tableName}" dropped`, 'success');
    loadDefinitions();
  } catch (err) {
    console.error(err); showMessage('Drop failed: ' + (err.message || err), 'danger');
  }
}
</script>
</body>
</html>
