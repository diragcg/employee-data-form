<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>संचालनालय कृषि छत्तीसगढ़ - ग्राउंड ट्रुथिंग सिस्टम</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Your existing CSS styles would be here -->
</head>
<body>
    <!-- Your existing HTML would be here -->

    <!-- Scripts at the end of the body -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <script>
        // Wait for DOM to fully load
        window.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            
            // Supabase configuration
            const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
            
            // Initialize Supabase client
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey);
            
            // Current user data
            let currentUser = null;
            
            // Simple function to handle navigation
            function navigateTo(sectionId) {
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show the requested section
                const targetSection = document.getElementById(sectionId + '-section');
                if (targetSection) {
                    targetSection.style.display = 'block';
                }
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeMenuItem = document.getElementById(sectionId + 'Link');
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }
            }
            
            // Function to handle logout
            function handleLogout() {
                console.log('Logging out');
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            }
            
            // Set up click events for navigation
            document.getElementById('dashboardLink').onclick = function(e) {
                e.preventDefault();
                navigateTo('dashboard');
            };
            
            document.getElementById('profileMenuLink').onclick = function(e) {
                e.preventDefault();
                navigateTo('profile');
            };
            
            document.getElementById('viewDataLink').onclick = function(e) {
                e.preventDefault();
                navigateTo('view-data');
            };
            
            document.getElementById('uploadDataLink').onclick = function(e) {
                e.preventDefault();
                navigateTo('upload-data');
            };
            
            document.getElementById('downloadTemplateLink').onclick = function(e) {
                e.preventDefault();
                navigateTo('download-template');
            };
            
            // Set up logout button
            document.getElementById('logoutLink').onclick = function(e) {
                e.preventDefault();
                handleLogout();
            };
            
            // Load user data on page load
            function loadUserData() {
                try {
                    const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user'));
                    if (!userData) {
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    currentUser = userData;
                    document.getElementById('userNameDisplay').textContent = userData.fullName || userData.username;
                    document.getElementById('districtDisplay').textContent = `जिला: ${userData.districtName || ''}`;
                } catch (error) {
                    console.error('Error loading user data:', error);
                    window.location.href = 'index.html';
                }
            }
            
            // Handle template downloads
            document.getElementById('downloadSurveyTemplate').onclick = function() {
                const fileName = "Survey_Template.xlsx";
                
                // Create a simple Excel file
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["जिला", "ब्लॉक", "गांव", "गांव कोड", "फसल", "स्थिति", "टिप्पणी"],
                    ["District Name", "Block Name", "Village Name", "V001", "Crop Name", "pending", ""]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Survey Data");
                
                // Convert to binary and trigger download
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
                
                // Convert string to ArrayBuffer
                const buf = new ArrayBuffer(wbout.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < wbout.length; i++) {
                    view[i] = wbout.charCodeAt(i) & 0xFF;
                }
                
                // Create Blob and download
                const blob = new Blob([buf], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 200);
            };
            
            document.getElementById('downloadReportTemplate').onclick = function() {
                const fileName = "Report_Template.xlsx";
                
                // Create a simple Excel file
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["जिला", "ब्लॉक", "गांव", "गांव कोड", "फसल", "स्थिति"],
                    ["District Name", "Block Name", "Village Name", "V001", "Crop Name", "completed"]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Report Data");
                
                // Convert to binary and trigger download
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
                
                // Convert string to ArrayBuffer
                const buf = new ArrayBuffer(wbout.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < wbout.length; i++) {
                    view[i] = wbout.charCodeAt(i) & 0xFF;
                }
                
                // Create Blob and download
                const blob = new Blob([buf], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 200);
            };
            
            document.getElementById('downloadVillageList').onclick = function() {
                const fileName = "Village_List.xlsx";
                
                // Create a simple Excel file
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["जिला", "ब्लॉक", "गांव", "गांव कोड"],
                    ["District Name", "Block Name", "Village Name", "V001"]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Villages");
                
                // Convert to binary and trigger download
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
                
                // Convert string to ArrayBuffer
                const buf = new ArrayBuffer(wbout.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < wbout.length; i++) {
                    view[i] = wbout.charCodeAt(i) & 0xFF;
                }
                
                // Create Blob and download
                const blob = new Blob([buf], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 200);
            };
            
            // Initialize the application
            loadUserData();
            navigateTo('dashboard');
        });
    </script>
</body>
</html>
