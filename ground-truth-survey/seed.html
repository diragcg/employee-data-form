<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>बीज मांग डेटा प्रविष्टि</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
<!-- Google Fonts Mukta -->
<link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;400;600;700&display=swap" rel="stylesheet" />

<style>
  /* Fixed header style, similar to seedlogin.html */
  body {
    font-family: 'Mukta', sans-serif;
    margin: 0; padding-top: 70px;
    background-color: #FFF8E1;
    color: #263238;
  }

  header.fixed-top {
    background-color: #1B5E20;
    padding: 12px 20px;
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1030;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    color: #FFF8E1;
    font-weight: 700;
    font-size: 1.3rem;
    letter-spacing: 0.3px;
  }

  header.fixed-top img {
    height: 40px;
    margin-right: 15px;
  }

  .container-main {
    max-width: 900px;
    margin: 0 auto 50px auto;
    padding: 0 15px;
  }

  h2.district-name {
    color: #1B5E20;
    font-weight: 700;
    margin-bottom: 1rem;
    font-size: 1.6rem;
  }

  table.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  table.data-table thead {
    background-color: #1B5E20;
    color: white;
    font-weight: 600;
  }

  table.data-table thead th {
    padding: 10px 12px;
  }

  table.data-table tbody tr {
    background-color: #f9fbf7;
  }
  
  table.data-table tbody td {
    padding: 8px 12px;
  }

  select.form-select,
  input.form-control {
    width: 100%;
    padding: 5px 10px;
    border-radius: 8px;
    border: 1px solid #c8e6c9;
    height: 38px;
    transition: border-color 0.3s ease;
    font-weight: 500;
    font-size: 1rem;
  }

  select.form-select:focus,
  input.form-control:focus {
    border-color: #388E3C;
    outline: none;
    box-shadow: 0 0 5px #8BC34A;
    background: #ffffff;
  }

  button.btn-add, button.btn-submit {
    font-weight: 700;
    background-color: #1B5E20;
    border: none;
    color: #FFF8E1;
    border-radius: 12px;
    padding: 10px 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button.btn-add:hover,
  button.btn-submit:hover {
    background-color: #388E3C;
  }

  button.btn-delete {
    background-color: #d9534f;
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 8px;
    padding: 5px 10px;
    cursor: pointer;
  }

  button.btn-delete:hover {
    background-color: #c9302c;
  }

  #alertBox {
    margin-bottom: 1rem;
    font-weight: 600;
    padding: 10px 16px;
    border-radius: 10px;
    display: none;
  }
  #alertBox.success {
    background-color: #E8F5E9;
    border: 1px solid #C8E6C9;
    color: #2E7D32;
  }
  #alertBox.error {
    background-color: #FFEBEE;
    border: 1px solid #FFCDD2;
    color: #C62828;
  }
</style>
</head>
<body>

<header class="fixed-top">
  <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="भारत सरकार" />
  संचालनालय कृषि छत्तीसगढ़ - बीज मांग डेटा प्रविष्टि
</header>

<div class="container-main">

  <h2 class="district-name" id="districtName">जिला: लोड हो रहा है...</h2>

  <div id="alertBox"></div>

  <table class="data-table" aria-label="बीज मांग डेटा प्रविष्टि तालिका">
    <thead>
      <tr>
        <th>फसल और विविधता <span style="color:red">*</span></th>
        <th>समिति (वैकल्पिक)</th>
        <th>मांगित मात्रा (qtl) <span style="color:red">*</span></th>
        <th>कार्य</th>
      </tr>
    </thead>
    <tbody id="entryTableBody">
      <!-- Rows will be appended here -->
    </tbody>
  </table>

  <button id="addRowBtn" class="btn btn-add mb-3"><i class="fas fa-plus-circle me-2"></i>नई पंक्ति जोड़ें</button>
  <button id="submitBtn" class="btn btn-submit w-100"><i class="fas fa-paper-plane me-2"></i>सबमिट करें</button>

</div>

<script>
  // Example user info from login session/local storage (replace this in your app)
  const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
  const userDistrictName = user.district_name || "अज्ञात जिला";
  const userDistrictId = user.district_id || null;
  const userId = user.id || null;

  const districtNameElem = document.getElementById('districtName');
  const alertBox = document.getElementById('alertBox');
  const entryTableBody = document.getElementById('entryTableBody');
  const addRowBtn = document.getElementById('addRowBtn');
  const submitBtn = document.getElementById('submitBtn');

  // Simulated master data (replace with actual Supabase fetches)
  // NOTE: crop_master must include variety for showing both
  // Here 'id' is UUID string, crop_name and variety are strings
  let crops = [
    {id: '1', crop_name: 'गेहूं', variety: 'शक्ति'},
    {id: '2', crop_name: 'चावल', variety: 'सिंह'},
    {id: '3', crop_name: 'मक्का', variety: ''},
  ];

  let committees = [
    {id: 'c1', committee_name: 'समिति अ'},
    {id: 'c2', committee_name: 'समिति ब'},
    {id: 'c3', committee_name: 'समिति स'},
  ];

  districtNameElem.textContent = `जिला: ${userDistrictName}`;

  function showAlert(msg, type = 'success') {
    alertBox.textContent = msg;
    alertBox.className = type === 'success' ? 'success' : 'error';
    alertBox.style.display = 'block';
    setTimeout(() => {
      alertBox.style.display = 'none';
    }, 5000);
  }

  // Create option HTML string for crops combining crop and variety
  function cropOptionsHTML() {
    return `<option value="">-- चुनें --</option>` +
      crops.map(c => `<option value="${c.id}">${c.crop_name}${c.variety ? ' - ' + c.variety : ''}</option>`).join('');
  }

  // Committee options with empty choice
  function committeeOptionsHTML() {
    return `<option value="">-- चुनें (वैकल्पिक) --</option>` +
      committees.map(c => `<option value="${c.id}">${c.committee_name}</option>`).join('');
  }

  // Add new table row for data entry
  function addRow() {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><select class="form-select form-select-sm demand-crop" required>${cropOptionsHTML()}</select></td>
      <td><select class="form-select form-select-sm demand-committee">${committeeOptionsHTML()}</select></td>
      <td><input type="number" class="form-control form-control-sm demand-quantity" min="0.01" step="0.01" placeholder="मात्रा दर्ज करें (qtl)" required></td>
      <td><button type="button" class="btn btn-delete btn-sm" title="पंक्ति मिटाएं"><i class="fas fa-trash-alt"></i></button></td>`;

    entryTableBody.appendChild(tr);

    tr.querySelector('.btn-delete').addEventListener('click', () => {
      tr.remove();
    });
  }

  addRowBtn.addEventListener('click', addRow);

  submitBtn.addEventListener('click', () => {
    const rows = Array.from(entryTableBody.querySelectorAll('tr'));
    if (rows.length === 0) {
      showAlert("कृपया कम से कम एक पंक्ति जोड़ें।", 'error');
      return;
    }

    let errors = [];
    const demandEntries = [];

    rows.forEach((tr, idx) => {
      const cropSel = tr.querySelector('.demand-crop');
      const committeeSel = tr.querySelector('.demand-committee');
      const quantityInp = tr.querySelector('.demand-quantity');

      if (!cropSel.value) errors.push(`पंक्ति ${idx + 1}: कृपया फसल चुनें।`);
      if (!quantityInp.value || isNaN(quantityInp.value) || Number(quantityInp.value) <= 0)
        errors.push(`पंक्ति ${idx + 1}: वैध मात्रा दर्ज करें।`);

      demandEntries.push({
        user_id: userId,
        district_id: userDistrictId,
        crop_id: cropSel.value,
        committee_id: committeeSel.value || null,
        demand_quantity: Number(quantityInp.value),
        demand_unit: 'qtl', // always fixed as requested
        requested_date: new Date().toISOString().slice(0,10)
      });
    });

    if (errors.length) {
      showAlert(errors.join(' '), 'error');
      return;
    }

    // -- INSERT TO SUPABASE EXAMPLE --
    // Here you can replace this console.log with your Supabase insert call
    console.log('Submitting data:', demandEntries);
    showAlert("डेटा सफलतापूर्वक सबमिट किया गया।", 'success');
    entryTableBody.innerHTML = '';
    addRow();
  });

  // Initialize: add first empty row
  window.onload = () => {
    addRow();
  };
</script>

</body>
</html>
