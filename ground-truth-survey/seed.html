<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>डेटा प्रविष्टि टेस्ट</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Add Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container my-5">
  <h3 class="mb-3">डेटा प्रविष्टि से परीक्षण</h3>
  <div id="loadingSpinner" class="text-center my-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">लोड हो रहा है...</span>
    </div>
    <p>डेटा लोड हो रहा है...</p>
  </div>
  <table class="table table-bordered" id="entryTable" style="display:none;">
    <thead class="table-success">
      <tr>
        <th>फसल</th>
        <th>समिति</th>
        <th>बीज निगम</th>
        <th>कार्य</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <button id="addRowBtn" class="btn btn-primary mb-3" style="display:none;">नई पंक्ति जोड़ें</button>
  <br />
  <button id="submitBtn" class="btn btn-success" style="display:none;">सबमिट करें</button>

  <div id="alertBox" class="mt-3"></div>
</div>

<script>
  // Supabase configuration
  const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
  
  // Initialize Supabase client
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const addRowBtn = document.getElementById('addRowBtn');
  const submitBtn = document.getElementById('submitBtn');
  const tableBody = document.getElementById('tableBody');
  const alertBox = document.getElementById('alertBox');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const entryTable = document.getElementById('entryTable');

  // Store fetched data
  let crops = [];
  let committees = [];
  let seedCorps = [];

  // Fetch data from Supabase
  async function fetchData() {
    try {
      // Fetch crops from crop_master table
      let { data: cropsData, error: cropsError } = await supabase
        .from('crop_master')
        .select('*');
      
      if (cropsError) throw cropsError;
      crops = cropsData;

      // Fetch committees from committee_master table
      let { data: committeesData, error: committeesError } = await supabase
        .from('committee_master')
        .select('*');
      
      if (committeesError) throw committeesError;
      committees = committeesData;

      // Fetch seed corporations (assuming there's a seed_corporation_master table)
      // If there's a different table name, replace it here
      let { data: seedCorpsData, error: seedCorpsError } = await supabase
        .from('seed_corporation_master')
        .select('*');
      
      if (seedCorpsError) throw seedCorpsError;
      seedCorps = seedCorpsData || []; // Default to empty array if table doesn't exist

      // Hide loading spinner and show table
      loadingSpinner.style.display = 'none';
      entryTable.style.display = 'table';
      addRowBtn.style.display = 'inline-block';
      submitBtn.style.display = 'inline-block';

      // Add first row
      addRow();
    } catch (error) {
      console.error('Error fetching data:', error);
      alertBox.innerHTML = `<div class="alert alert-danger">डेटा लोड करने में त्रुटि: ${error.message}</div>`;
      loadingSpinner.style.display = 'none';
    }
  }

  // Add a new row with dropdowns populated from Supabase data
  function addRow() {
    const tr = document.createElement('tr');

    // Determine the name field in your tables
    // Adjust these if your column names are different
    const cropNameField = crops.length > 0 && 'name' in crops[0] ? 'name' : 
                         (crops.length > 0 && 'crop_name' in crops[0] ? 'crop_name' : 'id');
    
    const committeeNameField = committees.length > 0 && 'name' in committees[0] ? 'name' : 
                              (committees.length > 0 && 'committee_name' in committees[0] ? 'committee_name' : 'id');
    
    const seedCorpNameField = seedCorps.length > 0 && 'name' in seedCorps[0] ? 'name' : 
                             (seedCorps.length > 0 && 'corporation_name' in seedCorps[0] ? 'corporation_name' : 'id');

    // Create crop dropdown HTML
    let cropOptions = crops.map(crop => 
      `<option value="${crop.id}">${crop[cropNameField]}</option>`
    ).join('');

    // Create committee dropdown HTML
    let committeeOptions = committees.map(committee => 
      `<option value="${committee.id}">${committee[committeeNameField]}</option>`
    ).join('');

    // Create seed corp dropdown HTML
    let seedCorpOptions = seedCorps.map(seedCorp => 
      `<option value="${seedCorp.id}">${seedCorp[seedCorpNameField]}</option>`
    ).join('');

    tr.innerHTML = `
      <td>
        <select class="form-select crop-select" required>
          <option value="">फसल चुनें</option>
          ${cropOptions}
        </select>
      </td>
      <td>
        <select class="form-select committee-select">
          <option value="">समिति चुनें</option>
          ${committeeOptions}
        </select>
      </td>
      <td>
        <select class="form-select seedcorp-select">
          <option value="">बीज निगम चुनें</option>
          ${seedCorpOptions}
        </select>
      </td>
      <td><button type="button" class="btn btn-danger btn-sm removeBtn">हटाएँ</button></td>
    `;

    tableBody.appendChild(tr);

    // Attach delete functionality
    tr.querySelector('.removeBtn').addEventListener('click', () => tr.remove());
  }

  addRowBtn.addEventListener('click', addRow);

  submitBtn.addEventListener('click', () => {
    alertBox.innerHTML = '';
    const rows = tableBody.querySelectorAll('tr');
    if (rows.length === 0) {
      alertBox.innerHTML = '<div class="alert alert-danger">कृपया कम से कम एक रिकॉर्ड जोड़ें।</div>';
      return;
    }

    const records = [];
    let validationErrors = [];

    rows.forEach((tr, index) => {
      const cropSelect = tr.querySelector('.crop-select');
      const committeeSelect = tr.querySelector('.committee-select');
      const seedCorpSelect = tr.querySelector('.seedcorp-select');
      
      const cropId = cropSelect.value;
      const committeeId = committeeSelect.value;
      const seedCorpId = seedCorpSelect.value;

      if (!cropId) {
        validationErrors.push(`पंक्ति ${index + 1}: फसल का चयन आवश्यक है।`);
      }

      records.push({ 
        crop_id: cropId, 
        committee_id: committeeId, 
        seed_corporation_id: seedCorpId 
      });
    });

    if (validationErrors.length) {
      alertBox.innerHTML = `<div class="alert alert-danger">${validationErrors.join('<br>')}</div>`;
      return;
    }

    // Insert data to Supabase (assuming table name is 'entries')
    // Change the table name if it's different
    async function insertRecords() {
      try {
        const { data, error } = await supabase
          .from('entries')
          .insert(records);
          
        if (error) throw error;
        
        alertBox.innerHTML = '<div class="alert alert-success">डेटा सफलतापूर्वक सबमिट किया गया।</div>';
        tableBody.innerHTML = '';
        addRow();
      } catch (error) {
        console.error('Error inserting data:', error);
        alertBox.innerHTML = `<div class="alert alert-danger">डेटा सबमिट करने में त्रुटि: ${error.message}</div>`;
      }
    }
    
    insertRecords();
  });

  // Load data when page loads
  window.onload = fetchData;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
