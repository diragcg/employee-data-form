<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>संचालनालय कृषि छत्तीसगढ़ - डेटा प्रविष्टि</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<!-- Google Font Mukta -->
<link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet" />
<!-- SheetJS for XLSX parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root {
    --primary-color: #1B5E20;
    --secondary-color: #388E3C;
    --highlight-bg: #2E7D32;
    --highlight-hover-bg: #1b4d12;
    --accent-color: #8BC34A;
    --text-dark: #263238;
    --text-light: #FFF8E1;
    --background-light: #FFF8E1;
    --border-color: #C8E6C9;
    --shadow-lg: 0 8px 24px rgba(27, 94, 32, 0.2);
  }

  body {
    font-family: 'Mukta', sans-serif;
    background-color: var(--background-light);
    min-height: 100vh;
  }

  .hindi {
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  header.header {
    background-color: var(--primary-color);
    box-shadow: var(--shadow-lg);
  }

  .navbar-brand {
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--text-light);
    display: flex;
    align-items: center;
  }

  .navbar-brand img {
    height: 45px;
    margin-right: 15px;
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
  }

  .nav-link {
    font-weight: 600;
    color: rgba(255, 248, 225, 0.9) !important;
    letter-spacing: 0.2px;
  }

  .nav-link:hover, .nav-link.active {
    background-color: rgba(255, 248, 225, 0.2);
    color: var(--text-light) !important;
  }

  .nav-link.dropdown-toggle {
    font-weight: 700 !important;
    color: var(--highlight-bg) !important;
  }
  .nav-link.dropdown-toggle:hover,
  .nav-link.dropdown-toggle:focus {
    color: var(--highlight-hover-bg) !important;
  }

  .container-main {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
  }

  .card {
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    border: none;
    margin-bottom: 30px;
  }

  .card-header {
    background-color: var(--primary-color);
    color: var(--text-light);
    font-weight: 700;
    font-size: 1.75rem;
    border-radius: 16px 16px 0 0;
    padding: 30px 40px;
  }

  .card-body {
    padding: 30px 40px;
  }

  label {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 1.1rem;
  }

  input.form-control,
  select.form-select {
    border-radius: 10px;
    border: 1px solid var(--border-color);
    height: 50px;
    padding: 10px 15px;
    font-size: 1rem;
    background-color: #f9fbf7;
  }

  input.form-control:focus,
  select.form-select:focus {
    border-color: var(--secondary-color);
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.15);
  }

  button.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    font-weight: 700;
    letter-spacing: 0.5px;
    font-size: 1.1rem;
    border-radius: 10px;
    height: 50px;
    transition: background-color 0.3s ease;
    box-shadow: 0 4px 10px rgba(27, 94, 32, 0.2);
  }

  button.btn-primary:hover {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
  }

  /* Bold and highlighted download/upload buttons in modals */
  .btn-download, .btn-upload {
    font-weight: 900;
    background-color: var(--highlight-bg);
    color: white;
    border-radius: 12px;
    font-size: 1.2rem;
    height: 50px;
    transition: background-color 0.3s ease;
    box-shadow: 0 5px 12px rgba(46, 125, 50, 0.8);
  }

  .btn-download:hover, .btn-upload:hover {
    background-color: var(--highlight-hover-bg);
  }

  /* Alert styles */
  #alertBox {
    border-radius: 10px;
    font-weight: 600;
    padding: 16px;
    margin-bottom: 25px;
    display: none;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  #alertBox.success {
    background-color: #E8F5E9;
    border-color: #C8E6C9;
    color: #2E7D32;
  }
  #alertBox.danger {
    background-color: #FFEBEE;
    border-color: #FFCDD2;
    color: #C62828;
  }

  /* Autocomplete styles */
  .autocomplete {
    position: relative;
  }
  .autocomplete-items {
    position: absolute;
    border: 1px solid var(--border-color);
    border-top: none;
    z-index: 1000;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background-color: white;
    border-radius: 0 0 10px 10px;
  }
  .autocomplete-items div {
    padding: 10px;
    cursor: pointer;
  }
  .autocomplete-items div:hover,
  .autocomplete-active {
    background-color: var(--secondary-color);
    color: white;
  }
</style>
</head>

<body>
<header class="header">
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="भारत सरकार" />
          <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
          aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a href="seed.html" class="nav-link active hindi" aria-current="page">डेटा प्रविष्टि</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle hindi" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                मास्टर अपडेट
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item hindi" href="#" id="openCropMasterUpload">फसल मास्टर अपलोड करें</a></li>
                <li><a class="dropdown-item hindi" href="#" id="openCommitteeMasterUpload">समिति मास्टर अपलोड करें</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a href="#" id="logoutBtn" class="nav-link hindi">लॉग आउट</a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link hindi" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="fas fa-question-circle me-1"></i> सहायता</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div>
</header>

<main class="container-main">
  <div id="alertBox" class="alert hindi"></div>

  <!-- Data Entry Form -->
  <div class="card">
    <div class="card-header hindi">डेटा प्रविष्टि फॉर्म</div>
    <div class="card-body">
      <form id="dataEntryForm" novalidate autocomplete="off">
        <div class="mb-3 autocomplete">
          <label for="district" class="form-label hindi">जिला</label>
          <input type="text" id="district" name="district" class="form-control" placeholder="जिला चुनें या टाइप करें" required />
          <div id="districtList" class="autocomplete-items"></div>
        </div>
        <div class="mb-3 autocomplete">
          <label for="block" class="form-label hindi">ब्लॉक</label>
          <input type="text" id="block" name="block" class="form-control" placeholder="ब्लॉक चुनें या टाइप करें" required disabled />
          <div id="blockList" class="autocomplete-items"></div>
        </div>
        <div class="mb-3 autocomplete">
          <label for="crop_name" class="form-label hindi">फसल का नाम</label>
          <input type="text" id="crop_name" name="crop_name" class="form-control" placeholder="फसल का नाम चुनें या टाइप करें" required />
          <div id="cropList" class="autocomplete-items"></div>
        </div>
        <div class="mb-3 autocomplete">
          <label for="committee" class="form-label hindi">समिति</label>
          <input type="text" id="committee" name="committee" class="form-control" placeholder="समिति चुनें या टाइप करें" />
          <div id="committeeList" class="autocomplete-items"></div>
        </div>
        <div class="mb-3">
          <label for="seed_corp" class="form-label hindi">बीज निगम</label>
          <input type="text" id="seed_corp" name="seed_corp" class="form-control" placeholder="बीज निगम का विवरण" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label for="scheme" class="form-label hindi">विभागीय योजना/ प्रदर्शन</label>
          <input type="text" id="scheme" name="scheme" class="form-control" placeholder="योजना/प्रदर्शन दर्ज करें" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label for="distribution" class="form-label hindi">प्रक्रिया केन्द्र से नगद/ उत्पादन वितरण</label>
          <input type="text" id="distribution" name="distribution" class="form-control" autocomplete="off" />
        </div>
        <button type="submit" class="btn btn-primary w-100 hindi">
          <i class="fas fa-save me-2"></i> सहेजें
        </button>
      </form>
    </div>
  </div>
</main>

<!-- Crop Master Upload Modal -->
<div class="modal fade" id="cropUploadModal" tabindex="-1" aria-labelledby="cropUploadLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="cropUploadForm" class="modal-content" novalidate autocomplete="off">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="cropUploadLabel">फसल मास्टर अपलोड करें</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1) opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <p class="hindi">टेम्पलेट डाउनलोड करें, भरें, और अपलोड करें।</p>
        <button type="button" class="btn btn-download w-100 mb-3" id="downloadCropTemplate">
          <i class="fas fa-file-download me-2"></i> टेम्पलेट डाउनलोड करें (.xlsx)
        </button>
        <input type="file" id="cropFileInput" accept=".xlsx" class="form-control" required />
      </div>
      <div class="modal-footer" style="border-top:none; background-color:#FAFAFA;">
        <button type="submit" class="btn btn-upload w-100 hindi">
          <i class="fas fa-upload me-2"></i> अपलोड करें
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Committee Master Upload Modal -->
<div class="modal fade" id="committeeUploadModal" tabindex="-1" aria-labelledby="committeeUploadLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="committeeUploadForm" class="modal-content" novalidate autocomplete="off">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="committeeUploadLabel">समिति मास्टर अपलोड करें</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1) opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <p class="hindi">टेम्पलेट डाउनलोड करें, भरें, और अपलोड करें।</p>
        <button type="button" class="btn btn-download w-100 mb-3" id="downloadCommitteeTemplate">
          <i class="fas fa-file-download me-2"></i> टेम्पलेट डाउनलोड करें (.xlsx)
        </button>
        <input type="file" id="committeeFileInput" accept=".xlsx" class="form-control" required />
      </div>
      <div class="modal-footer" style="border-top:none; background-color:#FAFAFA;">
        <button type="submit" class="btn btn-upload w-100 hindi">
          <i class="fas fa-upload me-2"></i> अपलोड करें
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="helpModalLabel">मदद और निर्देश</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1) opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold hindi">डेटा प्रविष्टि फॉर्म</h6>
        <p class="hindi">यहाँ आवश्यक फील्ड भरें और सहेजें पर क्लिक करें।</p>
        <h6 class="fw-bold hindi">मास्टर डेटा अपलोड</h6>
        <p class="hindi">मास्टर प्रकार चुनें, टेम्पलेट डाउनलोड करें, उसे भरें, फिर यहाँ अपलोड करें।</p>
        <h6 class="fw-bold hindi">सहायता संपर्क</h6>
        <p class="hindi">किसी समस्या के लिए, कृपया <strong>diagri-cg@cg.gov.in</strong> पर ईमेल करें या <strong>9399207068</strong> पर कॉल करें।</p>
      </div>
      <div class="modal-footer" style="background-color:#FAFAFA;">
        <button type="button" class="btn btn-primary hindi" data-bs-dismiss="modal">समझ गया</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>

<script>
  // Replace with your Supabase project info
  const supabaseUrl = "https://txjbfqrbbtvzlxpeegkv.supabase.co";
  const supabaseKey = "YOUR_SUPABASE_ANON_KEY"; // Replace with your anon key here!
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  // Global master data cache
  let districts = [];
  let blocks = [];
  let crops = [];
  let committees = [];

  // Alert function to show messages
  function showAlert(message, type = "success") {
    const alertBox = document.getElementById("alertBox");
    alertBox.textContent = message;
    alertBox.className = `alert hindi ${type === "success" ? "success" : "danger"}`;
    alertBox.style.display = "block";
    alertBox.style.animation = "fadeIn 0.3s ease-in forwards";
    setTimeout(() => {
      alertBox.style.animation = "fadeOut 0.3s ease-out forwards";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 300);
    }, 6000);
  }

  // Load user or redirect
  function loadUser() {
    const userJSON = localStorage.getItem("user") || sessionStorage.getItem("user");
    if (!userJSON) {
      window.location.href = "seedlogin.html";
      return null;
    }
    return JSON.parse(userJSON);
  }

  // Logout button
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user");
    sessionStorage.removeItem("user");
    window.location.href = "seedlogin.html";
  });

  // Fetch master tables
  async function loadMasters() {
    try {
      const [{ data: dData }, { data: bData }, { data: cData }, { data: cmData }] = await Promise.all([
        supabaseClient.from("districts").select("id, name").order("name"),
        supabaseClient.from("blocks").select("id, district_id, name").order("name"),
        supabaseClient.from("crop_master").select("id, crop_name").order("crop_name"),
        supabaseClient.from("committee_master").select("id, district_id, block_id, committee_name").order("committee_name"),
      ]);
      districts = dData || [];
      blocks = bData || [];
      crops = cData || [];
      committees = cmData || [];
    } catch (error) {
      console.error(error);
      showAlert("मास्टर डेटा लोड करने में त्रुटि हुई। कृपया पुनः प्रयास करें।", "danger");
    }
  }

  // AUTOCOMPLETE implementation (same as previous code snippet)
  function setupAutocomplete(inputEl, listEl, items, filterFn = null, onSelect) {
    let currentFocus = -1;

    inputEl.addEventListener("input", function () {
      const val = this.value.toLowerCase();
      closeLists();
      if (!val) return false;
      const filtered = filterFn
        ? items.filter((item) => filterFn(item, val))
        : items.filter((item) => item.name.toLowerCase().includes(val));
      if (!filtered.length) return false;

      let container = document.createElement("DIV");
      container.setAttribute("class", "autocomplete-items");
      listEl.appendChild(container);

      filtered.slice(0, 10).forEach((item) => {
        let itemDiv = document.createElement("DIV");
        const startIdx = item.name.toLowerCase().indexOf(val);
        if (startIdx >= 0) {
          itemDiv.innerHTML =
            item.name.substring(0, startIdx) +
            "<strong>" +
            item.name.substring(startIdx, startIdx + val.length) +
            "</strong>" +
            item.name.substring(startIdx + val.length);
        } else {
          itemDiv.textContent = item.name;
        }
        itemDiv.addEventListener("click", () => {
          inputEl.value = item.name;
          inputEl.dataset.id = item.id;
          closeLists();
          if (onSelect) onSelect(item);
        });
        container.appendChild(itemDiv);
      });
    });

    inputEl.addEventListener("keydown", function (e) {
      const itemsDiv = listEl.querySelector(".autocomplete-items");
      if (!itemsDiv) return;
      let items = itemsDiv.getElementsByTagName("div");
      if (e.key === "ArrowDown") {
        currentFocus++;
        addActive(items);
      } else if (e.key === "ArrowUp") {
        currentFocus--;
        addActive(items);
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) items[currentFocus].click();
      }
      function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add("autocomplete-active");
      }
      function removeActive(items) {
        for (let item of items) item.classList.remove("autocomplete-active");
      }
    });

    document.addEventListener("click", function (e) {
      if (e.target !== inputEl) closeLists();
    });

    function closeLists() {
      while (listEl.firstChild) listEl.removeChild(listEl.firstChild);
      currentFocus = -1;
    }
  }

  // Helper: reset inputs
  function resetInput(inputEl) {
    inputEl.value = "";
    inputEl.dataset.id = "";
    inputEl.disabled = true;
  }

  // Initialize autocomplete with cascading logic
  function initAutocomplete() {
    // District autocomplete
    setupAutocomplete(
      document.getElementById("district"),
      document.getElementById("districtList"),
      districts.map((d) => ({ id: d.id, name: d.name })),
      null,
      () => {
        resetInput(document.getElementById("block"));
        resetInput(document.getElementById("committee"));
        document.getElementById("block").disabled = false;
      }
    );

    // Block autocomplete: filter blocks by selected district
    setupAutocomplete(
      document.getElementById("block"),
      document.getElementById("blockList"),
      [],
      (item, val) => {
        const districtId = document.getElementById("district").dataset.id || "";
        return item.name.toLowerCase().includes(val) && item.district_id === districtId;
      },
      () => {
        resetInput(document.getElementById("committee"));
      }
    );

    document.getElementById("district").addEventListener("input", () => {
      const districtName = document.getElementById("district").value.toLowerCase();
      const district = districts.find((d) => d.name.toLowerCase() === districtName);
      if (district) {
        document.getElementById("district").dataset.id = district.id;
        document.getElementById("block").dataset.id = "";
        document.getElementById("committee").dataset.id = "";
        document.getElementById("block").value = "";
        document.getElementById("committee").value = "";
        const filteredBlocks = blocks
          .filter((b) => b.district_id === district.id)
          .map((b) => ({ id: b.id, name: b.name, district_id: b.district_id }));
        setupAutocomplete(
          document.getElementById("block"),
          document.getElementById("blockList"),
          filteredBlocks,
          null,
          () => resetInput(document.getElementById("committee"))
        );
        document.getElementById("block").disabled = false;
      } else {
        document.getElementById("district").dataset.id = "";
        resetInput(document.getElementById("block"));
        resetInput(document.getElementById("committee"));
      }
    });

    // Committee autocomplete: filter by selected district and block
    setupAutocomplete(
      document.getElementById("committee"),
      document.getElementById("committeeList"),
      [],
      (item, val) => {
        const districtId = document.getElementById("district").dataset.id || "";
        const blockId = document.getElementById("block").dataset.id || "";
        return (
          item.committee_name.toLowerCase().includes(val) &&
          item.district_id === districtId &&
          item.block_id === blockId
        );
      },
      (item) => {
        document.getElementById("committee").dataset.id = item.id;
      }
    );

    function updateCommitteeSource() {
      const districtName = document.getElementById("district").value.toLowerCase();
      const blockName = document.getElementById("block").value.toLowerCase();
      const district = districts.find((d) => d.name.toLowerCase() === districtName);
      const block = blocks.find((b) => b.name.toLowerCase() === blockName && b.district_id === (district ? district.id : null));
      if (district && block) {
        document.getElementById("district").dataset.id = district.id;
        document.getElementById("block").dataset.id = block.id;
        document.getElementById("committee").value = "";
        document.getElementById("committee").dataset.id = "";
        const filteredCommittees = committees
          .filter((c) => c.district_id === district.id && c.block_id === block.id)
          .map((c) => ({ id: c.id, name: c.committee_name, committee_name: c.committee_name, district_id: c.district_id, block_id: c.block_id }));
        setupAutocomplete(
          document.getElementById("committee"),
          document.getElementById("committeeList"),
          filteredCommittees,
          null,
          (item) => {
            document.getElementById("committee").dataset.id = item.id;
          }
        );
      } else {
        resetInput(document.getElementById("committee"));
      }
    }
    document.getElementById("district").addEventListener("input", updateCommitteeSource);
    document.getElementById("block").addEventListener("input", updateCommitteeSource);

    // Crop autocomplete
    setupAutocomplete(
      document.getElementById("crop_name"),
      document.getElementById("cropList"),
      crops.map((c) => ({ id: c.id, name: c.crop_name })),
      null,
      (item) => {
        document.getElementById("crop_name").dataset.id = item.id;
      }
    );
  }

  // Data Entry form submission
  document.getElementById("dataEntryForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector("button[type=submit]");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> कृपया प्रतीक्षा करें...';
    try {
      const user = loadUser();
      if (!user) return;

      const districtId = document.getElementById("district").dataset.id;
      const blockId = document.getElementById("block").dataset.id;
      const cropId = document.getElementById("crop_name").dataset.id;
      const committeeId = document.getElementById("committee").dataset.id || null;
      const seedCorp = e.target.seed_corp.value.trim() || null;
      const scheme = e.target.scheme.value.trim() || null;
      const distribution = e.target.distribution.value.trim() || null;

      if (!districtId || !blockId || !cropId) {
        showAlert("कृपया जिला, ब्लॉक और फसल का नाम सही ढंग से चुनें।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-2"></i> सहेजें';
        return;
      }

      // Insert into seed_entries table — adjust columns as per your schema
      const { error } = await supabaseClient.from("seed_entries").insert([{
        user_id: user.id,
        district_id: districtId,
        block_id: blockId,
        crop_name_id: cropId,
        committee_id: committeeId,
        seed_corp: seedCorp,
        scheme,
        distribution
      }]);
      if (error) throw error;

      showAlert("डेटा सफलतापूर्वक सहेजा गया।", "success");
      e.target.reset();
      ["district", "block", "crop_name", "committee"].forEach((id) => {
        const el = document.getElementById(id);
        el.dataset.id = "";
        if (id === "block" || id === "committee") el.disabled = true;
      });
    } catch (error) {
      console.error(error);
      showAlert("डेटा सहेजने में त्रुटि हुई। कृपया पुनः प्रयास करें।", "danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-2"></i> सहेजें';
    }
  });

  /* XLSX Download Template Helpers */
  function generateExcelSheet(columns, sheetName = "Sheet1") {
    const ws = XLSX.utils.aoa_to_sheet([columns]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    return XLSX.write(wb, { bookType: "xlsx", type: "binary" });
  }
  function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
    return buf;
  }
  function downloadExcel(columns, filename, sheetName) {
    const wbout = generateExcelSheet(columns, sheetName);
    const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 0);
  }

  document.getElementById("downloadCropTemplate").addEventListener("click", () => {
    downloadExcel(["crop_name", "variety"], "Crop_Master_Template.xlsx", "CropMaster");
  });

  document.getElementById("downloadCommitteeTemplate").addEventListener("click", () => {
    downloadExcel(["district_name", "block_name", "committee_name"], "Committee_Master_Template.xlsx", "CommitteeMaster");
  });

  async function parseXlsxFile(file) {
    const data = await file.arrayBuffer();
    return XLSX.read(data, { type: "array" });
  }

  // Crop Upload Handler
  document.getElementById("cropUploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector("button[type=submit]");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> अपलोड हो रहा है...';
    try {
      const user = loadUser();
      if (!user) return;

      const fileInput = document.getElementById("cropFileInput");
      if (!fileInput.files.length) {
        showAlert("कृपया फ़ाइल चुनें।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }
      const workbook = await parseXlsxFile(fileInput.files[0]);
      const sheetName = workbook.SheetNames.includes("CropMaster") ? "CropMaster" : workbook.SheetNames[0];
      const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

      if (!jsonData.length) {
        showAlert("फ़ाइल में कोई डेटा नहीं मिला।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }

      let rowsToInsert = [];
      let errors = [];
      jsonData.forEach((row, i) => {
        const lineNum = i + 2;
        const crop_name = (row.crop_name || "").trim();
        const variety = (row.variety || "").trim();
        if (!crop_name) errors.push(`पंक्ति ${lineNum}: फसल का नाम आवश्यक है।`);
        else rowsToInsert.push({ crop_name, variety: variety || null });
      });

      if (errors.length) {
        alert("त्रुटियां:\n" + errors.join("\n"));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }
      const { error } = await supabaseClient.from("crop_master").insert(rowsToInsert);
      if (error) throw error;

      showAlert("फसल मास्टर सफलतापूर्वक अपलोड किया गया।", "success");
      fileInput.value = "";
      bootstrap.Modal.getInstance(document.getElementById("cropUploadModal")).hide();
    } catch (err) {
      console.error(err);
      showAlert("अपलोड में त्रुटि हुई। कृपया पुनः प्रयास करें।", "danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
    }
  });

  // Committee Upload Handler (with district/block name mapping)
  document.getElementById("committeeUploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector("button[type=submit]");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> अपलोड हो रहा है...';
    try {
      const user = loadUser();
      if (!user) return;

      const fileInput = document.getElementById("committeeFileInput");
      if (!fileInput.files.length) {
        showAlert("कृपया फ़ाइल चुनें।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }
      const workbook = await parseXlsxFile(fileInput.files[0]);
      const sheetName = workbook.SheetNames.includes("CommitteeMaster")
        ? "CommitteeMaster"
        : workbook.SheetNames[0];
      const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

      if (!jsonData.length) {
        showAlert("फ़ाइल में कोई डेटा नहीं मिला।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }

      const districtMap = new Map(districts.map((d) => [d.name.toLowerCase(), d.id]));
      const blocksByDistrict = new Map();
      blocks.forEach((block) => {
        if (!blocksByDistrict.has(block.district_id)) {
          blocksByDistrict.set(block.district_id, new Map());
        }
        blocksByDistrict.get(block.district_id).set(block.name.toLowerCase(), block.id);
      });

      let errors = [];
      let rowsToInsert = [];
      jsonData.forEach((row, i) => {
        const lineNum = i + 2;
        const districtName = (row.district_name || "").trim().toLowerCase();
        const blockName = (row.block_name || "").trim().toLowerCase();
        const committeeName = (row.committee_name || "").trim();

        if (!districtMap.has(districtName)) {
          errors.push(`पंक्ति ${lineNum}: अमान्य जिला नाम "${row.district_name}"`);
          return;
        }
        const districtId = districtMap.get(districtName);

        const blockMapForDistrict = blocksByDistrict.get(districtId);
        if (!blockMapForDistrict || !blockMapForDistrict.has(blockName)) {
          errors.push(`पंक्ति ${lineNum}: अमान्य ब्लॉक नाम "${row.block_name}" जिला "${row.district_name}" के लिए`);
          return;
        }
        const blockId = blockMapForDistrict.get(blockName);

        if (!committeeName) {
          errors.push(`पंक्ति ${lineNum}: समिति नाम आवश्यक है`);
          return;
        }

        rowsToInsert.push({
          district_id: districtId,
          block_id: blockId,
          committee_name: committeeName,
        });
      });

      if (errors.length) {
        alert("त्रुटियां:\n" + errors.join("\n"));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
        return;
      }

      const { error } = await supabaseClient.from("committee_master").insert(rowsToInsert);
      if (error) throw error;

      showAlert("समिति मास्टर सफलतापूर्वक अपलोड किया गया।", "success");
      fileInput.value = "";
      bootstrap.Modal.getInstance(document.getElementById("committeeUploadModal")).hide();
    } catch (err) {
      console.error(err);
      showAlert("अपलोड में त्रुटि हुई। कृपया पुनः प्रयास करें।", "danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-upload me-2"></i> अपलोड करें';
    }
  });

  // Open modals from navbar dropdown
  document.getElementById("openCropMasterUpload").addEventListener("click", (e) => {
    e.preventDefault();
    new bootstrap.Modal(document.getElementById("cropUploadModal")).show();
  });
  document.getElementById("openCommitteeMasterUpload").addEventListener("click", (e) => {
    e.preventDefault();
    new bootstrap.Modal(document.getElementById("committeeUploadModal")).show();
  });

  // Initialize page
  document.addEventListener("DOMContentLoaded", async () => {
    const user = loadUser();
    if (!user) return;
    await loadMasters();
    initAutocomplete();
  });
</script>

<style>
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(-10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  @keyframes fadeOut {
    from {opacity: 1; transform: translateY(0);}
    to {opacity: 0; transform: translateY(-10px);}
  }
</style>
</body>
</html>
