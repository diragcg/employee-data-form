<!DOCTYPE html>
<html lang="hi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>बीज मांग डेटा प्रविष्टि</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <!-- Google Fonts Mukta -->
  <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;400;600;700&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Mukta', sans-serif;
      background-color: #FFF8E1;
      padding: 20px;
      color: #263238;
      margin: 0;
    }

    h2 {
      color: #1B5E20;
      font-weight: 700;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }

    thead th {
      background: #1B5E20;
      color: white;
      font-weight: 600;
      padding: 12px;
      border-radius: 8px 8px 0 0;
    }

    tbody tr {
      background: #f5f9f2;
    }

    tbody td {
      padding: 8px 12px;
      vertical-align: middle;
    }

    select.form-select,
    input.form-control {
      border-radius: 6px;
      border: 1px solid #a5d6a7;
      background: white;
      height: 38px;
      font-weight: 500;
      font-size: 1rem;
      width: 100%;
    }

    select.form-select:focus,
    input.form-control:focus {
      border-color: #4caf50;
      box-shadow: 0 0 8px #81c784;
      outline: none;
      background: white;
    }

    button.btn-add,
    button.btn-submit {
      background-color: #2e7d32;
      color: white;
      font-weight: 700;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 15px;
      border: none;
      transition: background-color 0.3s ease;
    }

    button.btn-add:hover,
    button.btn-submit:hover {
      background-color: #145214;
    }

    button.btn-delete {
      background-color: #d9534f;
      border: none;
      color: white;
      border-radius: 6px;
      padding: 5px 12px;
      cursor: pointer;
    }

    button.btn-delete:hover {
      background-color: #c9302c;
    }

    #alertBox {
      margin-top: 15px;
      font-weight: 600;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }

    #alertBox.success {
      background: #e8f5e9;
      color: #256029;
      border: 1px solid #a5d6a7;
    }

    #alertBox.error {
      background: #fcebea;
      color: #b71c1c;
      border: 1px solid #f08080;
    }
  </style>
</head>

<body>

  <h2 id="districtName">जिला: लोड हो रहा है...</h2>

  <table aria-label="बीज मांग डेटा प्रविष्टि तालिका" id="dataEntryTable">
    <thead>
      <tr>
        <th>फसल और विविधता <span style="color:red">*</span></th>
        <th>समिति (वैकल्पिक)</th>
        <th>मांगित मात्रा (qtl) <span style="color:red">*</span></th>
        <th>कार्य</th>
      </tr>
    </thead>
    <tbody id="entryTableBody"></tbody>
  </table>

  <button class="btn btn-add" id="addRowBtn"><i class="fas fa-plus-circle me-2"></i>नई पंक्ति जोड़ें</button>
  <button class="btn btn-submit w-100" id="submitBtn"><i class="fas fa-paper-plane me-2"></i>सबमिट करें</button>

  <div id="alertBox"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Simulate user session info (replace with your actual login session logic)
    const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
    const userId = user.id || null;
    const districtId = user.district_id || null;
    const districtName = user.district_name || 'अज्ञात जिला';

    const districtNameElem = document.getElementById('districtName');
    const entryTableBody = document.getElementById('entryTableBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const submitBtn = document.getElementById('submitBtn');
    const alertBox = document.getElementById('alertBox');

    districtNameElem.textContent = `जिला: ${districtName}`;

    let crops = [];
    let committees = [];

    function showAlert(message, type = 'success') {
      alertBox.textContent = message;
      alertBox.className = type === 'success' ? 'success' : 'error';
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 6000);
    }

    async function loadMasterData() {
      try {
        const { data: cropData, error: cropError } = await supabase
          .from('crop_master')
          .select('id, crop_name, variety')
          .order('crop_name');

        if (cropError) throw cropError;
        crops = cropData || [];

        const { data: committeeData, error: committeeError } = await supabase
          .from('committee_master')
          .select('id, committee_name')
          .eq('district_id', districtId)
          .order('committee_name');

        if (committeeError) throw committeeError;
        committees = committeeData || [];

      } catch (error) {
        showAlert('मास्टर डेटा लोड करने में त्रुटि: ' + error.message, 'error');
      }
    }

    function createCropOptions() {
      return `<option value="">-- फसल चुनें --</option>` +
        crops.map(c => `<option value="${c.id}">${c.crop_name}${c.variety ? ' - ' + c.variety : ''}</option>`).join('');
    }

    function createCommitteeOptions() {
      return `<option value="">-- समिति चुनें (वैकल्पिक) --</option>` +
        committees.map(c => `<option value="${c.id}">${c.committee_name}</option>`).join('');
    }

    // Add a new row with dropdown selects and quantity input
    function addRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><select class="form-select form-select-sm crop-select" required>${createCropOptions()}</select></td>
        <td><select class="form-select form-select-sm committee-select">${createCommitteeOptions()}</select></td>
        <td><input type="number" class="form-control form-control-sm demand-quantity" min="0.01" step="0.01" placeholder="दर्ज करें (qtl)" required></td>
        <td><button type="button" class="btn btn-danger btn-sm removeBtn" title="पंक्ति हटाएँ"><i class="fas fa-trash-alt"></i></button></td>
      `;
      entryTableBody.appendChild(tr);

      // Remove row handler
      tr.querySelector('.removeBtn').addEventListener('click', () => tr.remove());
    }

    addRowBtn.addEventListener('click', addRow);

    submitBtn.addEventListener('click', async () => {
      const rows = Array.from(entryTableBody.querySelectorAll('tr'));
      if (rows.length === 0) {
        showAlert('कृपया कम से कम एक रिकॉर्ड जोड़ें।', 'error');
        return;
      }

      let errors = [];
      let insertRecords = [];

      rows.forEach((tr, i) => {
        const cropSel = tr.querySelector('.crop-select');
        const committeeSel = tr.querySelector('.committee-select');
        const qtyInput = tr.querySelector('.demand-quantity');

        if (!cropSel.value) errors.push(`पंक्ति ${i + 1}: कृपया फसल चुनें।`);
        if (!qtyInput.value || isNaN(qtyInput.value) || Number(qtyInput.value) <= 0)
          errors.push(`पंक्ति ${i + 1}: वैध मात्रा दर्ज करें।`);

        insertRecords.push({
          user_id: userId,
          district_id: districtId,
          crop_id: cropSel.value,
          committee_id: committeeSel.value || null,
          demand_quantity: Number(qtyInput.value),
          demand_unit: 'qtl',
          requested_date: new Date().toISOString().slice(0, 10)
        });
      });

      if (errors.length) {
        showAlert(errors.join(' '), 'error');
        return;
      }

      try {
        const { error } = await supabase.from('seed_demand').insert(insertRecords);
        if (error) throw error;

        showAlert('मांग सफलतापूर्वक दर्ज की गई।', 'success');
        entryTableBody.innerHTML = '';
        addRow();

      } catch (err) {
        showAlert('डेटा जमा करने में त्रुटि: ' + err.message, 'error');
      }
    });

    window.addEventListener('DOMContentLoaded', async () => {
      if (!userId || !districtId) {
        alert('आप लॉग इन नहीं हैं। कृपया पुनः लॉग इन करें।');
        window.location.href = 'seedlogin.html';
        return;
      }
      await loadMasterData();
      addRow();
    });
  </script>
</body>

</html>
