<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>संचालनालय कृषि छत्तीसगढ़ - डेटा प्रविष्टि (मल्टीपल रिकॉर्ड)</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<!-- Google Fonts Mukta -->
<link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet" />

<style>
  :root {
    --primary-color: #1B5E20;
    --secondary-color: #388E3C;
    --highlight-bg: #2E7D32;
    --highlight-hover-bg: #1b4d12;
    --accent-color: #8BC34A;
    --text-dark: #263238;
    --text-light: #FFF8E1;
    --background-light: #FFF8E1;
    --border-color: #C8E6C9;
    --shadow-lg: 0 8px 24px rgba(27, 94, 32, 0.2);
  }

  body {
    font-family: 'Mukta', sans-serif;
    background-color: var(--background-light);
    min-height: 100vh;
  }

  .hindi {
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  header.header {
    background-color: var(--primary-color);
    box-shadow: var(--shadow-lg);
  }

  .container-main {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }

  .card {
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    border: none;
    margin-bottom: 30px;
  }

  .card-header {
    background-color: var(--primary-color);
    color: var(--text-light);
    font-weight: 700;
    font-size: 1.75rem;
    border-radius: 16px 16px 0 0;
    padding: 30px 40px;
  }

  .form-label-bold {
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 1.25rem;
  }

  table.data-entry-table {
    width: 100%;
    border-collapse: collapse;
  }

  table.data-entry-table thead tr {
    background-color: var(--primary-color);
    color: var(--text-light);
  }

  table.data-entry-table th,
  table.data-entry-table td {
    padding: 10px;
    border: 1px solid var(--border-color);
    font-size: 1rem;
  }

  table.data-entry-table input,
  table.data-entry-table select {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 10px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
  }

  table.data-entry-table input:focus,
  table.data-entry-table select:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 5px var(--accent-color);
  }

  .btn {
    font-weight: 600;
  }

  .btn-add-row {
    margin-bottom: 15px;
  }

  #alertBox {
    border-radius: 10px;
    font-weight: 600;
    padding: 16px;
    margin-bottom: 25px;
    display: none;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  #alertBox.success {
    background-color: #E8F5E9;
    border-color: #C8E6C9;
    color: #2E7D32;
  }
  #alertBox.danger {
    background-color: #FFEBEE;
    border-color: #FFCDD2;
    color: #C62828;
  }
</style>
</head>
<body>

<header class="header">
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="भारत सरकार" />
          <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
          aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a href="seed.html" class="nav-link active hindi">डेटा प्रविष्टि</a></li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle hindi" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">मास्टर अपडेट</a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item hindi" href="#" id="openCropUpload">फसल मास्टर अपलोड करें</a></li>
                <li><a class="dropdown-item hindi" href="#" id="openCommitteeUpload">समिति मास्टर अपलोड करें</a></li>
                <!-- Add more master uploads here -->
              </ul>
            </li>
            <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link hindi">लॉग आउट</a></li>
            <li class="nav-item">
              <a href="#" class="nav-link hindi" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="fas fa-question-circle me-1"></i> सहायता</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div>
</header>

<main class="container-main">
  <div id="alertBox" class="alert hindi"></div>

  <div class="card">
    <div class="card-header hindi">डेटा प्रविष्टि ({{userDistrictName}})</div>
    <div class="card-body">
      <!-- Show readonly district -->
      <p class="form-label-bold hindi">जिला: <span id="userDistrictNameDisplay"></span></p>

      <button id="btnAddRow" class="btn btn-success btn-add-row"><i class="fas fa-plus-circle me-1"></i> नया रिकॉर्ड जोड़ें</button>

      <form id="multiEntryForm" autocomplete="off" novalidate>
        <table class="data-entry-table" aria-label="डेटा प्रविष्टि तालिका">
          <thead>
            <tr>
              <th>ब्लॉक <span class="text-danger">*</span></th>
              <th>फसल का नाम <span class="text-danger">*</span></th>
              <th>समिति</th>
              <th>बीज निगम</th>
              <th>विभागीय योजना/ प्रदर्शन</th>
              <th>प्रक्रिया केन्द्र से नगद/ उत्पादन वितरण</th>
              <th>क्रिया</th>
            </tr>
          </thead>
          <tbody id="entryTableBody">
            <!-- Rows dynamically inserted here -->
          </tbody>
        </table>
        <button type="submit" class="btn btn-primary w-100 mt-3 hindi"><i class="fas fa-save me-2"></i> सबमिट करें</button>
      </form>
    </div>
  </div>
</main>

<!-- Upload Modals -->
<div class="modal fade" id="cropUploadModal" tabindex="-1" aria-labelledby="cropUploadLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="cropUploadForm" class="modal-content" novalidate autocomplete="off">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="cropUploadLabel">फसल मास्टर अपलोड करें</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1); opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <p class="hindi">टेम्पलेट डाउनलोड करें, भरें, और अपलोड करें।</p>
        <button type="button" class="btn btn-success w-100 mb-3" id="downloadCropTemplate"><i class="fas fa-file-download me-2"></i> टेम्पलेट डाउनलोड (.xlsx)</button>
        <input type="file" id="cropFileInput" accept=".xlsx" class="form-control" required />
      </div>
      <div class="modal-footer" style="background-color:#FAFAFA;">
        <button type="submit" class="btn btn-primary w-100 hindi"><i class="fas fa-upload me-2"></i> अपलोड करें</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="committeeUploadModal" tabindex="-1" aria-labelledby="committeeUploadLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="committeeUploadForm" class="modal-content" novalidate autocomplete="off">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="committeeUploadLabel">समिति मास्टर अपलोड करें</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1); opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <p class="hindi">टेम्पलेट डाउनलोड करें, भरें, और अपलोड करें।</p>
        <button type="button" class="btn btn-success w-100 mb-3" id="downloadCommitteeTemplate"><i class="fas fa-file-download me-2"></i> टेम्पलेट डाउनलोड (.xlsx)</button>
        <input type="file" id="committeeFileInput" accept=".xlsx" class="form-control" required />
      </div>
      <div class="modal-footer" style="background-color:#FAFAFA;">
        <button type="submit" class="btn btn-primary w-100 hindi"><i class="fas fa-upload me-2"></i> अपलोड करें</button>
      </div>
    </form>
  </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: var(--text-light);">
        <h5 class="modal-title hindi" id="helpModalLabel">मदद और निर्देश</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1); opacity: 0.8;"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold hindi">डेटा प्रविष्टि तालिका</h6>
        <p class="hindi">नई पंक्तियाँ जोड़ें, सभी आवश्यक जानकारी भरें, और सबमिट करें।</p>
        <h6 class="fw-bold hindi">मास्टर डेटा अपलोड</h6>
        <p class="hindi">मास्टर प्रकार चुनें, टेम्पलेट डाउनलोड करें, उसे भरें, फिर यहाँ अपलोड करें।</p>
        <h6 class="fw-bold hindi">सहायता संपर्क</h6>
        <p class="hindi">किसी समस्या के लिए, कृपया <strong>diagri-cg@cg.gov.in</strong> पर ईमेल करें या <strong>9399207068</strong> पर कॉल करें।</p>
      </div>
      <div class="modal-footer" style="background-color:#FAFAFA;">
        <button type="button" class="btn btn-primary hindi" data-bs-dismiss="modal">समझ गया</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap and Supabase -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  const supabaseUrl = "https://txjbfqrbbtvzlxpeegkv.supabase.co";
  const supabaseKey = "YOUR_SUPABASE_ANON_KEY"; // replace this with your anon key
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  let user = null;
  let userDistrictId = null;
  let userDistrictName = null;
  let blocks = [];
  let crops = [];
  let committees = [];

  const alertBox = document.getElementById("alertBox");
  const entryTbody = document.getElementById("entryTableBody");
  const userDistrictLabel = document.getElementById("userDistrictNameDisplay");
  const btnAddRow = document.getElementById("btnAddRow");

  // Show alert
  function showAlert(message, type = "success") {
    alertBox.textContent = message;
    alertBox.className = `alert hindi ${type === "success" ? "success" : "danger"}`;
    alertBox.style.display = "block";
    alertBox.style.animation = "fadeIn 0.3s ease-in forwards";
    setTimeout(() => {
      alertBox.style.animation = "fadeOut 0.3s ease-out forwards";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 300);
    }, 6000);
  }

  // Load user info and district info after login
  function loadUser() {
    const userJSON = localStorage.getItem("user") || sessionStorage.getItem("user");
    if (!userJSON) {
      window.location.href = "seedlogin.html";
      return null;
    }
    user = JSON.parse(userJSON);
    // user object must have district_id and district_name (you can store this on login)
    userDistrictId = user.district_id;
    userDistrictName = user.district_name;
    userDistrictLabel.textContent = userDistrictName || "अज्ञात";
  }

  // Load master data filtered by user's district where applicable
  async function loadMasters() {
    try {
      // Load blocks for user district
      const { data: blocksData, error: blocksErr } = await supabaseClient
        .from("blocks")
        .select("id, name")
        .eq("district_id", userDistrictId)
        .order("name");
      if (blocksErr) throw blocksErr;
      blocks = blocksData || [];

      // Load full crop master list
      const { data: cropsData, error: cropsErr } = await supabaseClient
        .from("crop_master")
        .select("id, crop_name")
        .order("crop_name");
      if (cropsErr) throw cropsErr;
      crops = cropsData || [];

      // Committees filtered by district:
      const { data: commData, error: commErr } = await supabaseClient
        .from("committee_master")
        .select("id, block_id, committee_name")
        .eq("district_id", userDistrictId)
        .order("committee_name");
      if (commErr) throw commErr;
      committees = commData || [];
    } catch (err) {
      console.error(err);
      showAlert("मास्टर डेटा लोड करने में त्रुटि हुई। कृपया पुनः प्रयास करें।", "danger");
    }
  }

  // Create a new blank row in table
  function createRow() {
    const tr = document.createElement("tr");

    // Block cell: select with options
    const tdBlock = document.createElement("td");
    const selectBlock = document.createElement("select");
    selectBlock.className = "form-select form-select-sm block-select";
    selectBlock.required = true;
    selectBlock.innerHTML = `<option value="">-- ब्लॉक चुनें --</option>`;
    blocks.forEach(b => {
      const option = document.createElement("option");
      option.value = b.id;
      option.textContent = b.name;
      selectBlock.appendChild(option);
    });
    tdBlock.appendChild(selectBlock);

    // Crop cell: select with options
    const tdCrop = document.createElement("td");
    const selectCrop = document.createElement("select");
    selectCrop.className = "form-select form-select-sm crop-select";
    selectCrop.required = true;
    selectCrop.innerHTML = `<option value="">-- फसल चुनें --</option>`;
    crops.forEach(c => {
      const option = document.createElement("option");
      option.value = c.id;
      option.textContent = c.crop_name;
      selectCrop.appendChild(option);
    });
    tdCrop.appendChild(selectCrop);

    // Committee cell: select filtered by block (initially empty)
    const tdCommittee = document.createElement("td");
    const selectCommittee = document.createElement("select");
    selectCommittee.className = "form-select form-select-sm committee-select";
    selectCommittee.innerHTML = `<option value="">-- समिति चुनें (वैकल्पिक) --</option>`;
    selectCommittee.disabled = true; // Disabled until block selected
    tdCommittee.appendChild(selectCommittee);

    // Other text fields
    function createInputCell(placeholder) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = "text";
      input.className = "form-control form-control-sm";
      input.placeholder = placeholder;
      td.appendChild(input);
      return td;
    }
    const tdSeedCorp = createInputCell("बीज निगम");
    const tdScheme = createInputCell("विभागीय योजना/ प्रदर्शन");
    const tdDistribution = createInputCell("नगद/उत्पादन वितरण");

    // Action cell: delete button
    const tdAction = document.createElement("td");
    const btnDelete = document.createElement("button");
    btnDelete.type = "button";
    btnDelete.className = "btn btn-danger btn-sm";
    btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
    btnDelete.title = "पंक्ति हटाएँ";
    btnDelete.addEventListener("click", () => tr.remove());
    tdAction.appendChild(btnDelete);

    // Append cells to row
    tr.append(tdBlock, tdCrop, tdCommittee, tdSeedCorp, tdScheme, tdDistribution, tdAction);

    // When block changes, populate committee dropdown filtered by block
    selectBlock.addEventListener("change", () => {
      const blockId = selectBlock.value;
      selectCommittee.innerHTML = `<option value="">-- समिति चुनें (वैकल्पिक) --</option>`;
      if (!blockId) {
        selectCommittee.disabled = true;
      } else {
        const filteredComm = committees.filter(c => c.block_id === blockId);
        filteredComm.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.committee_name;
          selectCommittee.appendChild(opt);
        });
        selectCommittee.disabled = false;
      }
    });

    return tr;
  }

  // Add initial row and set up add row button
  const addRowBtn = btnAddRow;
  addRowBtn.addEventListener("click", () => {
    const newRow = createRow();
    entryTbody.appendChild(newRow);
  });

  // Get all rows data and validate
  function getFormData() {
    const rows = entryTbody.querySelectorAll("tr");
    const data = [];
    let errors = [];

    rows.forEach((tr, idx) => {
      const rowNum = idx + 1;
      const blockSelect = tr.querySelector(".block-select");
      const cropSelect = tr.querySelector(".crop-select");
      const committeeSelect = tr.querySelector(".committee-select");
      const seedCorpInput = tr.cells[3].querySelector("input");
      const schemeInput = tr.cells[4].querySelector("input");
      const distributionInput = tr.cells[5].querySelector("input");

      if (!blockSelect.value) {
        errors.push(`पंक्ति ${rowNum}: ब्लॉक आवश्यक है।`);
      }
      if (!cropSelect.value) {
        errors.push(`पंक्ति ${rowNum}: फसल का नाम आवश्यक है।`);
      }

      if (errors.length) return;

      data.push({
        block_id: blockSelect.value,
        crop_name_id: cropSelect.value,
        committee_id: committeeSelect.value || null,
        seed_corp: seedCorpInput.value.trim() || null,
        scheme: schemeInput.value.trim() || null,
        distribution: distributionInput.value.trim() || null,
      });
    });
    return { data, errors };
  }

  // Submit form handler
  document.getElementById("multiEntryForm").addEventListener("submit", async e => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> कृपया प्रतीक्षा करें...';

    try {
      const { data, errors } = getFormData();
      if (errors.length) {
        showAlert(errors.join(" "), "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-2"></i> सबमिट करें';
        return;
      }
      if (data.length === 0) {
        showAlert("कम से कम एक रिकॉर्ड दर्ज करें।", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-2"></i> सबमिट करें';
        return;
      }

      const insertData = data.map(row => ({
        user_id: user.id,
        district_id: userDistrictId,
        ...row
      }));

      const { error } = await supabaseClient.from("seed_entries").insert(insertData);
      if (error) throw error;

      showAlert("डेटा सफलतापूर्वक सबमिट किया गया।", "success");
      entryTbody.innerHTML = "";
      addRowBtn.click(); // add blank row

    } catch (err) {
      console.error(err);
      showAlert("सर्वर त्रुटि: कृपया पुनः प्रयास करें।", "danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-2"></i> सबमिट करें';
    }
  });

  // Initial load
  document.addEventListener("DOMContentLoaded", async () => {
    loadUser();
    userDistrictLabel.textContent = userDistrictName || "";
    if (!userDistrictId) {
      // No district info - redirect
      window.location.href = "seedlogin.html";
      return;
    }
    await loadMasters();
    addRowBtn.click(); // Add first empty row on load
  });

  // Crop upload modal logic, committee upload modal logic,
  // and template download logic would be similar to previous examples,
  // but omitted here for brevity. Let me know if you want me to provide them as well.
</script>

</body>
</html>
