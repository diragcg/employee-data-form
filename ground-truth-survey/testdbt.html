<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º-KCC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .btn-custom {
            margin: 5px;
            padding: 10px 15px;
        }
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h3>‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º - KCC Dashboard</h3>
            <div>
                <span id="userInfo">User Info</span>
                <button id="btnLogout" class="btn btn-dark btn-custom">Logout</button>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h5>KCC Data Entry Form</h5>
        <div class="row">
            <div class="col-md-6">
                <label>Entry Date:</label>
                <input type="date" id="entry_date" class="form-control">
            </div>
            <div class="col-md-6">
                <label>District:</label>
                <input type="text" id="district_name_display" class="form-control" readonly>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-6">
                <label>Total Active KCC:</label>
                <input type="number" id="total_active_kcc" class="form-control">
            </div>
            <div class="col-md-6">
                <label>Total Saturated KCC:</label>
                <input type="number" id="total_kcc_saturated" class="form-control">
            </div>
        </div>
        <br>
        <div class="text-center">
            <button id="btnSave" class="btn btn-success btn-custom">
                <i class="fas fa-save"></i> Save Entry
            </button>
            <button id="btnClear" class="btn btn-secondary btn-custom">
                <i class="fas fa-eraser"></i> Clear Form
            </button>
            <button id="btnViewRecords" class="btn btn-primary btn-custom">
                <i class="fas fa-table"></i> View Records
            </button>
        </div>
    </div>

    <div id="status" class="alert alert-info">Ready</div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>

    <script>
        console.log('üöÄ Starting KCC Portal...');

        // Simple configuration
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;

        // Initialize Supabase
        function initSupabase() {
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(supabaseUrl, supabaseKey);
                console.log('‚úì Supabase initialized');
                return true;
            } catch (error) {
                console.error('‚úó Supabase error:', error);
                return false;
            }
        }

        // Load user session
        function loadUser() {
            const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
            
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    console.log('‚úì User loaded:', currentUser);
                    return true;
                } catch (e) {
                    console.error('‚úó User parse error:', e);
                }
            }
            
            // If no user found, create a test user
            console.log('‚ö† No user session found, creating test user');
            currentUser = {
                id: 'test-user-123',
                username: 'test_user',
                fullName: 'Test User',
                districtName: 'Test District',
                districtId: 'test-district-123',
                role: 'user'
            };
            return true;
        }

        // Update UI
        function updateUI() {
            if (!currentUser) return;
            
            // Update user info
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.textContent = `${currentUser.fullName} (${currentUser.districtName})`;
            }

            // Set district
            const districtDisplay = document.getElementById('district_name_display');
            if (districtDisplay) {
                districtDisplay.value = currentUser.districtName;
            }

            // Set today's date
            const entryDate = document.getElementById('entry_date');
            if (entryDate) {
                entryDate.value = new Date().toISOString().slice(0, 10);
            }

            console.log('‚úì UI updated');
        }

        // Event handlers
        function attachEvents() {
            // Logout button
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.onclick = function() {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('user');
                        sessionStorage.removeItem('user');
                        window.location.href = 'selectmodule1708.html';
                    }
                };
                console.log('‚úì Logout button attached');
            }

            // Save button
            const btnSave = document.getElementById('btnSave');
            if (btnSave) {
                btnSave.onclick = function() {
                    saveEntry();
                };
                console.log('‚úì Save button attached');
            }

            // Clear button
            const btnClear = document.getElementById('btnClear');
            if (btnClear) {
                btnClear.onclick = function() {
                    clearForm();
                };
                console.log('‚úì Clear button attached');
            }

            // View Records button
            const btnViewRecords = document.getElementById('btnViewRecords');
            if (btnViewRecords) {
                btnViewRecords.onclick = function() {
                    viewRecords();
                };
                console.log('‚úì View Records button attached');
            }
        }

        // Save entry function
        async function saveEntry() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.className = 'alert alert-info';
                statusDiv.textContent = 'Saving...';

                const entryDate = document.getElementById('entry_date').value;
                const activeKCC = document.getElementById('total_active_kcc').value;
                const saturatedKCC = document.getElementById('total_kcc_saturated').value;

                if (!entryDate || !activeKCC || !saturatedKCC) {
                    throw new Error('Please fill all required fields');
                }

                const payload = {
                    district_id: currentUser.districtId,
                    district_name: currentUser.districtName,
                    entry_date: entryDate,
                    total_active_kcc: parseInt(activeKCC),
                    total_kcc_saturated: parseInt(saturatedKCC),
                    total_kcc_not_saturated: parseInt(activeKCC) - parseInt(saturatedKCC),
                    created_by: currentUser.id,
                    is_current: true,
                    version_number: 1
                };

                console.log('Saving payload:', payload);

                const { data, error } = await supabaseClient
                    .from('kcc_entries')
                    .insert([payload]);

                if (error) throw error;

                statusDiv.className = 'alert alert-success';
                statusDiv.textContent = 'Entry saved successfully!';
                
                // Clear form after save
                setTimeout(() => {
                    clearForm();
                }, 2000);

            } catch (error) {
                console.error('Save error:', error);
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Save failed: ' + error.message;
            }
        }

        // Clear form function
        function clearForm() {
            document.getElementById('total_active_kcc').value = '';
            document.getElementById('total_kcc_saturated').value = '';
            document.getElementById('entry_date').value = new Date().toISOString().slice(0, 10);
            
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'alert alert-info';
            statusDiv.textContent = 'Form cleared. Ready for new entry.';
            
            console.log('‚úì Form cleared');
        }

        // View records function
        async function viewRecords() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.className = 'alert alert-info';
                statusDiv.textContent = 'Loading records...';

                const { data, error } = await supabaseClient
                    .from('kcc_entries')
                    .select('*')
                    .eq('district_id', currentUser.districtId)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    let recordsText = `Found ${data.length} records:\n\n`;
                    data.forEach((record, index) => {
                        recordsText += `${index + 1}. Date: ${record.entry_date}, Active: ${record.total_active_kcc}, Saturated: ${record.total_kcc_saturated}\n`;
                    });
                    alert(recordsText);
                } else {
                    alert('No records found for your district.');
                }

                statusDiv.className = 'alert alert-info';
                statusDiv.textContent = 'Ready';

            } catch (error) {
                console.error('View records error:', error);
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Error loading records: ' + error.message;
            }
        }

        // Initialize everything
        function init() {
            console.log('üîÑ Initializing application...');
            
            if (!initSupabase()) {
                alert('Failed to initialize database connection');
                return;
            }

            if (!loadUser()) {
                alert('Failed to load user session');
                return;
            }

            updateUI();
            attachEvents();
            
            console.log('‚úÖ Application initialized successfully');
            
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'alert alert-success';
            statusDiv.textContent = 'Application ready! All buttons should work now.';
        }

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Test function
        window.testButtons = function() {
            console.log('Testing all buttons...');
            
            const buttons = ['btnLogout', 'btnSave', 'btnClear', 'btnViewRecords'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                console.log(`${btnId}:`, btn ? 'Found' : 'NOT FOUND');
                if (btn) {
                    console.log(`${btnId} onclick:`, btn.onclick ? 'Attached' : 'NOT ATTACHED');
                }
            });
            
            console.log('Current user:', currentUser);
            console.log('Supabase client:', supabaseClient);
        };

        console.log('üìú Script loaded. Type testButtons() in console to debug.');
    </script>
</body>
</html>
