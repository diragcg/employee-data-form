<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Excel to Supabase Data Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background:#f5f7fb; color:#222; }
        .header-bg { background:#0d6efd; color:white; }
        .sidebar { width: 260px; min-height: calc(100vh - 56px); border-right: 1px solid #e6e9ef; background: #fff; }
        .main { padding: 24px; }
        .app-container { margin-top:56px; display:flex; gap:0; }
        .sidebar .logo { padding: 18px; font-weight:600; }
        .sidebar .nav-item { cursor:pointer; }
        .header-actions { gap:12px; }
        .list-group-item.form-list-item { cursor:pointer; }
        .active-form { background: #eef6ff; border-left: 4px solid #0d6efd; }
        .card-small { border-radius: 8px; }
        .hidden { display:none; }
        .file-info { font-size:13px; color:#5d6b7a; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg header-bg fixed-top">
    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="28" height="28" class="me-2" alt="">
            <span class="navbar-brand mb-0">Excel Data Portal</span>
        </div>
        <div class="d-flex ms-auto align-items-center header-actions me-3">
            <button id="home-btn" class="btn btn-outline-light btn-sm">Home</button>
            <button id="dashboard-btn" class="btn btn-outline-light btn-sm">Dashboard</button>
        </div>
    </div>
</nav>

<div class="app-container">
    <aside class="sidebar p-2">
        <div class="logo d-flex align-items-center">
            <div>
                <div class="fw-semibold">Forms</div>
                <div class="file-info" id="sidebar-subtitle">No tables yet</div>
            </div>
        </div>

        <div class="p-2">
            <div class="mb-3">
                <label class="form-label mb-1 small">Upload Excel</label>
                <input id="excel-file-input" type="file" class="form-control form-control-sm" accept=".xlsx,.xls">
                <div class="mt-2 d-grid">
                    <button id="process-file-btn" class="btn btn-primary btn-sm">Process File</button>
                </div>
            </div>

            <div class="mb-3">
                <div class="fw-semibold mb-1 small">Created Tables</div>
                <div id="table-list" class="list-group list-group-flush">
                    <!-- populated dynamically -->
                </div>
            </div>

            <div class="mb-3">
                <div class="fw-semibold mb-1 small">Forms for Selected Table</div>
                <div id="form-list" class="list-group list-group-flush">
                    <!-- each generated form entry -->
                </div>
            </div>

            <div class="mt-3">
                <small class="text-muted">Note: Only blank fillable forms are created from the headers; file rows are NOT inserted.</small>
            </div>
        </div>
    </aside>

    <main class="main flex-grow-1">
        <div id="home-view">
            <div class="row">
                <div class="col-12">
                    <div class="card card-small p-3 mb-3">
                        <h4 class="mb-1">Home</h4>
                        <p class="mb-0 text-muted">Use Upload Excel to create a table (based on first-row headers). Then create blank forms and save manual entries into the created table.</p>
                    </div>
                </div>

                <div class="col-12">
                    <div id="dashboard-view" class="card card-small p-3 hidden">
                        <h5 class="mb-2">Dashboard</h5>
                        <div id="dashboard-content">
                            <p class="text-muted">No tables yet.</p>
                        </div>
                    </div>

                    <div id="forms-area" class="card card-small p-3 hidden">
                        <h5 id="forms-area-title" class="mb-3">Forms</h5>
                        <div id="forms-body">
                            <!-- form cards inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal to confirm headers -->
<div class="modal fade" id="supabaseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Confirm Headers & Create Table</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Detected columns (first row). Confirm and create a table named from the file name (sanitized):</p>
        <div class="mb-2">
            <div><strong>Table name:</strong> <span id="modal-table-name" class="text-primary"></span></div>
        </div>
        <div id="header-list" class="list-group mb-3"></div>
        <div class="alert alert-warning small mb-0">Security: This creates schema objects in your DB. For production, do this server-side.</div>
      </div>
      <div class="modal-footer">
        <button id="cancel-modal" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="create-table-btn" type="button" class="btn btn-success">Create Table</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ---------- Configuration & client ---------- */
const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ---------- State ---------- */
let currentHeaders = [];
let currentTableName = '';
const tables = []; // { tableName, headers }

/* ---------- Elements ---------- */
const excelFileInput = document.getElementById('excel-file-input');
const processFileBtn = document.getElementById('process-file-btn');
const sidebarSubtitle = document.getElementById('sidebar-subtitle');
const tableListEl = document.getElementById('table-list');
const formListEl = document.getElementById('form-list');
const formsArea = document.getElementById('forms-area');
const formsBody = document.getElementById('forms-body');
const modalEl = document.getElementById('supabaseModal');
const bootstrapModal = new bootstrap.Modal(modalEl);
const modalHeaderList = modalEl.querySelector('#header-list');
const modalTableName = document.getElementById('modal-table-name');
const createTableBtn = document.getElementById('create-table-btn');
const dashboardBtn = document.getElementById('dashboard-btn');
const homeBtn = document.getElementById('home-btn');
const dashboardView = document.getElementById('dashboard-view');
const homeView = document.getElementById('home-view');

/* ---------- Helpers ---------- */
function sanitizeIdentifier(str) {
  return String(str || '')
    .trim()
    .replace(/\.[^/.]+$/, '') // remove ext
    .replace(/\s+/g, '_')
    .replace(/[^a-zA-Z0-9_]/g, '')
    .toLowerCase()
    || `table_${Date.now()}`;
}

function sanitizeColumnName(str, index) {
  let n = String(str || `column_${index+1}`).trim().replace(/[^a-zA-Z0-9_]/g, '');
  if (!n) n = `column_${index+1}`;
  return n;
}

function resetProcessUI() {
  processFileBtn.disabled = false;
}

/* ---------- File processing ---------- */
processFileBtn.addEventListener('click', () => {
  const file = excelFileInput.files[0];
  if (!file) { alert('Please select an Excel file.'); return; }

  processFileBtn.disabled = true;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      if (!jsonData || jsonData.length === 0 || !jsonData[0] || jsonData[0].length === 0) {
        alert('Excel file appears empty or has no headers.');
        resetProcessUI();
        return;
      }

      currentHeaders = jsonData[0].map(h => String(h || '').trim());
      currentTableName = sanitizeIdentifier(file.name);

      modalHeaderList.innerHTML = currentHeaders.map(h => `<div class="list-group-item header-list-item">${h || '(empty header)'}</div>`).join('');
      modalTableName.textContent = currentTableName;
      bootstrapModal.show();
    } catch (err) {
      console.error(err);
      alert('Failed to process file. Make sure it is a valid .xlsx or .xls file.');
    } finally {
      resetProcessUI();
    }
  };
  reader.onerror = () => { alert('Error reading file'); resetProcessUI(); };
  reader.readAsArrayBuffer(file);
});

/* ---------- Create table (RPC) ---------- */
createTableBtn.addEventListener('click', async () => {
  createTableBtn.disabled = true;
  try {
    // Prepare DDL
    const seen = new Set();
    const cols = currentHeaders.map((h, i) => {
      let col = sanitizeColumnName(h, i);
      let base = col;
      let suffix = 1;
      while (seen.has(col.toLowerCase())) {
        col = `${base}_${suffix++}`;
      }
      seen.add(col.toLowerCase());
      return `"${col}" TEXT`;
    }).join(', ');
    const ddl = `CREATE TABLE IF NOT EXISTS public."${currentTableName}" (${cols});`;

    // Call RPC that was created earlier
    const { data, error } = await supabaseClient.rpc('execute_sql_script', { sql_text: ddl });
    if (error) throw error;

    // store locally and update UI; do NOT insert file rows
    tables.push({ tableName: currentTableName, headers: currentHeaders.slice() });
    updateSidebar();
    bootstrapModal.hide();
    // show forms area and create blank form mapping
    createFormMappingForTable(currentTableName, currentHeaders);
    alert(`Table "${currentTableName}" created. Blank forms generated.`);
  } catch (err) {
    console.error(err);
    alert(`Failed to create table. Error: ${err.message || err}`);
  } finally {
    createTableBtn.disabled = false;
  }
});

/* ---------- Sidebar & Forms UI ---------- */
function updateSidebar() {
  // update subtitle and table list
  sidebarSubtitle.textContent = tables.length ? `${tables.length} table(s)` : 'No tables yet';
  tableListEl.innerHTML = tables.map(t => {
    return `<div class="list-group-item d-flex justify-content-between align-items-start form-list-item" data-table="${t.tableName}">
              <div>
                <div class="fw-medium">${t.tableName}</div>
                <small class="text-muted">${t.headers.length} column(s)</small>
              </div>
            </div>`;
  }).join('');

  // attach click handlers
  tableListEl.querySelectorAll('.form-list-item').forEach(el => {
    el.addEventListener('click', () => {
      const tname = el.getAttribute('data-table');
      selectTable(tname);
    });
  });

  // refresh dashboard content
  refreshDashboard();
}

function createFormMappingForTable(tableName, headers) {
  // Create one blank form per table (user asked many forms may be created; make ability to add additional blank forms)
  const entryId = `${tableName}::form::1`; // simple id; could be extended
  addFormEntry(tableName, entryId, headers);
  selectForm(entryId);
  selectTable(tableName);
}

function addFormEntry(tableName, formId, headers) {
  // Add form entry in mapping list
  const item = document.createElement('div');
  item.className = 'list-group-item form-list-item d-flex justify-content-between align-items-start';
  item.setAttribute('data-form-id', formId);
  item.setAttribute('data-table', tableName);
  item.innerHTML = `<div><div class="fw-medium">${tableName} — Blank Form</div><small class="text-muted">manual entry</small></div>`;
  formListEl.appendChild(item);

  item.addEventListener('click', () => {
    selectForm(formId);
    // highlight active item
    formListEl.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active-form'));
    item.classList.add('active-form');
  });

  // create the form DOM (hidden until selected)
  const formCard = document.createElement('div');
  formCard.className = 'card mb-3';
  formCard.id = `form-card-${formId}`;
  formCard.innerHTML = `
    <div class="card-body">
      <h6 class="card-title text-primary">${tableName} — Blank Record</h6>
      <form id="form-${formId}"></form>
      <div class="text-end mt-3">
        <button type="button" class="btn btn-success btn-sm save-btn" data-form-id="${formId}">Save</button>
      </div>
    </div>
  `;
  formsBody.appendChild(formCard);

  const formEl = formCard.querySelector(`#form-${formId}`);
  headers.forEach((h, idx) => {
    const label = h || `Column ${idx+1}`;
    const colName = sanitizeColumnName(h, idx);
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-2';
    wrapper.innerHTML = `
      <label class="form-label small">${label}</label>
      <input type="text" name="${colName}" class="form-control form-control-sm" />
    `;
    formEl.appendChild(wrapper);
  });

  // save handler
  formCard.querySelector('.save-btn').addEventListener('click', async (ev) => {
    const fid = ev.target.getAttribute('data-form-id');
    const fEl = document.getElementById(`form-${fid}`);
    const payload = {};
    fEl.querySelectorAll('input').forEach(i => {
      payload[i.name] = i.value;
    });

    try {
      const table = tableName;
      const { data, error } = await supabaseClient.from(table).insert([payload]);
      if (error) throw error;
      alert('Record saved successfully.');
      // optionally clear inputs
      fEl.querySelectorAll('input').forEach(i => i.value = '');
    } catch (err) {
      console.error(err);
      alert(`Save failed: ${err.message || err}`);
    }
  });

  // hide newly created form by default
  formCard.classList.add('hidden');
}

function selectTable(tableName) {
  // highlight selected table in sidebar
  tableListEl.querySelectorAll('.list-group-item').forEach(el => el.classList.toggle('active-form', el.getAttribute('data-table') === tableName));
  // show forms area and filter form-list to show only forms for that table
  formsArea.classList.remove('hidden');
  // show relevant form-list items
  formListEl.querySelectorAll('.list-group-item').forEach(li => {
    li.style.display = li.getAttribute('data-table') === tableName ? '' : 'none';
  });
  // show forms area title
  document.getElementById('forms-area-title').textContent = `Forms for "${tableName}"`;
  // also show only form cards for that table
  formsBody.querySelectorAll('.card').forEach(card => {
    const fid = card.id.replace('form-card-', '');
    const li = formListEl.querySelector(`[data-form-id="${fid}"]`);
    if (li && li.getAttribute('data-table') === tableName) {
      card.classList.remove('hidden');
    } else {
      card.classList.add('hidden');
    }
  });
}

function selectForm(formId) {
  // hide all, show selected
  formsBody.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
  const selected = document.getElementById(`form-card-${formId}`);
  if (selected) {
    selected.classList.remove('hidden');
    // scroll into view
    selected.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

/* ---------- Dashboard / Home nav ---------- */
dashboardBtn.addEventListener('click', () => {
  homeView.scrollIntoView({ behavior: 'smooth' });
  // show dashboard panel (toggle)
  dashboardView.classList.remove('hidden');
  formsArea.classList.add('hidden');
  // hide form list in sidebar when on dashboard? keep it visible.
});

homeBtn.addEventListener('click', () => {
  // go to home
  dashboardView.classList.add('hidden');
  formsArea.classList.add('hidden');
});

/* ---------- Dashboard refresh ---------- */
function refreshDashboard() {
  const content = document.getElementById('dashboard-content');
  if (!tables.length) {
    content.innerHTML = `<p class="text-muted">No tables created yet.</p>`;
    return;
  }
  content.innerHTML = tables.map(t => {
    return `<div class="mb-2 p-2 border rounded">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">${t.tableName}</div>
          <div class="text-muted small">${t.headers.length} columns</div>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary me-1" data-action="view" data-table="${t.tableName}">View</button>
          <button class="btn btn-sm btn-outline-secondary" data-action="delete" data-table="${t.tableName}">Delete</button>
        </div>
      </div>
    </div>`;
  }).join('');

  // attach actions
  content.querySelectorAll('button[data-action]').forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      const action = ev.target.getAttribute('data-action');
      const tname = ev.target.getAttribute('data-table');
      if (action === 'view') {
        selectTable(tname);
        formsArea.classList.remove('hidden');
        dashboardView.classList.add('hidden');
      } else if (action === 'delete') {
        if (!confirm(`Drop table "${tname}"? This will delete all data.`)) return;
        try {
          const ddl = `DROP TABLE IF EXISTS public."${tname}" CASCADE;`;
          const { data, error } = await supabaseClient.rpc('execute_sql_script', { sql_text: ddl });
          if (error) throw error;
          // remove from local state and UI
          const idx = tables.findIndex(x => x.tableName === tname);
          if (idx !== -1) tables.splice(idx, 1);
          // remove form entries and cards
          formListEl.querySelectorAll(`[data-table="${tname}"]`).forEach(el => el.remove());
          formsBody.querySelectorAll('.card').forEach(c => {
            if (c.id.startsWith(`form-card-${tname}`) || c.querySelector(`#form-${tname}`)) c.remove();
          });
          updateSidebar();
          refreshDashboard();
          alert(`Table "${tname}" dropped.`);
        } catch (err) {
          console.error(err);
          alert(`Failed to drop table: ${err.message || err}`);
        }
      }
    });
  });
}

/* ---------- Initialization ---------- */
// show home by default
homeBtn.click();
updateSidebar();

</script>
</body>
</html>
