<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel → Supabase — Admin / District App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    body { font-family: "Mukta", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f7fafc; }
    .topbar { position:fixed; top:0; left:0; right:0; height:56px; background:#0d6efd; color:#fff; display:flex; align-items:center; gap:12px; padding:0 16px; z-index:30; }
    .app { max-width:1100px; margin:80px auto 48px; }
    .hidden { display:none !important; }
    .card-sm { border-radius:10px; box-shadow:0 6px 20px rgba(2,6,23,0.06); background:#fff; padding:16px; }
    .sidebar { min-width:240px; }
    .list-hit { cursor:pointer; }
    footer.note { text-align:center; color:#6b7280; margin-top:20px; font-size:13px; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" width="28" height="28" alt="">
    <div class="fw-bold">डेटा पोर्टल</div>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <button id="homeBtn" class="btn btn-sm btn-light">Home</button>
      <button id="dashboardBtn" class="btn btn-sm btn-light">Dashboard</button>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
  <main class="app container-fluid">
    <div id="unauth" class="card-sm">
      <h5 class="mb-2">Unauthorized</h5>
      <p class="text-muted">You should be redirected here from login.html after authentication. This page requires a logged-in user stored in localStorage/sessionStorage under key "user".</p>
      <div>
        <button id="goLogin" class="btn btn-primary">Go to Login</button>
      </div>
    </div>
Text
<div id="appShell" class="row hidden">
  <aside class="col-md-3 sidebar">
    <div class="card-sm mb-3">
      <div><strong id="userName"></strong></div>
      <div class="text-muted small" id="userRole"></div>
      <div class="text-muted small" id="userDistrict"></div>
    </div>

    <div id="adminControls" class="card-sm mb-3 hidden">
      <h6>Admin — Create Forms</h6>
      <div class="mb-2">
        <label class="form-label small">Excel (.xlsx/.xls)</label>
        <input id="excelFile" type="file" accept=".xlsx,.xls" class="form-control form-control-sm" />
      </div>
      <div class="mb-2">
        <label class="form-label small">Table name (optional)</label>
        <input id="tableNameInput" class="form-control form-control-sm" placeholder="optional table name" />
      </div>
      <div class="d-grid">
        <button id="processExcelBtn" class="btn btn-sm btn-primary">Process & Create Table</button>
      </div>
      <small class="text-muted d-block mt-2">Admin only. This will create a table and store a form definition. No file rows are inserted.</small>
    </div>

    <div class="card-sm mb-3">
      <h6>Available Forms</h6>
      <div id="formsList" class="list-group"></div>
    </div>

    <div class="card-sm">
      <h6>Tables (admin)</h6>
      <div id="tablesList" class="list-group"></div>
    </div>
  </aside>

  <section class="col-md-9">
    <div id="homeView" class="card-sm mb-3">
      <h5>Home</h5>
      <p class="text-muted">Admin creates form designs from Excel. District users use these forms for manual data entry. District users cannot create or modify forms/tables.</p>
    </div>

    <div id="dashboardView" class="card-sm mb-3 hidden">
      <h5>Dashboard</h5>
      <div id="dashboardContent"></div>
    </div>

    <div id="formView" class="card-sm mb-3 hidden">
      <h5 id="formTitle"></h5>
      <form id="entryForm"></form>
      <div class="mt-3 text-end">
        <button id="saveRecordBtn" class="btn btn-success">Save Record</button>
      </div>
    </div>
  </section>
</div>

<footer class="note">Important: For production use Supabase Auth + server-side DDL. See in-file notes.</footer>
  </main>
<script>
/* ---------------- CONFIG: replace keys before production ---------------- */
const SUPABASE_URL = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const SUPABASE_KEY = 'eyJhbGci...'; // REPLACE with environment-appropriate key (anon for dev). For production use server-side for DDL.
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------- Utilities ---------------- */
const \$ = id => document.getElementById(id);
const showAlert = (msg, t='danger') => { alert(msg); }; // simple alert for this single-file
function sanitizeIdentifier(str) {
  return String(str||'').replace(/\.[^/.]+\$/, '').trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase() || `table_${Date.now()}`;
}
function sanitizeColName(str, idx) {
  let s = String(str||`column_${idx+1}`).trim().replace(/[^a-zA-Z0-9_]/g,'');
  if (!s) s = `column_${idx+1}`; return s;
}
function safeId(str) { return String(str||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }

/* ---------------- State ---------------- */
let currentUser = null;
let definitions = []; // cached form_definitions
let currentDefinition = null;

/* ---------------- Init & session check ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  // Expect login.html to set 'user' in localStorage or sessionStorage as JSON with at least {id, username, role, districtId}
  const stored = localStorage.getItem('user') || sessionStorage.getItem('user');
  if (!stored) {
    // show message and allow redirect to login
    \$('unauth').classList.remove('hidden');
    \$('goLogin').addEventListener('click', ()=> location.href = 'login.html');
    return;
  }
  currentUser = JSON.parse(stored);
  bootApp();
});

/* ---------------- Boot app for logged-in user ---------------- */
function bootApp() {
  // show app shell
  \$('unauth').classList.add('hidden');
  \$('appShell').classList.remove('hidden');

  // populate header info
  \$('userName').textContent = currentUser.fullName || currentUser.username || currentUser.id;
  \$('userRole').textContent = `Role: ${currentUser.role || 'user'}`;
  \$('userDistrict').textContent = currentUser.districtId ? `District: ${currentUser.districtId}` : '';

  // show admin controls to admins only
  if (currentUser.role === 'admin') $('adminControls').classList.remove('hidden'); else $('adminControls').classList.add('hidden');

  // wire nav
  \$('homeBtn').addEventListener('click', ()=> { showHome(); });
  \$('dashboardBtn').addEventListener('click', ()=> { showDashboard(); });
  \$('logoutBtn').addEventListener('click', ()=> { localStorage.removeItem('user'); sessionStorage.removeItem('user'); location.href='login.html'; });

  // load definitions and UI
  loadDefinitions();
}

/* ---------------- Load form_definitions from DB ----------------
   form_definitions table schema (expected):
   - id (uuid)
   - table_name text unique
   - label text
   - created_by uuid
   - created_at timestamptz
   - fields jsonb  -- array [{ "name": "colname", "label": "Label", "position": 0 }, ...]
*/
async function loadDefinitions() {
  try {
    const { data, error } = await supabase.from('form_definitions').select('*').order('created_at', { ascending:false });
    if (error) throw error;
    definitions = data || [];
    renderDefinitionsList();
    renderTablesList();
  } catch (err) {
    console.error('loadDefinitions', err);
    showAlert('Failed to load definitions: ' + (err.message || err));
  }
}

function renderDefinitionsList() {
  const el = \$('formsList'); el.innerHTML = '';
  if (!definitions.length) { el.innerHTML = '<div class="text-muted">No forms</div>'; return; }
  definitions.forEach(def => {
    const div = document.createElement('div');
    div.className = 'list-group-item list-hit';
    div.textContent = `${def.table_name} (${(def.fields||[]).length} fields)`;
    div.dataset.table = def.table_name;
    div.addEventListener('click', () => openForm(def.table_name));
    el.appendChild(div);
  });
}

function renderTablesList() {
  const el = \$('tablesList'); el.innerHTML = '';
  if (!definitions.length) { el.innerHTML = '<div class="text-muted">No tables</div>'; return; }
  definitions.forEach(def => {
    const container = document.createElement('div');
    container.className = 'list-group-item d-flex justify-content-between align-items-center';
    const left = document.createElement('div');
    left.innerHTML = `<div class="fw-medium">${def.table_name}</div><small class="text-muted">${(def.fields||[]).length} fields</small>`;
    const right = document.createElement('div');
    if (currentUser.role === 'admin') {
      const dropBtn = document.createElement('button');
      dropBtn.className = 'btn btn-sm btn-outline-danger';
      dropBtn.textContent = 'Drop';
      dropBtn.addEventListener('click', () => dropTable(def.table_name));
      right.appendChild(dropBtn);
    }
    container.appendChild(left); container.appendChild(right);
    el.appendChild(container);
  });
}

/* ---------------- Admin: Process Excel and create table + save definition -------------
   IMPORTANT: This code calls an RPC public.execute_sql_script(sql_text) to run DDL.
   - Create that RPC in Supabase SQL editor (only for dev/testing).
   - In production, run DDL server-side with a service-role key and do not expose RPC to anon.
*/
\$('processExcelBtn').addEventListener('click', async () => {
  if (currentUser.role !== 'admin') return showAlert('Admin only', 'danger');
  const f = \$('excelFile').files[0];
  if (!f) return showAlert('Select an Excel file');
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
      if (!rows || !rows.length || !rows[0].length) return showAlert('File has no headers');
      const headers = rows[0].map(h => String(h||'').trim());
      const tableName = sanitizeIdentifier(\$('tableNameInput').value || f.name);
      if (!confirm(`Create table "${tableName}" with ${headers.length} columns? (No file rows will be inserted)`)) return;

      // build columns + uniqueness
      const seen = new Set();
      const cols = headers.map((h,i) => {
        let col = sanitizeColName(h,i);
        const base = col; let s = 1;
        while (seen.has(col.toLowerCase())) col = `${base}_${s++}`;
        seen.add(col.toLowerCase());
        return `"${col}" TEXT`;
      }).join(', ');
      const ddl = `CREATE TABLE IF NOT EXISTS public."${tableName}" (${cols});`;

      // Execute DDL via RPC (must exist and be secured)
      const { error } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
      if (error) throw error;

      // Save form definition
      const fields = headers.map((h,i) => ({ name: sanitizeColName(h,i), label: String(h||`Column ${i+1}`), position: i }));
      const def = {
        table_name: tableName,
        label: tableName,
        created_by: currentUser.id,
        created_at: new Date().toISOString(),
        fields
      };
      const { error: err2 } = await supabase.from('form_definitions').insert([def]);
      if (err2) throw err2;

      $('tableNameInput').value = ''; $('excelFile').value = '';
      showAlert(`Table & definition created: ${tableName}`, 'success');
      await loadDefinitions();
    } catch (err) {
      console.error('create', err);
      showAlert('Create failed: ' + (err.message || err));
    }
  };
  reader.readAsArrayBuffer(f);
});

/* ---------------- Open a form (render blank fillable form) ---------------- */
async function openForm(tableName) {
  const def = definitions.find(d => d.table_name === tableName);
  if (!def) { showAlert('Definition not found'); return; }
  currentDefinition = def;
  // render blank form
  \$('formTitle').textContent = def.label || def.table_name;
  const form = \$('entryForm'); form.innerHTML = '';
  (def.fields || []).forEach(f => {
    const wrapper = document.createElement('div'); wrapper.className = 'mb-2';
    const label = document.createElement('label'); label.className = 'form-label'; label.textContent = f.label || f.name;
    const input = document.createElement('input'); input.className = 'form-control'; input.name = f.name;
    wrapper.appendChild(label); wrapper.appendChild(input);
    form.appendChild(wrapper);
  });
  \$('formView').classList.remove('hidden');
  \$('homeView').classList.add('hidden');
  \$('dashboardView').classList.add('hidden');
}

/* ---------------- Save record (only manual entry) ---------------- */
\$('saveRecordBtn').addEventListener('click', async () => {
  if (!currentDefinition) return showAlert('No form selected');
  const payload = {};
  \$('entryForm').querySelectorAll('input').forEach(i => { payload[i.name] = i.value === '' ? null : i.value; });
  // If user has districtId and the table has district_id column, set it
  if (currentUser?.districtId && Object.keys(payload).includes('district_id')) payload['district_id'] = currentUser.districtId;
  try {
    const { error } = await supabase.from(currentDefinition.table_name).insert([payload]);
    if (error) throw error;
    showAlert('Record saved', 'success');
    // clear form
    \$('entryForm').querySelectorAll('input').forEach(i => i.value = '');
  } catch (err) {
    console.error('save', err);
    showAlert('Save failed: ' + (err.message || err));
  }
});

/* ---------------- Drop table (admin) ---------------- */
async function dropTable(tableName) {
  if (currentUser.role !== 'admin') return showAlert('Admin only');
  if (!confirm(`Drop table "${tableName}"? This will delete all data.`)) return;
  try {
    const ddl = `DROP TABLE IF EXISTS public."${tableName}" CASCADE;`;
    const { error } = await supabase.rpc('execute_sql_script', { sql_text: ddl });
    if (error) throw error;
    // delete definition row
    const { error: err2 } = await supabase.from('form_definitions').delete().eq('table_name', tableName);
    if (err2) throw err2;
    showAlert('Table dropped', 'success');
    await loadDefinitions();
  } catch (err) {
    console.error('drop', err);
    showAlert('Drop failed: ' + (err.message || err));
  }
}

/* ---------------- Dashboard ---------------- */
function showHome() {
  \$('homeView').classList.remove('hidden');
  \$('dashboardView').classList.add('hidden');
  \$('formView').classList.add('hidden');
}
function showDashboard() {
  \$('homeView').classList.add('hidden');
  \$('dashboardView').classList.remove('hidden');
  \$('formView').classList.add('hidden');
  renderDashboard();
}
function renderDashboard() {
  const el = \$('dashboardContent'); el.innerHTML = '';
  if (!definitions.length) { el.innerHTML = '<div class="text-muted">No definitions</div>'; return; }
  definitions.forEach(d => {
    const card = document.createElement('div'); card.className = 'border rounded p-3 mb-2';
    card.innerHTML = `<div class="d-flex justify-content-between align-items-start">
      <div><strong>${d.table_name}</strong><div class="text-muted small">${(d.fields||[]).length} fields</div></div>
      <div>
        <button class="btn btn-sm btn-primary me-1" data-open="${d.table_name}">Open</button>
        ${currentUser.role === 'admin' ? `<button class="btn btn-sm btn-danger" data-drop="\${d.table_name}">Drop</button>` : ''}
      </div>
    </div>`;
    el.appendChild(card);
  });
  el.querySelectorAll('button[data-open]').forEach(b => b.addEventListener('click', ev => openForm(ev.target.dataset.open)));
  el.querySelectorAll('button[data-drop]').forEach(b => b.addEventListener('click', ev => dropTable(ev.target.dataset.drop)));
}

/* ---------------- Utility: keep UI lists updated when definitions change ---------------- */
async function loadDefinitionsAndRefresh() { await loadDefinitions(); renderDefinitionsList(); renderTablesList(); renderDashboard(); }
function refreshUIAfterChange(){ loadDefinitions(); }

/* ---------------- End of script ---------------- */
</script>
<!-- NOTES: 
  - Required DB objects:
    1) test_users (id, username, password_hash, role, district_id, is_active, full_name, email, last_login)
    2) districts (id, name)
    3) form_definitions (id uuid, table_name text unique, label text, created_by uuid, created_at timestamptz, fields jsonb)
    4) RPC (dev only): public.execute_sql_script(sql_text text) RETURNS text LANGUAGE plpgsql SECURITY DEFINER ...
       Example:
         create or replace function public.execute_sql_script(sql_text text) returns text language plpgsql security definer as $$
         begin
           execute sql_text;
           return 'OK';
         exception when others then
           return sqlerrm;
         end;
         $$;
  - Security:
    -> This single-file app assumes login.html stores a user object in localStorage/sessionStorage with role info.
    -> Do not expose an RPC that runs arbitrary SQL to untrusted clients in production.
    -> Use Supabase Auth server-side flows and server-side DDL with the service-role key for production.
    -> Add Row Level Security (RLS) to created tables so district users can only insert/read rows for their district.
-->
</body>
</html>

Insert
