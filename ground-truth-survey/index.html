<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisional User System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .card-container {
            perspective: 1000px;
            width: 100%;
            max-width: 450px;
        }
        
        .card-3d {
            transition: transform 0.8s;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
        }
        
        .card-3d.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
        }
        
        .card-back {
            transform: rotateY(180deg);
        }
        
        h2 {
            font-weight: 700;
            color: #4a4a4a;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-floating {
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            padding: 12px 0;
            font-weight: 700;
            letter-spacing: 1px;
            width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .btn-link {
            font-weight: 700;
            color: #6a11cb;
        }
        
        .division-select {
            margin-bottom: 20px;
        }
        
        .card-header-tabs {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="card-container">
        <div class="card-3d" id="card">
            <!-- Login Card (Front) -->
            <div class="card-face card-front">
                <h2>Login</h2>
                <form id="loginForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="loginUsername" placeholder="Username" required>
                        <label for="loginUsername">Username</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                        <label for="loginPassword">Password</label>
                    </div>
                    <button type="submit" class="btn btn-primary">LOGIN</button>
                    <div class="text-center mt-4">
                        <a href="#" class="btn-link" id="showRegister">Don't have an account? Register</a>
                    </div>
                </form>
            </div>
            
            <!-- Registration Card (Back) -->
            <div class="card-face card-back">
                <h2>Register</h2>
                <form id="registerForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="fullName" placeholder="Full Name" required>
                        <label for="fullName">Full Name</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="username" placeholder="Username" required>
                        <label for="username">Username (Max 50 chars)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="password" placeholder="Password" required>
                        <label for="password">Password</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="divisionId" required>
                            <option value="" selected disabled>Select Division</option>
                            <!-- Division options will be populated from database -->
                        </select>
                        <label for="divisionId">Division</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="role" required>
                            <option value="" selected disabled>Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="user">User</option>
                        </select>
                        <label for="role">Role</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="tel" class="form-control" id="mobileNumber" placeholder="Mobile Number">
                        <label for="mobileNumber">Mobile Number (Optional)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="email" placeholder="Email">
                        <label for="email">Email (Optional)</label>
                    </div>
                    <button type="submit" class="btn btn-primary">REGISTER</button>
                    <div class="text-center mt-4">
                        <a href="#" class="btn-link" id="showLogin">Already have an account? Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap & Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase client with your actual tokens
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzExNTY1NCwiZXhwIjoyMDY4NjkxNjU0fQ.LK9zJVsvXvJ4RQJkueywh0RrdyMsiKmkxa2aA8ydXFU';
        
        // Initialize with anon key for client-side operations
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // DOM Elements
        const card = document.getElementById('card');
        const showRegisterBtn = document.getElementById('showRegister');
        const showLoginBtn = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        // Card flip functionality
        showRegisterBtn.addEventListener('click', (e) => {
            e.preventDefault();
            card.classList.add('flipped');
        });
        
        showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            card.classList.remove('flipped');
        });
        
        // Fetch divisions for dropdown
        async function loadDivisions() {
            try {
                const { data, error } = await supabase
                    .from('divisions')  // Assuming you have a divisions table
                    .select('id, name');
                
                if (error) throw error;
                
                const divisionSelect = document.getElementById('divisionId');
                data.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division.id;
                    option.textContent = division.name;
                    divisionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading divisions:', error);
                
                // Fallback: Add some sample divisions if the table doesn't exist
                const divisionSelect = document.getElementById('divisionId');
                const sampleDivisions = [
                    { id: 1, name: 'IT Department' },
                    { id: 2, name: 'HR Department' },
                    { id: 3, name: 'Finance Department' },
                    { id: 4, name: 'Operations' },
                    { id: 5, name: 'Marketing' }
                ];
                
                sampleDivisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division.id;
                    option.textContent = division.name;
                    divisionSelect.appendChild(option);
                });
            }
        }
        
        // Helper function to hash passwords (in a real app, use a proper hashing library)
        async function hashPassword(password) {
            // This is a simple hash for demonstration - in production use bcrypt or similar
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // Hash the password for comparison (in a real app, this would be different)
                const hashedPassword = await hashPassword(password);
                
                // Query the divisional_users table
                const { data, error } = await supabase
                    .from('divisional_users')
                    .select('id, username, password_hash, full_name, division_id, division_name, role')
                    .eq('username', username)
                    .eq('is_active', true)
                    .single();
                
                if (error) throw error;
                
                // In a real app, you'd use proper password comparison
                // This is simplified for demonstration
                if (data && data.password_hash === hashedPassword) {
                    // Update last_login timestamp
                    await supabase
                        .from('divisional_users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('id', data.id);
                    
                    // Store user data in session storage
                    sessionStorage.setItem('user', JSON.stringify({
                        id: data.id,
                        username: data.username,
                        fullName: data.full_name,
                        division: data.division_name,
                        role: data.role
                    }));
                    
                    alert('Login successful!');
                    // Redirect to dashboard or home page
                    // window.location.href = 'dashboard.html';
                } else {
                    alert('Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        });
        
        // Registration form submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const divisionId = document.getElementById('divisionId').value;
            const role = document.getElementById('role').value;
            const mobileNumber = document.getElementById('mobileNumber').value;
            const email = document.getElementById('email').value;
            
            try {
                // Get division name based on division ID
                const { data: divisionData, error: divisionError } = await supabase
                    .from('divisions')
                    .select('name')
                    .eq('id', divisionId)
                    .single();
                
                let divisionName = '';
                if (divisionError) {
                    // Fallback if divisions table doesn't exist
                    const divisionSelect = document.getElementById('divisionId');
                    divisionName = divisionSelect.options[divisionSelect.selectedIndex].text;
                } else {
                    divisionName = divisionData.name;
                }
                
                // Hash the password
                const hashedPassword = await hashPassword(password);
                
                // Insert new user
                const { data, error } = await supabase
                    .from('divisional_users')
                    .insert([
                        {
                            username,
                            password_hash: hashedPassword,
                            full_name: fullName,
                            division_id: parseInt(divisionId),
                            division_name: divisionName,
                            role,
                            mobile_number: mobileNumber || null,
                            email: email || null,
                            is_active: true
                        }
                    ]);
                
                if (error) throw error;
                
                alert('Registration successful! Please login.');
                card.classList.remove('flipped');
                registerForm.reset();
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
        });
        
        // Load divisions when page loads
        document.addEventListener('DOMContentLoaded', loadDivisions);
    </script>
</body>
</html>
