<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Truth Survey | FASAL Project</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #800000;
            --secondary-color: #4d0000;
            --light-color: #ffffff;
            --dark-color: #333333;
            --gray-color: #f4f4f4;
            --border-color: #dddddd;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-color);
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-top-left-radius: 10px !important;
            border-top-right-radius: 10px !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
        }
        
        .required::after {
            content: " *";
            color: var(--primary-color);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
        }
        
        .footer {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-top: 50px;
        }
        
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Login Container -->
    <div class="container" id="loginContainer">
        <div class="login-container">
            <div class="card">
                <div class="card-header text-center">
                    <h4 class="mb-0">संचालनालय कृषि, छत्तीसगढ़</h4>
                </div>
                <div class="card-body">
                    <h5 class="text-center mb-4">Ground Truth Survey Portal</h5>
                    
                    <div class="alert alert-danger" id="loginAlert" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Invalid username or password
                    </div>
                    
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label required">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label required">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i> Login
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-3">
                        <small>For technical support: Shailendra Singh Chauhan - 9399207068</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="#">FASAL Project</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#officers" data-bs-toggle="tab">Officers</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#surveys" data-bs-toggle="tab">Surveys</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reports" data-bs-toggle="tab">Reports</a>
                        </li>
                    </ul>
                    <div class="d-flex text-light align-items-center">
                        <div class="me-3">
                            <span id="userDisplayName">User</span>
                            <div class="small text-light opacity-75" id="userDivision">Division</div>
                        </div>
                        <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Alerts -->
            <div class="alert alert-success alert-dismissible fade show" id="successAlert" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div class="alert alert-danger alert-dismissible fade show" id="errorAlert" style="display: none;">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard">
                    <div class="dashboard-header">
                        <h4>Division wise plan & proposal of ground truth survey for kharif 2025 under FASAL Project</h4>
                        <p class="mb-0">संचालनालय कृषि, छत्तीसगढ़</p>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Officers</h6>
                                            <h3 id="totalOfficers">0</h3>
                                        </div>
                                        <i class="fas fa-user-tie fa-2x text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Surveys</h6>
                                            <h3 id="totalSurveys">0</h3>
                                        </div>
                                        <i class="fas fa-map-marked-alt fa-2x text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Completed</h6>
                                            <h3 id="completedSurveys">0</h3>
                                        </div>
                                        <i class="fas fa-check-circle fa-2x text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Budget</h6>
                                            <h3 id="totalBudget">₹0</h3>
                                        </div>
                                        <i class="fas fa-rupee-sign fa-2x text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Recent Survey Data</span>
                            <button class="btn btn-sm btn-outline-light" id="refreshDashboardBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="recentSurveysTable">
                                    <thead>
                                        <tr>
                                            <th>Division</th>
                                            <th>Team</th>
                                            <th>Date</th>
                                            <th>Total</th>
                                            <th>Completed</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated from Supabase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Officers Tab -->
                <div class="tab-pane fade" id="officers">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>अधिकारी व्यक्तिगत जानकारी</span>
                            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#officerModal">
                                <i class="fas fa-plus"></i> Add New
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="officersTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Designation</th>
                                            <th>Division</th>
                                            <th>District</th>
                                            <th>Block</th>
                                            <th>Mobile</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated from Supabase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Surveys Tab -->
                <div class="tab-pane fade" id="surveys">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#groundTruth">Ground Truth</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#cropAssessment">Crop Assessment</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="groundTruth">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Ground Truth Survey Data</span>
                                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#groundTruthModal">
                                        <i class="fas fa-plus"></i> Add New
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="groundTruthTable">
                                            <thead>
                                                <tr>
                                                    <th>Division</th>
                                                    <th>Team</th>
                                                    <th>Date</th>
                                                    <th>Total</th>
                                                    <th>Completed</th>
                                                    <th>Expenditure</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated from Supabase -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="cropAssessment">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Crop Assessment Data</span>
                                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#cropAssessmentModal">
                                        <i class="fas fa-plus"></i> Add New
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="cropAssessmentTable">
                                            <thead>
                                                <tr>
                                                    <th>Division</th>
                                                    <th>District</th>
                                                    <th>Block</th>
                                                    <th>Village</th>
                                                    <th>Crop Type</th>
                                                    <th>Total</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated from Supabase -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports">
                    <div class="card">
                        <div class="card-header">Reports & Analytics</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="reportType" class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="division">Division-wise Report</option>
                                        <option value="district">District-wise Report</option>
                                        <option value="officer">Officer-wise Report</option>
                                        <option value="budget">Budget Report</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="dateFrom" class="form-label">Date From</label>
                                    <input type="date" class="form-control" id="dateFrom">
                                </div>
                                <div class="col-md-3">
                                    <label for="dateTo" class="form-label">Date To</label>
                                    <input type="date" class="form-control" id="dateTo">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generateReportBtn">Generate</button>
                                </div>
                            </div>
                            
                            <div id="reportResult">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Select report parameters and click Generate to view reports.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start">
                        <h6>संचालनालय कृषि, छत्तीसगढ़</h6>
                        <p class="small mb-0">Ground truth survey for kharif 2025 under FASAL Project</p>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <p class="small mb-0">&copy; 2025 All Rights Reserved</p>
                        <p class="small mb-0">Support: Shailendra Singh Chauhan - 9399207068</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Officer Modal -->
    <div class="modal fade" id="officerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="officerModalTitle">Add Officer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="officerForm">
                        <input type="hidden" id="officerId">
                        <div class="mb-3">
                            <label for="officerName" class="form-label required">अधिकारी/कर्मचारी का नाम</label>
                            <input type="text" class="form-control" id="officerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="officerDesignation" class="form-label required">पदनाम</label>
                            <select class="form-select" id="officerDesignation" required>
                                <option value="">पदनाम चुनें</option>
                                <option value="R.A.EO">R.A.EO</option>
                                <option value="A.D.O">A.D.O</option>
                                <option value="S.D.A.O">S.D.A.O</option>
                                <option value="A.D.A">A.D.A</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="officerDivision" class="form-label required">संभाग</label>
                            <select class="form-select" id="officerDivision" required onchange="populateDistricts('officerDivision', 'officerDistrict')">
                                <option value="">संभाग चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="officerDistrict" class="form-label required">जिला</label>
                            <select class="form-select" id="officerDistrict" required onchange="populateBlocks('officerDistrict', 'officerBlock')">
                                <option value="">जिला चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="officerBlock" class="form-label required">विकासखंड</label>
                            <select class="form-select" id="officerBlock" required>
                                <option value="">विकासखंड चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="officerMobile" class="form-label required">मोबाइल नंबर</label>
                            <input type="tel" class="form-control" id="officerMobile" pattern="[0-9]{10}" required>
                        </div>
                        <div class="mb-3">
                            <label for="officerEmail" class="form-label">ईमेल (वैकल्पिक)</label>
                            <input type="email" class="form-control" id="officerEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveOfficerBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ground Truth Modal -->
    <div class="modal fade" id="groundTruthModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="groundTruthModalTitle">Add Ground Truth Survey</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="groundTruthForm">
                        <input type="hidden" id="groundTruthId">
                        <div class="mb-3">
                            <label for="gtDivision" class="form-label required">संभाग का नाम</label>
                            <select class="form-select" id="gtDivision" required>
                                <option value="">संभाग चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gtTeam" class="form-label required">दल क्रमांक</label>
                            <input type="number" class="form-control" id="gtTeam" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtOfficers" class="form-label required">दल में संबंधित अधिकारियों का नाम</label>
                            <input type="text" class="form-control" id="gtOfficers" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtDate" class="form-label required">सर्वे दिनांक</label>
                            <input type="date" class="form-control" id="gtDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtTotalSurveys" class="form-label required">कुल सर्वे</label>
                            <input type="number" class="form-control" id="gtTotalSurveys" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtCompletedSurveys" class="form-label required">सम्पादित संख्या</label>
                            <input type="number" class="form-control" id="gtCompletedSurveys" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtExpenditure" class="form-label required">व्यय राशि (रूपये में)</label>
                            <input type="number" class="form-control" id="gtExpenditure" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtAmountDemanded" class="form-label required">कुल राशि की मांग</label>
                            <input type="number" class="form-control" id="gtAmountDemanded" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="gtRemarks" class="form-label">रिमार्क</label>
                            <textarea class="form-control" id="gtRemarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveGroundTruthBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Assessment Modal -->
    <div class="modal fade" id="cropAssessmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropAssessmentModalTitle">Add Crop Assessment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cropAssessmentForm">
                        <input type="hidden" id="cropAssessmentId">
                        <div class="mb-3">
                            <label for="caDivision" class="form-label required">संभाग का नाम</label>
                            <select class="form-select" id="caDivision" required onchange="populateDistricts('caDivision', 'caDistrict')">
                                <option value="">संभाग चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="caDistrict" class="form-label required">जिला का नाम</label>
                            <select class="form-select" id="caDistrict" required onchange="populateBlocks('caDistrict', 'caBlock')">
                                <option value="">जिला चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="caBlock" class="form-label required">विकासखण्ड का नाम</label>
                            <select class="form-select" id="caBlock" required>
                                <option value="">विकासखंड चुनें</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="caVillage" class="form-label required">ग्राम का नाम</label>
                            <input type="text" class="form-control" id="caVillage" required>
                        </div>
                        <div class="mb-3">
                            <label for="caCropType" class="form-label required">फसल प्रकार</label>
                            <select class="form-select" id="caCropType" required>
                                <option value="">फसल प्रकार चुनें</option>
                                <option value="सिंचित">सिंचित</option>
                                <option value="असिंचित">असिंचित</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="caTotalSurveys" class="form-label required">कुल सर्वे</label>
                            <input type="number" class="form-control" id="caTotalSurveys" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="caCompletedSurveys" class="form-label required">सम्पादित संख्या</label>
                            <input type="number" class="form-control" id="caCompletedSurveys" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="caRemarks" class="form-label">रिमार्क</label>
                            <textarea class="form-control" id="caRemarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCropAssessmentBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);

        // Division and District data
        const divisionData = {
            1: "रायपुर संभाग",
            2: "दुर्ग संभाग",
            3: "बिलासपुर संभाग",
            4: "सरगुजा संभाग",
            5: "बस्तर संभाग",
            6: "प्रदेश"
        };

        const districtData = {
            1: { name: "रायपुर", division_id: 1 },
            2: { name: "गरियाबंद", division_id: 1 },
            3: { name: "बलौदाबाजार", division_id: 1 },
            4: { name: "महासमुंद", division_id: 1 },
            5: { name: "धमतरी", division_id: 1 },
            6: { name: "दुर्ग", division_id: 2 },
            7: { name: "बालोद", division_id: 2 },
            8: { name: "बेमेतरा", division_id: 2 },
            9: { name: "कबीरधाम", division_id: 2 },
            10: { name: "राजनांदगांव", division_id: 2 },
            11: { name: "खैरागढ़", division_id: 2 },
            12: { name: "मोहला", division_id: 2 },
            13: { name: "बिलासपुर", division_id: 3 },
            14: { name: "गौरेला-पेण्ड्रा-मरवाही", division_id: 3 },
            15: { name: "मुंगेली", division_id: 3 },
            16: { name: "जांजगीर", division_id: 3 },
            17: { name: "सक्ती", division_id: 3 },
            18: { name: "कोरबा", division_id: 3 },
            19: { name: "रायगढ़", division_id: 3 },
            20: { name: "सारंगढ़-बिलाईगढ़", division_id: 3 },
            21: { name: "सरगुजा", division_id: 4 },
            22: { name: "सूरजपुर", division_id: 4 },
            23: { name: "बलरामपुर", division_id: 4 },
            24: { name: "कोरिया", division_id: 4 },
            25: { name: "मनेन्द्रगढ़-चिरमिरी", division_id: 4 },
            26: { name: "जशपुर", division_id: 4 },
            27: { name: "जगदलपुर", division_id: 5 },
            28: { name: "कोण्डागांव", division_id: 5 },
            29: { name: "कांकेर", division_id: 5 },
            30: { name: "दंतेवाड़ा", division_id: 5 },
            31: { name: "सुकमा", division_id: 5 },
            32: { name: "बीजापुर", division_id: 5 },
            33: { name: "नारायणपुर", division_id: 5 }
        };

        // Block data
        const blockData = {
            1: ["अभनपुर", "आरंग", "धरसींवा", "तिल्दा"],
            2: ["गरियाबंद", "छुरा", "देवभोग", "मैनपुर", "फिंगेश्वर"],
            3: ["बलौदाबाजार", "भाटापारा", "कसडोल", "पलारी", "सिमगा"],
            4: ["महासमुंद", "बागबाहरा", "पिथौरा", "बसना", "सरायपाली"],
            5: ["धमतरी", "नगरी", "कुरुद", "मगरलोड"],
            6: ["दुर्ग", "धमधा", "पाटन"],
            7: ["बालोद", "गुंडरदेही", "डौंडी", "डौंडीलोहारा", "गुरुर"],
            8: ["बेमेतरा", "बेरला", "साजा", "नवागढ़"],
            9: ["कबीरधाम", "बोडला", "कवर्धा", "पण्डरिया", "एस.लोहारा"],
            10: ["राजनांदगांव", "छुरिया", "डोंगरगढ़", "डोंगरगाँव"],
            11: ["खैरागढ़", "छुईखदान"],
            12: ["मोहला", "अम्बागढ़ चौकी", "मानपुर"],
            13: ["बिलासपुर", "कोटा", "बेलहा", "मस्तूरी", "तखतपुर"],
            14: ["मरवाही", "गौरेला-1", "गौरेला-2"],
            15: ["मुंगेली", "लोरमी", "पथरिया"],
            16: ["जांजगीर", "अकलतरा", "बलौदा", "बमहनीडीह", "नवागढ़", "पामगढ़"],
            17: ["सक्ती", "मलखरौदा", "डभरा", "जयजयपुर"],
            18: ["कोरबा", "करतला", "कटघोरा", "पाली", "पोड़ी उपरोड़ा"],
            19: ["रायगढ़", "धरमजयगढ़", "घरघोड़ा", "खरसिया", "लैलूंगा", "पुसौर", "तमनार"],
            20: ["बारमकेला", "सारंगढ़", "बिलाईगढ़"],
            21: ["अंबिकापुर", "बतौली", "लखनपुर", "लुंड्रा", "मैनपाट", "सीतापुर", "उदयपुर"],
            22: ["सूरजपुर", "भैयाथान", "ओडगी", "प्रतापपुर", "प्रेमनगर", "रामानुजगंज"],
            23: ["बलरामपुर", "वाड्रफनगर", "कुसमी", "राजपुर", "रामचंद्रपुर", "शंकरगढ़"],
            24: ["बैकुंठपुर", "खड़गवाना", "सोनहत"],
            25: ["भरतपुर", "खड़गवाना", "मनेंद्रगढ़"],
            26: ["बगीचा", "दुलदुला", "फरसाबहार", "जशपुर", "कुनकुरी", "मनोरा", "पत्थलगांव"],
            27: ["बकावंड", "बस्तनार", "बस्तर", "दरभा", "जगदलपुर", "लोहंडीगुड़ा", "तोकापाल"],
            28: ["बड़ेराजपुर", "केशकाल", "कोंडागांव", "माकड़ी", "फरसगांव"],
            29: ["अंतागढ़", "भानुप्रतापपुर", "चारामा", "दुर्गूकोंडल", "कांकेर", "नरहरपुर", "कोयलीबेड़ा"],
            30: ["कुवाकोंडा", "दंतेवाड़ा", "गीदम", "कटेकल्याण"],
            31: ["छिंदगढ़", "सुकमा", "कोंटा"],
            32: ["भैरमगढ़", "भोपालपट्नम", "बीजापुर", "उसूर"],
            33: ["नारायणपुर", "ओरछा"]
        };

        // User data for authentication
        const users = {
            "raipur_admin": { password: "raipur123", name: "रायपुर संभाग प्रशासक", division: "रायपुर संभाग", division_id: 1 },
            "durg_admin": { password: "durg123", name: "दुर्ग संभाग प्रशासक", division: "दुर्ग संभाग", division_id: 2 },
            "bilaspur_admin": { password: "bilaspur123", name: "बिलासपुर संभाग प्रशासक", division: "बिलासपुर संभाग", division_id: 3 },
            "surguja_admin": { password: "surguja123", name: "सरगुजा संभाग प्रशासक", division: "सरगुजा संभाग", division_id: 4 },
            "bastar_admin": { password: "bastar123", name: "बस्तर संभाग प्रशासक", division: "बस्तर संभाग", division_id: 5 },
            "admin": { password: "admin123", name: "Admin User", division: "All Divisions", division_id: 0 }
        };

        // Current user
        let currentUser = null;

        // Document Ready
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('refreshDashboardBtn').addEventListener('click', loadDashboardData);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            document.getElementById('saveOfficerBtn').addEventListener('click', saveOfficer);
            document.getElementById('saveGroundTruthBtn').addEventListener('click', saveGroundTruth);
            document.getElementById('saveCropAssessmentBtn').addEventListener('click', saveCropAssessment);
            
            // Populate division dropdowns
            populateDivisionDropdowns();
        });

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (users[username] && users[username].password === password) {
                // Login successful
                currentUser = {
                    username: username,
                    ...users[username]
                };
                
                document.getElementById('userDisplayName').textContent = currentUser.name;
                document.getElementById('userDivision').textContent = currentUser.division;
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // Load data
                loadDashboardData();
                loadOfficersData();
                loadGroundTruthData();
                loadCropAssessmentData();
            } else {
                // Login failed
                document.getElementById('loginAlert').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginAlert').style.display = 'none';
                }, 3000);
            }
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('loginForm').reset();
        }

        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successAlert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successAlert').style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('errorAlert').style.display = 'none';
            }, 3000);
        }

        // Populate all division dropdowns
        function populateDivisionDropdowns() {
            const divisionDropdowns = ['officerDivision', 'gtDivision', 'caDivision'];
            
            divisionDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">संभाग चुनें</option>';
                    
                    // If user is division admin, only show their division
                    if (currentUser && currentUser.division_id !== 0) {
                        const option = document.createElement('option');
                        option.value = currentUser.division_id;
                        option.textContent = currentUser.division;
                        dropdown.appendChild(option);
                    } else {
                        // Admin can see all divisions
                        Object.entries(divisionData).forEach(([id, name]) => {
                            if (id != 6) { // Skip Pradesh
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = name;
                                dropdown.appendChild(option);
                            }
                        });
                    }
                }
            });
        }

        // Populate districts based on division
        function populateDistricts(divisionSelectId, districtSelectId) {
            const divisionId = document.getElementById(divisionSelectId).value;
            const districtSelect = document.getElementById(districtSelectId);
            
            districtSelect.innerHTML = '<option value="">जिला चुनें</option>';
            
            if (!divisionId) return;
            
            Object.entries(districtData)
                .filter(([_, district]) => district.division_id == divisionId)
                .sort((a, b) => a[1].name.localeCompare(b[1].name))
                .forEach(([id, district]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });
        }

        // Populate blocks based on district
        function populateBlocks(districtSelectId, blockSelectId) {
            const districtId = document.getElementById(districtSelectId).value;
            const blockSelect = document.getElementById(blockSelectId);
            
            blockSelect.innerHTML = '<option value="">विकासखंड चुनें</option>';
            
            if (!districtId || !blockData[districtId]) return;
            
            blockData[districtId].forEach(block => {
                const option = document.createElement('option');
                option.value = block;
                option.textContent = block;
                blockSelect.appendChild(option);
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading();
            
            try {
                // Get officers count
                const { count: officersCount, error: officersError } = await supabase
                    .from('officers_training')
                    .select('*', { count: 'exact', head: true })
                    .eq(currentUser.division_id !== 0 ? 'division_id' : 'id', currentUser.division_id !== 0 ? currentUser.division_id : 'id');
                
                if (officersError) throw officersError;
                
                // Get ground truth surveys
                const { data: surveyData, error: surveyError } = await supabase
                    .from('ground_truth_survey')
                    .select('*')
                    .eq(currentUser.division_id !== 0 ? 'division_id' : 'id', currentUser.division_id !== 0 ? currentUser.division_id : 'id');
                
                if (surveyError) throw surveyError;
                
                // Calculate totals
                const totalSurveys = surveyData ? surveyData.length : 0;
                let completedSurveys = 0;
                let totalBudget = 0;
                
                if (surveyData && surveyData.length > 0) {
                    surveyData.forEach(survey => {
                        if (survey.total_surveys && survey.completed_surveys && 
                            survey.completed_surveys >= survey.total_surveys) {
                            completedSurveys++;
                        }
                        
                        if (survey.total_amount_demanded) {
                            totalBudget += parseFloat(survey.total_amount_demanded);
                        }
                    });
                }
                
                // Update dashboard cards
                document.getElementById('totalOfficers').textContent = officersCount || 0;
                document.getElementById('totalSurveys').textContent = totalSurveys;
                document.getElementById('completedSurveys').textContent = completedSurveys;
                document.getElementById('totalBudget').textContent = '₹' + (totalBudget ? totalBudget.toLocaleString('en-IN') : '0');
                
                // Update recent surveys table
                if (surveyData && surveyData.length > 0) {
                    const tableBody = document.getElementById('recentSurveysTable').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';
                    
                    // Sort by date (newest first) and take first 5
                    const recentSurveys = [...surveyData]
                        .sort((a, b) => new Date(b.survey_date) - new Date(a.survey_date))
                        .slice(0, 5);
                    
                    recentSurveys.forEach(survey => {
                        const row = tableBody.insertRow();
                        
                        // Division
                        let cell = row.insertCell();
                        cell.textContent = survey.division_name;
                        
                        // Team
                        cell = row.insertCell();
                        cell.textContent = survey.team_number;
                        
                        // Date
                        cell = row.insertCell();
                        const surveyDate = new Date(survey.survey_date);
                        cell.textContent = surveyDate.toLocaleDateString('hi-IN');
                        
                        // Total
                        cell = row.insertCell();
                        cell.textContent = survey.total_surveys;
                        
                        // Completed
                        cell = row.insertCell();
                        cell.textContent = survey.completed_surveys;
                        
                        // Status
                        cell = row.insertCell();
                        let badge;
                        
                        if (survey.completed_surveys >= survey.total_surveys) {
                            badge = '<span class="badge bg-success">पूर्ण</span>';
                        } else if (survey.completed_surveys > 0) {
                            badge = '<span class="badge bg-warning">प्रगति में</span>';
                        } else {
                            badge = '<span class="badge bg-secondary">शुरू नहीं</span>';
                        }
                        
                        cell.innerHTML = badge;
                    });
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                hideLoading();
                showError('डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Load officers data
        async function loadOfficersData() {
            showLoading();
            
            try {
                // Get officers data
                const { data: officersData, error: officersError } = await supabase
                    .from('officers_training')
                    .select('*')
                    .eq(currentUser.division_id !== 0 ? 'division_id' : 'id', currentUser.division_id !== 0 ? currentUser.division_id : 'id')
                    .order('name');
                
                if (officersError) throw officersError;
                
                // Update officers table
                const tableBody = document.getElementById('officersTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                
                if (officersData && officersData.length > 0) {
                    officersData.forEach(officer => {
                        const row = tableBody.insertRow();
                        
                        // Name
                        let cell = row.insertCell();
                        cell.textContent = officer.name;
                        
                        // Designation
                        cell = row.insertCell();
                        cell.textContent = officer.designation;
                        
                        // Division
                        cell = row.insertCell();
                        cell.textContent = officer.division_name;
                        
                        // District
                        cell = row.insertCell();
                        cell.textContent = officer.district_name;
                        
                        // Block
                        cell = row.insertCell();
                        cell.textContent = officer.block_name;
                        
                        // Mobile
                        cell = row.insertCell();
                        cell.textContent = officer.mobile_number;
                        
                        // Actions
                        cell = row.insertCell();
                        cell.innerHTML = `
                            <button class="btn btn-sm btn-primary me-1" onclick="editOfficer('\${officer.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteOfficer('\${officer.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    });
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading officers data:', error);
                hideLoading();
                showError('अधिकारी डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Load ground truth survey data
        async function loadGroundTruthData() {
            showLoading();
            
            try {
                // Get ground truth data
                const { data: surveyData, error: surveyError } = await supabase
                    .from('ground_truth_survey')
                    .select('*')
                    .eq(currentUser.division_id !== 0 ? 'division_id' : 'id', currentUser.division_id !== 0 ? currentUser.division_id : 'id')
                    .order('survey_date', { ascending: false });
                
                if (surveyError) throw surveyError;
                
                // Update ground truth table
                const tableBody = document.getElementById('groundTruthTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                
                if (surveyData && surveyData.length > 0) {
                    surveyData.forEach(survey => {
                        const row = tableBody.insertRow();
                        
                        // Division
                        let cell = row.insertCell();
                        cell.textContent = survey.division_name;
                        
                        // Team
                        cell = row.insertCell();
                        cell.textContent = survey.team_number;
                        
                        // Date
                        cell = row.insertCell();
                        const surveyDate = new Date(survey.survey_date);
                        cell.textContent = surveyDate.toLocaleDateString('hi-IN');
                        
                        // Total
                        cell = row.insertCell();
                        cell.textContent = survey.total_surveys;
                        
                        // Completed
                        cell = row.insertCell();
                        cell.textContent = survey.completed_surveys;
                        
                        // Expenditure
                        cell = row.insertCell();
                        cell.textContent = '₹' + parseFloat(survey.expenditure_amount).toLocaleString('en-IN');
                        
                        // Actions
                        cell = row.insertCell();
                        cell.innerHTML = `
                            <button class="btn btn-sm btn-primary me-1" onclick="editGroundTruth('\${survey.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGroundTruth('\${survey.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    });
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading ground truth data:', error);
                hideLoading();
                showError('सर्वे डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Load crop assessment data
        async function loadCropAssessmentData() {
            showLoading();
            
            try {
                // Get crop assessment data
                const { data: assessmentData, error: assessmentError } = await supabase
                    .from('crop_assessment')
                    .select('*')
                    .eq(currentUser.division_id !== 0 ? 'division_id' : 'id', currentUser.division_id !== 0 ? currentUser.division_id : 'id')
                    .order('created_at', { ascending: false });
                
                if (assessmentError) throw assessmentError;
                
                // Update crop assessment table
                const tableBody = document.getElementById('cropAssessmentTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                
                if (assessmentData && assessmentData.length > 0) {
                    assessmentData.forEach(assessment => {
                        const row = tableBody.insertRow();
                        
                        // Division
                        let cell = row.insertCell();
                        cell.textContent = assessment.division_name;
                        
                        // District
                        cell = row.insertCell();
                        cell.textContent = assessment.district_name;
                        
                        // Block
                        cell = row.insertCell();
                        cell.textContent = assessment.block_name;
                        
                        // Village
                        cell = row.insertCell();
                        cell.textContent = assessment.village_name;
                        
                        // Crop Type
                        cell = row.insertCell();
                        cell.textContent = assessment.crop_irrigation_status;
                        
                        // Total
                        cell = row.insertCell();
                        cell.textContent = assessment.total_crop_surveys;
                        
                        // Actions
                        cell = row.insertCell();
                        cell.innerHTML = `
                            <button class="btn btn-sm btn-primary me-1" onclick="editCropAssessment('\${assessment.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCropAssessment('\${assessment.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    });
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading crop assessment data:', error);
                hideLoading();
                showError('फसल आकलन डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Save officer data
        async function saveOfficer() {
            const form = document.getElementById('officerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading();
            
            const officerId = document.getElementById('officerId').value;
            const formData = {
                name: document.getElementById('officerName').value,
                designation: document.getElementById('officerDesignation').value,
                division_id: document.getElementById('officerDivision').value,
                division_name: document.getElementById('officerDivision').options[document.getElementById('officerDivision').selectedIndex].text,
                district_id: document.getElementById('officerDistrict').value,
                district_name: document.getElementById('officerDistrict').options[document.getElementById('officerDistrict').selectedIndex].text,
                block_name: document.getElementById('officerBlock').value,
                mobile_number: document.getElementById('officerMobile').value,
                email: document.getElementById('officerEmail').value || null
            };
            
            try {
                let result;
                
                if (officerId) {
                    // Update existing officer
                    result = await supabase
                        .from('officers_training')
                        .update(formData)
                        .eq('id', officerId);
                } else {
                    // Insert new officer
                    result = await supabase
                        .from('officers_training')
                        .insert([formData]);
                }
                
                if (result.error) throw result.error;
                
                // Close modal
                const officerModal = bootstrap.Modal.getInstance(document.getElementById('officerModal'));
                officerModal.hide();
                
                // Reset form
                document.getElementById('officerForm').reset();
                document.getElementById('officerId').value = '';
                
                // Show success message
                showSuccess('अधिकारी की जानकारी सफलतापूर्वक सहेजी गई!');
                
                // Reload officers data
                loadOfficersData();
                
                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error saving officer data:', error);
                hideLoading();
                showError('अधिकारी की जानकारी सहेजने में त्रुटि हुई।');
            }
        }

        // Save ground truth survey data
        async function saveGroundTruth() {
            const form = document.getElementById('groundTruthForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading();
            
            const groundTruthId = document.getElementById('groundTruthId').value;
            const formData = {
                division_id: document.getElementById('gtDivision').value,
                division_name: document.getElementById('gtDivision').options[document.getElementById('gtDivision').selectedIndex].text,
                team_number: document.getElementById('gtTeam').value,
                officer_names: document.getElementById('gtOfficers').value,
                survey_date: document.getElementById('gtDate').value,
                total_surveys: document.getElementById('gtTotalSurveys').value,
                completed_surveys: document.getElementById('gtCompletedSurveys').value,
                expenditure_amount: document.getElementById('gtExpenditure').value,
                total_amount_demanded: document.getElementById('gtAmountDemanded').value,
                remarks: document.getElementById('gtRemarks').value || null
            };
            
            try {
                let result;
                
                if (groundTruthId) {
                    // Update existing survey
                    result = await supabase
                        .from('ground_truth_survey')
                        .update(formData)
                        .eq('id', groundTruthId);
                } else {
                    // Insert new survey
                    result = await supabase
                        .from('ground_truth_survey')
                        .insert([formData]);
                }
                
                if (result.error) throw result.error;
                
                // Close modal
                const groundTruthModal = bootstrap.Modal.getInstance(document.getElementById('groundTruthModal'));
                groundTruthModal.hide();
                
                // Reset form
                document.getElementById('groundTruthForm').reset();
                document.getElementById('groundTruthId').value = '';
                
                // Show success message
                showSuccess('Ground Truth Survey डेटा सफलतापूर्वक सहेजा गया!');
                
                // Reload ground truth data
                loadGroundTruthData();
                
                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error saving ground truth data:', error);
                hideLoading();
                showError('Ground Truth Survey डेटा सहेजने में त्रुटि हुई।');
            }
        }

        // Save crop assessment data
        async function saveCropAssessment() {
            const form = document.getElementById('cropAssessmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            showLoading();
            
            const cropAssessmentId = document.getElementById('cropAssessmentId').value;
            const formData = {
                division_id: document.getElementById('caDivision').value,
                division_name: document.getElementById('caDivision').options[document.getElementById('caDivision').selectedIndex].text,
                district_id: document.getElementById('caDistrict').value,
                district_name: document.getElementById('caDistrict').options[document.getElementById('caDistrict').selectedIndex].text,
                block_name: document.getElementById('caBlock').value,
                village_name: document.getElementById('caVillage').value,
                crop_irrigation_status: document.getElementById('caCropType').value,
                total_crop_surveys: document.getElementById('caTotalSurveys').value,
                completed_surveys: document.getElementById('caCompletedSurveys').value,
                remarks: document.getElementById('caRemarks').value || null,
                assessment_date: new Date().toISOString().split('T')[0]
            };
            
            try {
                let result;
                
                if (cropAssessmentId) {
                    // Update existing assessment
                    result = await supabase
                        .from('crop_assessment')
                        .update(formData)
                        .eq('id', cropAssessmentId);
                } else {
                    // Insert new assessment
                    result = await supabase
                        .from('crop_assessment')
                        .insert([formData]);
                }
                
                if (result.error) throw result.error;
                
                // Close modal
                const cropAssessmentModal = bootstrap.Modal.getInstance(document.getElementById('cropAssessmentModal'));
                cropAssessmentModal.hide();
                
                // Reset form
                document.getElementById('cropAssessmentForm').reset();
                document.getElementById('cropAssessmentId').value = '';
                
                // Show success message
                showSuccess('Crop Assessment डेटा सफलतापूर्वक सहेजा गया!');
                
                // Reload crop assessment data
                loadCropAssessmentData();
                
                // Refresh dashboard
                loadDashboardData();
            } catch (error) {
                console.error('Error saving crop assessment data:', error);
                hideLoading();
                showError('Crop Assessment डेटा सहेजने में त्रुटि हुई।');
            }
        }

        // Edit officer
        async function editOfficer(id) {
            showLoading();
            
            try {
                // Get officer data
                const { data, error } = await supabase
                    .from('officers_training')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // Set form values
                    document.getElementById('officerId').value = data.id;
                    document.getElementById('officerName').value = data.name;
                    document.getElementById('officerDesignation').value = data.designation;
                    document.getElementById('officerDivision').value = data.division_id;
                    
                    // Populate districts based on division
                    populateDistricts('officerDivision', 'officerDistrict');
                    
                    setTimeout(() => {
                        document.getElementById('officerDistrict').value = data.district_id;
                        
                        // Populate blocks based on district
                        populateBlocks('officerDistrict', 'officerBlock');
                        
                        setTimeout(() => {
                            document.getElementById('officerBlock').value = data.block_name;
                            document.getElementById('officerMobile').value = data.mobile_number;
                            document.getElementById('officerEmail').value = data.email || '';
                            
                            // Update modal title
                            document.getElementById('officerModalTitle').textContent = 'Edit Officer';
                            
                            // Show modal
                            const officerModal = new bootstrap.Modal(document.getElementById('officerModal'));
                            officerModal.show();
                            
                            hideLoading();
                        }, 100);
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading officer data for edit:', error);
                hideLoading();
                showError('अधिकारी की जानकारी लोड करने में त्रुटि हुई।');
            }
        }

        // Delete officer
        async function deleteOfficer(id) {
            if (!confirm('क्या आप वाकई इस अधिकारी को हटाना चाहते हैं?')) {
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('officers_training')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showSuccess('अधिकारी की जानकारी सफलतापूर्वक हटा दी गई!');
                loadOfficersData();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting officer:', error);
                hideLoading();
                showError('अधिकारी की जानकारी हटाने में त्रुटि हुई।');
            }
        }

        // Edit ground truth survey
        async function editGroundTruth(id) {
            showLoading();
            
            try {
                // Get ground truth data
                const { data, error } = await supabase
                    .from('ground_truth_survey')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // Set form values
                    document.getElementById('groundTruthId').value = data.id;
                    document.getElementById('gtDivision').value = data.division_id;
                    document.getElementById('gtTeam').value = data.team_number;
                    document.getElementById('gtOfficers').value = data.officer_names;
                    document.getElementById('gtDate').value = data.survey_date;
                    document.getElementById('gtTotalSurveys').value = data.total_surveys;
                    document.getElementById('gtCompletedSurveys').value = data.completed_surveys;
                    document.getElementById('gtExpenditure').value = data.expenditure_amount;
                    document.getElementById('gtAmountDemanded').value = data.total_amount_demanded;
                    document.getElementById('gtRemarks').value = data.remarks || '';
                    
                    // Update modal title
                    document.getElementById('groundTruthModalTitle').textContent = 'Edit Ground Truth Survey';
                    
                    // Show modal
                    const groundTruthModal = new bootstrap.Modal(document.getElementById('groundTruthModal'));
                    groundTruthModal.show();
                    
                    hideLoading();
                }
            } catch (error) {
                console.error('Error loading ground truth data for edit:', error);
                hideLoading();
                showError('Ground Truth Survey डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Delete ground truth survey
        async function deleteGroundTruth(id) {
            if (!confirm('क्या आप वाकई इस Ground Truth Survey को हटाना चाहते हैं?')) {
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('ground_truth_survey')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showSuccess('Ground Truth Survey सफलतापूर्वक हटा दिया गया!');
                loadGroundTruthData();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting ground truth survey:', error);
                hideLoading();
                showError('Ground Truth Survey हटाने में त्रुटि हुई।');
            }
        }

        // Edit crop assessment
        async function editCropAssessment(id) {
            showLoading();
            
            try {
                // Get crop assessment data
                const { data, error } = await supabase
                    .from('crop_assessment')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // Set form values
                    document.getElementById('cropAssessmentId').value = data.id;
                    document.getElementById('caDivision').value = data.division_id;
                    
                    // Populate districts based on division
                    populateDistricts('caDivision', 'caDistrict');
                    
                    setTimeout(() => {
                        document.getElementById('caDistrict').value = data.district_id;
                        
                        // Populate blocks based on district
                        populateBlocks('caDistrict', 'caBlock');
                        
                        setTimeout(() => {
                            document.getElementById('caBlock').value = data.block_name;
                            document.getElementById('caVillage').value = data.village_name;
                            document.getElementById('caCropType').value = data.crop_irrigation_status;
                            document.getElementById('caTotalSurveys').value = data.total_crop_surveys;
                            document.getElementById('caCompletedSurveys').value = data.completed_surveys;
                            document.getElementById('caRemarks').value = data.remarks || '';
                            
                            // Update modal title
                            document.getElementById('cropAssessmentModalTitle').textContent = 'Edit Crop Assessment';
                            
                            // Show modal
                            const cropAssessmentModal = new bootstrap.Modal(document.getElementById('cropAssessmentModal'));
                            cropAssessmentModal.show();
                            
                            hideLoading();
                        }, 100);
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading crop assessment data for edit:', error);
                hideLoading();
                showError('Crop Assessment डेटा लोड करने में त्रुटि हुई।');
            }
        }

        // Delete crop assessment
        async function deleteCropAssessment(id) {
            if (!confirm('क्या आप वाकई इस Crop Assessment को हटाना चाहते हैं?')) {
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('crop_assessment')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showSuccess('Crop Assessment सफलतापूर्वक हटा दिया गया!');
                loadCropAssessmentData();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting crop assessment:', error);
                hideLoading();
                showError('Crop Assessment हटाने में त्रुटि हुई।');
            }
        }

        // Generate report
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (!dateFrom || !dateTo) {
                showError('कृपया रिपोर्ट के लिए तारीख का चयन करें।');
                return;
            }
            
            showLoading();
            
            try {
                let data;
                let columns;
                let title;
                
                // Get report data based on type
                if (reportType === 'division') {
                    title = 'Division-wise Report';
                    
                    // Get ground truth data grouped by division
                    const { data: reportData, error } = await supabase.rpc('get_division_report', {
                        start_date: dateFrom,
                        end_date: dateTo,
                        user_division_id: currentUser.division_id
                    });
                    
                    if (error) throw error;
                    
                    data = reportData || [];
                    columns = ['Division', 'Total Surveys', 'Completed', 'Completion %', 'Budget Demanded'];
                } else if (reportType === 'district') {
                    title = 'District-wise Report';
                    
                    // Get ground truth data grouped by district
                    const { data: reportData, error } = await supabase.rpc('get_district_report', {
                        start_date: dateFrom,
                        end_date: dateTo,
                        user_division_id: currentUser.division_id
                    });
                    
                    if (error) throw error;
                    
                    data = reportData || [];
                    columns = ['District', 'Division', 'Total Surveys', 'Completed', 'Completion %'];
                } else if (reportType === 'officer') {
                    title = 'Officer-wise Report';
                    
                    // Get ground truth data grouped by officer
                    const { data: reportData, error } = await supabase.rpc('get_officer_report', {
                        start_date: dateFrom,
                        end_date: dateTo,
                        user_division_id: currentUser.division_id
                    });
                    
                    if (error) throw error;
                    
                    data = reportData || [];
                    columns = ['Officer Name', 'Designation', 'Division', 'Total Surveys', 'Completed', 'Completion %'];
                } else if (reportType === 'budget') {
                    title = 'Budget Report';
                    
                    // Get budget data
                    const { data: reportData, error } = await supabase.rpc('get_budget_report', {
                        start_date: dateFrom,
                        end_date: dateTo,
                        user_division_id: currentUser.division_id
                    });
                    
                    if (error) throw error;
                    
                    data = reportData || [];
                    columns = ['Division', 'Expenditure Amount', 'Budget Demanded', 'Balance'];
                }
                
                // Generate HTML for report
                let reportHtml = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${title} (${dateFrom} to ${dateTo})</span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf me-1"></i> PDF
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel me-1"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                `;
                
                if (data && data.length > 0) {
                    reportHtml += `
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>क्र.सं.</th>
                    `;
                    
                    // Add column headers
                    columns.forEach(column => {
                        reportHtml += `<th>${column}</th>`;
                    });
                    
                    reportHtml += `
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Add data rows
                    data.forEach((row, index) => {
                        reportHtml += `<tr><td>${index + 1}</td>`;
                        
                        // Add cells based on report type
                        if (reportType === 'division') {
                            reportHtml += `
                                <td>${row.division_name}</td>
                                <td>${row.total_surveys}</td>
                                <td>${row.completed_surveys}</td>
                                <td>${row.completion_percentage}%</td>
                                <td>₹${parseFloat(row.total_budget).toLocaleString('en-IN')}</td>
                            `;
                        } else if (reportType === 'district') {
                            reportHtml += `
                                <td>${row.district_name}</td>
                                <td>${row.division_name}</td>
                                <td>${row.total_surveys}</td>
                                <td>${row.completed_surveys}</td>
                                <td>${row.completion_percentage}%</td>
                            `;
                        } else if (reportType === 'officer') {
                            reportHtml += `
                                <td>${row.officer_name}</td>
                                <td>${row.designation}</td>
                                <td>${row.division_name}</td>
                                <td>${row.total_surveys}</td>
                                <td>${row.completed_surveys}</td>
                                <td>${row.completion_percentage}%</td>
                            `;
                        } else if (reportType === 'budget') {
                            reportHtml += `
                                <td>${row.division_name}</td>
                                <td>₹${parseFloat(row.expenditure_amount).toLocaleString('en-IN')}</td>
                                <td>₹${parseFloat(row.total_budget).toLocaleString('en-IN')}</td>
                                <td>₹${parseFloat(row.balance).toLocaleString('en-IN')}</td>
                            `;
                        }
                        
                        reportHtml += `</tr>`;
                    });
                    
                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    reportHtml += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No data found for the selected criteria.
                        </div>
                    `;
                }
                
                reportHtml += `
                        </div>
                    </div>
                `;
                
                document.getElementById('reportResult').innerHTML = reportHtml;
                
                hideLoading();
            } catch (error) {
                console.error('Error generating report:', error);
                hideLoading();
                showError('रिपोर्ट जनरेट करने में त्रुटि हुई।');
            }
        }

        // Export to PDF function
        function exportToPDF() {
            showLoading();
            
            try {
                // In a real implementation, you would use a library like jsPDF
                // For now, just show a message
                hideLoading();
                showSuccess('PDF export functionality will be implemented using jsPDF library');
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                hideLoading();
                showError('PDF एक्सपोर्ट करने में त्रुटि हुई।');
            }
        }

        // Export to Excel function
        function exportToExcel() {
            showLoading();
            
            try {
                // In a real implementation, you would use a library like SheetJS
                // For now, just show a message
                hideLoading();
                showSuccess('Excel export functionality will be implemented using SheetJS library');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                hideLoading();
                showError('Excel एक्सपोर्ट करने में त्रुटि हुई।');
            }
        }
    </script>
</body>
</html>


