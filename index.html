<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Data Updation System - DirAgCg</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-color: #800000;
            /* Maroon red */
            --secondary-color: #333333;
            /* Dark gray/black */
            --light-color: #f8f8f8;
            --card-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f5;
            color: var(--secondary-color);
            padding-top: 20px;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1000px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: none;
        }

        .card-body {
            padding: 25px;
        }

        .form-label {
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
        }

        .btn {
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 8px;
            transition: all 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(128, 0, 0, 0.3);
            transform: translateY(0);
        }

        .btn-primary:hover {
            background-color: #600000;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(128, 0, 0, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(128, 0, 0, 0.3);
        }

        .btn-secondary {
            background-color: #444;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary:hover {
            background-color: #333;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section-title {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            color: var(--primary-color);
        }

        .alert {
            border-radius: 8px;
            font-weight: 500;
        }

        .required-field::after {
            content: " *";
            color: var(--primary-color);
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: #777;
            font-size: 0.9rem;
        }

        .field-row {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }

        .field-row:last-child {
            border-bottom: none;
        }

        .field-label {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .field-value {
            color: #555;
        }

        .verification-buttons {
            display: flex;
            gap: 10px;
        }

        .edit-field {
            display: none;
            margin-top: 10px;
        }

        .badge {
            font-weight: 500;
            padding: 6px 10px;
        }

        .badge-verified {
            background-color: #28a745;
        }

        .badge-edited {
            background-color: #fd7e14;
        }

        .badge-pending {
            background-color: #6c757d;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
        }

        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background-color: #28a745;
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            color: #777;
        }

        .step.active .step-title {
            color: var(--primary-color);
            font-weight: 600;
        }

        .step.completed .step-title {
            color: #28a745;
        }

        .step-line {
            position: absolute;
            top: 15px;
            height: 2px;
            background-color: #ddd;
            width: 100%;
            left: -50%;
            z-index: -1;
        }

        .step:first-child .step-line {
            display: none;
        }

        .step.completed .step-line {
            background-color: #28a745;
        }

        .logo {
            max-width: 100px;
            margin-bottom: 15px;
        }

        .year-picker {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }

        .admin-panel {
            margin-top: 20px;
        }

        .admin-tabs {
            margin-bottom: 20px;
        }

        .admin-tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .nav-tabs .nav-link {
            font-weight: 500;
            color: var(--secondary-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .table-responsive {
            margin-top: 20px;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: var(--secondary-color);
        }

        .disclaimer {
            font-size: 0.9rem;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .otp-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .otp-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
        }

        .login-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .login-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .login-option.active {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .login-option i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .step-title {
                font-size: 0.7rem;
            }

            .otp-inputs {
                gap: 5px;
            }

            .otp-input {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>EMPLOYEE DATA UPDATION SYSTEM</h1>
            <p>Directorate of Agriculture Chhattisgarh</p>
        </div>

        <!-- Login Options Card -->
        <div class="card" id="loginOptionsCard">
            <div class="card-header">
                <i class="fas fa-sign-in-alt me-2"></i> Login Options
            </div>
            <div class="card-body">
                <div class="disclaimer mb-4">
                    <strong>Disclaimer:</strong> This system is designed to collect and verify employee
                    information.
                    All data provided will be used for official purposes only and will be kept confidential in
                    accordance
                    with data protection policies. Please ensure that the information you provide is accurate and
                    up-to-date.
                </div>

                <div class="login-options">
                    <div class="login-option" id="employeeLoginOption">
                        <i class="fas fa-user"></i>
                        <h5>Employee Login</h5>
                        <p>Verify and update your information</p>
                    </div>
                    <div class="login-option" id="adminLoginOption">
                        <i class="fas fa-user-shield"></i>
                        <h5>Admin Login</h5>
                        <p>Access dashboard and reports</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Login Card -->
        <div class="card d-none" id="adminLoginCard">
            <div class="card-header">
                <i class="fas fa-user-shield me-2"></i> Admin Login
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-none" id="adminLoginError"></div>

                <form id="adminLoginForm">
                    <div class="mb-3">
                        <label for="adminUsername" class="form-label">Username (Mobile Number)</label>
                        <input type="text" class="form-control" id="adminUsername"
                            placeholder="Enter admin username">
                    </div>

                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword"
                            placeholder="Enter admin password">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i> LOGIN
                        </button>
                        <button type="button" class="btn btn-secondary" id="backToLoginOptions">
                            <i class="fas fa-arrow-left me-2"></i> BACK
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard Card -->
        <div class="card d-none" id="adminDashboardCard">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i> Admin Dashboard
                <button class="btn btn-sm btn-outline-light float-end" id="adminLogoutBtn">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs admin-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="employees-tab" data-bs-toggle="tab"
                            data-bs-target="#employees" type="button" role="tab" aria-controls="employees"
                            aria-selected="true">
                            <i class="fas fa-users me-2"></i> Employees
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports"
                            type="button" role="tab" aria-controls="reports" aria-selected="false">
                            <i class="fas fa-chart-bar me-2"></i> Reports
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export"
                            type="button" role="tab" aria-controls="export" aria-selected="false">
                            <i class="fas fa-download me-2"></i> Export Data
                        </button>
                    </li>
                </ul>

                <div class="tab-content admin-tab-content" id="adminTabContent">
                    <!-- Employees Tab -->
                    <div class="tab-pane fade show active" id="employees" role="tabpanel"
                        aria-labelledby="employees-tab">
                        <h4>Employee Records</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="employeesTable">
                                <thead>
                                    <tr>
                                        <th>Mobile Number</th>
                                        <th>Employee Name</th>
                                        <th>Email</th>
                                        <th>Designation</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody">
                                    <!-- Data will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="loading-spinner" id="employeesTableSpinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading employee data...</div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                        <h4>Verification Status Report</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Verification Status</h5>
                                        <canvas id="verificationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Designation Distribution</h5>
                                        <canvas id="designationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="loading-spinner" id="reportsSpinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Generating reports...</div>
                        </div>
                    </div>

                    <!-- Export Tab -->
                    <div class="tab-pane fade" id="export" role="tabpanel" aria-labelledby="export-tab">
                        <h4>Export Employee Data</h4>
                        <p>Download employee data in various formats.</p>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-excel text-success" style="font-size: 48px;"></i>
                                        <h5 class="mt-3">Excel Format</h5>
                                        <button class="btn btn-success mt-3" id="exportExcelBtn">
                                            <i class="fas fa-download me-2"></i> Download Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-csv text-primary" style="font-size: 48px;"></i>
                                        <h5 class="mt-3">CSV Format</h5>
                                        <button class="btn btn-primary mt-3" id="exportCsvBtn">
                                            <i class="fas fa-download me-2"></i> Download CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf text-danger" style="font-size: 48px;"></i>
                                        <h5 class="mt-3">PDF Format</h5>
                                        <button class="btn btn-danger mt-3" id="exportPdfBtn">
                                            <i class="fas fa-download me-2"></i> Download PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator d-none" id="stepIndicator">
            <div class="step active" id="step1">
                <div class="step-line"></div>
                <div class="step-number">1</div>
                <div class="step-title">Search</div>
            </div>
            <div class="step" id="step2">
                <div class="step-line"></div>
                <div class="step-number">2</div>
                <div class="step-title">Verify</div>
            </div>
            <div class="step" id="step3">
                <div class="step-line"></div>
                <div class="step-number">3</div>
                <div class="step-title">Review</div>
            </div>
            <div class="step" id="step4">
                <div class="step-line"></div>
                <div class="step-number">4</div>
                <div class="step-title">Submit</div>
            </div>
        </div>

        <!-- Search Card -->
        <div class="card d-none" id="searchCard">
            <div class="card-header">
                <i class="fas fa-search me-2"></i> Search Your Record
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-none" id="searchError"></div>

                <div class="mb-3">
                    <label for="mobileNumber" class="form-label required-field">Mobile Number</label>
                    <input type="text" class="form-control" id="mobileNumber"
                        placeholder="Enter your registered mobile number">
                    <div class="form-text">Please enter the mobile number registered in our database.</div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="searchButton">
                        <i class="fas fa-search me-2"></i> FIND MY RECORD
                    </button>
                    <button class="btn btn-secondary" id="backToLoginOptionsFromSearch">
                        <i class="fas fa-arrow-left me-2"></i> BACK
                    </button>
                </div>

                <div class="loading-spinner" id="searchSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Searching for your record...</div>
                </div>
            </div>
        </div>

        <!-- OTP Verification Card -->
        <div class="card d-none" id="otpCard">
            <div class="card-header">
                <i class="fas fa-key me-2"></i> Verify Your Identity
            </div>
            <div class="card-body text-center">
                <div class="alert alert-danger d-none" id="otpError"></div>
                <div class="alert alert-success d-none" id="otpSuccess"></div>

                <p>A verification code has been sent to your email address ending with <span
                        id="maskedMobile">****</span></p>

                <div class="otp-inputs">
                    <input type="text" maxlength="1" class="form-control otp-input" id="otp1">
                    <input type="text" maxlength="1" class="form-control otp-input" id="otp2">
                    <input type="text" maxlength="1" class="form-control otp-input" id="otp3">
                    <input type="text" maxlength="1" class="form-control otp-input" id="otp4">
                </div>

                <p>Didn't receive the code? <a href="#" id="resendOtp">Resend OTP</a></p>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="verifyOtpButton">
                        <i class="fas fa-check-circle me-2"></i> VERIFY OTP
                    </button>
                    <button class="btn btn-secondary" id="backFromOtp">
                        <i class="fas fa-arrow-left me-2"></i> BACK
                    </button>
                </div>

                <div class="loading-spinner" id="otpSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Verifying OTP...</div>
                </div>
            </div>
        </div>

        <!-- Verification Card -->
        <div class="card d-none" id="verificationCard">
            <div class="card-header">
                <i class="fas fa-user-check me-2"></i> Verify Your Information
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> Please verify each field below. Click "Yes" if the
                    information is correct, or "No" to edit.
                </div>

                <div class="progress-section">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Verification Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar">
                        </div>
                    </div>
                </div>

                <div id="fieldsContainer">
                    <!-- Fields will be dynamically added here -->
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" id="backButton">
                        <i class="fas fa-arrow-left me-2"></i> GO BACK
                    </button>
                    <button type="button" class="btn btn-primary" id="saveDraftButton">
                        <i class="fas fa-save me-2"></i> SAVE DRAFT
                    </button>
                    <button type="button" class="btn btn-success" id="continueButton" disabled>
                        <i class="fas fa-check me-2"></i> CONTINUE
                    </button>
                </div>

                <div class="loading-spinner" id="verifySpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Processing...</div>
                </div>
            </div>
        </div>

        <!-- Review Card -->
        <div class="card d-none" id="reviewCard">
            <div class="card-header">
                <i class="fas fa-clipboard-check me-2"></i> Review Your Information
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> Please review all your information below before final
                    submission.
                </div>

                <div id="reviewContainer">
                    <!-- Review information will be added here -->
                </div>

                <div class="form-check mb-4 mt-3">
                    <input class="form-check-input" type="checkbox" id="confirmCheck">
                    <label class="form-check-label" for="confirmCheck">
                        I confirm that all the information provided is accurate and complete.
                    </label>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="backToVerifyButton">
                        <i class="fas fa-arrow-left me-2"></i> BACK TO VERIFY
                    </button>
                    <button type="button" class="btn btn-success" id="submitButton" disabled>
                        <i class="fas fa-paper-plane me-2"></i> SUBMIT
                    </button>
                </div>

                <div class="loading-spinner" id="submitSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Submitting your information...</div>
                </div>
            </div>
        </div>

        <!-- Success Card -->
        <div class="card d-none" id="successCard">
            <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i> Submission Successful
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 64px;"></i>
                </div>
                <h3 class="mb-3">Thank You!</h3>
                <p>Your information has been successfully verified and submitted.</p>
                <div class="mt-4">
                    <button class="btn btn-primary me-2" id="downloadPdfButton">
                        <i class="fas fa-file-pdf me-2"></i> DOWNLOAD PDF
                    </button>
                    <button class="btn btn-secondary" id="startOverButton">
                        <i class="fas fa-redo me-2"></i> START OVER
                    </button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 Directorate of Agriculture Chhattisgarh. All rights reserved.</p>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <!-- Chart.js for admin dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Supabase JS - Make sure to load this before our custom script -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Global variables
        let supabaseClient;
        let currentEmployee = null;
        let fieldStatuses = {};
        let editedFields = {};
        let allEmployees = [];
        let employeesTable = null;
        let verificationChart = null;
        let designationChart = null;

        // Admin credentials (normally these would be stored securely on a server)
        const ADMIN_USERNAME = '7354900500';
        const ADMIN_PASSWORD = '9329807288';

       // Supabase configuration
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';

        // Generate year options for year picker (1950 to current year)
        function generateYearOptions() {
            const currentYear = new Date().getFullYear();
            let options = [];
            for (let year = currentYear; year >= 1950; year--) {
                options.push(year.toString());
            }
            return options;
        }

        // Field definitions - matching your table structure exactly with dropdown options
        const fieldDefinitions = [{
                id: "Mobile Number",
                label: "Mobile Number",
                type: "text",
                required: true,
                readonly: true
            },
            {
                id: "Employee Name",
                label: "Employee Name",
                type: "text",
                required: true
            },
            {
                id: "Nic E-mail ID",
                label: "Email ID",
                type: "email"
            },
            {
                id: "Gender",
                label: "Gender",
                type: "select",
                options: ["Male", "Female", "Other"]
            },
            {
                id: "Father's Name",
                label: "Father's Name",
                type: "text"
            },
            {
                id: "Date of Birth",
                label: "Date of Birth",
                type: "date"
            },
            {
                id: "Nationality",
                label: "Nationality",
                type: "select",
                options: ["Indian", "NRI"]
            },
            {
                id: "Religion",
                label: "Religion",
                type: "select",
                options: ["Hindu", "Jain", "Buddhist", "Christian", "Islam", "Sikh", "Others"]
            },
            {
                id: "Category",
                label: "Category",
                type: "select",
                options: ["Unreserved", "OBC", "SC", "ST"]
            },
            {
                id: "Designation",
                label: "Designation",
                type: "select",
                options: [
                    "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF",
                    "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA",
                    "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO",
                    "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO",
                    "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
                ]
            },
            {
                id: "Service",
                label: "Service",
                type: "select",
                options: ["Permanent", "Not Permanent"]
            },
            {
                id: "Orgnazation",
                label: "Organization",
                type: "select",
                options: ["Directorate of Agriculture", "Deputation"]
            },
            {
                id: "Organization from Date",
                label: "Date of Joining",
                type: "date"
            },
            {
                id: "Designation on Joining Date",
                label: "Designation on Joining",
                type: "select",
                options: [
                    "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF",
                    "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA",
                    "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO",
                    "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO",
                    "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
                ]
            },
            {
                id: "Type of Appointment",
                label: "Type of Appointment",
                type: "select",
                options: ["Regular", "Temporary"]
            },
            {
                id: "Appointment Order Date",
                label: "Appointment Order Date",
                type: "date"
            },
            {
                id: "Roles",
                label: "Roles (In CR reporting System)",
                type: "text"
            },
            {
                id: "Allotment Year",
                label: "Allotment Year (Year of Promotion)",
                type: "select",
                options: generateYearOptions()
            }
        ];

        // Initialize Supabase client
        let supabaseClient;

        // DOMContentLoaded - Initialize everything here
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM is fully loaded");

            // Initialize Supabase
            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log("Supabase client initialized");

                // Test connection
                testConnection();

                // Initialize UI and event listeners
                initUI();
                initEventListeners();

            } catch (error) {
                console.error("Error initializing:", error);
                showMessage('searchError', 'Error initializing application. Please try again later.', true);
            }
        });

        // Function to send email (Google Apps Script)
        async function sendEmail(email, subject, body) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Email sent successfully:", response);
                        resolve(response);
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error sending email:", error);
                        reject(error);
                    })
                    .sendEmailGAS(email, subject, body);
            });
        }

        // Google Apps Script function to send email
        // The following function must be in Code.gs
        // @param {string} email The recipient's email address.
        // @param {string} subject The email subject.
        // @param {string} body The email body.
        function sendEmailGAS(email, subject, body) {
            GmailApp.sendEmail(email, subject, body);
        }

        // Function to generate a random OTP
        function generateOTP() {
            const digits = '0123456789';
            let OTP = '';
            for (let i = 0; i < 6; i++) {
                OTP += digits[Math.floor(Math.random() * 10)];
            }
            return OTP;
        }

        // Function to store OTP server-side (Google Sheets)
        async function storeOTPServerSide(mobileNumber, otp) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = 'your-spreadsheet-id'; // Replace with the ID of your Google Sheet
                
                // Use google.script.run to call the server-side function
                await google.script.run.storeOTPData(mobileNumber, otp, spreadsheetId);
            } catch (error) {
                console.error("Error storing OTP:", error);
                alert('Error storing OTP: ' + error.message);
            }
        }

        // Send OTP via Gmail
        async function sendEmailOTP(email, otp) {
            // Show sending message
            showMessage('otpSuccess', 'Sending OTP...', false);

            try {
                // Send email using Google Apps Script
                await sendEmail(email, 'Your Verification Code', `Your verification code is: ${otp}`);

                // Show success message
                showMessage('otpSuccess', 'OTP sent to your email successfully!', false);
            } catch (error) {
                console.error("Error sending email:", error);
                showMessage('otpError', 'Error sending email: ' + error, true);
            }
        }
        
        // Google Apps Script function to store OTP data in Google Sheets
        function storeOTPData(mobileNumber, otp, spreadsheetId) {
            try {
                // Get the spreadsheet and sheet
                var sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName('OTPData');
                
                // If sheet doesn't exist, create it
                if (!sheet) {
                    sheet = SpreadsheetApp.openById(spreadsheetId).insertSheet('OTPData');
                    sheet.appendRow(['Mobile Number', 'OTP', 'Expiry Time']);
                }
                
                // Find the employee row
                var dataRange = sheet.getDataRange();
                var values = dataRange.getValues();
                var headers = values[0];
                
                var mobileCol = headers.indexOf('Mobile Number');
                if (mobileCol == -1) {
                    Logger.log('Mobile Number column not found');
                    return;
                }
                
                // Search for the employee row
                var employeeRow = -1;
                for (var i = 1; i < values.length; i++) {
                    if (values[i][mobileCol] == mobileNumber) {
                        employeeRow = i + 1; // +1 because array is 0-indexed but sheets are 1-indexed
                        break;
                    }
                }
                
                // Set expiry time
                var expiryTime = new Date().getTime() + 5 * 60 * 1000;
                
                // If employee found, update the OTP
                if (employeeRow > 0) {
                    // Update the OTP and Expiry Time
                    sheet.getRange(employeeRow, headers.indexOf('OTP') + 1).setValue(otp);
                    sheet.getRange(employeeRow, headers.indexOf('Expiry Time') + 1).setValue(expiryTime);
                } else {
                    // Append the new OTP
                    sheet.appendRow([mobileNumber, otp, expiryTime]);
                }
            } catch (error) {
                console.error("Error storing OTP:", error);
            }
        }
        
        // Get OTP and expiry time from server-side storage (Google Sheets)
        async function getServerSideOTP(mobileNumber) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            resolve(result);
                        } else {
                            reject('OTP not found on server');
                        }
                    })
                    .withFailureHandler(function(error) {
                        reject(error);
                    })
                    .getOTPData(mobileNumber);
            });
        }

        // Show message
        function showMessage(elementId, message, isError) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'message';
            if (isError) {
                element.classList.add('alert-danger');
                element.classList.remove('alert-success');
            } else {
                element.classList.add('alert-success');
                element.classList.remove('alert-danger');
            }
            element.classList.remove('d-none');
            
            // Hide message after 5 seconds
            setTimeout(function() {
                element.classList.add('d-none');
            }, 5000);
        }

        // Check for saved draft on page load
        function checkForSavedDraft(mobileNumber) {
            console.log("Checking for saved draft for:", mobileNumber);

            try {
                const draftKey = 'employeeDraft_' + mobileNumber;
                const savedDraft = localStorage.getItem(draftKey);

                if (savedDraft) {
                    const draftData = JSON.parse(savedDraft);
                    const timestamp = new Date(draftData.timestamp);
                    const now = new Date();
                    const hoursDiff = Math.abs(now - timestamp) / 36e5; // Convert to hours

                    console.log("Found saved draft from:", timestamp);

                    // If draft is less than 24 hours old, ask to restore
                    if (hoursDiff < 24) {
                        const confirm = window.confirm('You have a saved draft from ' + timestamp.toLocaleString() +
                            '. Would you like to restore it?');

                        if (confirm) {
                            console.log("Restoring saved draft");

                            // Restore the saved state
                            currentEmployee = draftData.employee;
                            fieldStatuses = draftData.statuses;
                            editedFields = draftData.edits;

                            // Show verification card
                            document.getElementById('searchCard').classList.add('d-none');
                            document.getElementById('verificationCard').classList.remove('d-none');

                            // Update step indicator
                            updateStepIndicator(2);

                            // Generate verification fields
                            generateVerificationFields();

                            // Update progress
                            updateProgress();
                            checkAllFieldsVerified();

                            return true;
                        }
                    }
                }
            } catch (error) {
                console.error("Error checking for saved draft:", error);
            }

            return false;
        }
    

  
        // Initialize Supabase client
        let supabaseClient;

        // DOMContentLoaded - Initialize everything here
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM is fully loaded");

            // Initialize Supabase
            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log("Supabase client initialized");

                // Test connection
                testConnection();

                // Initialize UI and event listeners
                initUI();
                initEventListeners();
                initOtpInputs();
            } catch (error) {
                console.error("Error initializing:", error);
                showMessage('searchError', 'Error initializing application. Please try again later.', true);
            }
        });

        // Function to send email (Google Apps Script)
        async function sendEmail(email, subject, body) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Email sent successfully:", response);
                        resolve(response);
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error sending email:", error);
                        reject(error);
                    })
                    .sendEmailGAS(email, subject, body);
            });
        }

        // Google Apps Script function to send email
        // The following function must be in Code.gs
        // @param {string} email The recipient's email address.
        // @param {string} subject The email subject.
        // @param {string} body The email body.
        function sendEmailGAS(email, subject, body) {
            GmailApp.sendEmail(email, subject, body);
        }

        // Function to generate a random OTP
        function generateOTP() {
            const digits = '0123456789';
            let OTP = '';
            for (let i = 0; i < 6; i++) {
                OTP += digits[Math.floor(Math.random() * 10)];
            }
            return OTP;
        }

        // Function to store OTP server-side (Google Sheets)
        async function storeOTPServerSide(mobileNumber, otp) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet

                // Use google.script.run to call the server-side function
                await google.script.run.storeOTPData(mobileNumber, otp, spreadsheetId);
            } catch (error) {
                console.error("Error storing OTP:", error);
                alert('Error storing OTP: ' + error.message);
            }
        }

        // Get OTP and expiry time from server-side storage (Google Sheets)
        async function getServerSideOTP(mobileNumber) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result) {
                            resolve(result);
                        } else {
                            reject('OTP not found on server');
                        }
                    })
                    .withFailureHandler(function (error) {
                        reject(error);
                    })
                    .getOTPData(mobileNumber);
            });
        }

        function searchEmployee() {
            console.log("Search function called");

            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            console.log("Mobile number entered:", mobileNumber);

            if (!mobileNumber) {
                showMessage('searchError', 'Please enter your mobile number', true);
                return;
            }

            // Show spinner
            document.getElementById('searchSpinner').style.display = 'block';
            document.getElementById('searchButton').disabled = true;

            try {
                console.log("Querying Supabase for mobile number:", mobileNumber);

                // Query Supabase for employee with this mobile number
                supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('Mobile Number', mobileNumber)
                    .then(response => {
                        console.log("Supabase response:", response);

                        // Hide spinner
                        document.getElementById('searchSpinner').style.display = 'none';
                        document.getElementById('searchButton').disabled = false;

                        if (response.error) {
                            console.error("Error from Supabase:", response.error);
                            showMessage('searchError', 'Database error: ' + response.error.message, true);
                            return;
                        }

                        if (response.data && response.data.length > 0) {
                            // Employee found
                            currentEmployee = response.data[0];
                            console.log("Employee found:", currentEmployee);

                            // Send OTP to email
                            const otp = generateOTP();
                            storeOTPServerSide(mobileNumber, otp);
                            sendEmailOTP(currentEmployee["Nic E-mail ID"], otp);

                            // Show OTP verification
                            document.getElementById('searchCard').classList.add('d-none');
                            document.getElementById('otpCard').classList.remove('d-none');

                            // Display masked mobile number
                            const maskedNumber = mobileNumber.substring(0, 2) + '****' + mobileNumber.substring(mobileNumber.length - 4);
                            document.getElementById('maskedMobile').textContent = maskedNumber;

                        } else {
                            console.log("No employee found with mobile number:", mobileNumber);
                            showMessage('searchError', 'No employee found with this mobile number', true);
                        }
                    });
            } catch (error) {
                console.error("Exception in searchEmployee:", error);

                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;

                // Show error message
                showMessage('searchError', 'Error: ' + error.message, true);
            }
        }

        // Function to send OTP
        async function sendEmailOTP(email, otp) {
            // Show sending message
            showMessage('otpSuccess', 'Sending OTP...', false);

            try {
                // Send email using Google Apps Script
                const result = await google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Email sent successfully:", response);
                        showMessage('otpSuccess', 'OTP sent to your email successfully!', false);
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error sending email:", error);
                        showMessage('otpError', 'Error sending email: ' + error, true);
                    })
                    .sendEmail(email, 'Your Verification Code', `Your verification code is: ${otp}`);
            } catch (e) {
                console.error("Error sending email:", e);
                showMessage('otpError', 'Error sending email: ' + e, true);
            }
        }

    // Get OTP and expiry time from server-side storage (Google Sheets)
    async function getServerSideOTP(mobileNumber) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result) {
                        resolve(result);
                    } else {
                        reject('OTP not found on server');
                    }
                })
                .withFailureHandler(function (error) {
                    reject(error);
                })
                .getOTPData(mobileNumber);
        });
    }

    // Google Apps Script function to get OTP and expiry time from the sheet
    // This function MUST be in Code.gs
    function getOTPData(mobileNumber) {
        try {
            // Get the spreadsheet - replace with your actual spreadsheet ID
            var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s';
            var sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName('OTPData');

            // If sheet doesn't exist, return null
            if (!sheet) {
                return null;
            }

            // Get data range
            var dataRange = sheet.getDataRange();
            var values = dataRange.getValues();
            var headers = values[0];

            var mobileCol = headers.indexOf('Mobile Number');
            if (mobileCol == -1) {
                Logger.log('Mobile Number column not found');
                return null;
            }

            // Search for the employee row
            var employeeRow = -1;
            for (var i = 1; i < values.length; i++) {
                if (values[i][mobileCol] == mobileNumber) {
                    employeeRow = i + 1; // +1 because array is 0-indexed but sheets are 1-indexed
                    break;
                }
            }

            // If employee found, return the OTP and Expiry Time
            if (employeeRow > 0) {
                var otp = sheet.getRange(employeeRow, headers.indexOf('OTP') + 1).getValue();
                var expiryTime = sheet.getRange(employeeRow, headers.indexOf('Expiry Time') + 1).getValue();
                return {
                    storedOtp: otp,
                    expiryTime: expiryTime.getTime()
                };
            } else {
                return null;
            }
        } catch (error) {
            console.error("Error getting OTP data:", error);
            return null;
        }
    }

    // Verify OTP
    async function verifyOtp() {
        console.log("Verifying OTP");

        const mobileNumber = currentEmployee['Mobile Number'];

        // Get entered OTP
        const otp1 = document.getElementById('otp1').value;
        const otp2 = document.getElementById('otp2').value;
        const otp3 = document.getElementById('otp3').value;
        const otp4 = document.getElementById('otp4').value;
        const enteredOtp = otp1 + otp2 + otp3 + otp4;

        // Show spinner
        document.getElementById('otpSpinner').style.display = 'block';
        document.getElementById('verifyOtpButton').disabled = true;

        try {
            // Get stored OTP and expiry time from the server
            const {
                storedOtp,
                expiryTime
            } = await getServerSideOTP(mobileNumber);

            // Check if OTP has expired
            if (Date.now() > expiryTime) {
                showMessage('otpError', 'OTP has expired. Please request a new one.', true);
                return;
            }

            // Check OTP
            if (enteredOtp == storedOtp) {
                // OTP verified, proceed to verification screen
                document.getElementById('otpCard').classList.add('d-none');
                document.getElementById('verificationCard').classList.remove('d-none');

                // Initialize field statuses
                fieldDefinitions.forEach(function (field) {
                    fieldStatuses[field.id] = 'pending';
                });

                // Update step indicator
                updateStepIndicator(2);

                // Generate verification fields
                generateVerificationFields();
            } else {
                // Invalid OTP
                showMessage('otpError', 'Invalid OTP. Please try again.', true);
            }
        } catch (error) {
            console.error("Exception verifying OTP:", error);

            // Show spinner
            document.getElementById('otpSpinner').style.display = 'none';
            document.getElementById('verifyOtpButton').disabled = false;

            // Show error message
            showMessage('otpError', 'Error verifying OTP: ' + error, true);
        } finally {
            // Hide spinner
            document.getElementById('otpSpinner').style.display = 'none';
            document.getElementById('verifyOtpButton').disabled = false;
        }
    }

    // Show message
    function showMessage(elementId, message, isError) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = 'message';
        if (isError) {
            element.classList.add('alert-danger');
            element.classList.remove('alert-success');
        } else {
            element.classList.add('alert-success');
            element.classList.remove('alert-danger');
        }
        element.classList.remove('d-none');

        // Hide message after 5 seconds
        setTimeout(function () {
            element.classList.add('d-none');
        }, 5000);
    }

    // Check for saved draft on page load
    function checkForSavedDraft(mobileNumber) {
        console.log("Checking for saved draft for:", mobileNumber);

        try {
            const draftKey = 'employeeDraft_' + mobileNumber;
            const savedDraft = localStorage.getItem(draftKey);

            if (savedDraft) {
                const draftData = JSON.parse(savedDraft);
                const timestamp = new Date(draftData.timestamp);
                const now = new Date();
                const hoursDiff = Math.abs(now - timestamp) / 36e5; // Convert to hours

                console.log("Found saved draft from:", timestamp);

                // If draft is less than 24 hours old, ask to restore
                if (hoursDiff < 24) {
                    const confirm = window.confirm('You have a saved draft from ' + timestamp.toLocaleString() +
                        '. Would you like to restore it?');

                    if (confirm) {
                        console.log("Restoring saved draft");

                        // Restore the saved state
                        currentEmployee = draftData.employee;
                        fieldStatuses = draftData.statuses;
                        editedFields = draftData.edits;

                        // Show verification card
                        document.getElementById('searchCard').classList.add('d-none');
                        document.getElementById('verificationCard').classList.remove('d-none');

                        // Update step indicator
                        updateStepIndicator(2);

                        // Generate verification fields
                        generateVerificationFields();

                        // Update progress
                        updateProgress();
                        checkAllFieldsVerified();

                        return true;
                    }
                }
            }
        } catch (error) {
            console.error("Error checking for saved draft:", error);
        }

        return false;
    }

    // Initialize Supabase client
    let supabaseClient;

    // DOMContentLoaded - Initialize everything here
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM is fully loaded");

        // Initialize Supabase
        try {
            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            console.log("Supabase client initialized");

            // Test connection
            testConnection();

            // Initialize UI and event listeners
            initUI();
            initEventListeners();
            initOtpInputs();
        } catch (error) {
            console.error("Error initializing:", error);
            showMessage('searchError', 'Error initializing application. Please try again later.', true);
        }
    });

    // Function to send email (Google Apps Script)
    async function sendEmail(email, subject, body) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(function (response) {
                    console.log("Email sent successfully:", response);
                    resolve(response);
                })
                .withFailureHandler(function (error) {
                    console.error("Error sending email:", error);
                    reject(error);
                })
                .sendEmailGAS(email, subject, body);
        });
    }

    // Google Apps Script function to send email
    // The following function must be in Code.gs
    // @param {string} email The recipient's email address.
    // @param {string} subject The email subject.
    // @param {string} body The email body.
    function sendEmailGAS(email, subject, body) {
        GmailApp.sendEmail(email, subject, body);
    }

    // Function to generate a random OTP
    function generateOTP() {
        const digits = '0123456789';
        let OTP = '';
        for (let i = 0; i < 6; i++) {
            OTP += digits[Math.floor(Math.random() * 10)];
        }
        return OTP;
    }

    // Function to store OTP server-side (Google Sheets)
    async function storeOTPServerSide(mobileNumber, otp) {
        try {
            // Get the spreadsheet - replace with your actual spreadsheet ID
            var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet

            // Use google.script.run to call the server-side function
            await google.script.run.storeOTPData(mobileNumber, otp, spreadsheetId);
        } catch (error) {
            console.error("Error storing OTP:", error);
            alert('Error storing OTP: ' + error.message);
        }
    }

    // Get OTP and expiry time from server-side storage (Google Sheets)
    async function getServerSideOTP(mobileNumber) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result) {
                        resolve(result);
                    } else {
                        reject('OTP not found on server');
                    }
                })
                .withFailureHandler(function (error) {
                    reject(error);
                })
                .getOTPData(mobileNumber);
        });
    }

    // Get data from server side
    async function searchEmployee(mobileNumber) {
        console.log("Search function called with mobile number:", mobileNumber);
        if (!mobileNumber) {
            showMessage('searchError', 'Please enter your mobile number', true);
            return;
        }

        // Show spinner
        document.getElementById('searchSpinner').style.display = 'block';
        document.getElementById('searchButton').disabled = true;

        try {
            console.log("Querying Supabase for mobile number:", mobileNumber);

            // Fetch all employees
            const {
                data,
                error
            } = await supabaseClient
                .from('employees')
                .select('*')
                .eq('Mobile Number', mobileNumber);

            console.log("Supabase response:", {
                data,
                error
            });
            
            if (error) {
                console.error("Error from Supabase:", error);
                showMessage('searchError', 'Database error: ' + error.message, true);
                return;
            }

            // Hide spinner
            document.getElementById('searchSpinner').style.display = 'none';
            document.getElementById('searchButton').disabled = false;

            if (data && data.length > 0) {
                // Store employee data
                currentEmployee = data[0];
                console.log("Employee data loaded:", currentEmployee);

                // Send OTP to email
                const otp = generateOTP();
                storeOTPServerSide(mobileNumber, otp);

                sendEmailOTP(currentEmployee["Nic E-mail ID"], otp);

                // Show OTP verification
                document.getElementById('searchCard').classList.add('d-none');
                document.getElementById('otpCard').classList.remove('d-none');

                // Display masked mobile number
                const maskedNumber = mobileNumber.substring(0, 2) + '****' + mobileNumber.substring(mobileNumber.length - 4);
                document.getElementById('maskedMobile').textContent = maskedNumber;

            } else {
                console.log("No employee found with mobile number:", mobileNumber);
                showMessage('searchError', 'No employee found with this mobile number', true);
            }
        } catch (error) {
            console.error("Error in searchEmployee:", error);

            // Hide spinner
            document.getElementById('searchSpinner').style.display = 'none';
            document.getElementById('searchButton').disabled = false;

            // Show error message
            showMessage('searchError', 'Error: ' + error.message, true);
        }
    }

    // Function to send OTP
    async function sendEmailOTP(email, otp) {
        // Show sending message
        showMessage('otpSuccess', 'Sending OTP...', false);

        try {
            // Send email using Google Apps Script
            await sendEmail(email, 'Your Verification Code', `Your verification code is: \${otp}`);

            // Show success message
            showMessage('otpSuccess', 'OTP sent to your email successfully!', false);
        } catch (error) {
            console.error("Error sending email:", error);
            showMessage('otpError', 'Error sending email: ' + error, true);
        }
    }
    // Initialize event listeners
    function initEventListeners() {
        // Login options
        document.getElementById('employeeLoginOption').addEventListener('click', showEmployeeLogin);
        document.getElementById('adminLoginOption').addEventListener('click', showAdminLogin);
        document.getElementById('backToLoginOptions').addEventListener('click', showLoginOptions);
        document.getElementById('backToLoginOptionsFromSearch').addEventListener('click', showLoginOptions);

        // Admin login
        document.getElementById('adminLoginForm').addEventListener('submit', function (e) {
            e.preventDefault();
            handleAdminLogin();
        });
        document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);

        // Export buttons
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);

       // Employee search and verification
        document.getElementById('searchButton').addEventListener('click', function () {
            searchEmployee(document.getElementById('mobileNumber').value);
        });
        document.getElementById('backButton').addEventListener('click', goBackToSearch);
        document.getElementById('saveDraftButton').addEventListener('click', saveDraft);
        document.getElementById('continueButton').addEventListener('click', showReview);
        document.getElementById('backToVerifyButton').addEventListener('click', goBackToVerify);
        document.getElementById('confirmCheck').addEventListener('change', toggleSubmitButton);
        document.getElementById('submitButton').addEventListener('click', submitForm);
        document.getElementById('downloadPdfButton').addEventListener('click', generatePDF);
        document.getElementById('startOverButton').addEventListener('click', startOver);

        // OTP verification
        document.getElementById('verifyOtpButton').addEventListener('click', verifyOtp);
        document.getElementById('backFromOtp').addEventListener('click', function () {
            document.getElementById('otpCard').classList.add('d-none');
            document.getElementById('searchCard').classList.remove('d-none');
        });
        document.getElementById('resendOtp').addEventListener('click', function (e) {
            e.preventDefault();
            sendEmailOTP(currentEmployee["Nic E-mail ID"], generateOTP());
        });

        // Admin tabs
        document.getElementById('employees-tab').addEventListener('click', loadEmployeeData);
        document.getElementById('reports-tab').addEventListener('click', loadReportData);
    }

    // Initialize OTP input fields
    function initOtpInputs() {
        const otpInputs = document.querySelectorAll('.otp-input');

        otpInputs.forEach(function (input, index) {
            // Auto-focus next input on input
            input.addEventListener('input', function () {
                if (this.value.length === this.maxLength && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            // Handle backspace
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });
    }

    // Show employee login (search card)
    function showEmployeeLogin() {
        console.log("Showing employee login");
        document.getElementById('loginOptionsCard').classList.add('d-none');
        document.getElementById('searchCard').classList.remove('d-none');
        document.getElementById('stepIndicator').classList.remove('d-none');
    }

    // Show admin login card
    function showAdminLogin() {
        console.log("Showing admin login");
        document.getElementById('loginOptionsCard').classList.add('d-none');
        document.getElementById('adminLoginCard').classList.remove('d-none');
    }

    // Show login options card
    function showLoginOptions() {
        console.log("Showing login options card");
        document.getElementById('searchCard').classList.add('d-none');
        document.getElementById('adminLoginCard').classList.add('d-none');
        document.getElementById('otpCard').classList.add('d-none');
        document.getElementById('verificationCard').classList.add('d-none');
        document.getElementById('reviewCard').classList.add('d-none');
        document.getElementById('successCard').classList.add('d-none');
        document.getElementById('adminDashboardCard').classList.add('d-none');
        document.getElementById('loginOptionsCard').classList.remove('d-none');
        document.getElementById('stepIndicator').classList.add('d-none');

        // Clear inputs
        document.getElementById('mobileNumber').value = '';
        document.getElementById('adminUsername').value = '';
        document.getElementById('adminPassword').value = '';

        // Hide error messages
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => alert.classList.add('d-none'));
    }

    // Handle admin login
    function handleAdminLogin() {
        const username = document.getElementById('adminUsername').value.trim();
        const password = document.getElementById('adminPassword').value.trim();

        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            // Show admin dashboard
            document.getElementById('adminLoginCard').classList.add('d-none');
            document.getElementById('adminDashboardCard').classList.remove('d-none');

            // Load employee data
            loadEmployeeData();
        } else {
            // Show error message
            const errorElement = document.getElementById('adminLoginError');
            errorElement.textContent = 'Invalid username or password';
            errorElement.classList.remove('d-none');
        }
    }

    // Admin logout
    function adminLogout() {
        document.getElementById('adminDashboardCard').classList.add('d-none');
        document.getElementById('loginOptionsCard').classList.remove('d-none');

        // Clear admin login form
        document.getElementById('adminUsername').value = '';
        document.getElementById('adminPassword').value = '';

        // Clear any selected admin tab
        const tabs = document.querySelectorAll('.nav-link');
        tabs.forEach(tab => tab.classList.remove('active'));
        document.getElementById('employees-tab').classList.add('active');

        // Show the login options
        showLoginOptions();
    }

    // Load employee data for admin dashboard
    async function loadEmployeeData() {
        console.log("Loading employee data");

        // Show loading spinner
        document.getElementById('employeesTableSpinner').style.display = 'block';

        try {
            // Fetch all employees
            const {
                data,
                error
            } = await supabaseClient
                .from('employees')
                .select('*');

            if (error) throw error;

            // Store employee data
            allEmployees = data;

            // Populate table
            populateEmployeesTable(data);

            // Hide loading spinner
            document.getElementById('employeesTableSpinner').style.display = 'none';
        } catch (error) {
            console.error("Error loading employee data:", error);
            document.getElementById('employeesTableSpinner').style.display = 'none';
            alert('Error loading employee data: ' + error.message);
        }
    }

    // Populate employees table
    function populateEmployeesTable(employees) {
        const tableBody = document.getElementById('employeesTableBody');
        tableBody.innerHTML = '';

        employees.forEach(function (employee) {
            const row = document.createElement('tr');

            // Mobile Number
            const mobileCell = document.createElement('td');
            mobileCell.textContent = employee['Mobile Number'] || '';
            row.appendChild(mobileCell);

            // Employee Name
            const nameCell = document.createElement('td');
            nameCell.textContent = employee['Employee Name'] || '';
            row.appendChild(nameCell);

            // Email
            const emailCell = document.createElement('td');
            emailCell.textContent = employee['Nic E-mail ID'] || '';
            row.appendChild(emailCell);

            // Designation
            const designationCell = document.createElement('td');
            designationCell.textContent = employee['Designation'] || '';
            row.appendChild(designationCell);

            // Status
            const statusCell = document.createElement('td');
            const hasBeenUpdated = employee['Modified Date'] !== null && employee['Modified Date'] !== undefined;
            const statusBadge = document.createElement('span');
            statusBadge.className = 'badge ' + (hasBeenUpdated ? 'bg-success' : 'bg-secondary');
            statusBadge.textContent = hasBeenUpdated ? 'Updated' : 'Pending';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);

            // Actions
            const actionsCell = document.createElement('td');

            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-sm btn-info me-2';
            viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
            viewBtn.title = 'View Details';
            viewBtn.onclick = function () {
                viewEmployeeDetails(employee);
            };
            actionsCell.appendChild(viewBtn);

            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-sm btn-primary';
            exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
            exportBtn.title = 'Export PDF';
            exportBtn.onclick = function () {
                exportEmployeePdf(employee);
            };
            actionsCell.appendChild(exportBtn);

            row.appendChild(actionsCell);

            tableBody.appendChild(row);
        });

        // Initialize DataTable if not already initialized
        if (!employeesTable) {
            employeesTable = $('#employeesTable').DataTable({
                responsive: true,
                pageLength: 10,
                language: {
                    search: "Search employees:",
                    lengthMenu: "Show _MENU_ entries per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ employees",
                    infoEmpty: "Showing 0 to 0 of 0 employees",
                    infoFiltered: "(filtered from _MAX_ total employees)"
                }
            });
        } else {
            // Refresh the table
            employeesTable.clear().rows.add($(tableBody).find('tr')).draw();
        }
    }

    // View employee details (for admin)
    function viewEmployeeDetails(employee) {
        // Create modal with employee details
        const modalHtml = `
            <div class="modal fade" id="employeeDetailsModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Employee Details</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h5 class="form-section-title">Personal Information</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Mobile Number:</strong> \${employee['Mobile Number'] || ''}</p>
                                    <p><strong>Employee Name:</strong> \${employee['Employee Name'] || ''}</p>
                                    <p><strong>Email ID:</strong> \${employee['Nic E-mail ID'] || ''}</p>
                                    <p><strong>Gender:</strong> \${employee['Gender'] || ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Father's Name:</strong> \${employee["Father's Name"] || ''}</p>
                                    <p><strong>Date of Birth:</strong> \${employee['Date of Birth'] || ''}</p>
                                    <p><strong>Nationality:</strong> \${employee['Nationality'] || ''}</p>
                                    <p><strong>Religion:</strong> \${employee['Religion'] || ''}</p>
                                    <p><strong>Category:</strong> \${employee['Category'] || ''}</p>
                                </div>
                            </div>
                            
                            <h5 class="form-section-title">Professional Information</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Designation:</strong> \${employee['Designation'] || ''}</p>
                                    <p><strong>Service:</strong> \${employee['Service'] || ''}</p>
                                    <p><strong>Organization:</strong> \${employee['Orgnazation'] || ''}</p>
                                    <p><strong>Date of Joining:</strong> \${employee['Organization from Date'] || ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Designation on Joining:</strong> \${employee['Designation on Joining Date'] || ''}</p>
                                    <p><strong>Type of Appointment:</strong> \${employee['Type of Appointment'] || ''}</p>
                                    <p><strong>Appointment Order Date:</strong> \${employee['Appointment Order Date'] || ''}</p>
                                    <p><strong>Roles:</strong> \${employee['Roles'] || ''}</p>
                                    <p><strong>Allotment Year:</strong> \${employee['Allotment Year'] || ''}</p>
                                </div>
                            </div>
                            
                            <h5 class="form-section-title">System Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Last Updated:</strong> \${employee['Modified Date'] ? new Date(employee['Modified Date']).toLocaleString() : 'Never'}</p>
                                    <p><strong>Created Date:</strong> \${employee['Created Date'] ? new Date(employee['Created Date']).toLocaleString() : ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Modified By:</strong> \${employee['Modified By'] || ''}</p>
                                    <p><strong>Created By:</strong> \${employee['Created By'] || ''}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportEmployeePdf(\${JSON.stringify(employee).replace(/"/g, '&quot;')})">
                                <i class="fas fa-file-pdf me-2"></i> Export as PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to body
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('employeeDetailsModal'));
        modal.show();

        // Remove modal from DOM when hidden
        document.getElementById('employeeDetailsModal').addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modalContainer);
        });
    }

    // Export employee data as PDF (for admin)
    function exportEmployeePdf(employee) {
        try {
            // Initialize jsPDF
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Add title
            doc.setFontSize(18);
            doc.setTextColor(128, 0, 0);
            doc.text('Employee Data Report', 150, 15, {
                align: 'center'
            });

            // Add subtitle
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Directorate of Agriculture Chhattisgarh', 150, 25, {
                align: 'center'
            });
            doc.text('Generated on: ' + new Date().toLocaleDateString(), 150, 35, {
                align: 'center'
            });

            // Prepare data for table
            const tableData = [
                ['Mobile Number', employee['Mobile Number'] || ''],
                ['Employee Name', employee['Employee Name'] || ''],
                ['Email ID', employee['Nic E-mail ID'] || ''],
                ['Designation', employee['Designation'] || ''],
                ['Service', employee['Service'] || ''],
                ['Modified Date', employee['Modified Date'] ? new Date(employee['Modified Date']).toLocaleString() : 'Never']
            ];

            // Add table
            doc.autoTable({
                startY: 45,
                head: [['Field', 'Value']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [128, 0, 0],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    cellPadding: 3,
                    fontSize: 8
                }
            });

            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Directorate of Agriculture Chhattisgarh - Page ' + i + ' of ' + pageCount, 150, 200, {
                    align: 'center'
                });
            }

            // Save the PDF
            doc.save("Employee_Data_Report.pdf");
        } catch (error) {
            console.error("Error exporting to PDF:", error);
            alert('Error exporting to PDF: ' + error.message);
        }
    }

        // Function to generate a random OTP
        function generateOTP() {
            const digits = '0123456789';
            let OTP = '';
            for (let i = 0; i < 6; i++) {
                OTP += digits[Math.floor(Math.random() * 10)];
            }
            return OTP;
        }

        // Function to store OTP server-side (Google Sheets)
        async function storeOTPServerSide(mobileNumber, otp) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet

                // Use google.script.run to call the server-side function
                await google.script.run.storeOTPData(mobileNumber, otp, spreadsheetId);
            } catch (error) {
                console.error("Error storing OTP:", error);
                alert('Error storing OTP: ' + error.message);
            }
        }

        // Get OTP and expiry time from server-side storage (Google Sheets)
        async function getServerSideOTP(mobileNumber) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result) {
                            resolve(result);
                        } else {
                            reject('OTP not found on server');
                        }
                    })
                    .withFailureHandler(function (error) {
                        reject(error);
                    })
                    .getOTPData(mobileNumber);
            });
        }

        // Function to send email (Google Apps Script)
        async function sendEmail(email, subject, body) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Email sent successfully:", response);
                        resolve(response);
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error sending email:", error);
                        reject(error);
                    })
                    .sendEmailGAS(email, subject, body);
            });
        }

        // Google Apps Script function to send email
        // The following function must be in Code.gs
        /**
         * @param {string} email The recipient's email address.
         * @param {string} subject The email subject.
         * @param {string} body The email body.
         */
        function sendEmailGAS(email, subject, body) {
            GmailApp.sendEmail(email, subject, body);
        }

        // Function to get OTP data from the server
        function getOTPData(mobileNumber) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet
                var sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName('OTPData');

                // If sheet doesn't exist, return null
                if (!sheet) {
                    return null;
                }

                // Get data range
                var dataRange = sheet.getDataRange();
                var values = dataRange.getValues();
                var headers = values[0];

                var mobileCol = headers.indexOf('Mobile Number');
                if (mobileCol == -1) {
                    Logger.log('Mobile Number column not found');
                    return null;
                }

                // Search for the employee row
                var employeeRow = -1;
                for (var i = 1; i < values.length; i++) {
                    if (values[i][mobileCol] == mobileNumber) {
                        employeeRow = i + 1; // +1 because array is 0-indexed but sheets are 1-indexed
                        break;
                    }
                }

                // If employee found, return the OTP and Expiry Time
                if (employeeRow > 0) {
                    var otp = sheet.getRange(employeeRow, headers.indexOf('OTP') + 1).getValue();
                    var expiryTime = sheet.getRange(employeeRow, headers.indexOf('Expiry Time') + 1).getValue();
                    return {
                        storedOtp: otp,
                        expiryTime: expiryTime.getTime()
                    };
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error getting OTP data:", error);
                return null;
            }
        }
    
    // Search for employee by mobile number
        async function searchEmployee(mobileNumber) {
            console.log("Search function called with mobile number:", mobileNumber);
            
            if (!mobileNumber) {
                showMessage('searchError', 'Please enter your mobile number', true);
                return;
            }
            
            // Show spinner
            document.getElementById('searchSpinner').style.display = 'block';
            document.getElementById('searchButton').disabled = true;
            
            try {
                console.log("Querying Supabase for mobile number:", mobileNumber);
                
                // Query Supabase for employee with this mobile number
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('Mobile Number, "Nic E-mail ID", "Employee Name"')
                    .eq('Mobile Number', mobileNumber);
                
                console.log("Supabase response:", { data, error });
                
                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
                
                if (error) {
                    console.error("Error from Supabase:", error);
                    showMessage('searchError', 'Database error: ' + error.message, true);
                    return;
                }
                
                if (data && data.length > 0) {
                    // Employee found
                    currentEmployee = data[0];
                    console.log("Employee found:", currentEmployee);
                    
                    // Send OTP to email
                    const otp = generateOTP();
                    await storeOTPServerSide(mobileNumber, otp);
                    await sendEmailOTP(currentEmployee["Nic E-mail ID"], otp);
                    
                    // Show OTP verification
                    document.getElementById('searchCard').classList.add('d-none');
                    document.getElementById('otpCard').classList.remove('d-none');
                    
                    // Display masked mobile number
                    const maskedNumber = mobileNumber.substring(0, 2) + '****' + mobileNumber.substring(mobileNumber.length - 4);
                    document.getElementById('maskedMobile').textContent = maskedNumber;
                    
                } else {
                    console.log("No employee found with mobile number:", mobileNumber);
                    showMessage('searchError', 'No employee found with this mobile number', true);
                }
            } catch (error) {
                console.error("Exception in searchEmployee:", error);
                
                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
                
                // Show error message
                showMessage('searchError', 'Error: ' + error.message, true);
            }
        }
        
        // Show the OTP verification card
        function showOtpVerification() {
            document.getElementById('searchCard').classList.add('d-none');
            document.getElementById('otpCard').classList.remove('d-none');
        }

        // Initialize event listeners
        function initEventListeners() {
            // Login options
            document.getElementById('employeeLoginOption').addEventListener('click', showEmployeeLogin);
            document.getElementById('adminLoginOption').addEventListener('click', showAdminLogin);
            document.getElementById('backToLoginOptions').addEventListener('click', showLoginOptions);
            document.getElementById('backToLoginOptionsFromSearch').addEventListener('click', showLoginOptions);

            // Admin login
            document.getElementById('adminLoginForm').addEventListener('submit', function (e) {
                e.preventDefault();
                handleAdminLogin();
            });
            document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);

            // Export buttons
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);

            // Employee search and verification
            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', function () {
                    searchEmployee(document.getElementById('mobileNumber').value);
                });
            } else {
                console.error("Search button not found");
            }
            document.getElementById('backButton').addEventListener('click', goBackToSearch);
            document.getElementById('saveDraftButton').addEventListener('click', saveDraft);
            document.getElementById('continueButton').addEventListener('click', showReview);
            document.getElementById('backToVerifyButton').addEventListener('click', goBackToVerify);
            document.getElementById('confirmCheck').addEventListener('change', toggleSubmitButton);
            document.getElementById('submitButton').addEventListener('click', submitForm);
            document.getElementById('downloadPdfButton').addEventListener('click', generatePDF);
            document.getElementById('startOverButton').addEventListener('click', startOver);

            // OTP verification
            document.getElementById('verifyOtpButton').addEventListener('click', verifyOtp);
            document.getElementById('backFromOtp').addEventListener('click', function () {
                document.getElementById('otpCard').classList.add('d-none');
                document.getElementById('searchCard').classList.remove('d-none');
            });
            document.getElementById('resendOtp').addEventListener('click', function (e) {
                e.preventDefault();
                sendEmailOTP(currentEmployee["Nic E-mail ID"], generateOTP());
            });

            // Admin tabs
            document.getElementById('employees-tab').addEventListener('click', loadEmployeeData);
            document.getElementById('reports-tab').addEventListener('click', loadReportData);
        }

        // Initialize OTP input fields
        function initOtpInputs() {
            const otpInputs = document.querySelectorAll('.otp-input');

            otpInputs.forEach(function (input, index) {
                // Auto-focus next input on input
                input.addEventListener('input', function () {
                    if (this.value.length === this.maxLength && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                });

                // Handle backspace
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });
        }

        // Show employee login (search card)
        function showEmployeeLogin() {
            console.log("Showing employee login");
            document.getElementById('loginOptionsCard').classList.add('d-none');
            document.getElementById('searchCard').classList.remove('d-none');
            document.getElementById('stepIndicator').classList.remove('d-none');
        }

        // Show admin login card
        function showAdminLogin() {
            console.log("Showing admin login");
            document.getElementById('loginOptionsCard').classList.add('d-none');
            document.getElementById('adminLoginCard').classList.remove('d-none');
        }

        // Show login options card
        function showLoginOptions() {
            console.log("Showing login options card");
            document.getElementById('searchCard').classList.add('d-none');
            document.getElementById('adminLoginCard').classList.add('d-none');
            document.getElementById('otpCard').classList.add('d-none');
            document.getElementById('verificationCard').classList.add('d-none');
            document.getElementById('reviewCard').classList.add('d-none');
            document.getElementById('successCard').classList.add('d-none');
            document.getElementById('adminDashboardCard').classList.add('d-none');
            document.getElementById('loginOptionsCard').classList.remove('d-none');
            document.getElementById('stepIndicator').classList.add('d-none');

            // Clear inputs
            document.getElementById('mobileNumber').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';

            // Hide error messages
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.classList.add('d-none'));
        }

        // Handle admin login
        function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Show admin dashboard
                document.getElementById('adminLoginCard').classList.add('d-none');
                document.getElementById('adminDashboardCard').classList.remove('d-none');

                // Load employee data
                loadEmployeeData();
            } else {
                // Show error message
                const errorElement = document.getElementById('adminLoginError');
                errorElement.textContent = 'Invalid username or password';
                errorElement.classList.remove('d-none');
            }
        }

        // Admin logout
        function adminLogout() {
            document.getElementById('adminDashboardCard').classList.add('d-none');
            document.getElementById('loginOptionsCard').classList.remove('d-none');

            // Clear admin login form
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';

            // Clear any selected admin tab
            const tabs = document.querySelectorAll('.nav-link');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById('employees-tab').classList.add('active');

            // Show the login options
            showLoginOptions();
        }

        // Load employee data for admin dashboard
        async function loadEmployeeData() {
            console.log("Loading employee data");

            // Show loading spinner
            document.getElementById('employeesTableSpinner').style.display = 'block';

            try {
                // Fetch all employees
                const {
                    data,
                    error
                } = await supabaseClient
                    .from('employees')
                    .select('*');

                if (error) throw error;

                // Store employee data
                allEmployees = data;

                // Populate table
                populateEmployeesTable(data);

                // Hide loading spinner
                document.getElementById('employeesTableSpinner').style.display = 'none';
            } catch (error) {
                console.error("Error loading employee data:", error);
                document.getElementById('employeesTableSpinner').style.display = 'none';
                alert('Error loading employee data: ' + error.message);
            }
        }

        // Populate employees table
        function populateEmployeesTable(employees) {
            const tableBody = document.getElementById('employeesTableBody');
            tableBody.innerHTML = '';

            employees.forEach(function (employee) {
                const row = document.createElement('tr');

                // Mobile Number
                const mobileCell = document.createElement('td');
                mobileCell.textContent = employee['Mobile Number'] || '';
                row.appendChild(mobileCell);

                // Employee Name
                const nameCell = document.createElement('td');
                nameCell.textContent = employee['Employee Name'] || '';
                row.appendChild(nameCell);

                // Email
                const emailCell = document.createElement('td');
                emailCell.textContent = employee['Nic E-mail ID'] || '';
                row.appendChild(emailCell);

                // Designation
                const designationCell = document.createElement('td');
                designationCell.textContent = employee['Designation'] || '';
                row.appendChild(designationCell);

                // Status
                const statusCell = document.createElement('td');
                const hasBeenUpdated = employee['Modified Date'] !== null && employee['Modified Date'] !== undefined;
                const statusBadge = document.createElement('span');
                statusBadge.className = 'badge ' + (hasBeenUpdated ? 'bg-success' : 'bg-secondary');
                statusBadge.textContent = hasBeenUpdated ? 'Updated' : 'Pending';
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);

                // Actions
                const actionsCell = document.createElement('td');

                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-info me-2';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.title = 'View Details';
                viewBtn.onclick = function () {
                    viewEmployeeDetails(employee);
                };
                actionsCell.appendChild(viewBtn);

                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn btn-sm btn-primary';
                exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                exportBtn.title = 'Export PDF';
                exportBtn.onclick = function () {
                    exportEmployeePdf(employee);
                };
                actionsCell.appendChild(exportBtn);

                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });

            // Initialize DataTable if not already initialized
            if (!employeesTable) {
                employeesTable = $('#employeesTable').DataTable({
                    responsive: true,
                    pageLength: 10,
                    language: {
                        search: "Search employees:",
                        lengthMenu: "Show _MENU_ entries per page",
                        info: "Showing _START_ to _END_ of _TOTAL_ employees",
                        infoEmpty: "Showing 0 to 0 of 0 employees",
                        infoFiltered: "(filtered from _MAX_ total employees)"
                    }
                });
            } else {
                // Refresh the table
                employeesTable.clear().rows.add($(tableBody).find('tr')).draw();
            }
        }

// View employee details (for admin)
        function viewEmployeeDetails(employee) {
            // Create modal with employee details
            const modalHtml = `
            <div class="modal fade" id="employeeDetailsModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Employee Details</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h5 class="form-section-title">Personal Information</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Mobile Number:</strong> ${employee['Mobile Number'] || ''}</p>
                                    <p><strong>Employee Name:</strong> ${employee['Employee Name'] || ''}</p>
                                    <p><strong>Email ID:</strong> ${employee['Nic E-mail ID'] || ''}</p>
                                    <p><strong>Gender:</strong> ${employee['Gender'] || ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Father's Name:</strong> ${employee["Father's Name"] || ''}</p>
                                    <p><strong>Date of Birth:</strong> ${employee['Date of Birth'] || ''}</p>
                                    <p><strong>Nationality:</strong> ${employee['Nationality'] || ''}</p>
                                    <p><strong>Religion:</strong> ${employee['Religion'] || ''}</p>
                                    <p><strong>Category:</strong> ${employee['Category'] || ''}</p>
                                </div>
                            </div>
                            
                            <h5 class="form-section-title">Professional Information</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Designation:</strong> ${employee['Designation'] || ''}</p>
                                    <p><strong>Service:</strong> ${employee['Service'] || ''}</p>
                                    <p><strong>Organization:</strong> ${employee['Orgnazation'] || ''}</p>
                                    <p><strong>Date of Joining:</strong> ${employee['Organization from Date'] || ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Designation on Joining:</strong> ${employee['Designation on Joining Date'] || ''}</p>
                                    <p><strong>Type of Appointment:</strong> ${employee['Type of Appointment'] || ''}</p>
                                    <p><strong>Appointment Order Date:</strong> ${employee['Appointment Order Date'] || ''}</p>
                                    <p><strong>Roles:</strong> ${employee['Roles'] || ''}</p>
                                    <p><strong>Allotment Year:</strong> ${employee['Allotment Year'] || ''}</p>
                                </div>
                            </div>
                            
                            <h5 class="form-section-title">System Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Last Updated:</strong> ${employee['Modified Date'] ? new Date(employee['Modified Date']).toLocaleString() : 'Never'}</p>
                                    <p><strong>Created Date:</strong> ${employee['Created Date'] ? new Date(employee['Created Date']).toLocaleString() : ''}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Modified By:</strong> ${employee['Modified By'] || ''}</p>
                                    <p><strong>Created By:</strong> ${employee['Created By'] || ''}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportEmployeePdf(${JSON.stringify(employee).replace(/"/g, '&quot;')})">
                                <i class="fas fa-file-pdf me-2"></i> Export as PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to body
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('employeeDetailsModal'));
        modal.show();

        // Remove modal from DOM when hidden
        document.getElementById('employeeDetailsModal').addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(modalContainer);
        });
    }

    // Export employee data as PDF (for admin)
    function exportEmployeePdf(employee) {
        try {
            // Initialize jsPDF
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Add title
            doc.setFontSize(18);
            doc.setTextColor(128, 0, 0);
            doc.text('Employee Data Report', 150, 15, {
                align: 'center'
            });

            // Add subtitle
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Directorate of Agriculture Chhattisgarh', 150, 25, {
                align: 'center'
            });
            doc.text('Generated on: ' + new Date().toLocaleDateString(), 150, 35, {
                align: 'center'
            });

            // Prepare data for table
            const tableData = [
                ['Mobile Number', employee['Mobile Number'] || ''],
                ['Employee Name', employee['Employee Name'] || ''],
                ['Email ID', employee['Nic E-mail ID'] || ''],
                ['Designation', employee['Designation'] || ''],
                ['Service', employee['Service'] || ''],
                ['Status', employee['Modified Date'] ? 'Updated' : 'Pending']
            ];

            // Add table
            doc.autoTable({
                startY: 45,
                head: [['Field', 'Value']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [128, 0, 0],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    cellPadding: 3,
                    fontSize: 8
                }
            });

            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Directorate of Agriculture Chhattisgarh - Page ' + i + ' of ' + pageCount, 150, 200, {
                    align: 'center'
                });
            }

            // Save the PDF
            doc.save("Employee_Data_Report.pdf");
        } catch (error) {
            console.error("Error exporting to PDF:", error);
            alert('Error exporting to PDF: ' + error.message);
        }
    }

        // Function to generate a random OTP
        function generateOTP() {
            const digits = '0123456789';
            let OTP = '';
            for (let i = 0; i < 6; i++) {
                OTP += digits[Math.floor(Math.random() * 10)];
            }
            return OTP;
        }

        // Function to store OTP server-side (Google Sheets)
        async function storeOTPServerSide(mobileNumber, otp) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet

                // Use google.script.run to call the server-side function
                await google.script.run.storeOTPData(mobileNumber, otp, spreadsheetId);
            } catch (error) {
                console.error("Error storing OTP:", error);
                alert('Error storing OTP: ' + error.message);
            }
        }

        // Get OTP and expiry time from server-side storage (Google Sheets)
        async function getServerSideOTP(mobileNumber) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result) {
                            resolve(result);
                        } else {
                            reject('OTP not found on server');
                        }
                    })
                    .withFailureHandler(function (error) {
                        reject(error);
                    })
                    .getOTPData(mobileNumber);
            });
        }

        // Function to send email (Google Apps Script)
        async function sendEmail(email, subject, body) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Email sent successfully:", response);
                        resolve(response);
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error sending email:", error);
                        reject(error);
                    })
                    .sendEmailGAS(email, subject, body);
            });
        }

        // Google Apps Script function to send email
        // The following function must be in Code.gs
        /**
         * @param {string} email The recipient's email address.
         * @param {string} subject The email subject.
         * @param {string} body The email body.
         */
        function sendEmailGAS(email, subject, body) {
            GmailApp.sendEmail(email, subject, body);
        }

        // Function to get OTP data from the server
        function getOTPData(mobileNumber) {
            try {
                // Get the spreadsheet - replace with your actual spreadsheet ID
                var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s'; // Replace with the ID of your Google Sheet
                var sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName('OTPData');

                // If sheet doesn't exist, return null
                if (!sheet) {
                    return null;
                }

                // Get data range
                var dataRange = sheet.getDataRange();
                var values = dataRange.getValues();
                var headers = values[0];

                var mobileCol = headers.indexOf('Mobile Number');
                if (mobileCol == -1) {
                    Logger.log('Mobile Number column not found');
                    return null;
                }

                // Search for the employee row
                var employeeRow = -1;
                for (var i = 1; i < values.length; i++) {
                    if (values[i][mobileCol] == mobileNumber) {
                        employeeRow = i + 1; // +1 because array is 0-indexed but sheets are 1-indexed
                        break;
                    }
                }

                // If employee found, return the OTP and Expiry Time
                if (employeeRow > 0) {
                    var otp = sheet.getRange(employeeRow, headers.indexOf('OTP') + 1).getValue();
                    var expiryTime = sheet.getRange(employeeRow, headers.indexOf('Expiry Time') + 1).getValue();
                    return {
                        storedOtp: otp,
                        expiryTime: expiryTime.getTime()
                    };
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error getting OTP data:", error);
                return null;
            }
        }

        // Search for employee by mobile number
        async function searchEmployee(mobileNumber) {
            console.log("Search function called with mobile number:", mobileNumber);

            if (!mobileNumber) {
                showMessage('searchError', 'Please enter your mobile number', true);
                return;
            }

            // Show spinner
            document.getElementById('searchSpinner').style.display = 'block';
            document.getElementById('searchButton').disabled = true;

            try {
                console.log("Querying Supabase for mobile number:", mobileNumber);

                // Fetch all employees
                const {
                    data,
                    error
                } = await supabaseClient
                    .from('employees')
                    .select('Mobile Number, "Nic E-mail ID", "Employee Name"')
                    .eq('Mobile Number', mobileNumber);

                console.log("Supabase response:", {
                    data,
                    error
                });

                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;

                if (error) {
                    console.error("Error from Supabase:", error);
                    showMessage('searchError', 'Database error: ' + error.message, true);
                    return;
                }

                if (data && data.length > 0) {
                    // Employee found
                    currentEmployee = data[0];
                    console.log("Employee data loaded:", currentEmployee);

                    // Send OTP to email
                    const otp = generateOTP();
                    await storeOTPServerSide(mobileNumber, otp);
                    await sendEmailOTP(currentEmployee["Nic E-mail ID"], otp);

                    // Show OTP verification
                    document.getElementById('searchCard').classList.add('d-none');
                    document.getElementById('otpCard').classList.remove('d-none');

                    // Display masked mobile number
                    const mobileNumber = currentEmployee['Mobile Number'];
                    const maskedNumber = mobileNumber.substring(0, 2) + '****' + mobileNumber.substring(mobileNumber.length - 4);
                    document.getElementById('maskedMobile').textContent = maskedNumber;

                } else {
                    console.log("No employee found with mobile number:", mobileNumber);
                    showMessage('searchError', 'No employee found with this mobile number', true);
                }
            } catch (error) {
                console.error("Error in searchEmployee:", error);

                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;

                // Show error message
                showMessage('searchError', 'Error: ' + error.message, true);
            }
        }

        // Show login options
        function showLoginOptions() {
            console.log("Showing login options card");
            document.getElementById('searchCard').classList.add('d-none');
            document.getElementById('adminLoginCard').classList.add('d-none');
            document.getElementById('otpCard').classList.add('d-none');
            document.getElementById('verificationCard').classList.add('d-none');
            document.getElementById('reviewCard').classList.add('d-none');
            document.getElementById('successCard').classList.add('d-none');
            document.getElementById('adminDashboardCard').classList.add('d-none');
            document.getElementById('loginOptionsCard').classList.remove('d-none');
            document.getElementById('stepIndicator').classList.add('d-none');

            // Clear inputs
            document.getElementById('mobileNumber').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';

            // Hide error messages
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.classList.add('d-none'));
        }

        // Show admin login card
        function showAdminLogin() {
            console.log("Showing admin login");
            document.getElementById('loginOptionsCard').classList.add('d-none');
            document.getElementById('adminLoginCard').classList.remove('d-none');
        }

        // Handle admin login
        function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Show admin dashboard
                document.getElementById('adminLoginCard').classList.add('d-none');
                document.getElementById('adminDashboardCard').classList.remove('d-none');

                // Load employee data
                loadEmployeeData();
            } else {
                // Show error message
                const errorElement = document.getElementById('adminLoginError');
                errorElement.textContent = 'Invalid username or password';
                errorElement.classList.remove('d-none');
            }
        }

        // Admin logout
        function adminLogout() {
            document.getElementById('adminDashboardCard').classList.add('d-none');
            document.getElementById('loginOptionsCard').classList.remove('d-none');

            // Clear admin login form
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';

            // Clear any selected admin tab
            const tabs = document.querySelectorAll('.nav-link');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById('employees-tab').classList.add('active');

            // Show the login options
            showLoginOptions();
        }

        // Load employee data for admin dashboard
        async function loadEmployeeData() {
            console.log("Loading employee data");

            // Show loading spinner
            document.getElementById('employeesTableSpinner').style.display = 'block';

            try {
                // Fetch all employees
                const {
                    data,
                    error
                } = await supabaseClient
                    .from('employees')
                    .select('*');

                if (error) throw error;

                // Store employee data
                allEmployees = data;

                // Populate table
                populateEmployeesTable(data);

                // Hide loading spinner
                document.getElementById('employeesTableSpinner').style.display = 'none';
            } catch (error) {
                console.error("Error loading employee data:", error);
                document.getElementById('employeesTableSpinner').style.display = 'none';
                alert('Error loading employee data: ' + error.message);
            }
        }

    
    /**
     * Now, let's put the rest of your code here, including:
     *
     *  - all functions related to generating report data (charts, CSV, excel etc)
     *  - all functions related to the employee data update form (otp verification, 
     *    field verification, review screen etc)
     *
     * Note: The code for those functions have not changed from the previous ones, so you can 
     * just copy it from the previous codes and paste it here
     */
    

        // Initialize UI and event listeners
        function initUI() {
            // Hide all cards except login options
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => card.classList.add('d-none'));
            document.getElementById('loginOptionsCard').classList.remove('d-none');

            // Clear any existing alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.classList.add('d-none'));
        }

        // Test connection to Supabase
        async function testConnection() {
            try {
                console.log("Testing connection to Supabase...");
                const {
                    data,
                    error
                } = await supabaseClient
                    .from('employees')
                    .select('count');

                if (error) {
                    console.error("Connection test failed:", error);
                    showMessage('searchError', 'Database connection error. Please try again later.', true);
                } else {
                    console.log("Connection successful!");
                }
            } catch (error) {
                console.error("Error in connection test:", error);
                showMessage('searchError', 'Error connecting to database. Please try again later.', true);
            }
        }

        // Show message
        function showMessage(elementId, message, isError) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'message';
            if (isError) {
                element.classList.add('alert-danger');
                element.classList.remove('alert-success');
            } else {
                element.classList.add('alert-success');
                element.classList.remove('alert-danger');
            }
            element.classList.remove('d-none');

            // Hide message after 5 seconds
            setTimeout(function () {
                element.classList.add('d-none');
            }, 5000);
        }

        // Check for saved draft on page load
        function checkForSavedDraft(mobileNumber) {
            console.log("Checking for saved draft for:", mobileNumber);

            try {
                const draftKey = 'employeeDraft_' + mobileNumber;
                const savedDraft = localStorage.getItem(draftKey);

                if (savedDraft) {
                    const draftData = JSON.parse(savedDraft);
                    const timestamp = new Date(draftData.timestamp);
                    const now = new Date();
                    const hoursDiff = Math.abs(now - timestamp) / 36e5; // Convert to hours

                    console.log("Found saved draft from:", timestamp);

                    // If draft is less than 24 hours old, ask to restore
                    if (hoursDiff < 24) {
                        const confirm = window.confirm('You have a saved draft from ' + timestamp.toLocaleString() +
                            '. Would you like to restore it?');

                        if (confirm) {
                            console.log("Restoring saved draft");

                            // Restore the saved state
                            currentEmployee = draftData.employee;
                            fieldStatuses = draftData.statuses;
                            editedFields = draftData.edits;

                            // Show verification card
                            document.getElementById('searchCard').classList.add('d-none');
                            document.getElementById('verificationCard').classList.remove('d-none');

                            // Update step indicator
                            updateStepIndicator(2);

                            // Generate verification fields
                            generateVerificationFields();

                            // Update progress
                            updateProgress();
                            checkAllFieldsVerified();

                            return true;
                        }
                    }
                }
            } catch (error) {
                console.error("Error checking for saved draft:", error);
            }

            return false;
        }
        
    // Get the spreadsheet - replace with your actual spreadsheet ID
    var spreadsheetId = '1jmjT3x0Q-V-0_nL52Q65w77Y-4Xj4G63hQGk9m3jD6s';

    // Initialize Supabase client
    const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';

    // Test connection
    async function testConnection() {
        try {
            // Test database connection
            const {
                data,
                error
            } = await supabaseClient
                .from('employees')
                .select('count');
            if (error) {
                console.error("Connection test failed:", error);
                showMessage('searchError', 'Database connection error. Please try again later.', true);
            } else {
                console.log("Connection test successful!");
            }
        } catch (error) {
            console.error("Error in connection test:", error);
            showMessage('searchError', 'Error connecting to database. Please try again later.', true);
        }
    }
</script>

</html>


        
