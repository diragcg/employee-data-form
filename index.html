<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Data Updation System - DirAgCg</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-color: #800000; /* Maroon red */
            --secondary-color: #333333; /* Dark gray/black */
            --light-color: #f8f8f8;
            --card-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f5;
            color: var(--secondary-color);
            padding-top: 20px;
            padding-bottom: 50px;
        }
        
        .container {
            max-width: 1000px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h3 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: none;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
        }
        
        .btn {
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 8px;
            transition: all 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(128, 0, 0, 0.3);
            transform: translateY(0);
        }
        
        .btn-primary:hover {
            background-color: #600000;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(128, 0, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(128, 0, 0, 0.3);
        }
        
        .btn-secondary {
            background-color: #444;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary:hover {
            background-color: #333;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-section-title {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: var(--primary-color);
        }
        
        .alert {
            border-radius: 8px;
            font-weight: 500;
        }
        
        .required-field::after {
            content: " *";
            color: var(--primary-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #777;
            font-size: 0.9rem;
        }
        
        .field-row {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .field-row:last-child {
            border-bottom: none;
        }
        
        .field-label {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .field-value {
            color: #555;
        }
        
        .verification-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-field {
            display: none;
            margin-top: 10px;
        }
        
        .badge {
            font-weight: 500;
            padding: 6px 10px;
        }
        
        .badge-verified {
            background-color: #28a745;
        }
        
        .badge-edited {
            background-color: #fd7e14;
        }
        
        .badge-pending {
            background-color: #6c757d;
        }
        
        .progress-section {
            margin: 20px 0;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-number {
            background-color: #28a745;
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            color: #777;
        }
        
        .step.active .step-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .step.completed .step-title {
            color: #28a745;
        }
        
        .step-line {
            position: absolute;
            top: 15px;
            height: 2px;
            background-color: #ddd;
            width: 100%;
            left: -50%;
            z-index: -1;
        }
        
        .step:first-child .step-line {
            display: none;
        }
        
        .step.completed .step-line {
            background-color: #28a745;
        }
        
        .logo {
            max-width: 100px;
            margin-bottom: 15px;
        }
        
        .year-picker {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Login styles */
        .login-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .login-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
        }
        
        .login-option:hover {
            transform: translateY(-5px);
        }
        
        .login-option.active {
            background-color: rgba(128, 0, 0, 0.1);
            border: 2px solid var(--primary-color);
        }
        
        .login-option i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        /* Admin dashboard styles */
        .dashboard-card {
            margin-bottom: 20px;
        }
        
        .dashboard-card .card-header {
            font-size: 1.2rem;
        }
        
        .stats-box {
            text-align: center;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stats-label {
            color: #555;
            font-size: 0.9rem;
        }
        
        .employee-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .employee-item:last-child {
            border-bottom: none;
        }
        
        .employee-name {
            font-weight: 500;
        }
        
        .employee-status.updated {
            color: #28a745;
        }
        
        .employee-status.pending {
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .step-title {
                font-size: 0.7rem;
            }
            
            .login-options {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h3>EMPLOYEE DATA SELF VERIFICATION & UPDATION SYSTEM FOR SPARROW</h3>
            <p>Directorate of Agriculture Chhattisgarh</p>
        </div>
        
        <!-- Login Card -->
        <div class="card" id="loginCard">
            <div class="card-header">
                <i class="fas fa-sign-in-alt me-2"></i> Login to System
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-none" id="loginError"></div>
                
                <div class="login-options">
                    <div class="login-option active" id="employeeLoginOption">
                        <i class="fas fa-user"></i>
                        <h5>Employee Login</h5>
                        <p>Login with your mobile number</p>
                    </div>
                    <div class="login-option" id="adminLoginOption">
                        <i class="fas fa-user-shield"></i>
                        <h5>Admin Login</h5>
                        <p>Login to admin dashboard</p>
                    </div>
                </div>
                
                <!-- Employee Login Form -->
                <div class="login-form active" id="employeeLoginForm">
                    <div class="mb-3">
                        <label for="employeeMobile" class="form-label required-field">Mobile Number</label>
                        <input type="text" class="form-control" id="employeeMobile" placeholder="Enter your registered mobile number">
                        <div class="form-text">Please enter the mobile number registered in E-office.</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="employeeLoginButton" type="button">
                            <i class="fas fa-sign-in-alt me-2"></i> LOGIN
                        </button>
                    </div>
                </div>
                
                <!-- Admin Login Form -->
                <div class="login-form" id="adminLoginForm">
                    <div class="mb-3">
                        <label for="adminUserId" class="form-label required-field">User ID</label>
                        <input type="text" class="form-control" id="adminUserId" placeholder="Enter admin user ID">
                    </div>
                    
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label required-field">Password</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="adminLoginButton" type="button">
                            <i class="fas fa-sign-in-alt me-2"></i> LOGIN
                        </button>
                    </div>
                </div>
                
                <div class="loading-spinner" id="loginSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Logging in...</div>
                </div>
            </div>
        </div>
        
        <!-- Admin Dashboard Card -->
        <div class="card d-none" id="adminDashboardCard">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i> Admin Dashboard
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-info-circle me-2"></i> Welcome to the Admin Dashboard. Here you can monitor employee data updation status.
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-number" id="totalEmployees">0</div>
                            <div class="stats-label">Total Employees</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-number" id="updatedProfiles">0</div>
                            <div class="stats-label">Updated Profiles</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-number" id="pendingProfiles">0</div>
                            <div class="stats-label">Pending Profiles</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-users me-2"></i> Employee Update Status
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="employeeSearch" placeholder="Search employees...">
                        </div>
                        
                        <div class="employee-list" id="employeeList">
                            <!-- Employee list will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button class="btn btn-secondary" id="adminLogoutButton" type="button">
                        <i class="fas fa-sign-out-alt me-2"></i> LOGOUT
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Step Indicator -->
        <div class="step-indicator d-none" id="stepIndicator">
            <div class="step active" id="step1">
                <div class="step-line"></div>
                <div class="step-number">1</div>
                <div class="step-title">Search</div>
            </div>
            <div class="step" id="step2">
                <div class="step-line"></div>
                <div class="step-number">2</div>
                <div class="step-title">Verify</div>
            </div>
            <div class="step" id="step3">
                <div class="step-line"></div>
                <div class="step-number">3</div>
                <div class="step-title">Review</div>
            </div>
            <div class="step" id="step4">
                <div class="step-line"></div>
                <div class="step-number">4</div>
                <div class="step-title">Submit</div>
            </div>
        </div>
        
        <!-- Search Card -->
        <div class="card d-none" id="searchCard">
            <div class="card-header">
                <i class="fas fa-search me-2"></i> Search Your Record
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-none" id="searchError"></div>
                
                <div class="mb-3">
                    <label for="mobileNumber" class="form-label required-field">Mobile Number</label>
                    <input type="text" class="form-control" id="mobileNumber" placeholder="Enter your registered mobile number">
                    <div class="form-text">Please enter the mobile number registered in E-office.</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="searchButton" type="button">
                        <i class="fas fa-search me-2"></i> FIND MY RECORD
                    </button>
                </div>
                
                <div class="loading-spinner" id="searchSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Searching for your record...</div>
                </div>
            </div>
        </div>
        
        <!-- Verification Card -->
        <div class="card d-none" id="verificationCard">
            <div class="card-header">
                <i class="fas fa-user-check me-2"></i> Verify Your Information
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> Please verify each field below. Click "Yes" if the information is correct, or "No" to edit.
                </div>
                
                <div class="progress-section">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Verification Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>
                
                <div id="fieldsContainer">
                    <!-- Fields will be dynamically added here -->
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" id="backButton">
                        <i class="fas fa-arrow-left me-2"></i> GO BACK
                    </button>
                    <button type="button" class="btn btn-primary" id="saveDraftButton">
                        <i class="fas fa-save me-2"></i> SAVE DRAFT
                    </button>
                    <button type="button" class="btn btn-success" id="continueButton" disabled>
                        <i class="fas fa-check me-2"></i> CONTINUE
                    </button>
                </div>
                
                <div class="loading-spinner" id="verifySpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Processing...</div>
                </div>
            </div>
        </div>
        
        <!-- Review Card -->
        <div class="card d-none" id="reviewCard">
            <div class="card-header">
                <i class="fas fa-clipboard-check me-2"></i> Review Your Information
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> Please review all your information below before final submission.
                </div>
                
                <div id="reviewContainer">
                    <!-- Review information will be added here -->
                </div>
                
                <div class="form-check mb-4 mt-3">
                    <input class="form-check-input" type="checkbox" id="confirmCheck">
                    <label class="form-check-label" for="confirmCheck">
                        I confirm that all the information provided is accurate and complete.
                    </label>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="backToVerifyButton">
                        <i class="fas fa-arrow-left me-2"></i> BACK TO VERIFY
                    </button>
                    <button type="button" class="btn btn-success" id="submitButton" disabled>
                        <i class="fas fa-paper-plane me-2"></i> SUBMIT
                    </button>
                </div>
                
                <div class="loading-spinner" id="submitSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Submitting your information...</div>
                </div>
            </div>
        </div>
        
        <!-- Success Card -->
        <div class="card d-none" id="successCard">
            <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i> Submission Successful
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 64px;"></i>
                </div>
                <h3 class="mb-3">Thank You!</h3>
                <p>Your information has been successfully verified and submitted.</p>
                <div class="mt-4">
                    <button class="btn btn-primary me-2" id="downloadPdfButton" type="button">
                        <i class="fas fa-file-pdf me-2"></i> DOWNLOAD PDF
                    </button>
                    <button class="btn btn-secondary" id="startOverButton" type="button">
                        <i class="fas fa-redo me-2"></i> START OVER
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2025 सूचना प्रौद्योगिकी शाखा, संचालनालय कृषि छत्तीसगढ. रायपुर . सर्वाधिकार सुरक्षित.</p>
        </div>
    </div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS - Make sure to load this before our custom script -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Global variables
        let currentEmployee = null;
        let fieldStatuses = {};
        let editedFields = {};
        let isAdminLoggedIn = false;
        
        // Admin credentials
        const ADMIN_USER_ID = '7354900500';
        const ADMIN_PASSWORD = '9329807288';
        
        // Generate year options for year picker (1950 to current year)
        function generateYearOptions() {
            const currentYear = new Date().getFullYear();
            let options = [];
            for (let year = currentYear; year >= 1950; year--) {
                options.push(year.toString());
            }
            return options;
        }
        
        // Field definitions - matching your table structure exactly with dropdown options
        const fieldDefinitions = [
            { id: "Mobile Number", label: "Mobile Number", type: "text", required: true, readonly: true },
            { id: "Employee Name", label: "Employee Name", type: "text", required: true },
            { id: "Nic E-mail ID", label: "Email ID", type: "email" },
            { id: "Gender", label: "Gender", type: "select", options: ["Male", "Female", "Other"] },
            { id: "Father's Name", label: "Father's Name", type: "text" },
            { id: "Date of Birth", label: "Date of Birth", type: "date" },
            { id: "Nationality", label: "Nationality", type: "select", options: ["Indian", "NRI"] },
            { id: "Religion", label: "Religion", type: "select", options: ["Hindu", "Jain", "Buddhist", "Christian", "Islam", "Sikh", "Others"] },
            { id: "Category", label: "Category", type: "select", options: ["Unreserved", "OBC", "SC", "ST"] },
            { id: "Designation", label: "Designation", type: "select", options: [
                "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF", 
                "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA", 
                "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO", 
                "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO", 
                "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
            ]},
            { id: "Service", label: "Service", type: "select", options: ["Permanent", "Not Permanent"] },
            { id: "Orgnazation", label: "Organization", type: "select", options: ["Directorate of Agriculture", "Deputation"] },
            { id: "Organization from Date", label: "Date of Joining", type: "date" },
            { id: "Designation on Joining Date", label: "Designation on Joining", type: "select", options: [
                "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF", 
                "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA", 
                "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO", 
                "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO", 
                "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
            ]},
            { id: "Type of Appointment", label: "Type of Appointment", type: "select", options: ["Regular", "Temporary"] },
            { id: "Appointment Order Date", label: "Appointment Order Date", type: "date" },
            { id: "Roles", label: "Roles (In CR reporting System)", type: "text" },
            { id: "Allotment Year", label: "Allotment Year (Year of Promotion)", type: "year", options: generateYearOptions() }
        ];
        
       // Initialize Supabase client
const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
let supabaseClient;

// Document ready
document.addEventListener('DOMContentLoaded', function() {
    console.log("Document loaded");
    
    try {
        // Initialize Supabase
        supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        console.log("Supabase client initialized");
        
        // Test connection
        testConnection();
        
        // Initialize login event listeners
        initLoginListeners();
    } catch (error) {
        console.error("Error initializing:", error);
        showMessage('loginError', 'Error initializing application. Please try again later.', true);
    }
});

// Initialize login event listeners
function initLoginListeners() {
    console.log("Initializing login listeners");
    
    // Login option selection
    document.getElementById('employeeLoginOption').addEventListener('click', function() {
        console.log("Employee login option clicked");
        switchToEmployeeLogin();
    });
    
    document.getElementById('adminLoginOption').addEventListener('click', function() {
        console.log("Admin login option clicked");
        switchToAdminLogin();
    });
    
    // Login buttons
    document.getElementById('employeeLoginButton').addEventListener('click', function() {
        console.log("Employee login button clicked");
        loginEmployee();
    });
    
    document.getElementById('adminLoginButton').addEventListener('click', function() {
        console.log("Admin login button clicked");
        loginAdmin();
    });
    
    // Logout button
    if (document.getElementById('adminLogoutButton')) {
        document.getElementById('adminLogoutButton').addEventListener('click', function() {
            console.log("Admin logout button clicked");
            logoutAdmin();
        });
    }
    
    // Employee search in admin dashboard
    if (document.getElementById('employeeSearch')) {
        document.getElementById('employeeSearch').addEventListener('input', function() {
            console.log("Employee search input");
            filterEmployees();
        });
    }
    
    // Search button
    document.getElementById('searchButton').addEventListener('click', function() {
        console.log("Search button clicked");
        searchEmployee();
    });
    
    // Back button
    document.getElementById('backButton').addEventListener('click', function() {
        console.log("Back button clicked");
        goBackToSearch();
    });
    
    // Save draft button
    document.getElementById('saveDraftButton').addEventListener('click', function() {
        console.log("Save draft button clicked");
        saveDraft();
    });
    
    // Continue button
    document.getElementById('continueButton').addEventListener('click', function() {
        console.log("Continue button clicked");
        showReview();
    });
    
    // Back to verify button
    document.getElementById('backToVerifyButton').addEventListener('click', function() {
        console.log("Back to verify button clicked");
        goBackToVerify();
    });
    
    // Confirm checkbox
    document.getElementById('confirmCheck').addEventListener('change', function() {
        console.log("Confirm checkbox changed");
        toggleSubmitButton();
    });
    
    // Submit button
    document.getElementById('submitButton').addEventListener('click', function() {
        console.log("Submit button clicked");
        submitForm();
    });
    
    // Download PDF button
    document.getElementById('downloadPdfButton').addEventListener('click', function() {
        console.log("Download PDF button clicked");
        generatePDF();
    });
    
    // Start over button
    document.getElementById('startOverButton').addEventListener('click', function() {
        console.log("Start over button clicked");
        startOver();
    });
}

// Switch to employee login form
function switchToEmployeeLogin() {
    document.getElementById('employeeLoginOption').classList.add('active');
    document.getElementById('adminLoginOption').classList.remove('active');
    document.getElementById('employeeLoginForm').classList.add('active');
    document.getElementById('adminLoginForm').classList.remove('active');
    console.log("Switched to employee login");
}

// Switch to admin login form
function switchToAdminLogin() {
    document.getElementById('employeeLoginOption').classList.remove('active');
    document.getElementById('adminLoginOption').classList.add('active');
    document.getElementById('employeeLoginForm').classList.remove('active');
    document.getElementById('adminLoginForm').classList.add('active');
    console.log("Switched to admin login");
}

// Login employee
function loginEmployee() {
    const mobileNumber = document.getElementById('employeeMobile').value.trim();
    console.log("Employee login attempt with mobile:", mobileNumber);
    
    if (!mobileNumber) {
        showMessage('loginError', 'Please enter your mobile number', true);
        return;
    }
    
    // Show spinner
    document.getElementById('loginSpinner').style.display = 'block';
    document.getElementById('employeeLoginButton').disabled = true;
    
    // Transfer mobile number to search field and proceed to search card
    document.getElementById('mobileNumber').value = mobileNumber;
    
    // Hide login card and show search card and step indicator
    setTimeout(function() {
        document.getElementById('loginSpinner').style.display = 'none';
        document.getElementById('employeeLoginButton').disabled = false;
        document.getElementById('loginCard').classList.add('d-none');
        document.getElementById('searchCard').classList.remove('d-none');
        document.getElementById('stepIndicator').classList.remove('d-none');
        updateStepIndicator(1);
        console.log("Employee login successful, showing search card");
    }, 1000);
}

// Login admin
async function loginAdmin() {
    const userId = document.getElementById('adminUserId').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    console.log("Admin login attempt");
    
    if (!userId || !password) {
        showMessage('loginError', 'Please enter both User ID and Password', true);
        return;
    }
    
    // Show spinner
    document.getElementById('loginSpinner').style.display = 'block';
    document.getElementById('adminLoginButton').disabled = true;
    
    // Check admin credentials
    if (userId === ADMIN_USER_ID && password === ADMIN_PASSWORD) {
        // Successful login - load admin dashboard
        isAdminLoggedIn = true;
        await loadAdminDashboard();
        
        // Hide login card and show admin dashboard
        document.getElementById('loginSpinner').style.display = 'none';
        document.getElementById('adminLoginButton').disabled = false;
        document.getElementById('loginCard').classList.add('d-none');
        document.getElementById('adminDashboardCard').classList.remove('d-none');
        console.log("Admin login successful, showing dashboard");
    } else {
        // Failed login
        document.getElementById('loginSpinner').style.display = 'none';
        document.getElementById('adminLoginButton').disabled = false;
        showMessage('loginError', 'Invalid User ID or Password', true);
        console.log("Admin login failed - invalid credentials");
    }
}

// Logout admin
function logoutAdmin() {
    console.log("Admin logout");
    isAdminLoggedIn = false;
    document.getElementById('adminDashboardCard').classList.add('d-none');
    document.getElementById('loginCard').classList.remove('d-none');
    
    // Clear admin login fields
    document.getElementById('adminUserId').value = '';
    document.getElementById('adminPassword').value = '';
    switchToEmployeeLogin();
}

// Load admin dashboard data
async function loadAdminDashboard() {
    console.log("Loading admin dashboard data");
    try {
        // Fetch all employees from the database
        const { data: employees, error } = await supabaseClient
            .from('employees')
            .select('*');
        
        if (error) {
            console.error("Error fetching employees:", error);
            return;
        }
        
        // Count total, updated, and pending profiles
        const totalCount = employees.length;
        
        // Assuming a profile is updated if it has a "last_updated" field or similar
        const updatedCount = employees.filter(emp => emp.last_updated).length;
        const pendingCount = totalCount - updatedCount;
        
        // Update stats display
        document.getElementById('totalEmployees').textContent = totalCount;
        document.getElementById('updatedProfiles').textContent = updatedCount;
        document.getElementById('pendingProfiles').textContent = pendingCount;
        
        // Populate employee list
        populateEmployeeList(employees);
        console.log("Admin dashboard loaded successfully");
        
    } catch (error) {
        console.error("Error loading admin dashboard:", error);
    }
}

// Populate employee list in admin dashboard
function populateEmployeeList(employees) {
    console.log("Populating employee list with", employees.length, "employees");
    const container = document.getElementById('employeeList');
    container.innerHTML = '';
    
    if (employees.length === 0) {
        container.innerHTML = '<div class="text-center p-3">No employees found</div>';
        return;
    }
    
    employees.forEach(function(employee) {
        const isUpdated = employee.last_updated ? true : false;
        
        const employeeItem = document.createElement('div');
        employeeItem.className = 'employee-item';
        employeeItem.dataset.name = employee['Employee Name'] || '';
        employeeItem.dataset.mobile = employee['Mobile Number'] || '';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'employee-name';
        nameDiv.textContent = employee['Employee Name'] || 'Unknown';
        
        const mobileDiv = document.createElement('div');
        mobileDiv.className = 'employee-mobile';
        mobileDiv.textContent = employee['Mobile Number'] || '';
        
        const statusDiv = document.createElement('div');
        statusDiv.className = isUpdated ? 'employee-status updated' : 'employee-status pending';
        statusDiv.textContent = isUpdated ? 'Updated' : 'Pending';
        
        employeeItem.appendChild(nameDiv);
        employeeItem.appendChild(mobileDiv);
        employeeItem.appendChild(statusDiv);
        
        container.appendChild(employeeItem);
    });
}

// Filter employees in admin dashboard
function filterEmployees() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    const employeeItems = document.querySelectorAll('#employeeList .employee-item');
    
    console.log("Filtering employees with search term:", searchTerm);
    
    employeeItems.forEach(function(item) {
        const name = item.dataset.name.toLowerCase();
        const mobile = item.dataset.mobile.toLowerCase();
        
        if (name.includes(searchTerm) || mobile.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// Test connection to Supabase
async function testConnection() {
    try {
        console.log("Testing connection to Supabase...");
        
        // Simple query to test connection
        const { data, error } = await supabaseClient
            .from('employees')
            .select('count');
        
        if (error) {
            console.error("Connection test failed:", error);
        } else {
            console.log("Connection successful!");
        }
    } catch (error) {
        console.error("Error in connection test:", error);
    }
}

// Search for employee by mobile number
async function searchEmployee() {
    console.log("Search function called");
    
    const mobileNumber = document.getElementById('mobileNumber').value.trim();
    console.log("Mobile number entered:", mobileNumber);
    
    if (!mobileNumber) {
        showMessage('searchError', 'Please enter your mobile number', true);
        return;
    }
    
    // Show spinner
    document.getElementById('searchSpinner').style.display = 'block';
    document.getElementById('searchButton').disabled = true;
    
    try {
        console.log("Querying Supabase for mobile number:", mobileNumber);
        
        // Query Supabase for employee with this mobile number
        const { data, error } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('Mobile Number', mobileNumber);
        
        console.log("Query complete. Data:", data);
        console.log("Query error:", error);
        
        // Hide spinner
        document.getElementById('searchSpinner').style.display = 'none';
        document.getElementById('searchButton').disabled = false;
        
        if (error) {
            console.error("Error from Supabase:", error);
            showMessage('searchError', 'Database error: ' + error.message, true);
            return;
        }
        
        if (data && data.length > 0) {
            console.log("Employee found:", data[0]);
            
            // Store employee data
            currentEmployee = data[0];
            
            // Initialize field statuses
            fieldDefinitions.forEach(function(field) {
                fieldStatuses[field.id] = 'pending';
            });
            
            // Show verification card
            document.getElementById('searchCard').classList.add('d-none');
            document.getElementById('verificationCard').classList.remove('d-none');
            
            // Update step indicator
            updateStepIndicator(2);
            
            // Generate verification fields
            generateVerificationFields();
        } else {
            console.log("No employee found with mobile number:", mobileNumber);
            showMessage('searchError', 'No employee found with this mobile number', true);
        }
    } catch (error) {
        console.error("Exception in searchEmployee:", error);
        
        // Hide spinner
        document.getElementById('searchSpinner').style.display = 'none';
        document.getElementById('searchButton').disabled = false;
        
        // Show error message
        showMessage('searchError', 'Error: ' + error.message, true);
    }
}

// Generate verification fields
function generateVerificationFields() {
    console.log("Generating verification fields");
    const container = document.getElementById('fieldsContainer');
    container.innerHTML = '';
    
    fieldDefinitions.forEach(function(field) {
        console.log("Processing field:", field.id, field.label);
        const value = currentEmployee[field.id] || '';
        const fieldId = field.id.replace(/[^a-zA-Z0-9]/g, '_');
        
        const fieldRow = document.createElement('div');
        fieldRow.className = 'field-row';
        fieldRow.id = 'row-' + fieldId;
        
        // Create inner content
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        
        // Label column
        const labelCol = document.createElement('div');
        labelCol.className = 'col-md-4';
        const labelDiv = document.createElement('div');
        labelDiv.className = 'field-label';
        labelDiv.textContent = field.label;
        labelCol.appendChild(labelDiv);
        
        // Value column
        const valueCol = document.createElement('div');
        valueCol.className = 'col-md-4';
        const valueDiv = document.createElement('div');
        valueDiv.className = 'field-value';
        valueDiv.id = 'value-' + fieldId;
        valueDiv.textContent = value;
        valueCol.appendChild(valueDiv);
        
        // Verification column
        const verifyCol = document.createElement('div');
        verifyCol.className = 'col-md-4';
        
        // Verification buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'verification-buttons';
        
        // Yes button
        const yesButton = document.createElement('button');
        yesButton.className = 'btn btn-sm btn-outline-success verify-yes';
        yesButton.setAttribute('data-field', field.id);
        yesButton.innerHTML = '<i class="fas fa-check"></i> Yes';
        yesButton.onclick = function() {
            console.log("Yes clicked for field:", field.id);
            verifyField(field.id, true);
        };
        
        // No button
        const noButton = document.createElement('button');
        noButton.className = 'btn btn-sm btn-outline-danger verify-no';
        noButton.setAttribute('data-field', field.id);
        noButton.innerHTML = '<i class="fas fa-times"></i> No';
        noButton.onclick = function() {
            console.log("No clicked for field:", field.id);
            verifyField(field.id, false);
        };
        
        // Status badge
        const statusSpan = document.createElement('span');
        statusSpan.className = 'ms-2 badge badge-pending';
        statusSpan.id = 'status-' + fieldId;
        statusSpan.textContent = 'Pending';
        
        // Add buttons and badge to buttons div
        buttonsDiv.appendChild(yesButton);
        buttonsDiv.appendChild(noButton);
        buttonsDiv.appendChild(statusSpan);
        
        // Edit field div
        const editDiv = document.createElement('div');
        editDiv.className = 'edit-field';
        editDiv.id = 'edit-' + fieldId;
        editDiv.style.display = 'none';
        
        // Create input field based on field type
        if (field.type === 'select' && field.options) {
            // Create select element
            const select = document.createElement('select');
            select.className = 'form-select';
            select.id = 'input-' + fieldId;
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select ' + field.label;
            select.appendChild(defaultOption);
            
            // Add options
            field.options.forEach(function(opt) {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (value === opt) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            editDiv.appendChild(select);
        } else if (field.type === 'date') {
            // Create date input element
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'form-control';
            input.id = 'input-' + fieldId;
            
            // Format date value if it exists
            if (value) {
                try {
                    // Try to format the date
                    const dateObj = new Date(value);
                    if (!isNaN(dateObj.getTime())) {
                        input.value = dateObj.toISOString().split('T')[0];
                    } else {
                        input.value = value;
                    }
                } catch (e) {
                    console.error("Error formatting date:", e);
                    input.value = value;
                }
            }
            
            if (field.readonly) {
                input.readOnly = true;
            }
            
            editDiv.appendChild(input);
        } else if (field.type === 'year') {
            // Create select element for year picker
            const select = document.createElement('select');
            select.className = 'form-select';
            select.id = 'input-' + fieldId;
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Year';
            select.appendChild(defaultOption);
            
            // Add year options
            field.options.forEach(function(year) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (value === year) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            editDiv.appendChild(select);
        } else {
            // Create standard input element
            const input = document.createElement('input');
            input.type = field.type;
            input.className = 'form-control';
            input.id = 'input-' + fieldId;
            input.value = value;
            if (field.readonly) {
                input.readOnly = true;
            }
            
            editDiv.appendChild(input);
        }
        
        // Add buttons container
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'mt-2';
        
        // Save button
        const saveButton = document.createElement('button');
        saveButton.className = 'btn btn-sm btn-primary save-edit';
        saveButton.textContent = 'Save';
        saveButton.onclick = function() {
            saveEdit(field.id);
        };
        
        // Cancel button
        const cancelButton = document.createElement('button');
        cancelButton.className = 'btn btn-sm btn-secondary cancel-edit ms-2';
        cancelButton.textContent = 'Cancel';
        cancelButton.onclick = function() {
            cancelEdit(field.id);
        };
        
        buttonContainer.appendChild(saveButton);
        buttonContainer.appendChild(cancelButton);
        editDiv.appendChild(buttonContainer);
        
        // Add all elements to verification column
        verifyCol.appendChild(buttonsDiv);
        verifyCol.appendChild(editDiv);
        
        // Add all columns to row
        rowDiv.appendChild(labelCol);
        rowDiv.appendChild(valueCol);
        rowDiv.appendChild(verifyCol);
        
        // Add row to field row
        fieldRow.appendChild(rowDiv);
        
        // Add field row to container
        container.appendChild(fieldRow);
    });
    
    console.log("Verification fields generated");
}

// Verify a field
function verifyField(fieldId, isCorrect) {
    console.log("verifyField called for:", fieldId, "isCorrect:", isCorrect);
    
    const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
    
    if (isCorrect) {
        // Field is correct
        fieldStatuses[fieldId] = 'verified';
        updateFieldStatus(fieldId, 'verified');
        console.log("Field marked as verified:", fieldId);
    } else {
        // Field needs editing
        const editElement = document.getElementById('edit-' + safeFieldId);
        if (editElement) {
            editElement.style.display = 'block';
            console.log("Edit form displayed for field:", fieldId);
        } else {
            console.error("Could not find edit element for field:", fieldId);
        }
    }
    
    updateProgress();
    checkAllFieldsVerified();
}

// Save edited field
function saveEdit(fieldId) {
    console.log("saveEdit called for:", fieldId);
    
    const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
    const inputElement = document.getElementById('input-' + safeFieldId);
    
    if (!inputElement) {
        console.error("Could not find input element for field:", fieldId);
        return;
    }
    
    const newValue = inputElement.value;
    console.log("New value:", newValue);
    
    // Update the displayed value
    const valueElement = document.getElementById('value-' + safeFieldId);
    if (valueElement) {
        valueElement.textContent = newValue;
    }
    
    // Hide the edit form
    const editElement = document.getElementById('edit-' + safeFieldId);
    if (editElement) {
        editElement.style.display = 'none';
    }
    
    // Mark as edited
    fieldStatuses[fieldId] = 'edited';
    updateFieldStatus(fieldId, 'edited');
    
    // Store the edited value
    editedFields[fieldId] = newValue;
    
    console.log("Field edited successfully:", fieldId);
    
    updateProgress();
    checkAllFieldsVerified();
}

// Cancel edit
function cancelEdit(fieldId) {
    console.log("cancelEdit called for:", fieldId);
    
    const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
    const editElement = document.getElementById('edit-' + safeFieldId);
    
    if (editElement) {
        editElement.style.display = 'none';
        console.log("Edit form hidden for field:", fieldId);
    } else {
        console.error("Could not find edit element for field:", fieldId);
    }
}

// Update field status badge
function updateFieldStatus(fieldId, status) {
    console.log("updateFieldStatus called for:", fieldId, "status:", status);
    
    const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
    const statusElement = document.getElementById('status-' + safeFieldId);
    
    if (statusElement) {
        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusElement.className = 'ms-2 badge ' + getBadgeClass(status);
        console.log("Status updated for field:", fieldId);
    } else {
        console.error("Could not find status element for field:", fieldId);
    }
}

// Get badge class based on status
function getBadgeClass(status) {
    switch (status) {
        case 'verified': return 'badge-verified';
        case 'edited': return 'badge-edited';
        default: return 'badge-pending';
    }
}

// Update progress bar
function updateProgress() {
    const totalFields = Object.keys(fieldStatuses).length;
    const verifiedFields = Object.values(fieldStatuses).filter(function(status) {
        return status === 'verified' || status === 'edited';
    }).length;
    
    const percentage = Math.round((verifiedFields / totalFields) * 100);
    
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    const progressText = document.getElementById('progressText');
    if (progressText) {
        progressText.textContent = percentage + '%';
    }
    
    console.log("Progress updated:", percentage + '%');
}

// Check if all fields have been verified
function checkAllFieldsVerified() {
    const allVerified = Object.values(fieldStatuses).every(function(status) {
        return status === 'verified' || status === 'edited';
    });
    
    const continueButton = document.getElementById('continueButton');
    if (continueButton) {
        continueButton.disabled = !allVerified;
    }
    
    console.log("All fields verified:", allVerified);
}

// Save draft of current progress
function saveDraft() {
    console.log("Saving draft");
    
    // Show spinner
    document.getElementById('verifySpinner').style.display = 'block';
    
    // Store the current state in localStorage
    const draftData = {
        employee: currentEmployee,
        statuses: fieldStatuses,
        edits: editedFields,
        timestamp: new Date().toISOString()
    };
    
    try {
        localStorage.setItem('employeeDraft_' + currentEmployee['Mobile Number'], JSON.stringify(draftData));
        console.log("Draft saved successfully");
        
        // Hide spinner after a short delay
        setTimeout(function() {
            document.getElementById('verifySpinner').style.display = 'none';
            alert('Your progress has been saved as a draft. You can continue later.');
        }, 1000);
    } catch (error) {
        console.error("Error saving draft:", error);
        document.getElementById('verifySpinner').style.display = 'none';
        alert('Error saving draft: ' + error.message);
    }
}

// Show review screen
function showReview() {
    console.log("Showing review screen");
    
    // Generate review content
    generateReviewContent();
    
    // Show review card
    document.getElementById('verificationCard').classList.add('d-none');
    document.getElementById('reviewCard').classList.remove('d-none');
    
    // Update step indicator
    updateStepIndicator(3);
}

// Generate review content
function generateReviewContent() {
    console.log("Generating review content");
    
    const container = document.getElementById('reviewContainer');
    container.innerHTML = '';
    
    // Create sections
    const personalSection = document.createElement('div');
    personalSection.className = 'mb-4';
    
    const personalTitle = document.createElement('h5');
    personalTitle.className = 'form-section-title';
    personalTitle.textContent = 'Personal Information';
    personalSection.appendChild(personalTitle);
    
    const professionalSection = document.createElement('div');
    professionalSection.className = 'mb-4';
    
    const professionalTitle = document.createElement('h5');
    professionalTitle.className = 'form-section-title';
    professionalTitle.textContent = 'Professional Information';
    professionalSection.appendChild(professionalTitle);
    
    // Add fields to appropriate sections
    fieldDefinitions.forEach(function(field) {
        let value = currentEmployee[field.id] || '';
        
        // If this field was edited, use the edited value
        if (editedFields[field.id] !== undefined) {
            value = editedFields[field.id];
        }
        
        const status = fieldStatuses[field.id];
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        
        // Create row div
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row mb-2';
        
        // Create label column
        const labelCol = document.createElement('div');
        labelCol.className = 'col-md-4';
        const strongLabel = document.createElement('strong');
        strongLabel.textContent = field.label + ':';
        labelCol.appendChild(strongLabel);
        
        // Create value column
        const valueCol = document.createElement('div');
        valueCol.className = 'col-md-6';
        valueCol.textContent = value;
        
        // Create status column
        const statusCol = document.createElement('div');
        statusCol.className = 'col-md-2 text-end';
        
        const statusBadge = document.createElement('span');
        statusBadge.className = 'badge ' + getBadgeClass(status);
        statusBadge.textContent = statusText;
        statusCol.appendChild(statusBadge);
        
        // Add columns to row
        rowDiv.appendChild(labelCol);
        rowDiv.appendChild(valueCol);
        rowDiv.appendChild(statusCol);
        
        // Add to appropriate section based on field type
        if (['Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'].includes(field.id)) {
            personalSection.appendChild(rowDiv);
        } else {
            professionalSection.appendChild(rowDiv);
        }
    });
    
    // Add sections to container
    container.appendChild(personalSection);
    container.appendChild(professionalSection);
    
    console.log("Review content generated");
}

// Toggle submit button based on confirmation checkbox
function toggleSubmitButton() {
    const isChecked = document.getElementById('confirmCheck').checked;
    document.getElementById('submitButton').disabled = !isChecked;
    console.log("Submit button toggled:", !isChecked ? "disabled" : "enabled");
}

// Submit the form
async function submitForm() {
    console.log("Submitting form");
    
    // Show spinner
    document.getElementById('submitSpinner').style.display = 'block';
    document.getElementById('submitButton').disabled = true;
    
    try {
        // Only update fields that were actually edited
        if (Object.keys(editedFields).length > 0) {
            console.log("Submitting edited fields:", editedFields);
            
            // Add last_updated field to track profile updates
            editedFields.last_updated = new Date().toISOString();
            
            // Update the employee record in Supabase with only edited fields
            const { data, error } = await supabaseClient
                .from('employees')
                .update(editedFields)
                .eq('Mobile Number', currentEmployee['Mobile Number']);
                
            console.log("Update response:", { data, error });
            
            if (error) throw error;
        } else {
            console.log("No fields were edited, skipping update");
            
            // Still mark as updated even if no fields were changed
            const { data, error } = await supabaseClient
                .from('employees')
                .update({ last_updated: new Date().toISOString() })
                .eq('Mobile Number', currentEmployee['Mobile Number']);
                
            console.log("Update timestamp response:", { data, error });
            
            if (error) throw error;
        }
        
        // Hide spinner
        document.getElementById('submitSpinner').style.display = 'none';
        
        // Show success card
        document.getElementById('reviewCard').classList.add('d-none');
        document.getElementById('successCard').classList.remove('d-none');
        
        // Update step indicator
        updateStepIndicator(4);
        
        // Clear any saved draft
        try {
            localStorage.removeItem('employeeDraft_' + currentEmployee['Mobile Number']);
        } catch (e) {
            console.error("Error removing draft from localStorage:", e);
        }
        
        console.log("Form submission completed successfully");
        
    } catch (error) {
        console.error("Error submitting form:", error);
        
        // Hide spinner
        document.getElementById('submitSpinner').style.display = 'none';
        document.getElementById('submitButton').disabled = false;
        
        // Show error
        alert('Error submitting form: ' + error.message);
    }
}

// Generate PDF
function generatePDF() {
    console.log("Generating PDF");
    
    try {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined') {
            console.error("jsPDF library not loaded");
            alert("PDF generation library not loaded. Please try again later.");
            return;
        }
        
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(18);
        doc.setTextColor(128, 0, 0);
        doc.text('Employee Data Verification Report', 105, 15, { align: 'center' });
        
        // Add subtitle
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text('Directorate of Agriculture Chhattisgarh', 105, 25, { align: 'center' });
        
        // Add employee name and ID
        doc.setFontSize(12);
        doc.text('Employee: ' + currentEmployee['Employee Name'], 14, 40);
        doc.text('Mobile: ' + currentEmployee['Mobile Number'], 14, 48);
        doc.text('Verification Date: ' + new Date().toLocaleDateString(), 14, 56);
        
        // Add horizontal line
        doc.setDrawColor(128, 0, 0);
        doc.setLineWidth(0.5);
        doc.line(14, 60, 196, 60);
        
        // Prepare data for table
        const personalData = [];
        const professionalData = [];
        
        fieldDefinitions.forEach(function(field) {
            let value = currentEmployee[field.id] || '';
            
            // If this field was edited, use the edited value
            if (editedFields[field.id] !== undefined) {
                value = editedFields[field.id];
            }
            
            const status = fieldStatuses[field.id];
            const row = [field.label, value, status.charAt(0).toUpperCase() + status.slice(1)];
            
            // Add to appropriate array based on field type
            if (['Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'].includes(field.id)) {
                personalData.push(row);
            } else {
                professionalData.push(row);
            }
        });
        
        // Add personal information table
        doc.setFontSize(14);
        doc.text('Personal Information', 14, 70);
        
        doc.autoTable({
            startY: 75,
            head: [['Field', 'Value', 'Status']],
            body: personalData,
            theme: 'striped',
            headStyles: {
                fillColor: [128, 0, 0],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            styles: {
                cellPadding: 3
            }
        });
        
        // Add professional information table
        const professionalStartY = doc.previousAutoTable.finalY + 10;
        doc.text('Professional Information', 14, professionalStartY);
        
        doc.autoTable({
            startY: professionalStartY + 5,
            head: [['Field', 'Value', 'Status']],
            body: professionalData,
            theme: 'striped',
            headStyles: {
                fillColor: [128, 0, 0],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            styles: {
                cellPadding: 3
            }
        });
        
        // Add footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Directorate of Agriculture Chhattisgarh - Page ' + i + ' of ' + pageCount, 105, 290, { align: 'center' });
        }
        
        // Save the PDF
        const fileName = 'Employee_Verification_' + currentEmployee['Employee Name'].replace(/\s+/g, '_') + '.pdf';
        doc.save(fileName);
        
        console.log("PDF generated successfully:", fileName);
    } catch (error) {
        console.error("Error generating PDF:", error);
        alert('Error generating PDF: ' + error.message);
    }
}

// Go back to search
function goBackToSearch() {
    console.log("Going back to search");
    
    document.getElementById('verificationCard').classList.add('d-none');
    document.getElementById('searchCard').classList.remove('d-none');
    
    // Reset state
    currentEmployee = null;
    fieldStatuses = {};
    editedFields = {};
    
    // Update step indicator
    updateStepIndicator(1);
}

// Go back to verify
function goBackToVerify() {
    console.log("Going back to verify");
    
    document.getElementById('reviewCard').classList.add('d-none');
    document.getElementById('verificationCard').classList.remove('d-none');
    
    // Update step indicator
    updateStepIndicator(2);
}

// Start over from the beginning
function startOver() {
    console.log("Starting over");
    
    document.getElementById('successCard').classList.add('d-none');
    document.getElementById('loginCard').classList.remove('d-none');
    
    // Clear search field
    document.getElementById('mobileNumber').value = '';
    document.getElementById('employeeMobile').value = '';
    
    // Hide step indicator
    document.getElementById('stepIndicator').classList.add('d-none');
    
    // Reset state
    currentEmployee = null;
    fieldStatuses = {};
    editedFields = {};
    
    // Switch to employee login option
    switchToEmployeeLogin();
}

// Update step indicator
function updateStepIndicator(currentStep) {
    console.log("Updating step indicator to step:", currentStep);
    
    // Reset all steps
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById('step' + i);
        if (stepElement) {
            stepElement.className = 'step';
            
            if (i < currentStep) {
                stepElement.classList.add('completed');
            } else if (i === currentStep) {
                stepElement.classList.add('active');
            }
        }
    }
}

// Show message
function showMessage(elementId, message, isError) {
    console.log("Showing message:", message, "isError:", isError);
    
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.classList.remove('d-none');
        
        // Hide message after 5 seconds
        setTimeout(function() {
            element.classList.add('d-none');
        }, 5000);
    } else {
        console.error("Message element not found:", elementId);
    }
}

// Check for saved draft on page load
function checkForSavedDraft(mobileNumber) {
    console.log("Checking for saved draft for:", mobileNumber);
    
    try {
        const draftKey = 'employeeDraft_' + mobileNumber;
        const savedDraft = localStorage.getItem(draftKey);
        
        if (savedDraft) {
            const draftData = JSON.parse(savedDraft);
            const timestamp = new Date(draftData.timestamp);
            const now = new Date();
            const hoursDiff = Math.abs(now - timestamp) / 36e5; // Convert to hours
            
            console.log("Found saved draft from:", timestamp);
            
            // If draft is less than 24 hours old, ask to restore
            if (hoursDiff < 24) {
                const confirm = window.confirm('You have a saved draft from ' + timestamp.toLocaleString() + '. Would you like to restore it?');
                
                if (confirm) {
                    console.log("Restoring saved draft");
                    
                    // Restore the saved state
                    currentEmployee = draftData.employee;
                    fieldStatuses = draftData.statuses;
                    editedFields = draftData.edits;
                    
                    // Show verification card
                    document.getElementById('searchCard').classList.add('d-none');
                    document.getElementById('verificationCard').classList.remove('d-none');
                    
                    // Update step indicator
                    updateStepIndicator(2);
                    
                    // Generate verification fields
                    generateVerificationFields();
                    
                    // Update progress
                    updateProgress();
                    checkAllFieldsVerified();
                    
                    return true;
                }
            }
        }
    } catch (error) {
        console.error("Error checking for saved draft:", error);
    }
    
    return false;
}
</script>
</body>
</html>
