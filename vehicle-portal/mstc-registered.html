<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSTC नीलामी पंजीकृत वाहन</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --success-green: #16a34a;
            --warning-orange: #ea580c;
            --danger-red: #dc2626;
            --info-teal: #0891b2;
            --dark-gray: #374151;
            --light-gray: #f8fafc;
            /* MSTC Registered specific colors */
            --mstcreg-accent-color: #003366; /* Purple */
            --mstcreg-gradient-start: #005A9C; 
            --mstcreg-gradient-end: #36454F;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            font-weight: 300;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            letter-spacing: 0.3px;
        }
        
        .hindi { 
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        .navbar { 
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 500;
            font-size: 1.1rem; /* Smaller font for brand */
            display: flex;
            align-items: center;
        }
        .navbar-brand i {
            color: white;
        }
        .navbar-brand:hover {
            color: #e0f2fe;
        }
        .navbar-brand img {
            height: 35px; /* Adjust logo size */
            margin-right: 10px;
        }

        /* User info styling */
        .user-info {
            color: #e0f2fe !important;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem; /* Smaller font for user info */
        }
        
        /* Logout button styling */
        .logout-btn {
            background-color: var(--danger-red) !important;
            border-color: var(--danger-red) !important;
            color: white !important;
            font-weight: 400;
            font-size: 0.85rem; /* Smaller font for logout button */
            padding: 5px 12px;
        }
        .logout-btn:hover {
            background-color: #b91c1c !important;
            border-color: #b91c1c !important;
            color: white !important;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e5f5 100%); /* MSTC Registered specific gradient */
            border-radius: 12px; /* Slightly smaller border radius */
            padding: 20px; /* Slightly less padding */
            margin-bottom: 25px; /* Slightly less margin */
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); /* Lighter shadow */
            border-top: 3px solid var(--mstcreg-accent-color); /* Thinner border */
        }

        .page-header h4 {
            color: var(--mstcreg-accent-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.3rem; /* Slightly smaller font for page title */
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 10px; /* Slightly smaller border radius */
            padding: 18px; /* Slightly less padding */
            margin-bottom: 18px; /* Slightly less margin */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* Lighter shadow */
            border-left: 3px solid var(--mstcreg-accent-color); /* Thinner border */
        }

        .filter-title {
            color: var(--mstcreg-accent-color);
            font-weight: 600;
            margin-bottom: 12px; /* Slightly less margin */
            font-size: 1.05rem; /* Smaller font for filter title */
        }

        /* Table Container */
        .table-container { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-top: 3px solid var(--mstcreg-accent-color);
        }

        /* Table Styling */
        .table {
            border: 1px solid var(--mstcreg-accent-color); /* Thinner border */
            border-radius: 6px; /* Smaller border radius */
            overflow: hidden;
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--mstcreg-gradient-start) 0%, var(--mstcreg-gradient-end) 100%);
            color: white;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--mstcreg-gradient-end);
            padding: 10px 6px; /* Reduced padding */
            font-size: 0.85rem; /* Smaller font for table headers */
        }

        .table tbody td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 8px 6px; /* Reduced padding */
            font-weight: 300;
            font-size: 0.8rem; /* **Smaller font for table data** */
        }

        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table tbody tr:hover {
            background-color: #faf5ff; /* MSTC Registered specific hover */
        }

        /* Form Controls */
        .form-control, .form-select { 
            border-radius: 6px; /* Smaller border radius */
            border: 1px solid #ced4da; /* Thinner border */
            font-weight: 300;
            font-size: 0.85rem; /* Smaller font for form inputs */
            padding: 8px 12px;
            height: auto; /* Allow height to adjust */
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--mstcreg-accent-color);
            box-shadow: 0 0 0 0.15rem rgba(155, 89, 182, 0.2); /* Lighter shadow */
        }

        .form-label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem; /* Smaller font for labels */
            margin-bottom: 5px;
        }

        /* Button Styling */
        .btn-mstc-reg { 
            background: linear-gradient(135deg, var(--mstcreg-gradient-start) 0%, var(--mstcreg-gradient-end) 100%);
            border: none;
            color: white;
            font-weight: 400;
            border-radius: 6px; /* Smaller border radius */
            padding: 8px 18px; /* Reduced padding */
            font-size: 0.9rem; /* Smaller font for buttons */
            transition: all 0.3s ease;
        }
        .btn-mstc-reg:hover { 
            background: linear-gradient(135deg, var(--mstcreg-gradient-end) 0%, #7d3c98 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3); /* Lighter shadow */
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            font-weight: 400;
            font-size: 0.9rem;
            padding: 8px 18px;
            border-radius: 6px;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            font-weight: 400;
            font-size: 0.9rem;
            padding: 8px 18px;
            border-radius: 6px;
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
        }

        /* Modal Styling */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--mstcreg-gradient-start) 0%, var(--mstcreg-gradient-end) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 500;
            font-size: 1.1rem;
        }
        .btn-close-white {
            filter: invert(1);
        }

        /* Action Buttons in Table */
        .action-btn {
            padding: 4px 8px; /* Smaller padding */
            border-radius: 4px; /* Smaller border radius */
            font-size: 0.75rem; /* Smaller font size */
        }

        .btn-warning.action-btn {
            background: #f39c12;
            color: white;
        }

        .btn-danger.action-btn {
            background: var(--danger-red);
            color: white;
        }

        /* Pagination */
        .pagination {
            justify-content: center;
            margin-top: 15px; /* Slightly less margin */
        }

        .page-link {
            color: var(--mstcreg-accent-color);
            border-color: var(--mstcreg-accent-color);
            font-weight: 400;
            font-size: 0.85rem; /* Smaller font */
            padding: 6px 10px; /* Reduced padding */
        }

        .page-link:hover {
            background-color: var(--mstcreg-accent-color);
            border-color: var(--mstcreg-accent-color);
            color: white;
        }

        .page-item.active .page-link {
            background-color: var(--mstcreg-accent-color);
            border-color: var(--mstcreg-accent-color);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            color: white;
            font-size: 1.5rem; /* Smaller spinner */
        }
        .loading-overlay p {
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .table-container {
                padding: 15px;
            }
            
            .page-header {
                padding: 15px;
            }
            
            .page-header h4 {
                font-size: 1.1rem;
            }
            
            .filter-section {
                padding: 12px;
            }

            .form-control, .form-select, .form-label, .btn {
                font-size: 0.8rem;
            }

            .table thead th, .table tbody td {
                font-size: 0.75rem;
                padding: 6px 4px;
            }
            .action-btn {
                padding: 3px 6px;
                font-size: 0.65rem;
            }
        }

        /* Print Styles */
        @media print {
            .navbar, .filter-section, .modal, .btn, .pagination, .action-btn {
                display: none !important;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #000;
                padding: 0;
            }
            
            .table {
                font-size: 9px;
                width: 100%;
                margin: 0;
            }
            
            .table th, .table td {
                border: 1px solid #000 !important;
                padding: 3px 2px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }

            .page-header {
                text-align: center;
                margin-bottom: 15px;
                box-shadow: none;
                border: none;
            }
            .page-header h4 {
                font-size: 1.1rem;
                color: #000;
            }
            
            body {
                font-size: 10px;
                color: #000;
                background-color: white !important;
            }
            
            .table thead th {
                background: #e7e7e7 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand hindi" href="dashboard.html">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार">
                <i class="fas fa-arrow-left me-2"></i>MSTC नीलामी पंजीकृत
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3 hindi user-info" id="userInfo"></span>
                <button class="btn btn-sm logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i> लॉगआउट
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="page-header">
            <h4 class="hindi text-center">MSTC पोर्टल पर नीलामी के लिए पंजीकृत वाहनों की संख्या</h4>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h6 class="filter-title hindi">
                <i class="fas fa-filter me-2"></i>फिल्टर और खोज विकल्प
            </h6>
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label hindi">खोजें</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="विक्रेता का नाम में खोजें" onkeyup="filterTable()">
                </div>
                <div class="col-md-3">
                    <label class="form-label hindi">दोपहिया वाहन > 0</label>
                    <select class="form-select" id="twoWheelerFilter" onchange="filterTable()">
                        <option value="">सभी</option>
                        <option value="yes">हाँ</option>
                        <option value="no">नहीं</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label hindi">चारपहिया वाहन > 0</label>
                    <select class="form-select" id="fourWheelerFilter" onchange="filterTable()">
                        <option value="">सभी</option>
                        <option value="yes">हाँ</option>
                        <option value="no">नहीं</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>साफ़ करें
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="hindi mb-0" style="color: var(--mstcreg-accent-color); font-size: 1.1rem;">MSTC नीलामी पंजीकृत वाहन</h5>
                    <small class="text-muted">कुल एंट्री: <span id="totalEntries">0</span></small>
                </div>
                <div>
                    <button class="btn btn-mstc-reg me-2" onclick="addNewRow()">
                        <i class="fas fa-plus me-2"></i>नई एंट्री जोड़ें
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>एक्सपोर्ट
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-2"></i>Excel में डाउनलोड
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>PDF में डाउनलोड
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="mstcRegisteredTable">
                    <thead>
                        <tr class="hindi">
                            <th rowspan="2" style="width: 5%;">
                                SI No
                                <i class="fas fa-sort ms-1" onclick="sortTable(0)" style="cursor: pointer;"></i>
                            </th>
                            <th rowspan="2" style="width: 20%;">
                                Seller Name/Office Name
                                <i class="fas fa-sort ms-1" onclick="sortTable(1)" style="cursor: pointer;"></i>
                            </th>
                            <th colspan="8">No of Vehicles Registered on MSTC Portal for Auction</th>
                            <th rowspan="2" style="width: 8%;">
                                Total
                                <i class="fas fa-sort ms-1" onclick="sortTable(10)" style="cursor: pointer;"></i>
                            </th>
                            <th rowspan="2" style="width: 10%;">Action</th>
                        </tr>
                        <tr class="hindi">
                            <th style="width: 8%;">Two-Wheeler</th>
                            <th style="width: 10%;">Four-Wheeler (Car/Jeep/SUV)</th>
                            <th style="width: 7%;">Bus</th>
                            <th style="width: 7%;">Truck</th>
                            <th style="width: 7%;">Ambulance</th>
                            <th style="width: 10%;">Fire Tender/Extinguisher</th>
                            <th style="width: 8%;">Police Owned Vehicle</th>
                            <th style="width: 8%;">Police Impounded Vehicle</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic rows will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="Table pagination">
                <ul class="pagination" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>

            <div class="mt-3 text-center">
                <button class="btn btn-secondary me-2" onclick="loadData()">
                    <i class="fas fa-refresh me-2"></i>डेटा रिफ्रेश करें
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hindi" id="modalTitle">नई एंट्री जोड़ें</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <input type="hidden" id="entryId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">SI No</label>
                                <input type="number" class="form-control" id="siNo" readonly style="background-color: #e9ecef;" required>
                                <small class="text-muted hindi">यह स्वचालित रूप से भरा जाएगा</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">Seller Name/Office Name</label>
                                <input type="text" class="form-control" id="sellerName" readonly style="background-color: #e9ecef;" required>
                                <small class="text-muted hindi">यह आपके लॉगिन विवरण से स्वचालित रूप से भरा जाएगा</small>
                            </div>
                        </div>
                        
                        <h6 class="hindi mb-3">वाहनों की संख्या दर्ज करें:</h6>
                        <div class="row g-2">
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Two-Wheeler</label>
                                <input type="number" class="form-control vehicle-input" id="twoWheeler" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Four-Wheeler (Car/Jeep/SUV)</label>
                                <input type="number" class="form-control vehicle-input" id="fourWheeler" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Bus</label>
                                <input type="number" class="form-control vehicle-input" id="bus" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Truck</label>
                                <input type="number" class="form-control vehicle-input" id="truck" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Ambulance</label>
                                <input type="number" class="form-control vehicle-input" id="ambulance" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Fire Tender/Extinguisher</label>
                                <input type="number" class="form-control vehicle-input" id="fireTender" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Police Owned Vehicle</label>
                                <input type="number" class="form-control vehicle-input" id="policeOwned" min="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label hindi">Police Impounded Vehicle</label>
                                <input type="number" class="form-control vehicle-input" id="policeImpounded" min="0" value="0" onchange="calculateTotal()">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mt-3">
                                <label class="form-label hindi">Total</label>
                                <input type="number" class="form-control" id="total" readonly style="background-color: #e9ecef;">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द करें</button>
                    <button type="button" class="btn btn-mstc-reg" onclick="saveEntry()">
                        <i class="fas fa-save me-2"></i>सेव करें
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border loading-spinner" role="status"></div>
            <p class="text-white mt-2">प्रोसेसिंग हो रही है...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentEditId = null;
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortColumn = -1;
        let sortDirection = 'asc';
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            displayUserInfo();
            loadData();
        });

        function displayUserInfo() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userInfo').textContent = 
                    `${user.fullName} (${user.districtName})`;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function calculateTotal() {
            const inputs = ['twoWheeler', 'fourWheeler', 'bus', 'truck', 'ambulance', 'fireTender', 'policeOwned', 'policeImpounded'];
            let total = 0;
            
            inputs.forEach(id => {
                const value = parseInt(document.getElementById(id).value) || 0;
                total += value;
            });
            
            document.getElementById('total').value = total;
        }

        async function loadData() {
            try {
                showLoading();
                
                const { data, error } = await supabaseClient
                    .from('mstc_auction_registered')
                    .select('*')
                    .order('si_no', { ascending: true });

                if (error) throw error;

                allData = data || [];
                filteredData = [...allData];
                
                updateTotalCount();
                renderTable();
                renderPagination();
                
                hideLoading();

            } catch (error) {
                hideLoading();
                alert('डेटा लोड करने में त्रुटि: ' + error.message);
            }
        }

        function updateTotalCount() {
            document.getElementById('totalEntries').textContent = filteredData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.si_no || startIndex + index + 1}</strong></td>
                    <td>${row.seller_office_name || ''}</td>
                    <td>${row.two_wheeler || 0}</td>
                    <td>${row.four_wheeler || 0}</td>
                    <td>${row.bus || 0}</td>
                    <td>${row.truck || 0}</td>
                    <td>${row.ambulance || 0}</td>
                    <td>${row.fire_tender || 0}</td>
                    <td>${row.police_owned || 0}</td>
                    <td>${row.police_impounded || 0}</td>
                    <td><strong>${row.total || 0}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-warning action-btn me-1" onclick="editEntry('${row.id}')" title="एडिट करें">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteEntry('${row.id}')" title="डिलीट करें">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">पिछला</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">अगला</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTable();
            renderPagination();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const twoWheelerFilter = document.getElementById('twoWheelerFilter').value;
            const fourWheelerFilter = document.getElementById('fourWheelerFilter').value;

            filteredData = allData.filter(row => {
                const matchesSearch = !searchTerm || 
                    (row.seller_office_name && row.seller_office_name.toLowerCase().includes(searchTerm));

                const matchesTwoWheeler = !twoWheelerFilter || 
                    (twoWheelerFilter === 'yes' && (row.two_wheeler || 0) > 0) ||
                    (twoWheelerFilter === 'no' && (row.two_wheeler || 0) === 0);

                const matchesFourWheeler = !fourWheelerFilter ||
                    (fourWheelerFilter === 'yes' && (row.four_wheeler || 0) > 0) ||
                    (fourWheelerFilter === 'no' && (row.four_wheeler || 0) === 0);

                return matchesSearch && matchesTwoWheeler && matchesFourWheeler;
            });

            currentPage = 1;
            updateTotalCount();
            renderTable();
            renderPagination();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('twoWheelerFilter').value = '';
            document.getElementById('fourWheelerFilter').value = '';
            filterTable();
        }

        function sortTable(columnIndex) {
            const columns = ['si_no', 'seller_office_name', 'two_wheeler', 'four_wheeler', 'bus', 'truck', 'ambulance', 'fire_tender', 'police_owned', 'police_impounded', 'total'];
            const column = columns[columnIndex];
            
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (columnIndex >= 0) { // All vehicle counts and SI No are numbers
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            renderTable();
            renderPagination();
        }

        async function getNextSerialNumber() {
            try {
                const { data, error } = await supabaseClient
                    .from('mstc_auction_registered')
                    .select('si_no')
                    .order('si_no', { ascending: false })
                    .limit(1);

                if (error) throw error;

                return data && data.length > 0 && data[0].si_no !== null ? data[0].si_no + 1 : 1;
            } catch (error) {
                console.error('Error getting next SI number:', error);
                return allData.length + 1;
            }
        }

        async function addNewRow() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'नई एंट्री जोड़ें';
            document.getElementById('entryForm').reset();
            document.getElementById('entryId').value = '';
            
            // Auto-fill SI No
            const nextSiNo = await getNextSerialNumber();
            document.getElementById('siNo').value = nextSiNo;

            // Autofill Seller Name/Office Name from logged-in user
            const user = getCurrentUser();
            if (user) {
                document.getElementById('sellerName').value = `${user.fullName} (${user.districtName})`;
            }
            
            // Reset all vehicle counts to 0 and calculate total
            ['twoWheeler', 'fourWheeler', 'bus', 'truck', 'ambulance', 'fireTender', 'policeOwned', 'policeImpounded'].forEach(id => {
                document.getElementById(id).value = 0;
            });
            calculateTotal();
            
            const modal = new bootstrap.Modal(document.getElementById('entryModal'));
            modal.show();
        }

        async function editEntry(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('mstc_auction_registered')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditId = id;
                document.getElementById('modalTitle').textContent = 'एंट्री एडिट करें';
                document.getElementById('entryId').value = data.id;
                document.getElementById('siNo').value = data.si_no || '';
                document.getElementById('sellerName').value = data.seller_office_name || '';
                document.getElementById('twoWheeler').value = data.two_wheeler || 0;
                document.getElementById('fourWheeler').value = data.four_wheeler || 0;
                document.getElementById('bus').value = data.bus || 0;
                document.getElementById('truck').value = data.truck || 0;
                document.getElementById('ambulance').value = data.ambulance || 0;
                document.getElementById('fireTender').value = data.fire_tender || 0;
                document.getElementById('policeOwned').value = data.police_owned || 0;
                document.getElementById('policeImpounded').value = data.police_impounded || 0;
                
                calculateTotal();

                const modal = new bootstrap.Modal(document.getElementById('entryModal'));
                modal.show();

            } catch (error) {
                alert('डेटा लोड करने में त्रुटि: ' + error.message);
            }
        }

        async function saveEntry() {
            try {
                showLoading();
                const formData = {
                    si_no: parseInt(document.getElementById('siNo').value) || null,
                    seller_office_name: document.getElementById('sellerName').value,
                    two_wheeler: parseInt(document.getElementById('twoWheeler').value) || 0,
                    four_wheeler: parseInt(document.getElementById('fourWheeler').value) || 0,
                    bus: parseInt(document.getElementById('bus').value) || 0,
                    truck: parseInt(document.getElementById('truck').value) || 0,
                    ambulance: parseInt(document.getElementById('ambulance').value) || 0,
                    fire_tender: parseInt(document.getElementById('fireTender').value) || 0,
                    police_owned: parseInt(document.getElementById('policeOwned').value) || 0,
                    police_impounded: parseInt(document.getElementById('policeImpounded').value) || 0,
                    total: parseInt(document.getElementById('total').value) || 0
                };

                let result;
                if (currentEditId) {
                    result = await supabaseClient
                        .from('mstc_auction_registered')
                        .update(formData)
                        .eq('id', currentEditId);
                } else {
                    result = await supabaseClient
                        .from('mstc_auction_registered')
                        .insert([formData]);
                }

                if (result.error) throw result.error;

                alert('डेटा सफलतापूर्वक सेव हो गया!');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('entryModal'));
                modal.hide();
                
                loadData();
                hideLoading();

            } catch (error) {
                hideLoading();
                alert('डेटा सेव करने में त्रुटि: ' + error.message);
            }
        }

        async function deleteEntry(id) {
            if (confirm('क्या आप वाकई इस एंट्री को डिलीट करना चाहते हैं?')) {
                try {
                    showLoading();
                    const { error } = await supabaseClient
                        .from('mstc_auction_registered')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    alert('एंट्री सफलतापूर्वक डिलीट हो गई!');
                    loadData();
                    hideLoading();

                } catch (error) {
                    hideLoading();
                    alert('डिलीट करने में त्रुटि: ' + error.message);
                }
            }
        }

        // Helper for Excel binary export
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        function exportToExcel() {
            showLoading();
            const reportDate = new Date().toLocaleDateString('hi-IN');
            const user = getCurrentUser();
            const generatedBy = user ? `${user.fullName} (${user.districtName})` : 'अज्ञात उपयोगकर्ता';
            const generationTime = new Date().toLocaleTimeString('hi-IN');

            const ws_data = [
                ['संचालनालय कृषि छत्तीसगढ़ रायपुर'],
                ['MSTC पोर्टल पर नीलामी के लिए पंजीकृत वाहनों की संख्या'], // Subtitle
                ['रिपोर्ट दिनांक: ' + reportDate],
                [], // Empty row for spacing
                // Main Header Row (colspan)
                ['SI No', 'Seller Name/Office Name', null, null, null, null, null, null, null, null, 'Total'],
                // Sub Header Row
                [null, null, 'Two-Wheeler', 'Four-Wheeler (Car/Jeep/SUV)', 'Bus', 'Truck', 'Ambulance', 'Fire Tender/Extinguisher', 'Police Owned Vehicle', 'Police Impounded Vehicle', null]
            ];

            filteredData.forEach(row => {
                ws_data.push([
                    row.si_no || '',
                    row.seller_office_name || '',
                    row.two_wheeler || 0,
                    row.four_wheeler || 0,
                    row.bus || 0,
                    row.truck || 0,
                    row.ambulance || 0,
                    row.fire_tender || 0,
                    row.police_owned || 0,
                    row.police_impounded || 0,
                    row.total || 0
                ]);
            });

            // Add footer details
            ws_data.push([]); // Empty row
            ws_data.push(['रिपोर्ट जेनरेटेड: ' + reportDate + ' ' + generationTime]);
            ws_data.push(['द्वारा जेनरेटेड: ' + generatedBy]);
            ws_data.push(['अल्गोरिथम: डेटाबेस से सीधे एक्सपोर्ट किया गया']);


            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Calculate number of data columns for merging and styling
            const numDataColumns = ws_data[5].length; // Use the actual data header row for column count

            // Merge cells for titles over all data columns
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: numDataColumns - 1 } },
                { s: { r: 1, c: 0 }, e: { r: 1, c: numDataColumns - 1 } },
                { s: { r: 2, c: 0 }, e: { r: 2, c: numDataColumns - 1 } },
                // Merge for the main table header "No of Vehicles Registered..."
                { s: { r: 4, c: 2 }, e: { r: 4, c: 9 } }, 
                // Merge footer rows
                { s: { r: ws_data.length - 3, c: 0 }, e: { r: ws_data.length - 3, c: numDataColumns - 1 } },
                { s: { r: ws_data.length - 2, c: 0 }, e: { r: ws_data.length - 2, c: numDataColumns - 1 } },
                { s: { r: ws_data.length - 1, c: 0 }, e: { r: ws_data.length - 1, c: numDataColumns - 1 } }
            ];

            // Style for titles and headers (monochrome)
            const titleStyle = { 
                font: { bold: true, sz: 16, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const subtitleStyle = { 
                font: { bold: true, sz: 14, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const dateStyle = { 
                font: { sz: 11, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const mainHeaderStyle = { // For "No of Vehicles Registered..."
                font: { bold: true, sz: 12, color: { rgb: "FF000000" } },
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                fill: { fgColor: { rgb: "FFD3D3D3" } }, /* Light gray background */
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            const subHeaderCellStyle = { // For "Two-Wheeler", "Four-Wheeler" etc.
                font: { bold: true, sz: 10, color: { rgb: "FF000000" } }, /* Black color, smaller font */
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                fill: { fgColor: { rgb: "FFD3D3D3" } }, /* Light gray background */
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            const dataCellStyle = {
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            const footerStyle = {
                font: { sz: 10, color: { rgb: "FF000000" } },
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                fill: { fgColor: { rgb: "FFE0E0E0" } }, // Slightly darker gray for footer
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            
            if (ws['A1']) ws['A1'].s = titleStyle;
            if (ws['A2']) ws['A2'].s = subtitleStyle;
            if (ws['A3']) ws['A3'].s = dateStyle;

            // Apply main header style (row 5, merged)
            const mainHeaderCellRef = XLSX.utils.encode_cell({ r: 4, c: 2 });
            if (ws[mainHeaderCellRef]) ws[mainHeaderCellRef].s = mainHeaderStyle;

            // Apply sub-header style (row 6)
            for (let c = 0; c < numDataColumns; c++) {
                const cellRef = XLSX.utils.encode_cell({ r: 5, c: c });
                if (!ws[cellRef]) ws[cellRef] = {};
                ws[cellRef].s = subHeaderCellStyle;
            }

            // Apply style to SI No and Total columns in the first header row
            const siNoHeaderRef = XLSX.utils.encode_cell({ r: 4, c: 0 });
            if (!ws[siNoHeaderRef]) ws[siNoHeaderRef] = {};
            ws[siNoHeaderRef].s = mainHeaderStyle;

            const sellerNameHeaderRef = XLSX.utils.encode_cell({ r: 4, c: 1 });
            if (!ws[sellerNameHeaderRef]) ws[sellerNameHeaderRef] = {};
            ws[sellerNameHeaderRef].s = mainHeaderStyle;

            const totalHeaderRef = XLSX.utils.encode_cell({ r: 4, c: 10 }); // Assuming Total is at index 10
            if (!ws[totalHeaderRef]) ws[totalHeaderRef] = {};
            ws[totalHeaderRef].s = mainHeaderStyle;


            // Apply data cell styles to data rows (from row 7)
            for (let r = 6; r < ws_data.length - 3; r++) { // Exclude footer rows
                for (let c = 0; c < numDataColumns; c++) {
                    const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!ws[cellRef]) ws[cellRef] = {};
                    ws[cellRef].s = dataCellStyle;
                }
            }

            // Apply footer style
            for (let i = 0; i < 3; i++) { // 3 footer rows
                const footerRowRef = ws_data.length - 3 + i;
                const cellRef = XLSX.utils.encode_cell({ r: footerRowRef, c: 0 }); // Apply to merged cell
                if (ws[cellRef]) ws[cellRef].s = footerStyle;
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'MSTC_पंजीकृत'); 

            // Auto-fit columns AFTER all data and styles are applied
            if (typeof XLSX.utils.autofit_columns === 'function') {
                XLSX.utils.autofit_columns(wb.Sheets['MSTC_पंजीकृत']);
            } else {
                // Fallback to predefined widths if autofit_columns is not available
                const fallbackColWidths = [
                    { wch: 8 }, { wch: 25 }, { wch: 12 }, { wch: 15 }, 
                    { wch: 8 }, { wch: 8 }, { wch: 10 }, { wch: 18 }, 
                    { wch: 15 }, { wch: 15 }, { wch: 10 }
                ];
                wb.Sheets['MSTC_पंजीकृत']['!cols'] = fallbackColWidths;
            }

            // Landscape orientation
            if (!wb.Sheets['MSTC_पंजीकृत']['!pageSetup']) wb.Sheets['MSTC_पंजीकृत']['!pageSetup'] = {};
            wb.Sheets['MSTC_पंजीकृत']['!pageSetup'].orientation = 'landscape';

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'MSTC_नीलामी_पंजीकृत_वाहन.xlsx'; 
            link.click();
            hideLoading();
        }

        async function exportToPDF() {
            showLoading();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape

            // ======================================================================================
            // IMPORTANT: For Hindi (Devanagari) to render correctly in PDF, you MUST embed a Unicode font.
            // jsPDF's default fonts (helvetica, times, courier) do NOT support Devanagari characters.
            // Without embedding a custom font, Hindi text will appear as garbled characters or empty boxes.
            //
            // How to embed a font (example with Noto Sans Devanagari):
            // 1. Get the font files (e.g., NotoSansDevanagari-Regular.ttf).
            // 2. Convert the TTF to jsPDF's base64 format using a tool (e.g., https://raw.githack.com/MrRio/jsPDF/master/fontconverter/fontconverter.html)
            //    or `jspdf-autotable`'s font generation: https://jspdf.org/docs/fonts/
            // 3. Add the generated font definition to your script:
            //    doc.addFileToVFS('NotoSansDevanagari-Regular.ttf', 'BASE64_ENCODED_FONT_STRING_HERE');
            //    doc.addFont('NotoSansDevanagari-Regular.ttf', 'NotoSansDevanagari', 'normal');
            //    doc.setFont('NotoSansDevanagari');
            //
            // For this example, we will use 'helvetica' as a fallback. Hindi will likely be garbled.
            // ======================================================================================
            doc.setFont('helvetica'); 

            // Report details for footer
            const reportDate = new Date().toLocaleDateString('hi-IN');
            const user = getCurrentUser();
            const generatedBy = user ? `${user.fullName} (${user.districtName})` : 'अज्ञात उपयोगकर्ता';
            const generationTime = new Date().toLocaleTimeString('hi-IN');
            const footerText = `रिपोर्ट जेनरेटेड: ${reportDate} ${generationTime}\nद्वारा जेनरेटेड: ${generatedBy}\nअल्गोरिथम: डेटाबेस से सीधे एक्सपोर्ट किया गया`;

            doc.setTextColor(0, 0, 0); // Black text color
            doc.setFontSize(16);
            doc.text('संचालनालय कृषि छत्तीसगढ़ रायपुर', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('MSTC पोर्टल पर नीलामी के लिए पंजीकृत वाहनों की संख्या', doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' }); // Subtitle
            doc.setFontSize(10);
            doc.text('रिपोर्ट दिनांक: ' + reportDate, doc.internal.pageSize.getWidth() / 2, 35, { align: 'center' });

            const headers = [
                [{ content: 'SI No', rowSpan: 2 }],
                [{ content: 'Seller Name/Office Name', rowSpan: 2 }],
                [{ content: 'No of Vehicles Registered on MSTC Portal for Auction', colSpan: 8 }],
                [{ content: 'Total', rowSpan: 2 }]
            ];

            const subHeaders = [
                'Two-Wheeler', 'Four-Wheeler (Car/Jeep/SUV)', 'Bus', 'Truck', 'Ambulance', 
                'Fire Tender/Extinguisher', 'Police Owned Vehicle', 'Police Impounded Vehicle'
            ];
            
            // Combine headers for jsPDF-Autotable
            const finalHeaders = [
                headers[0], headers[1], headers[2], headers[3]
            ];
            finalHeaders.splice(2, 1, ...headers[2].map(h => h.content ? h : null).filter(Boolean)); // Extract colSpan header
            finalHeaders.splice(2, 0, ...subHeaders.map(sh => ({ content: sh }))); // Insert subheaders

            const data = filteredData.map(row => [
                row.si_no || '',
                row.seller_office_name || '',
                row.two_wheeler || 0,
                row.four_wheeler || 0,
                row.bus || 0,
                row.truck || 0,
                row.ambulance || 0,
                row.fire_tender || 0,
                row.police_owned || 0,
                row.police_impounded || 0,
                row.total || 0
            ]);

            doc.autoTable({
                head: [
                    [{ content: 'SI No', rowSpan: 2 }, { content: 'Seller Name/Office Name', rowSpan: 2 }, { content: 'No of Vehicles Registered on MSTC Portal for Auction', colSpan: 8 }, { content: 'Total', rowSpan: 2 }],
                    ['Two-Wheeler', 'Four-Wheeler (Car/Jeep/SUV)', 'Bus', 'Truck', 'Ambulance', 'Fire Tender/Extinguisher', 'Police Owned Vehicle', 'Police Impounded Vehicle']
                ],
                body: data,
                startY: 45,
                theme: 'grid',
                headStyles: { 
                    fillColor: [230, 230, 230], // Light gray background
                    textColor: [0, 0, 0], // Black text
                    fontStyle: 'bold', 
                    halign: 'center',
                    valign: 'middle',
                    fontSize: 7, // Smaller font for headers in PDF
                    lineColor: [0, 0, 0], // Black border
                    lineWidth: 0.1
                },
                bodyStyles: { 
                    textColor: [0, 0, 0], // Black text
                    halign: 'center', 
                    valign: 'middle',
                    fontSize: 7, // Smaller font for body in PDF
                    lineColor: [0, 0, 0], // Black border
                    lineWidth: 0.1
                },
                alternateRowStyles: { 
                    fillColor: [245, 245, 245] // Very light gray for alternate rows
                },
                styles: {
                    font: 'helvetica', // Use a font that supports Hindi, or embed one
                    cellPadding: 1.5, // Reduced cell padding
                    lineWidth: 0.1,
                    lineColor: [0, 0, 0] // All borders black
                },
                // Removed columnStyles to enable auto-fitting widths by jsPDF-Autotable
                didDrawPage: function (data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0); // Black for footer text
                    const pageHeight = doc.internal.pageSize.getHeight();
                    doc.text(footerText, data.settings.margin.left, pageHeight - 10, {
                        align: 'left'
                    });
                    // Page number
                    doc.text('Page ' + doc.internal.getNumberOfPages(), doc.internal.pageSize.getWidth() - data.settings.margin.right, pageHeight - 10, {
                        align: 'right'
                    });
                },
                margin: { top: 40, bottom: 20, left: 10, right: 10 } // Proper page margins
            });

            doc.save('MSTC_नीलामी_पंजीकृत_वाहन.pdf'); 
            hideLoading();
        }

        function logout() {
            if (confirm('क्या आप वाकई लॉगआउट करना चाहते हैं?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
