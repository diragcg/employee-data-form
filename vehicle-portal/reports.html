<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>वाहन आबंटन रिपोर्ट्स</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Mukta', sans-serif; background: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #6F42C1 0%, #5A32A3 100%); }
        .hindi { font-weight: 500; }
        .report-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .report-icon { font-size: 2.5rem; color: #6F42C1; }
        .stat-card { background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%); color: white; border-radius: 10px; padding: 20px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand hindi" href="dashboard.html">
                <i class="fas fa-arrow-left me-2"></i>रिपोर्ट्स
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3 hindi" id="userInfo"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i> लॉगआउट
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h4 id="divisionCount">0</h4>
                    <p class="hindi">संभाग कार्यालय</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <i class="fas fa-city fa-2x mb-2"></i>
                    <h4 id="districtCount">0</h4>
                    <p class="hindi">जिला कार्यालय</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <i class="fas fa-home fa-2x mb-2"></i>
                    <h4 id="fieldCount">0</h4>
                    <p class="hindi">मैदानी कार्यालय</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <i class="fas fa-car fa-2x mb-2"></i>
                    <h4 id="totalVehicles">0</h4>
                    <p class="hindi">कुल वाहन</p>
                </div>
            </div>
        </div>

        <!-- Report Cards -->
        <div class="row">
            <div class="col-md-6">
                <div class="report-card text-center">
                    <div class="report-icon mb-3">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h5 class="hindi">संपूर्ण डेटा रिपोर्ट</h5>
                    <p class="hindi">सभी कार्यालयों का संपूर्ण वाहन आबंटन डेटा</p>
                    <button class="btn btn-success" onclick="exportAllData()">
                        <i class="fas fa-download me-2"></i>डाउनलोड करें
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="report-card text-center">
                    <div class="report-icon mb-3">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <h5 class="hindi">MSTC नीलामी रिपोर्ट</h5>
                    <p class="hindi">पंजीकृत और बेचे गए वाहनों की रिपोर्ट</p>
                    <button class="btn btn-warning" onclick="exportMSTCData()">
                        <i class="fas fa-download me-2"></i>डाउनलोड करें
                    </button>
                </div>
            </div>
        </div>

        <!-- Detailed Reports -->
        <div class="report-card">
            <h5 class="hindi mb-3">विस्तृत रिपोर्ट्स</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <button class="btn btn-outline-primary w-100" onclick="exportDivisionData()">
                        <i class="fas fa-building me-2"></i>संभाग स्तर रिपोर्ट
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-outline-primary w-100" onclick="exportDistrictData()">
                        <i class="fas fa-city me-2"></i>जिला स्तर रिपोर्ट
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-outline-primary w-100" onclick="exportFieldData()">
                        <i class="fas fa-home me-2"></i>मैदानी कार्यालय रिपोर्ट
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            displayUserInfo();
            loadStatistics();
        });

        function displayUserInfo() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userInfo').textContent = 
                    `${user.fullName} (${user.districtName})`;
            }
        }

        async function loadStatistics() {
            try {
                // Load division count
                const { count: divisionCount } = await supabaseClient
                    .from('division_office_vehicles')
                    .select('*', { count: 'exact', head: true });
                
                // Load district count
                const { count: districtCount } = await supabaseClient
                    .from('district_office_vehicles')
                    .select('*', { count: 'exact', head: true });
                
                // Load field count
                const { count: fieldCount } = await supabaseClient
                    .from('field_office_vehicles')
                    .select('*', { count: 'exact', head: true });

                // Load MSTC data for total vehicles
                const { data: mstcData } = await supabaseClient
                    .from('mstc_auction_registered')
                    .select('total');
                
                const totalVehicles = mstcData ? mstcData.reduce((sum, row) => sum + (row.total || 0), 0) : 0;

                // Update display
                document.getElementById('divisionCount').textContent = divisionCount || 0;
                document.getElementById('districtCount').textContent = districtCount || 0;
                document.getElementById('fieldCount').textContent = fieldCount || 0;
                document.getElementById('totalVehicles').textContent = totalVehicles;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function exportAllData() {
            try {
                // Get all data from all tables
                const [divisionData, districtData, fieldData, mstcRegistered, mstcSold] = await Promise.all([
                    supabaseClient.from('division_office_vehicles').select('*').order('serial_no'),
                    supabaseClient.from('district_office_vehicles').select('*').order('serial_no'),
                    supabaseClient.from('field_office_vehicles').select('*').order('serial_no'),
                    supabaseClient.from('mstc_auction_registered').select('*').order('si_no'),
                    supabaseClient.from('mstc_auction_sold').select('*').order('si_no')
                ]);

                let csv = [];
                
                // Add Division data
                csv.push('संभाग स्तर कार्यालय');
                csv.push('क्रमांक,कार्यालय का नाम एवं जिला,पदनाम,वेतनमान,स्वीकृत पद संख्या,वाहन की पात्रता,वर्तमान में वाहन आबंटित,रिमार्क');
                
                if (divisionData.data) {
                    divisionData.data.forEach(row => {
                        csv.push(`"${row.serial_no || ''}","${row.office_name_district || ''}","${row.designation || ''}","${row.pay_scale || ''}","${row.sanctioned_posts || ''}","${row.vehicle_eligibility || ''}","${row.current_allocation || ''}","${row.remarks || ''}"`);
                    });
                }
                
                csv.push(''); // Empty line
                
                // Add District data
                csv.push('जिला स्तर कार्यालय');
                csv.push('क्रमांक,कार्यालय का नाम एवं जिला,पदनाम,वेतनमान,स्वीकृत पद संख्या,वाहन की पात्रता,वर्तमान में वाहन आबंटित,रिमार्क');
                
                if (districtData.data) {
                    districtData.data.forEach(row => {
                        csv.push(`"${row.serial_no || ''}","${row.office_name_district || ''}","${row.designation || ''}","${row.pay_scale || ''}","${row.sanctioned_posts || ''}","${row.vehicle_eligibility || ''}","${row.current_allocation || ''}","${row.remarks || ''}"`);
                    });
                }
                
                csv.push(''); // Empty line
                
                // Add Field data
                csv.push('अन्य मैदानी कार्यालय');
                csv.push('क्रमांक,कार्यालय का नाम एवं जिला,पदनाम,वेतनमान,स्वीकृत पद संख्या,वाहन की पात्रता,वर्तमान में वाहन आबंटित,रिमार्क');
                
                if (fieldData.data) {
                    fieldData.data.forEach(row => {
                        csv.push(`"${row.serial_no || ''}","${row.office_name_district || ''}","${row.designation || ''}","${row.pay_scale || ''}","${row.sanctioned_posts || ''}","${row.vehicle_eligibility || ''}","${row.current_allocation || ''}","${row.remarks || ''}"`);
                    });
                }

                // Download CSV
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'संपूर्ण_वाहन_आबंटन_रिपोर्ट.csv';
                link.click();

            } catch (error) {
                alert('रिपोर्ट डाउनलोड करने में त्रुटि: ' + error.message);
            }
        }

        async function exportMSTCData() {
            try {
                const [registeredData, soldData] = await Promise.all([
                    supabaseClient.from('mstc_auction_registered').select('*').order('si_no'),
                    supabaseClient.from('mstc_auction_sold').select('*').order('si_no')
                ]);

                let csv = [];
                
                // MSTC Registered
                csv.push('MSTC नीलामी पंजीकृत वाहन');
                csv.push('SI No,Seller Name,Two-Wheeler,Four-Wheeler,Bus,Truck,Ambulance,Fire Tender,Police Owned,Police Impounded,Total');
                
                if (registeredData.data) {
                    registeredData.data.forEach(row => {
                        csv.push(`"${row.si_no || ''}","${row.seller_office_name || ''}","${row.two_wheeler || 0}","${row.four_wheeler || 0}","${row.bus || 0}","${row.truck || 0}","${row.ambulance || 0}","${row.fire_tender || 0}","${row.police_owned || 0}","${row.police_impounded || 0}","${row.total || 0}"`);
                    });
                }
                
                csv.push(''); // Empty line
                
                // MSTC Sold
                csv.push('MSTC नीलामी बेचे गए वाहन');
                csv.push('SI No,Seller Name,Two-Wheeler,Four-Wheeler,Bus,Truck,Ambulance,Fire Tender,Police Owned,Police Impounded,Total');
                
                if (soldData.data) {
                    soldData.data.forEach(row => {
                        csv.push(`"${row.si_no || ''}","${row.seller_office_name || ''}","${row.two_wheeler || 0}","${row.four_wheeler || 0}","${row.bus || 0}","${row.truck || 0}","${row.ambulance || 0}","${row.fire_tender || 0}","${row.police_owned || 0}","${row.police_impounded || 0}","${row.total || 0}"`);
                    });
                }

                // Download CSV
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'MSTC_नीलामी_रिपोर्ट.csv';
                link.click();

            } catch (error) {
                alert('MSTC रिपोर्ट डाउनलोड करने में त्रुटि: ' + error.message);
            }
        }

        // Individual export functions
        async function exportDivisionData() {
            window.open('division-vehicles.html', '_blank');
        }

        async function exportDistrictData() {
            window.open('district-vehicles.html', '_blank');
        }

        async function exportFieldData() {
            window.open('field-vehicles.html', '_blank');
        }

        function logout() {
            if (confirm('क्या आप वाकई लॉगआउट करना चाहते हैं?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
